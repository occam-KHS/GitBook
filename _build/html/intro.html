
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>나만의 추천 시스템</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint single-page" id="site-navigation">
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/occam-KHS/JupyterBook.git"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/occam-KHS/JupyterBook.git/issues/new?title=Issue%20on%20page%20%2Fintro.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <p class="caption" role="heading">
 <span class="caption-text">
  chapter 1
 </span>
</p>
<ul class="visible nav section-nav flex-column">
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter1/1.1.0_SOP">
   <strong>
    책을 시작하면서
   </strong>
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter1/1.2.0_Data_Science">
   데이터분석 환경의 변화
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  chapter 2
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter2/2.1.0_Python_Basics">
   <strong>
    파이썬 데이터분석 기초
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.1.1_Python_Basics">
     Data Type
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#string">
     String
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#list">
     List
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#number">
     Number
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#date">
     Date
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#dictionary">
     Dictionary
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#series">
     Series
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#dataframe">
     DataFrame
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.1.2_Python_Basics">
     Index
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#id1">
     Index 활용
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#id2">
     Index 생성 및 추출
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.1.3_Python_Basics">
     For Loop
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#while-loop">
     While Loop
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.1.4_Python_Basics">
     If Condition
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.1.5_Python_Basics">
     Functions
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter2/2.2.0_Useful_Techniques">
   <strong>
    유용한 기능들
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.2.1_Useful_Techniques">
     Append
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.2.2_Useful_Techniques">
     Concat 과 Merge
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#concat">
     Concat
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#merge">
     Merge
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.2.3_Useful_Techniques">
     Groupby
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#br-pd-cut-pd-qcut">
     <br/>
     pd.cut / pd.qcut
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.2.4_Useful_Techniques">
     Resample
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#financedatareader">
     FinanceDataReader
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.2.5_Useful_Techniques">
     Pickle
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.2.6_Useful_Techniques">
     Shift
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.2.7_Useful_Techniques">
     Rolling
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter2/2.3.0_Visualization">
   <strong>
    시각화
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.3.1_Visualization">
     Pandas Plot
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.3.2_Visualization">
     Matplotlib
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter2/2.4.0_Volatility_Breakout">
   <strong>
    변동성 돌파전략 구현
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.4.1_Volatility_Breakout">
     변동성 돌파전략 1
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#k">
     K 값 찾기
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#id2">
     종목 찾기
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.4.2_Volatility_Breakout">
     변동성 돌파전략 2
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#id2">
     주가지수 데이터로 전략 개선
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  chapter 3
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter3/3.1.0_Use_Case">
   <strong>
    데이터분석 활용사례
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter3/3.1.1_Use_Case">
     보험사 사례
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter3/3.1.2_Use_Case">
     신용카드사 사례
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter3/3.1.3_Use_Case">
     소매업 사례
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter3/3.1.4_Use_Case">
     제조업 사례 (난이도 상)
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  chapter 4
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter4/4.0.0_My_Strategy">
   <strong>
    데이터분석으로 나만의 전략 만들기
   </strong>
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter4/4.1.0_My_Strategy">
   <strong>
    문제점 파악
   </strong>
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter4/4.2.0_My_Strategy">
   <strong>
    정보 수집 및 전문가 인터뷰
   </strong>
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter4/4.3.0_My_Strategy">
   <strong>
    가설 설정
   </strong>
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter4/4.4.0_Data_Collection">
   <strong>
    데이터 수집 및 분석
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter4/4.4.1_Data_Collection">
     일봉 데이터 가져오기
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#financedatareader">
     FinanceDataReader 로 일봉 데이터 가져오기
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#id2">
     네이버 증권 웹크롤링으로 일봉 데이터 가져오기
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#pykrx">
     Pykrx 로 일봉 데이터 가져오기
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter4/4.4.2_Data_Collection">
     코스닥 인덱스 데이터
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter4/4.4.3_Data_Collection">
     종목별 일봉 데이터와 코스피 지수 데이터와 결합
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter4/4.4.4_Data_Processing">
     가설 검증을 위한 데이터 처리
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#br">
     <br/>
     매도 전략 데이터 프로세싱
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#id2">
     <br/>
     매수 전략 데이터 프로세싱
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  chapter 5
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter5/5.1.0_Hypothesis">
   <strong>
    가설 검정
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter5/5.1.1_Hypothesis_1">
     가격 변동성이 크고 거래량이 몰린 종목이 주가가 상승한다.
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter5/5.1.2_Hypothesis_2">
     5일 이동 평균선이 오늘 종가보다 위에 위치해 있다.
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter5/5.1.3_Hypothesis_3">
     위 꼬리가 긴 양봉이 자주 발생한다.
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter5/5.1.4_Hypothesis_4">
     거래량이 종종 터지며, 매집의 흔적을 보인다.
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter5/5.1.5_Hypothesis_5">
     주가지수보다 더 좋은 수익율을 자주 보여준다.
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter5/5.1.6_Hypothesis_6">
     동종업계 평균 수익률보다 더 좋은 수익률을 보여준다.
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter5/5.2.0_Solution_Details">
   <strong>
    해결책 개발
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter5/5.2.1_Feature_Engineering">
     피처 엔지니어링
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter5/5.2.2_Modeling_Library">
     모델링 라이브러리 소개
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#statsmodels-logistic-regression">
     Statsmodels - Logistic Regression
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#sk-learn-logistic-regression">
     SK-Learn - Logistic Regression
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#sk-learn-random-forerst">
     SK-learn - Random Forerst
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter5/5.2.3_GAM">
     종목 선정 모델 개발
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#basic-filtering">
     Basic Filtering
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter5/5.2.4_LM_Assumptions">
     선형모델 가정에 대한 이해
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  chapter 6
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter6/6.0.0_Effectiveness_Testing">
   <strong>
    해결책의 효과 측정
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter6/6.1.1_Stock_Selection">
     종목 추천 프로세스
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter6/6.1.2_Stock_Selection_Function">
     해결책 테스트
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter6/6.1.3_Save_Stocks">
     <strong>
      추천 종목을 파일로 저장
     </strong>
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  chapter 7
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter7/7.0.0_Auto_Overview">
   자동매매를 해보자
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter7/7.2.0_env_setting">
     개발환경
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter7/7.2.1_create_accnt_hanguk">
     한국투자증권
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter7/7.2.2_connect_hanguk">
     서비스 연결
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter7/7.2.3_functions_hanguk">
     주요 함수 정의
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter7/7.2.4_main_hanguk">
     자동매매 로직 이해하기
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  chapter 8
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter8/8.0.0_Web_Intro">
   <strong>
    WebApp을 만들어보자
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter8/8.1.0_Web_Application">
     WebApp 로컬에서 구현하기
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter8/8.1.1_Webapp_Deployment">
     WebApp을 배포하자
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  chapter 9
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter9/9.0.0_POC">
   <strong>
    종목 추천과 자동매매를 하나로
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter9/9.1.0_Packaging">
     파이썬 프로그램 패키징
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter9/9.1.1_Scheduling">
     윈도우즈 스케줄러
    </a>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>나만의 추천 시스템</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <p class="caption" role="heading">
 <span class="caption-text">
  chapter 1
 </span>
</p>
<ul class="visible nav section-nav flex-column">
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter1/1.1.0_SOP">
   <strong>
    책을 시작하면서
   </strong>
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter1/1.2.0_Data_Science">
   데이터분석 환경의 변화
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  chapter 2
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter2/2.1.0_Python_Basics">
   <strong>
    파이썬 데이터분석 기초
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.1.1_Python_Basics">
     Data Type
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#string">
     String
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#list">
     List
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#number">
     Number
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#date">
     Date
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#dictionary">
     Dictionary
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#series">
     Series
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#dataframe">
     DataFrame
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.1.2_Python_Basics">
     Index
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#id1">
     Index 활용
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#id2">
     Index 생성 및 추출
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.1.3_Python_Basics">
     For Loop
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#while-loop">
     While Loop
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.1.4_Python_Basics">
     If Condition
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.1.5_Python_Basics">
     Functions
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter2/2.2.0_Useful_Techniques">
   <strong>
    유용한 기능들
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.2.1_Useful_Techniques">
     Append
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.2.2_Useful_Techniques">
     Concat 과 Merge
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#concat">
     Concat
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#merge">
     Merge
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.2.3_Useful_Techniques">
     Groupby
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#br-pd-cut-pd-qcut">
     <br/>
     pd.cut / pd.qcut
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.2.4_Useful_Techniques">
     Resample
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#financedatareader">
     FinanceDataReader
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.2.5_Useful_Techniques">
     Pickle
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.2.6_Useful_Techniques">
     Shift
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.2.7_Useful_Techniques">
     Rolling
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter2/2.3.0_Visualization">
   <strong>
    시각화
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.3.1_Visualization">
     Pandas Plot
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.3.2_Visualization">
     Matplotlib
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter2/2.4.0_Volatility_Breakout">
   <strong>
    변동성 돌파전략 구현
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.4.1_Volatility_Breakout">
     변동성 돌파전략 1
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#k">
     K 값 찾기
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#id2">
     종목 찾기
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter2/2.4.2_Volatility_Breakout">
     변동성 돌파전략 2
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#id2">
     주가지수 데이터로 전략 개선
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  chapter 3
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter3/3.1.0_Use_Case">
   <strong>
    데이터분석 활용사례
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter3/3.1.1_Use_Case">
     보험사 사례
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter3/3.1.2_Use_Case">
     신용카드사 사례
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter3/3.1.3_Use_Case">
     소매업 사례
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter3/3.1.4_Use_Case">
     제조업 사례 (난이도 상)
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  chapter 4
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter4/4.0.0_My_Strategy">
   <strong>
    데이터분석으로 나만의 전략 만들기
   </strong>
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter4/4.1.0_My_Strategy">
   <strong>
    문제점 파악
   </strong>
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter4/4.2.0_My_Strategy">
   <strong>
    정보 수집 및 전문가 인터뷰
   </strong>
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter4/4.3.0_My_Strategy">
   <strong>
    가설 설정
   </strong>
  </a>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter4/4.4.0_Data_Collection">
   <strong>
    데이터 수집 및 분석
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter4/4.4.1_Data_Collection">
     일봉 데이터 가져오기
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#financedatareader">
     FinanceDataReader 로 일봉 데이터 가져오기
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#id2">
     네이버 증권 웹크롤링으로 일봉 데이터 가져오기
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#pykrx">
     Pykrx 로 일봉 데이터 가져오기
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter4/4.4.2_Data_Collection">
     코스닥 인덱스 데이터
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter4/4.4.3_Data_Collection">
     종목별 일봉 데이터와 코스피 지수 데이터와 결합
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter4/4.4.4_Data_Processing">
     가설 검증을 위한 데이터 처리
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#br">
     <br/>
     매도 전략 데이터 프로세싱
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#id2">
     <br/>
     매수 전략 데이터 프로세싱
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  chapter 5
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter5/5.1.0_Hypothesis">
   <strong>
    가설 검정
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter5/5.1.1_Hypothesis_1">
     가격 변동성이 크고 거래량이 몰린 종목이 주가가 상승한다.
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter5/5.1.2_Hypothesis_2">
     5일 이동 평균선이 오늘 종가보다 위에 위치해 있다.
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter5/5.1.3_Hypothesis_3">
     위 꼬리가 긴 양봉이 자주 발생한다.
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter5/5.1.4_Hypothesis_4">
     거래량이 종종 터지며, 매집의 흔적을 보인다.
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter5/5.1.5_Hypothesis_5">
     주가지수보다 더 좋은 수익율을 자주 보여준다.
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter5/5.1.6_Hypothesis_6">
     동종업계 평균 수익률보다 더 좋은 수익률을 보여준다.
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter5/5.2.0_Solution_Details">
   <strong>
    해결책 개발
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter5/5.2.1_Feature_Engineering">
     피처 엔지니어링
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter5/5.2.2_Modeling_Library">
     모델링 라이브러리 소개
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#statsmodels-logistic-regression">
     Statsmodels - Logistic Regression
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#sk-learn-logistic-regression">
     SK-Learn - Logistic Regression
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#sk-learn-random-forerst">
     SK-learn - Random Forerst
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter5/5.2.3_GAM">
     종목 선정 모델 개발
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#basic-filtering">
     Basic Filtering
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter5/5.2.4_LM_Assumptions">
     선형모델 가정에 대한 이해
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  chapter 6
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter6/6.0.0_Effectiveness_Testing">
   <strong>
    해결책의 효과 측정
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter6/6.1.1_Stock_Selection">
     종목 추천 프로세스
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter6/6.1.2_Stock_Selection_Function">
     해결책 테스트
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter6/6.1.3_Save_Stocks">
     <strong>
      추천 종목을 파일로 저장
     </strong>
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  chapter 7
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter7/7.0.0_Auto_Overview">
   자동매매를 해보자
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter7/7.2.0_env_setting">
     개발환경
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter7/7.2.1_create_accnt_hanguk">
     한국투자증권
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter7/7.2.2_connect_hanguk">
     서비스 연결
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter7/7.2.3_functions_hanguk">
     주요 함수 정의
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter7/7.2.4_main_hanguk">
     자동매매 로직 이해하기
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  chapter 8
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter8/8.0.0_Web_Intro">
   <strong>
    WebApp을 만들어보자
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter8/8.1.0_Web_Application">
     WebApp 로컬에서 구현하기
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter8/8.1.1_Webapp_Deployment">
     WebApp을 배포하자
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  chapter 9
 </span>
</p>
<ul class="nav section-nav flex-column">
 <li class="toctree-l1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-chapter9/9.0.0_POC">
   <strong>
    종목 추천과 자동매매를 하나로
   </strong>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter9/9.1.0_Packaging">
     파이썬 프로그램 패키징
    </a>
   </li>
   <li class="toctree-l2 nav-item toc-entry">
    <a class="reference internal nav-link" href="intro.html#document-chapter9/9.1.1_Scheduling">
     윈도우즈 스케줄러
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1><strong>나만의 추천 시스템</strong><a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="id2">
<h1>(주식데이터로 데이터분석 배우기)<a class="headerlink" href="#id2" title="Permalink to this headline">#</a></h1>
<div class="toctree-wrapper compound">
<span id="document-chapter1/1.1.0_SOP"></span><section id="id1">
<h2><strong>책을 시작하면서</strong><a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<br>
약 2년의 코로나 팬데믹 기간 동안 재택근무를 하면서 저녁시간에는 새로운 관심사를 찾아볼 시간적인 여유가 있었습니다. 저처럼 체력이 약한 사람은 퇴근 후 집에 오면, 보통 육체적 정신적 에너지가 하나도 남아있지 않았지만, 재택 기간동안은 저녁에 새로운 것들을 시도할 정신적 여유가 있었습니다. 그 중에 하나가 주식데이터 분석이였습니다. 시장에 많은 돈이 풀리면서 유동성이 증가했고, 코스피 지수는 3000 이 넘어가기도 했습니다. 많은 분들이 주식에 관심을 가지게 되었고, 저도 그 중 한 명입니다. 투자로 많은 수익을 얻은 분들은 “이런 시그널이 있으면 주가가 상승한다”  등의 실용적인 콘텐츠를 유투브에 많이 올려주셨습니다.  유투브로 많은 정보를 얻었습니다. 코로나 팬데믹 전까지는 한 번도 주식투자를 해 보지 않았는데요, 재택기간 동안 주위에 주식으로 돈을 많이 번 사람들을 만나면서, 나도 한 번 해볼까 하는 욕심이 생겼습니다. 하지만, 데이터 분석을 오랫동안 업으로 한 직장인으로서 다른 사람이 설명해주는 이론에 솔깃해서 투자하고 싶지는 않았습니다. 직접 데이터 분석으로 주가가 상승할 종목을 예측하는 알고리즘을 하나 만들어보고 싶었습니다. 그리고 그 과정들을 나름대로 요약하여 책에 담기로 했습니다. 책을 집필하면서 다시 코드를 정리해보는 기회가 되었고, 새로운 아이디어도 얻었습니다. 혹자는 “좋은 알고리즘이 있으면 당신이 혼자 사용해서 돈을 벌지, 왜 책으로 대중에게 공개하느냐?” 하는 질문이 있으실텐데요. 이 책에서 제안하는 알고리즘도 나름 저의 노하우가 많이 들어가 있지만, 더 좋은 알고리즘을 많이 만들 수 있습니다. 이 책의 중요한 목적은 데이터 분석을 배우고 싶은 분들에게 대중적 관심도가 높은 주식데이터를 이용함으로써 좀 더 흥미롭게 데이터분석을 배우는 것입니다. 이 책에서는 데이터 수집 - 가공 -예측모델링 - 활용 - 실행까지 전 머신러닝의 전 과정을 주식데이터로 진행하게 됩니다. 무엇보다도 중요한 것은 데이터 분석을 통해 수익을 만드는 경험을 해 보는 것입니다. 그것이 주식이여도 좋고, 부동산이여도 좋습니다. 데이터분석이 직접 수익으로 연결되는 과정을 주식데이터를 이용해서 증명하고 싶었습니다. 
</section>
<span id="document-chapter1/1.2.0_Data_Science"></span><section id="id1">
<h2>데이터분석 환경의 변화<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<br>
1990년대 데이터 분석(혹은 데이터 사이언스)는 주로 데이터베이스 마케팅에 분야에 활용이 되었습니다. 데이터베이스 마케팅이란 고객과 회사와 접점에서 발생하는 데이터를 데이터베이스화하고 마케팅에 활용하자는 아이디어입니다. 여러번 구매할 수 있는 상품의 경우 데이터베이스 마케팅이 효과가 좋습니다. 주로 트랜잭션(구매이력) 을 RFM (Recently, Frequceny and Monetary) 등의 인자로 고객을 세분화하고 세분된 고객군별로 별도의 마케팅을 함으로써 더 효과적인 캠페인을 할 수 있었습니다. <br></br>
<p>2000년 초반에는 CRM(Customer Relationship Management) 이  업계의 화두였습니다. 특히 데이터베이스마케팅을 할 수 있는 소프트웨어가 인기가 좋았습니다. 오라클(Oracle), 시불(Siebel) 등은 CRM 소프트웨어와 컨설팅을 경쟁적으로 시장에 팔았습니다. CRM 은 “신규고객 1 명 획득에 따른 비용 대비 수익보다, 기존 고객을 유지하는 비용 대비 수익이 훨씬 좋다”라는 기본 철학을 바탕으로 합니다. 하지만 고객 분석과 전략보다는 벤더의 소프트웨어 판매에 치중이 되다보니, 효과를 입증하기 어려웠고 무용론이 대두되었습니다.</p>
<p>또한 데이터분석은 개인 신용평가에도 활용이 많이 되었습니다. 과거 IMF (1997년) 이전에는 대출 신용한도나 신용카드 한도를 대출 담당직원이 심도있는 데이터 분석 없이 결정했습니다. 데이터에 근거하지 않고, 과거 경험으로 결정했습니다. IMF 이후, 많은 신용불량자가 생성되자 은행에서는 연체관리의 중요성을 인식하기 시작했습니다. 데이터에 근거한 통계적인 접근을 시작했습니다. 예를 들어, “이 고객은 통계적으로 연체할 확률이 70% 이므로, 예상되는 손실이 오백만원이 될때까지 신용한도를 낮춰야한다. 이런 식의 접근입니다”</p>
<p>데이터 분석은 회사에서 중요한 업무를 담당했지만, 대우를 잘 받지는 못 했습니다. 똑똑한 신입이나 대리급에서 하는 일이라고 생각하는 임원이 대부분이였습니다. 따라서 지원부서의 역할이 강했고 승진과 성과급은 영업부서의 독차지였죠.</p>
<p>하지만, 시대가 변했습니다. 인터넷/모바일의 발달로 온라인 시장이 급격히 커졌습니다. 온라인은 영업부서의 역할을 축소시켰습니다. 은행은 점포보다는 모바일 채널을 통하여 고객에게 더 저렴하고 다양한 서비스를 제공할 수 있게 되었습니다.  딥러닝 기술의 발달로 사람의 판단이 필요없는 단순한 업무는 자동화가 가능해졌습니다. 즉 분석된 결과가 비용절감과 영업의 결과로 곧바로 연결이 되는 시대가 되어 가고 있습니다. 구글은 유투브 광고를 통하여 많은 수익을 올리고 있습니다. 데이터 분석(추천 알고리즘) 이 영업결과가 되는 대표적인 케이스라고 말씀드릴 수 있습니다.</p>
<p>제조업도 센서기술과 빅데이터 저장 기술의 발달로 데이터분석의 혜택을 보기 시작했습니다. 전체 프로세스에서 발생되는 데이터를 연결하여 불량 원인분석, 비용절감 및 생산증대에 데이터를 활용하고 있습니다. 특히, 데이터를 활용하여 최적으로 기계를 제어하는 부분까지 발전하고 있습니다.</p>
<p>분석 툴과 용어도 많은 변화가 있습니다. 과거에는 SAS 라는 통계분석툴을 주로 사용했습니다. 개인적으로도 SAS 를 이용하여 20년이상 일을 했습니다. 아침에 출근하면 왼쪽 모니터에는 엑셀, 오른쪽 모니터에는 SAS 가 있었습니다. 개인적으로 애착이 깊은 소프트웨어입니다. 요즘에는 파이썬이 대세입니다. 두가지 툴 사이에 큰 차이점은 SAS 는 분석에 특화되어 있지만, 파이썬은 분석뿐 아니라 자동화와 배포(예를 들면 웹서비스)까지 모든 서비스를 가능하게 합니다. 따라서 분석의 결과를 구현해서 성과로 보여주고 싶다면 파이썬이 좋은 툴입니다.</p>
<p>데이터분석이라고 부르던 업무 영역들이 확장되어 이제는 데이터사이언스라고 불리고 있습니다. 일부는 데이터분석가과 데이터사이언티스트를 구분하고 업무영역을 다르게 보는 시각이 있으나, 제 경험으로는 차이가 크게 없습니다. 요즘 데이터사이언티스트를 하시는 분들은 컴퓨터 혹은 소프트웨어 전공자 분들이 많으셔서 소프트웨어 개발도 잘 하십니다. 분석결과가 실행되어 결과가 되는 속도가 더욱 가속되고 있습니다.</p>
</section>
</div>
<div class="toctree-wrapper compound">
<span id="document-chapter2/2.1.0_Python_Basics"></span><section id="id1">
<h2><strong>파이썬 데이터분석 기초</strong><a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<p>이번 장에서는 데이터 분석에 꼭 필요한 부분만 다룰 수 있도록 하겠습니다. 파이썬 기초 학습은 유튜브에서 좋은 강의를 쉽게 찾으실 수 있습니다. 이 장에서는 주가데이터 분석에 필요한 기술만 우선적으로 익히고, 배운 기술을 이용하여 래리 윌리암스의 변동성 돌파전략을 구현해 보겠습니다. 알고리즘 개발을 위한 파이썬 코드는 쥬피터노트북 환경에서 작성하고 실행을 하였습니다. 주피터노트북은 대화형으로 코딩을 할 수 있는 파이썬 에디터이기 때문에 데이터분석가 가장 선호하는 에디터입니다. 아나콘다를 설치하면 데이터분석을 위한 여러 패키지와 함께 주피터노트북이 설치됩니다. 아나콘다 설치 관련하여 다양한 유투브 동영상과 온라인 자료가 있습니다. 본서에는 7장(자동매매)에서 아나콘다 설치를 위한 가이드를 제공합니다. 아나콘다를 설치 못하신 독자는 아나콘다 설치 완료하시고 진행하시면 되겠습니다.</p>
<div class="toctree-wrapper compound">
<span id="document-chapter2/2.1.1_Python_Basics"></span><section id="data-type">
<h3>Data Type<a class="headerlink" href="#data-type" title="Permalink to this headline">#</a></h3>
<p>먼저 데이터 타입에 대한 이해가 필요합니다. 주식 데이터 분석에서 활용할 데이터 타입은 숫자(Number),  문자열(String),  날짜(Date), 딕셔너리(Dictionary), 리스트(List), 시리즈(Series), 데이터프레임(DataFrame) 등이 있습니다. 각 타입의 형식은 아래와 같습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Number</span>
<span class="n">n1</span> <span class="o">=</span> <span class="mi">123</span>
<span class="n">n2</span> <span class="o">=</span> <span class="mi">234</span>

<span class="c1"># String </span>
<span class="n">s1</span> <span class="o">=</span> <span class="s1">&#39;string&#39;</span>
<span class="n">s2</span> <span class="o">=</span> <span class="s1">&#39;I am Tom&#39;</span>

<span class="c1"># Date</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="n">d1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">yymmdd</span> <span class="o">=</span> <span class="s1">&#39;2021-01-03&#39;</span>
<span class="n">d2</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">yymmdd</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Dictionary</span>
<span class="n">dic1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span><span class="mi">13</span><span class="p">}</span>

<span class="c1"># List</span>
<span class="n">l1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="n">l2</span> <span class="o">=</span>  <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>

<span class="c1"># Series</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">ss1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">]</span>
<span class="n">ss2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ss1</span><span class="p">)</span>

<span class="c1"># DataFrame</span>
<span class="n">c_1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="n">c_2</span> <span class="o">=</span>  <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>
<span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;col1&#39;</span><span class="p">:</span> <span class="n">c_1</span><span class="p">,</span> <span class="s1">&#39;col2&#39;</span><span class="p">:</span> <span class="n">c_2</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="string">
<h3>String<a class="headerlink" href="#string" title="Permalink to this headline">#</a></h3>
<p>문자열의 첫 글자부터 0, 1, 2 번째 문자 해당합니다. 예를 들어, ‘String’ 이란 문자열을 s1 이란 변수에서 저장한 경우, s1[0] 은 ‘s’ 에 해당하고, s1[1] 은 ‘t’ 에 해당합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># String </span>
<span class="n">s1</span> <span class="o">=</span> <span class="s1">&#39;string&#39;</span>
<span class="n">s2</span> <span class="o">=</span> <span class="s1">&#39;I am Tom&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">s2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s2</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="c1"># I am Tom 의 첫번재[0], 6번째[5] 글자 반환. 대부분의 컴푸터 언어는 0 부터 시작.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>string
I T
</pre></div>
</div>
</div>
</div>
</section>
<section id="list">
<h3>List<a class="headerlink" href="#list" title="Permalink to this headline">#</a></h3>
<p>리스트는 여러 개의 원소를 대괄호 [] 에 넣은 형태입니다. 리스트도 문자열과 동일하게 0 부터 시작합니다.
아래 l1 에서 0 번째 원소는 1 이고, l2 에서는 ‘a’ 입니다. 그리고 [start_point:end_point] 를 형식으로 원소의 일부만 가져올 수 있습니다. 단, [start_point:end_point] 에서 원소는 end_point 전까지 가져오는 사실만 유의하시면 됩니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># List</span>
<span class="n">l1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="n">l2</span> <span class="o">=</span>  <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">l1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">l2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">l2</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="c1"># 0 ~ 1 번째 문자를 가져옴. 2 번째 포함되지 않음.</span>
<span class="nb">print</span><span class="p">(</span><span class="n">l2</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span> <span class="c1"># 1 ~ 2 번째 문자를 가져옴. 3 번째는 포함되지 않음</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
a
[&#39;a&#39;, &#39;b&#39;]
[&#39;b&#39;, &#39;c&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="number">
<h3>Number<a class="headerlink" href="#number" title="Permalink to this headline">#</a></h3>
<p>숫자형은 정수형, 소숫점형으로 나눌 수 있으나, 아래와 같이 곧바로 사칙연산이 가능합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Number</span>
<span class="n">n1</span> <span class="o">=</span> <span class="mi">123</span>
<span class="n">n2</span> <span class="o">=</span> <span class="mi">234</span>
<span class="nb">print</span><span class="p">(</span><span class="n">n1</span><span class="o">*</span><span class="n">n2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>28782
</pre></div>
</div>
</div>
</div>
</section>
<section id="date">
<h3>Date<a class="headerlink" href="#date" title="Permalink to this headline">#</a></h3>
<p>날짜형 데이터는 주식데이터 분석에 중요한 데이터형식입니다. 활용도가 아주 높습니다. 날짜 데이터를 활용하기 위해서는 먼저 datetime 패키지를 import 합니다. datetime 는 날짜 데이터를 다루기 위한 여러 메소드를 가지고 있습니다. 첫 번째 d1 변수에서 datetime.datetime 함수는 년, 월, 시 등의 숫자를 파이썬 날짜로 변형할 수 있게 해 줍니다. d2 변수는 문자열로 되어 있는 날짜를 파이썬 날짜로 변형하는 한 후 저장을 합니다. strptime 은 문자열을 파이썬 날짜로 변경해주는 메소드입니다. strptime 은 두 개의 인수가 필요한데요. 이 함수의 첫 번째 인자는 날짜 형태의 문자열, 두번 째 인자는 형식 포맷입니다. 문자열 날짜 포맷이 %Y-%m-%d 형태라는 것을 인수로 알려줍니다. d3 는 다른 날짜 형식으로 되어 있는 문자열을 파이썬 날짜로 변경하는 법을 보여줍니다. d4 는 반대로 파이썬 날짜를 다시 문자열로 변경하는 법을 보여주고 있습니다. 이 때 함수는 strpftime 입니다. 마지막으로 timedelta 를 알아보겠습니다. timedelta 는 일정한 시간을 뒤로 이동한 결과를 반환합니다. 예를 들어 d1 에 hours=5 를 추가하면 2021년 1월 3일 0 시에서 2021년 1월 3일 5시로 변경됩니다. 아래 예시는 d1 에서 5 시간을 더 했을 때, 2 일 더했을 때 결과를 보여줍니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Date</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="n">d1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">yymmdd</span> <span class="o">=</span> <span class="s1">&#39;2021-01-03&#39;</span>
<span class="n">d2</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">yymmdd</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">time_point</span> <span class="o">=</span> <span class="s1">&#39;2021/01/03 19:15:32&#39;</span>
<span class="n">d3</span> <span class="o">=</span>  <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time_point</span><span class="p">,</span> <span class="s1">&#39;%Y/%m/</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>

<span class="n">d4</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">d3</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">d3</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">d3</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">d4</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">d4</span><span class="p">))</span>    

<span class="nb">print</span><span class="p">(</span><span class="n">d1</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">d1</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-01-03 00:00:00
2021-01-03 00:00:00
2021-01-03 19:15:32 &lt;class &#39;datetime.datetime&#39;&gt;
2021-01-03 &lt;class &#39;str&#39;&gt;
2021-01-03 05:00:00
2021-01-05 00:00:00
</pre></div>
</div>
</div>
</div>
</section>
<section id="dictionary">
<h3>Dictionary<a class="headerlink" href="#dictionary" title="Permalink to this headline">#</a></h3>
<p>디셔너리는 key 와 value 가 있는 짝으로 있는 형태입니다. key 를 이용하여 원하는 값을 찾을 수 있어서, 프로그램에서 참조 값을 저장해 둘 때 아주 유용합니다. value 대신에 List 나 DataFrame 형식의 데이터도 넣을 수 도 있습니다. 아래 예시에서는 dic1 에서 키값 ‘a’ 에 해당하는 값은 11 입니다. 새로운 key 와 value 를 넣어서 기존의 Dictionary 에 추가할 수 있습니다. 아래 두 번째 예시는 ‘d’라는 key 에 value 14 를 추가하는 방법입니다. Dictionary 가 너무 커서 어떤 key 값들이 있는 지 알고 싶을 때는 key() 메소드를 사용합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dictionary</span>
<span class="n">dic1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span><span class="mi">13</span><span class="p">}</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dic1</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])</span>

<span class="n">dic1</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">14</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dic1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">dic1</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>11
{&#39;a&#39;: 11, &#39;b&#39;: 12, &#39;c&#39;: 13, &#39;d&#39;: 14}
dict_keys([&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;])
</pre></div>
</div>
</div>
</div>
</section>
<section id="series">
<h3>Series<a class="headerlink" href="#series" title="Permalink to this headline">#</a></h3>
<p>Series 라는 데이터 타입을 이용하기 위해서는 Pandas 패키지를 이용합니다. Pandas 는 테이블 형태의 데이터를 다루는데 정말 강력한 패키지입니다. 먼저 ss1 이라는 리스트를 생성해 보겠습니다. ss1 이라는 리스트에 어떤 메소드를 사용할 수 있는 지 알기 위해서는 dir() 를 이용합니다.  dir() 를 하면 Built-in 함수 전체를 알 수 있습니다. append 부터 sort 까지 총 11 개의 함수가 나옵니다. 이 11 개 함수가 List 에서 쓸 수 있는 메소드입니다. 이번에는 ss1 를 Series 로 변경한 후, ss2 에 저장하겠습니다. 그리고 dir() 함수로 호출해 보겠습니다. 많은 메소스가 나열됩니다. 예를 들어 List 값의 평균을 알고 싶은데, List 는 평균을 구하는 메소드가 없습니다. 하지만 Series 에는 mean() 으로 평균값을 구할 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">ss1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">]</span>
<span class="n">ss2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ss1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">ss1</span><span class="p">))</span> <span class="c1"># &#39;append&#39;, &#39;clear&#39;, &#39;copy&#39;, &#39;count&#39;, &#39;extend&#39;, &#39;index&#39;, &#39;insert&#39;, &#39;pop&#39;, &#39;remove&#39;, &#39;reverse&#39;, &#39;sort&#39; 등 사용가능</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">ss2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="sd">&#39;&#39;&#39; ss1.mean() --&gt; 에러발생 &#39;&#39;&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ss2</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="c1"># 평균값 13 반환</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;__add__&#39;, &#39;__class__&#39;, &#39;__class_getitem__&#39;, &#39;__contains__&#39;, &#39;__delattr__&#39;, &#39;__delitem__&#39;, &#39;__dir__&#39;, &#39;__doc__&#39;, &#39;__eq__&#39;, &#39;__format__&#39;, &#39;__ge__&#39;, &#39;__getattribute__&#39;, &#39;__getitem__&#39;, &#39;__gt__&#39;, &#39;__hash__&#39;, &#39;__iadd__&#39;, &#39;__imul__&#39;, &#39;__init__&#39;, &#39;__init_subclass__&#39;, &#39;__iter__&#39;, &#39;__le__&#39;, &#39;__len__&#39;, &#39;__lt__&#39;, &#39;__mul__&#39;, &#39;__ne__&#39;, &#39;__new__&#39;, &#39;__reduce__&#39;, &#39;__reduce_ex__&#39;, &#39;__repr__&#39;, &#39;__reversed__&#39;, &#39;__rmul__&#39;, &#39;__setattr__&#39;, &#39;__setitem__&#39;, &#39;__sizeof__&#39;, &#39;__str__&#39;, &#39;__subclasshook__&#39;, &#39;append&#39;, &#39;clear&#39;, &#39;copy&#39;, &#39;count&#39;, &#39;extend&#39;, &#39;index&#39;, &#39;insert&#39;, &#39;pop&#39;, &#39;remove&#39;, &#39;reverse&#39;, &#39;sort&#39;]


[&#39;T&#39;, &#39;_AXIS_LEN&#39;, &#39;_AXIS_ORDERS&#39;, &#39;_AXIS_REVERSED&#39;, &#39;_AXIS_TO_AXIS_NUMBER&#39;, &#39;_HANDLED_TYPES&#39;, &#39;__abs__&#39;, &#39;__add__&#39;, &#39;__and__&#39;, &#39;__annotations__&#39;, &#39;__array__&#39;, &#39;__array_priority__&#39;, &#39;__array_ufunc__&#39;, &#39;__array_wrap__&#39;, &#39;__bool__&#39;, &#39;__class__&#39;, &#39;__contains__&#39;, &#39;__copy__&#39;, &#39;__deepcopy__&#39;, &#39;__delattr__&#39;, &#39;__delitem__&#39;, &#39;__dict__&#39;, &#39;__dir__&#39;, &#39;__divmod__&#39;, &#39;__doc__&#39;, &#39;__eq__&#39;, &#39;__finalize__&#39;, &#39;__float__&#39;, &#39;__floordiv__&#39;, &#39;__format__&#39;, &#39;__ge__&#39;, &#39;__getattr__&#39;, &#39;__getattribute__&#39;, &#39;__getitem__&#39;, &#39;__getstate__&#39;, &#39;__gt__&#39;, &#39;__hash__&#39;, &#39;__iadd__&#39;, &#39;__iand__&#39;, &#39;__ifloordiv__&#39;, &#39;__imod__&#39;, &#39;__imul__&#39;, &#39;__init__&#39;, &#39;__init_subclass__&#39;, &#39;__int__&#39;, &#39;__invert__&#39;, &#39;__ior__&#39;, &#39;__ipow__&#39;, &#39;__isub__&#39;, &#39;__iter__&#39;, &#39;__itruediv__&#39;, &#39;__ixor__&#39;, &#39;__le__&#39;, &#39;__len__&#39;, &#39;__long__&#39;, &#39;__lt__&#39;, &#39;__matmul__&#39;, &#39;__mod__&#39;, &#39;__module__&#39;, &#39;__mul__&#39;, &#39;__ne__&#39;, &#39;__neg__&#39;, &#39;__new__&#39;, &#39;__nonzero__&#39;, &#39;__or__&#39;, &#39;__pos__&#39;, &#39;__pow__&#39;, &#39;__radd__&#39;, &#39;__rand__&#39;, &#39;__rdivmod__&#39;, &#39;__reduce__&#39;, &#39;__reduce_ex__&#39;, &#39;__repr__&#39;, &#39;__rfloordiv__&#39;, &#39;__rmatmul__&#39;, &#39;__rmod__&#39;, &#39;__rmul__&#39;, &#39;__ror__&#39;, &#39;__round__&#39;, &#39;__rpow__&#39;, &#39;__rsub__&#39;, &#39;__rtruediv__&#39;, &#39;__rxor__&#39;, &#39;__setattr__&#39;, &#39;__setitem__&#39;, &#39;__setstate__&#39;, &#39;__sizeof__&#39;, &#39;__str__&#39;, &#39;__sub__&#39;, &#39;__subclasshook__&#39;, &#39;__truediv__&#39;, &#39;__weakref__&#39;, &#39;__xor__&#39;, &#39;_accessors&#39;, &#39;_accum_func&#39;, &#39;_add_numeric_operations&#39;, &#39;_agg_by_level&#39;, &#39;_agg_examples_doc&#39;, &#39;_agg_see_also_doc&#39;, &#39;_align_frame&#39;, &#39;_align_series&#39;, &#39;_arith_method&#39;, &#39;_as_manager&#39;, &#39;_attrs&#39;, &#39;_binop&#39;, &#39;_can_hold_na&#39;, &#39;_check_inplace_and_allows_duplicate_labels&#39;, &#39;_check_inplace_setting&#39;, &#39;_check_is_chained_assignment_possible&#39;, &#39;_check_label_or_level_ambiguity&#39;, &#39;_check_setitem_copy&#39;, &#39;_clear_item_cache&#39;, &#39;_clip_with_one_bound&#39;, &#39;_clip_with_scalar&#39;, &#39;_cmp_method&#39;, &#39;_consolidate&#39;, &#39;_consolidate_inplace&#39;, &#39;_construct_axes_dict&#39;, &#39;_construct_axes_from_arguments&#39;, &#39;_construct_result&#39;, &#39;_constructor&#39;, &#39;_constructor_expanddim&#39;, &#39;_convert&#39;, &#39;_convert_dtypes&#39;, &#39;_data&#39;, &#39;_dir_additions&#39;, &#39;_dir_deletions&#39;, &#39;_drop_axis&#39;, &#39;_drop_labels_or_levels&#39;, &#39;_duplicated&#39;, &#39;_find_valid_index&#39;, &#39;_flags&#39;, &#39;_from_mgr&#39;, &#39;_get_axis&#39;, &#39;_get_axis_name&#39;, &#39;_get_axis_number&#39;, &#39;_get_axis_resolvers&#39;, &#39;_get_block_manager_axis&#39;, &#39;_get_bool_data&#39;, &#39;_get_cacher&#39;, &#39;_get_cleaned_column_resolvers&#39;, &#39;_get_index_resolvers&#39;, &#39;_get_label_or_level_values&#39;, &#39;_get_numeric_data&#39;, &#39;_get_value&#39;, &#39;_get_values&#39;, &#39;_get_values_tuple&#39;, &#39;_get_with&#39;, &#39;_gotitem&#39;, &#39;_hidden_attrs&#39;, &#39;_index&#39;, &#39;_indexed_same&#39;, &#39;_info_axis&#39;, &#39;_info_axis_name&#39;, &#39;_info_axis_number&#39;, &#39;_init_dict&#39;, &#39;_init_mgr&#39;, &#39;_inplace_method&#39;, &#39;_internal_names&#39;, &#39;_internal_names_set&#39;, &#39;_is_cached&#39;, &#39;_is_copy&#39;, &#39;_is_label_or_level_reference&#39;, &#39;_is_label_reference&#39;, &#39;_is_level_reference&#39;, &#39;_is_mixed_type&#39;, &#39;_is_view&#39;, &#39;_item_cache&#39;, &#39;_ixs&#39;, &#39;_logical_func&#39;, &#39;_logical_method&#39;, &#39;_map_values&#39;, &#39;_maybe_update_cacher&#39;, &#39;_memory_usage&#39;, &#39;_metadata&#39;, &#39;_mgr&#39;, &#39;_min_count_stat_function&#39;, &#39;_name&#39;, &#39;_needs_reindex_multi&#39;, &#39;_protect_consolidate&#39;, &#39;_reduce&#39;, &#39;_reindex_axes&#39;, &#39;_reindex_indexer&#39;, &#39;_reindex_multi&#39;, &#39;_reindex_with_indexers&#39;, &#39;_replace_single&#39;, &#39;_repr_data_resource_&#39;, &#39;_repr_latex_&#39;, &#39;_reset_cache&#39;, &#39;_reset_cacher&#39;, &#39;_set_as_cached&#39;, &#39;_set_axis&#39;, &#39;_set_axis_name&#39;, &#39;_set_axis_nocheck&#39;, &#39;_set_is_copy&#39;, &#39;_set_labels&#39;, &#39;_set_name&#39;, &#39;_set_value&#39;, &#39;_set_values&#39;, &#39;_set_with&#39;, &#39;_set_with_engine&#39;, &#39;_slice&#39;, &#39;_stat_axis&#39;, &#39;_stat_axis_name&#39;, &#39;_stat_axis_number&#39;, &#39;_stat_function&#39;, &#39;_stat_function_ddof&#39;, &#39;_take_with_is_copy&#39;, &#39;_typ&#39;, &#39;_update_inplace&#39;, &#39;_validate_dtype&#39;, &#39;_values&#39;, &#39;_where&#39;, &#39;abs&#39;, &#39;add&#39;, &#39;add_prefix&#39;, &#39;add_suffix&#39;, &#39;agg&#39;, &#39;aggregate&#39;, &#39;align&#39;, &#39;all&#39;, &#39;any&#39;, &#39;append&#39;, &#39;apply&#39;, &#39;argmax&#39;, &#39;argmin&#39;, &#39;argsort&#39;, &#39;array&#39;, &#39;asfreq&#39;, &#39;asof&#39;, &#39;astype&#39;, &#39;at&#39;, &#39;at_time&#39;, &#39;attrs&#39;, &#39;autocorr&#39;, &#39;axes&#39;, &#39;backfill&#39;, &#39;between&#39;, &#39;between_time&#39;, &#39;bfill&#39;, &#39;bool&#39;, &#39;clip&#39;, &#39;combine&#39;, &#39;combine_first&#39;, &#39;compare&#39;, &#39;convert_dtypes&#39;, &#39;copy&#39;, &#39;corr&#39;, &#39;count&#39;, &#39;cov&#39;, &#39;cummax&#39;, &#39;cummin&#39;, &#39;cumprod&#39;, &#39;cumsum&#39;, &#39;describe&#39;, &#39;diff&#39;, &#39;div&#39;, &#39;divide&#39;, &#39;divmod&#39;, &#39;dot&#39;, &#39;drop&#39;, &#39;drop_duplicates&#39;, &#39;droplevel&#39;, &#39;dropna&#39;, &#39;dtype&#39;, &#39;dtypes&#39;, &#39;duplicated&#39;, &#39;empty&#39;, &#39;eq&#39;, &#39;equals&#39;, &#39;ewm&#39;, &#39;expanding&#39;, &#39;explode&#39;, &#39;factorize&#39;, &#39;ffill&#39;, &#39;fillna&#39;, &#39;filter&#39;, &#39;first&#39;, &#39;first_valid_index&#39;, &#39;flags&#39;, &#39;floordiv&#39;, &#39;ge&#39;, &#39;get&#39;, &#39;groupby&#39;, &#39;gt&#39;, &#39;hasnans&#39;, &#39;head&#39;, &#39;hist&#39;, &#39;iat&#39;, &#39;idxmax&#39;, &#39;idxmin&#39;, &#39;iloc&#39;, &#39;index&#39;, &#39;infer_objects&#39;, &#39;interpolate&#39;, &#39;is_monotonic&#39;, &#39;is_monotonic_decreasing&#39;, &#39;is_monotonic_increasing&#39;, &#39;is_unique&#39;, &#39;isin&#39;, &#39;isna&#39;, &#39;isnull&#39;, &#39;item&#39;, &#39;items&#39;, &#39;iteritems&#39;, &#39;keys&#39;, &#39;kurt&#39;, &#39;kurtosis&#39;, &#39;last&#39;, &#39;last_valid_index&#39;, &#39;le&#39;, &#39;loc&#39;, &#39;lt&#39;, &#39;mad&#39;, &#39;map&#39;, &#39;mask&#39;, &#39;max&#39;, &#39;mean&#39;, &#39;median&#39;, &#39;memory_usage&#39;, &#39;min&#39;, &#39;mod&#39;, &#39;mode&#39;, &#39;mul&#39;, &#39;multiply&#39;, &#39;name&#39;, &#39;nbytes&#39;, &#39;ndim&#39;, &#39;ne&#39;, &#39;nlargest&#39;, &#39;notna&#39;, &#39;notnull&#39;, &#39;nsmallest&#39;, &#39;nunique&#39;, &#39;pad&#39;, &#39;pct_change&#39;, &#39;pipe&#39;, &#39;plot&#39;, &#39;pop&#39;, &#39;pow&#39;, &#39;prod&#39;, &#39;product&#39;, &#39;quantile&#39;, &#39;radd&#39;, &#39;rank&#39;, &#39;ravel&#39;, &#39;rdiv&#39;, &#39;rdivmod&#39;, &#39;reindex&#39;, &#39;reindex_like&#39;, &#39;rename&#39;, &#39;rename_axis&#39;, &#39;reorder_levels&#39;, &#39;repeat&#39;, &#39;replace&#39;, &#39;resample&#39;, &#39;reset_index&#39;, &#39;rfloordiv&#39;, &#39;rmod&#39;, &#39;rmul&#39;, &#39;rolling&#39;, &#39;round&#39;, &#39;rpow&#39;, &#39;rsub&#39;, &#39;rtruediv&#39;, &#39;sample&#39;, &#39;searchsorted&#39;, &#39;sem&#39;, &#39;set_axis&#39;, &#39;set_flags&#39;, &#39;shape&#39;, &#39;shift&#39;, &#39;size&#39;, &#39;skew&#39;, &#39;slice_shift&#39;, &#39;sort_index&#39;, &#39;sort_values&#39;, &#39;squeeze&#39;, &#39;std&#39;, &#39;sub&#39;, &#39;subtract&#39;, &#39;sum&#39;, &#39;swapaxes&#39;, &#39;swaplevel&#39;, &#39;tail&#39;, &#39;take&#39;, &#39;to_clipboard&#39;, &#39;to_csv&#39;, &#39;to_dict&#39;, &#39;to_excel&#39;, &#39;to_frame&#39;, &#39;to_hdf&#39;, &#39;to_json&#39;, &#39;to_latex&#39;, &#39;to_list&#39;, &#39;to_markdown&#39;, &#39;to_numpy&#39;, &#39;to_period&#39;, &#39;to_pickle&#39;, &#39;to_sql&#39;, &#39;to_string&#39;, &#39;to_timestamp&#39;, &#39;to_xarray&#39;, &#39;transform&#39;, &#39;transpose&#39;, &#39;truediv&#39;, &#39;truncate&#39;, &#39;tz_convert&#39;, &#39;tz_localize&#39;, &#39;unique&#39;, &#39;unstack&#39;, &#39;update&#39;, &#39;value_counts&#39;, &#39;values&#39;, &#39;var&#39;, &#39;view&#39;, &#39;where&#39;, &#39;xs&#39;]


13.0
</pre></div>
</div>
</div>
</div>
</section>
<section id="dataframe">
<h3>DataFrame<a class="headerlink" href="#dataframe" title="Permalink to this headline">#</a></h3>
<p>DataFrame 은 Series의 확장으로, DataFrame 에서 한 개의 Series 는 하나의 Column 이 됩니다. DataFrame 은 여러 개 Column 이 모여 있는 테이블 형태의 데이터 형식입니다. 우선 Dictionary 로 DataFrame 을 만들어 보겠습니다. 두 개의 List - c1_list 와 c2_list 가 두 개의 key - ‘c1’, ‘c2’ 대응이 되는 Dictionary, dic_c12 를 생성합니다. 그 다음 pd.DataFrame(dic_c12) 와 같이 DataFrame 으로 데이터 타입을 변경합니다. 출력해보면 테이블 형태로 변경되었음을 알 수 있습니다. 그리고 이 DataFrame 을 df 라는 변수에 저장합니다. df 에서 한 컬럼만 자르면 다시 Series 로 변경됩니다. Series 보다 더 많은 메소드를 이용할 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c1_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">]</span>
<span class="n">c2_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;e&#39;</span><span class="p">]</span>

<span class="n">dic_c12</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;c1&#39;</span><span class="p">:</span> <span class="n">c1_list</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">:</span> <span class="n">c2_list</span><span class="p">}</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dic_c12</span><span class="p">)</span> <span class="c1"># DataFrame 으로 변경</span>

<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">],</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   c1 c2
0  11  a
1  12  b
2  13  c
3  14  d
4  15  e


0    11
1    12
2    13
3    14
4    15
Name: c1, dtype: int64 &lt;class &#39;pandas.core.series.Series&#39;&gt;
</pre></div>
</div>
</div>
</div>
</section>
<span id="document-chapter2/2.1.2_Python_Basics"></span><section id="index">
<h3>Index<a class="headerlink" href="#index" title="Permalink to this headline">#</a></h3>
<p>데이터 처리에 중요한 역활을 하는 Index 에 대하여 알아보겠습니다. Index 는 우리말로 색인이라고 할 수 있을 것 같은데요. 색인은 무엇을 빨리 찾기 위해 순서대로 정리되어 있는 목록입니다. Index 는 색인처럼 어떤 값을 빨리 찾을 때도 필요하지만, 두 데이터를 어떤 값을 기준으로 결합하는데도 유용하게 쓰입니다. Index 는 Series 와 DataFrame 에 주로 활용됩니다. ss2 는 바로 이전 장에서 만든 Series 입니다. 출력을 해 보면 맨 왼쪽에 0 ~ 4 까지 값이 보이는데요. 이게 Index 입니다. 특별하게 지정하지 않으면 숫자 0 부터서 순서대로 들어가게 됩니다. 다음은 알파벳 Index 를 넣어서 ss3 를 생성하고 출력 해보겠습니다. 맨 왼쪽 index 값이 숫자가 아니라 알파벳으로 바뀌었습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">ss1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">]</span>
<span class="n">ss2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ss1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ss2</span><span class="p">)</span>

<span class="n">ss3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ss1</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ss3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0    11
1    12
2    13
3    14
4    15
dtype: int64
a    11
b    12
c    13
d    14
e    15
dtype: int64
</pre></div>
</div>
</div>
</div>
</section>
<section id="id1">
<h3>Index 활용<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>Index 의 본연의 기능은 찾기입니다. ss3.loc[인덱스값] 를 이용하여 원하는 값을 찾을 수 있습니다. 인덱스 ‘c’ 에 해당하는 값은 13입니다. ss3.loc[‘c’] 를 하면 13이 출력됩니다. 만약, 인덱스 ‘a’ 와 ‘c’ 를 다 찾고 싶으면 [‘a’, ‘c’] 와 같이 List 로 넣어주면 됩니다. loc 를 하지 않아도 같은 결과를 얻으시겠지만, loc 를 넣으면 ‘a’,’c’ 를 column 이 아니라 index 에서 찾는다는 것을 명확하게 해 줍니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ss3</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">],</span> <span class="n">ss3</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ss3</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>11 13
a    11
c    13
dtype: int64
</pre></div>
</div>
</div>
</div>
<p><br> DataFrame 에서도 동일하게 활용가능합니다. 먼저 df1 이라는 DataFrame 을 생성하고 출력합니다. Default Index 인 숫자 0 ~ 4 로 되어 있음을 확인할 수 있습니다. 이제 원하는 인덱스 s1 ~ s5 를 할당하고 df2 에 저장합니다. 출력 결과를 보니 df2 의 인덱스가 바뀌었습니다.</p>
<p>이번에는 원하는 값을 찾아보겠습니다. df2 의 index 가 ‘s3’ 인 c1 컬럼값을 알고 싶다면 df2.loc[‘s3’][‘c1’] 이라고 하면 됩니다. 만약, c1 과 c2 둘다 출력하고 싶으면  df2.loc[‘s3’][[‘c1’,’c2’]] 형태로 리스트로 입력합니다. 실수로 df2.loc[‘s3’][‘c1’,’c2’] 로 입력을 하면 Pandas 패키지는 ‘c1,’c2’ 가 하나의 column 이름이라고 착각하게 되어 에러가 발생합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># DataFrame 생성</span>
<span class="n">c1_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">]</span>
<span class="n">c2_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;e&#39;</span><span class="p">]</span>
<span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;c1&#39;</span><span class="p">:</span> <span class="n">c1_list</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">:</span> <span class="n">c2_list</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;c1&#39;</span><span class="p">:</span> <span class="n">c1_list</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">:</span> <span class="n">c2_list</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;s1&#39;</span><span class="p">,</span><span class="s1">&#39;s2&#39;</span><span class="p">,</span><span class="s1">&#39;s3&#39;</span><span class="p">,</span><span class="s1">&#39;s4&#39;</span><span class="p">,</span><span class="s1">&#39;s4&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">][</span><span class="s1">&#39;c1&#39;</span><span class="p">])</span> <span class="c1"># 13 출력</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;s3&#39;</span><span class="p">][[</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span><span class="s1">&#39;c2&#39;</span><span class="p">]])</span> <span class="c1"># 13 과 c 출력</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   c1 c2
0  11  a
1  12  b
2  13  c
3  14  d
4  15  e


    c1 c2
s1  11  a
s2  12  b
s3  13  c
s4  14  d
s4  15  e


13
c1    13
c2     c
Name: s3, dtype: object
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h3>Index 생성 및 추출<a class="headerlink" href="#id2" title="Permalink to this headline">#</a></h3>
<p>set_index 메소드로 기존의 column 을 index 로 만들 수 있습니다. set_index(‘c2’) 처리 후, df2 를 출력하시면 df1 의 ‘c2’ 컬럼이 index 로 되어 있음을 확인할 수 있습니다.
이제 df2 의 index 값을 변경해 보겠습니다. 아래와 같이 DataFrame 의 Index를 호출하여 원하는 Index 로 교체도 가능합니다. 참고로 아래 df2 는 column 하나지만 현재 Series 가 아닌 DataFrame 입니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c1_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">]</span>
<span class="n">c2_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;e&#39;</span><span class="p">]</span>
<span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;c1&#39;</span><span class="p">:</span> <span class="n">c1_list</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">:</span> <span class="n">c2_list</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span>        

<span class="n">df2</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;c2&#39;</span><span class="p">)</span> <span class="c1"># c2 를 index 로 변경</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">df2</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ss1&#39;</span><span class="p">,</span> <span class="s1">&#39;ss2&#39;</span><span class="p">,</span> <span class="s1">&#39;ss3&#39;</span><span class="p">,</span> <span class="s1">&#39;ss4&#39;</span><span class="p">,</span> <span class="s1">&#39;ss5&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df2</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">df2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   c1 c2
0  11  a
1  12  b
2  13  c
3  14  d
4  15  e
    c1
c2    
a   11
b   12
c   13
d   14
e   15


     c1
ss1  11
ss2  12
ss3  13
ss4  14
ss5  15 &lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
</pre></div>
</div>
</div>
</div>
<p><br> 항상 두 데이터셋을 index 로 병합할 때는 index 에 중복이 있는지 확인을 할 필요가 있습니다. index 가 중복 여부를 체크하는 인수는 verify_integriry 입니다. 아래는 중복이 있는 경우 에러를 발생시킵니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c1_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">]</span>
<span class="n">c2_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="c1"># 값에 중복이 있음</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;c1&#39;</span><span class="p">:</span> <span class="n">c1_list</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">:</span> <span class="n">c2_list</span><span class="p">})</span>
<span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;c2&#39;</span><span class="p">,</span> <span class="n">verify_integrity</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># index 중복여부를 체크</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="o">~</span>\<span class="n">AppData</span>\<span class="n">Local</span>\<span class="n">Temp</span>\<span class="n">ipykernel_3484</span>\<span class="mf">2078573242.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">c2_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="c1"># 값에 중복이 있음</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;c1&#39;</span><span class="p">:</span> <span class="n">c1_list</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">:</span> <span class="n">c2_list</span><span class="p">})</span>
<span class="ne">----&gt; </span><span class="mi">4</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;c2&#39;</span><span class="p">,</span> <span class="n">verify_integrity</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># index 중복여부를 체크</span>

<span class="nn">~\Anaconda3\lib\site-packages\pandas\util\_decorators.py</span> in <span class="ni">wrapper</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">309</span>                     <span class="n">stacklevel</span><span class="o">=</span><span class="n">stacklevel</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">310</span>                 <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">311</span>             <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">312</span> 
<span class="g g-Whitespace">    </span><span class="mi">313</span>         <span class="k">return</span> <span class="n">wrapper</span>

<span class="nn">~\Anaconda3\lib\site-packages\pandas\core\frame.py</span> in <span class="ni">set_index</span><span class="nt">(self, keys, drop, append, inplace, verify_integrity)</span>
<span class="g g-Whitespace">   </span><span class="mi">5508</span>         <span class="k">if</span> <span class="n">verify_integrity</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">index</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">5509</span>             <span class="n">duplicates</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="ne">-&gt; </span><span class="mi">5510</span>             <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index has duplicate keys: </span><span class="si">{</span><span class="n">duplicates</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">5511</span> 
<span class="g g-Whitespace">   </span><span class="mi">5512</span>         <span class="c1"># use set to handle duplicate column names gracefully in case of drop</span>

<span class="ne">ValueError</span>: Index has duplicate keys: Index([&#39;a&#39;], dtype=&#39;object&#39;, name=&#39;c2&#39;)
</pre></div>
</div>
</div>
</div>
</section>
<span id="document-chapter2/2.1.3_Python_Basics"></span><section id="for-loop">
<h3>For Loop<a class="headerlink" href="#for-loop" title="Permalink to this headline">#</a></h3>
<p>컴퓨터를 잘 활용한다는 것의 컴퓨터의 3 가지 강점 - 기억, 반복, 계산을 잘 활용한다는 뜻입니다. 그 중에서도 인간보다 탁월한 능력이 바로 반복입니다. 컴퓨터는 수만번, 수천번의 반복도 금방 해 치웁니다. 이번에는 그 반복문을 배우겠습니다. 반복문 중에 for ~ in 구분이 가장 많이 활용됩니다. for ~ in 형식에서 in 다음에 List 를 넣으면 List 의 원소를 순서대로 꺼내어 처리합니다. 단순히 출력만 해보겠습니다. 다음에는 제곱한 값을 출력해 보겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">num_list</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>    
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">num_list</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
2
3
4
5
6


1
4
9
16
25
36
</pre></div>
</div>
</div>
</div>
<br>
for 반복문에서 break 와 continue 의 활용법도 배워보겠습니다. i 가 3 일때 for 반복문을 빠져나오고 싶으면 break 를 사용하고, i 가 3 일때는 패스하고, 4 부터 다시 시작하고 싶으면 continue를 사용합니다.<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># break</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">num_list</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># continue</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">num_list</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
4
16
25
36
</pre></div>
</div>
</div>
</div>
</section>
<section id="while-loop">
<h3>While Loop<a class="headerlink" href="#while-loop" title="Permalink to this headline">#</a></h3>
<p>While 반복문도 자주 활용됩니다. While 안의 조건이 만족하는 한, 계속 반복합니다. break 문으로 While Loop 를 빠져나올 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
4
9
16
25
36
49
64
81
100
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span><span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
4
9
16
25
36
49
64
81
100
</pre></div>
</div>
</div>
</div>
</section>
<span id="document-chapter2/2.1.4_Python_Basics"></span><section id="if-condition">
<h3>If Condition<a class="headerlink" href="#if-condition" title="Permalink to this headline">#</a></h3>
<p>파이썬의 조건문 if ~ else 형식으로 다른 컴퓨터 언어와 다르지 않습니다. 단지 else if 부분은 줄여서 elif 로 씁니다. 아래 예제를 보시면 쉽게 이해가 되실 것으로 생각합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;a &gt; b&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;a &lt;= b&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>a &gt; b
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">num_list</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;the number is less than 3&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;The number is greater than 3&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;The number is 3&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1 the number is less than 3
2 the number is less than 3
3 The number is 3
4 The number is greater than 3
5 The number is greater than 3
6 The number is greater than 3
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">num_list</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;the number is less than 3&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># 아무런 처리를 하지 않음</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;The number is 3&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1 the number is less than 3
2 the number is less than 3
3 The number is 3
</pre></div>
</div>
</div>
</div>
</section>
<span id="document-chapter2/2.1.5_Python_Basics"></span><section id="functions">
<h3>Functions<a class="headerlink" href="#functions" title="Permalink to this headline">#</a></h3>
<p>파이썬의 함수는 def 로 시작하고 결과값을 return 으로 반환합니다. 결과값의 반환은 여러 개도 가능합니다. 단, 함수 호출 후 결과 값을 받을 때, 함수가 return 하는 결과 값 갯수가 동일해야 합니다. 함수도 아래 예제를 보시면 쉽게 이해가 되시리라 생각합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
    <span class="k">return</span> <span class="n">z</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">cal</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">y</span>
    <span class="k">return</span> <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span>

<span class="n">result1</span><span class="p">,</span> <span class="n">result2</span> <span class="o">=</span> <span class="n">cal</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result1</span><span class="p">,</span> <span class="n">result2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5 6
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span>  <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="n">y</span><span class="p">)</span>

<span class="n">result1</span><span class="p">,</span> <span class="n">result2</span><span class="p">,</span> <span class="n">result3</span> <span class="o">=</span> <span class="n">cal</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result1</span><span class="p">,</span> <span class="n">result2</span><span class="p">,</span> <span class="n">result3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5 6 8
</pre></div>
</div>
</div>
</div>
</section>
</div>
</section>
<span id="document-chapter2/2.2.0_Useful_Techniques"></span><section id="id1">
<h2><strong>유용한 기능들</strong><a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<p>이번 장에서는 유용한 데이터 핸들링 방법들을 배우겠습니다. 데이터 분석을 통해서 원하는 결과를 얻기 위해서는, 우선 분석이 가능한 형태의 데이터로 가공을 해야합니다.</p>
<div class="toctree-wrapper compound">
<span id="document-chapter2/2.2.1_Useful_Techniques"></span><section id="append">
<h3>Append<a class="headerlink" href="#append" title="Permalink to this headline">#</a></h3>
<p>append 는 반복문에서 발생하는 값을 순차적으로 모으는데 유용합니다. 아래 예제는 반복문에서 추출된 원소를 제곱한 값을 계속 v_list 리스트에 추가하는 코드입니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">v_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">aa</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>

<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">aa</span><span class="p">:</span>
    <span class="n">v_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
<span class="nb">print</span><span class="p">(</span><span class="n">v_list</span><span class="p">)</span>    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 4, 9, 16, 25]
</pre></div>
</div>
</div>
</div>
<br>
아래는 DataFrame 의 'c1' 컬럼을 List로 만들어, 반복을 수행합니다. 'c1' 의 제곱 값을 r_list 에 담은 후, 결과 값을 원래 DataFrame 에 'c3' Column 으로 추가하는 코드입니다.<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">r_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">c1_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">]</span>
<span class="n">c2_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;e&#39;</span><span class="p">]</span>

<span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;c1&#39;</span><span class="p">:</span> <span class="n">c1_list</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">:</span> <span class="n">c2_list</span><span class="p">})</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df1</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">]):</span> <span class="c1"># List 함수가 꼭 필요하지는 않음  df1[&#39;c1&#39;] =&gt; [11,12,13,14,15]</span>
    <span class="n">r_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
<span class="n">df1</span><span class="p">[</span><span class="s1">&#39;c3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_list</span> <span class="c1"># r_list 갯수와 df1 갯수가 동일해야 함</span>

<span class="nb">print</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   c1 c2   c3
0  11  a  121
1  12  b  144
2  13  c  169
3  14  d  196
4  15  e  225
</pre></div>
</div>
</div>
</div>
<br>
아래와 같은 방식으로 처리를 해도 동일한 df1 가 생성됩니다.<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">c1_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">]</span>
<span class="n">c2_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;e&#39;</span><span class="p">]</span>
<span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;c1&#39;</span><span class="p">:</span> <span class="n">c1_list</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">:</span> <span class="n">c2_list</span><span class="p">})</span>

<span class="n">df1</span><span class="p">[</span><span class="s1">&#39;c3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   c1 c2   c3
0  11  a  121
1  12  b  144
2  13  c  169
3  14  d  196
4  15  e  225
</pre></div>
</div>
</div>
</div>
</section>
<span id="document-chapter2/2.2.2_Useful_Techniques"></span><section id="concat-merge">
<h3>Concat 과 Merge<a class="headerlink" href="#concat-merge" title="Permalink to this headline">#</a></h3>
<p>Concat 과 Merge 는 두개 이상의 DataFrame/Series 을 키 값(매칭을 위한 값)으로 합칠 때 쓰는 메소드입니다.</p>
</section>
<section id="concat">
<h3>Concat<a class="headerlink" href="#concat" title="Permalink to this headline">#</a></h3>
<p>먼저 concat 를 해 보겠습니다. concat 는 axis 라는 인수를 사용해서 위-아래로 합할 것인지, 좌-우로 합할 것인지 알려줍니다. 좌-우로 합치는 경우는 index(행) 를 기준으로 하고, 위-아래로 합치는 경우는 column(열) 을 기준으로 합니다. 다른 인수로는 join 이 있습니다. 주로 axis=1 로 병합(좌-우)하는 경우가 많은데요. 양쪽 데이터셋에 동시에 존재하는 index 만으로 합칠 때는 join=’inner’ 를 넣어주고, 모든 index 를 남기고 싶을 때는 join=’outer’ 를 넣어줍니다. 아래 예제에서 Series s1 과 Series s2 의 index 가 동일하므로, ‘inner’ 나 ‘outer’ 로 합쳐도 동일한 결과가 나옵니다. 두개의 데이터셋이 같은 지 체크하는 메소드는 equal 입니다. 체크한 결과 True 를 얻었습니다. 참고로 함수의 ()안에 커서를 놓고, ‘Shift+Tab’ 를 하면 활용 가능한 모든 인수와 설명이 나옵니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">s1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;s1&#39;</span><span class="p">)</span> <span class="c1"># 두 Series를 합친 후, 어느 Series 에서 알기위해 이름 지정</span>
<span class="n">s2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;e&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;s2&#39;</span><span class="p">)</span>

<span class="n">horizontal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># axis=1 이면 index (행) 기준으로 합함. 즉. 좌-우로 합함</span>
<span class="nb">print</span><span class="p">(</span><span class="n">horizontal</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">vertical</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># axis=0 이면 column(열) 기준으로 합함. 즉 위-아래로 합함</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vertical</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">vertical_1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span> <span class="c1"># axis=1 인덱스 기준으로 합함. 양쪽 Series 에 존재하는 모든 index 는 남김</span>
<span class="n">vertical_2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span> <span class="c1"># axis=1 인덱스 기준으로 합함. 양쪽 Series 에 동시에 존재하는 index 만 남김</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vertical_1</span><span class="o">.</span><span class="n">equals</span><span class="p">(</span><span class="n">vertical_2</span><span class="p">))</span> <span class="c1"># 두개의 DataFrame 이 서로 동일한지 체크. 인덱스가 동일하므로 동일 결과가 됨.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   s1 s2
0   1  a
1   2  b
2   3  c
3   4  d
4   5  e


0    1
1    2
2    3
3    4
4    5
0    a
1    b
2    c
3    d
4    e
dtype: object


True
</pre></div>
</div>
</div>
</div>
<p><br> concat 에서 두 Series 의 index 가 다르경우, 원하는 결과가 안 나온다는 것의 유의합니다. 아래 예제에서 index 가 서로 다른 Series 를 합쳐보겠습니다. join=’inner’ 조건에서는 동일한 index 가 없으므로 concat 후 결과가 없습니다. 단지 좌-우로 합치는 것이 목적이라면 기존의 index 를 제거하고 default index 인 숫자를 넣어주고 concat 하면 됩니다. 기존의 index 를 제거할 때는  reset_index(drop=True) 를 합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;e&#39;</span><span class="p">]</span> <span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
<span class="n">s4</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">],</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;h&#39;</span><span class="p">,</span><span class="s1">&#39;i&#39;</span><span class="p">,</span><span class="s1">&#39;j&#39;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;s4&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">s3</span><span class="p">,</span> <span class="n">s4</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">))</span> <span class="c1"># axis=1 이면 인덱스 기준으로 합함. 즉. 좌-우로 합함</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">s3</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">s4</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">))</span> <span class="c1"># axis=1 이면 인덱스 기준으로 합함. 즉. 좌-우로 합함</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Empty DataFrame
Columns: [s3, s4]
Index: []


   s3  s4
0   1  11
1   2  12
2   3  13
3   4  14
4   5  15
</pre></div>
</div>
</div>
</div>
</section>
<section id="merge">
<h3>Merge<a class="headerlink" href="#merge" title="Permalink to this headline">#</a></h3>
<p>Index 가 동일하고, 단순한 병합일 때는 concat 를 쓰지만, 서로 다른 컬럼으로 병합을 할 때는 Merge 를 씁니다.
만약 두 데이터셋이 있고, 고객번호로 서로 Merge 하려고 한다고 합시다. 그런데 한 데이터셋에는 고객번호가 cust_id 로 되어 있고, 다른 데이터셋에는 Cust_Number 로 되어 있으면 concat 를 활용하기 어렵습니다. 이 경우는 merge 를 쓰는 것이 편리합니다. merge 는 넣어야하는 인수가 concat 보다많아, 단순한 병합은 concat 으로 합니다. 먼저 예제 DataFrame 을 생성합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cust_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">]</span>
<span class="n">product_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">]</span>
<span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;cust_id&#39;</span><span class="p">:</span> <span class="n">cust_list</span><span class="p">,</span> <span class="s1">&#39;product&#39;</span><span class="p">:</span> <span class="n">product_list</span><span class="p">})</span>

<span class="n">cust_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">]</span>
<span class="n">grade_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">,</span><span class="s1">&#39;p2&#39;</span><span class="p">,</span><span class="s1">&#39;p3&#39;</span><span class="p">,</span><span class="s1">&#39;p4&#39;</span><span class="p">,</span><span class="s1">&#39;p5&#39;</span><span class="p">,</span><span class="s1">&#39;p6&#39;</span><span class="p">]</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;cust_number&#39;</span><span class="p">:</span> <span class="n">cust_list</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">:</span> <span class="n">grade_list</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">df1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   cust_id product
0       10       a
1       11       b
2       12       c
3       13       d
4       14       e
5       15       f


   cust_number grade
0           12    p1
1           13    p2
2           14    p3
3           15    p4
4           16    p5
5           17    p6
</pre></div>
</div>
</div>
</div>
<br>
Merge 로 데이터셋을 병합하는 방법에는 여러가지가 있습니다. 예제에서는 index 를 기준으로 합치는 방법을 해 보겠습니다. 일단, df1 과 df2 에서 키가 되는 고객번호가 존재합니다. 이 고객번호를 index 로 만드는 법은 아래와 같습니다.<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">df1</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;cust_id&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;cust_number&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        product
cust_id        
10            a
11            b
12            c
13            d
14            e
15            f
            grade
cust_number      
12             p1
13             p2
14             p3
15             p4
16             p5
17             p6
</pre></div>
</div>
</div>
</div>
<br>
다음은 만들어진 index 를 이용하여 두 데이터셋을 병합(merge) 합니다. left_index=True, right_index=True 를 인수로 넣어, index 키로 병합한다는 것을 알려줍니다. 병합하는 방법은 how 인수로 알려줍니다. how='inner' 면 df1, df2 동시에 존재하는 index 만을 남기겠다는 인수입니다. 아래 예제에서 두 번째 방식으로도 가능하나, 제 생각에는 첫 번째가 직관적입니다.
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;cust_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;cust_number&#39;</span><span class="p">),</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>product</th>
      <th>grade</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>12</th>
      <td>c</td>
      <td>p1</td>
    </tr>
    <tr>
      <th>13</th>
      <td>d</td>
      <td>p2</td>
    </tr>
    <tr>
      <th>14</th>
      <td>e</td>
      <td>p3</td>
    </tr>
    <tr>
      <th>15</th>
      <td>f</td>
      <td>p4</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">df1</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;cust_id&#39;</span><span class="p">),</span> <span class="n">right</span><span class="o">=</span><span class="n">df2</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;cust_number&#39;</span><span class="p">),</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>product</th>
      <th>grade</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>12</th>
      <td>c</td>
      <td>p1</td>
    </tr>
    <tr>
      <th>13</th>
      <td>d</td>
      <td>p2</td>
    </tr>
    <tr>
      <th>14</th>
      <td>e</td>
      <td>p3</td>
    </tr>
    <tr>
      <th>15</th>
      <td>f</td>
      <td>p4</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<br>
Index 가 된 고객번호를 다시 DataFrame 으로 가져오고 싶으면, reset_index() 로 index 를 없앤 후, rename 메소드에서 원하는 이름으로 변경해주면 됩니다. 아래 예제와 같이 파이썬에서는 여러가지 데이터처리를 '.' (dot notation) 을 이용하여 한 줄에 처리할 수 있습니다. <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df1</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;cust_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;cust_number&#39;</span><span class="p">),</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="s1">&#39;cust_id&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cust_id</th>
      <th>product</th>
      <th>grade</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>12</td>
      <td>c</td>
      <td>p1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>13</td>
      <td>d</td>
      <td>p2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>14</td>
      <td>e</td>
      <td>p3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>15</td>
      <td>f</td>
      <td>p4</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<span id="document-chapter2/2.2.3_Useful_Techniques"></span><section id="groupby">
<h3>Groupby<a class="headerlink" href="#groupby" title="Permalink to this headline">#</a></h3>
<p>Groupby 는 데이터를 요약할 때 많이 활용하는 기법입니다. 아래 예제에서 만들어진 DataFrame - df 의 ‘grp’ 컬럼을 이용하여 ‘a’, ‘b’, ‘c’ 등의 3 개의 그룹으로 나눌 수 있습니다.
먼저, 그룹을 무시하고 v1, v2 의 평균값을 알아봅니다. 그 다음, 그룹 별로 v1 과 v2 의 평균값을 알아봅니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">g_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>
<span class="n">v1_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="n">v2_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>

<span class="n">df</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;grp&#39;</span><span class="p">:</span> <span class="n">g_list</span><span class="p">,</span> <span class="s1">&#39;v1&#39;</span><span class="p">:</span> <span class="n">v1_list</span><span class="p">,</span> <span class="s1">&#39;v2&#39;</span><span class="p">:</span> <span class="n">v2_list</span><span class="p">})</span> <span class="c1"># 그룹핑을 할 수 있는 컬럼을 가진 DataFrame 생성</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;v1&#39;</span><span class="p">,</span> <span class="s1">&#39;v2&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 전체 평균</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>v1     5.5
v2    15.5
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;grp&#39;</span><span class="p">)[</span><span class="s1">&#39;v1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 그룹별 평균</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>grp
a    2.0
b    5.0
c    8.5
Name: v1, dtype: float64
</pre></div>
</div>
</div>
</div>
<br>
그룹별로 여러개의 통계값도 구할 수 있습니다. v1 의 평균, 최대값, 총합을 알아봅니다.<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;grp&#39;</span><span class="p">)[</span><span class="s1">&#39;v1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">,</span><span class="s1">&#39;sum&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>max</th>
      <th>sum</th>
    </tr>
    <tr>
      <th>grp</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>2.0</td>
      <td>3</td>
      <td>6</td>
    </tr>
    <tr>
      <th>b</th>
      <td>5.0</td>
      <td>6</td>
      <td>15</td>
    </tr>
    <tr>
      <th>c</th>
      <td>8.5</td>
      <td>10</td>
      <td>34</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<br>
그룹별로 v1 과 v2 의 평균, 최대값, 총합을 알아봅니다.<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;grp&#39;</span><span class="p">)[[</span><span class="s1">&#39;v1&#39;</span><span class="p">,</span><span class="s1">&#39;v2&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">,</span><span class="s1">&#39;sum&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="3" halign="left">v1</th>
      <th colspan="3" halign="left">v2</th>
    </tr>
    <tr>
      <th></th>
      <th>mean</th>
      <th>max</th>
      <th>sum</th>
      <th>mean</th>
      <th>max</th>
      <th>sum</th>
    </tr>
    <tr>
      <th>grp</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>2.0</td>
      <td>3</td>
      <td>6</td>
      <td>12.0</td>
      <td>13</td>
      <td>36</td>
    </tr>
    <tr>
      <th>b</th>
      <td>5.0</td>
      <td>6</td>
      <td>15</td>
      <td>15.0</td>
      <td>16</td>
      <td>45</td>
    </tr>
    <tr>
      <th>c</th>
      <td>8.5</td>
      <td>10</td>
      <td>34</td>
      <td>18.5</td>
      <td>20</td>
      <td>74</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<br>
이번에는 그룹별로 v1 은 평균, v2 는 총합을 알아봅니다.<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;v1&#39;</span><span class="p">:</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;v2&#39;</span><span class="p">:</span><span class="s1">&#39;sum&#39;</span><span class="p">}</span>
<span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;grp&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>v1</th>
      <th>v2</th>
    </tr>
    <tr>
      <th>grp</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>2.0</td>
      <td>36</td>
    </tr>
    <tr>
      <th>b</th>
      <td>5.0</td>
      <td>45</td>
    </tr>
    <tr>
      <th>c</th>
      <td>8.5</td>
      <td>74</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<br>
그룹별 최대값에서 최소값을 뺀 값을 알아봅니다. lambda 함수를 이용했습니다. lambda 함수의 자세한 활용법은 다루지 않도록 하겠습니다. Apply 함수를 이용한 경우와 Transform 함수를 이용한 경우의 차이점을 알아야 합니다. Apply 를 이용하면 생성된 그룹의 갯 수 만큼의 행을 리턴합니다. Transform 은 그룹핑하기 전의 데이터 행의 갯 수 만큼을 반환합니다. 그룹별 요약된 정보를 원래 데이터에 추가하고 싶을 때는 Transform 이 사용됩니다.<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;grp&#39;</span><span class="p">)[</span><span class="s1">&#39;v1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>grp
a    1.0
b    1.0
c    1.5
Name: v1, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;grp&#39;</span><span class="p">)[</span><span class="s1">&#39;v1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0    1.0
1    1.0
2    1.0
3    1.0
4    1.0
5    1.0
6    1.5
7    1.5
8    1.5
9    1.5
Name: v1, dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="br-pd-cut-pd-qcut">
<h3><br>pd.cut / pd.qcut<a class="headerlink" href="#br-pd-cut-pd-qcut" title="Permalink to this headline">#</a></h3>
<p>이번에는 그룹핑을 하기 위해 활용되는 pd.qcut() 혹은 pd.cut() 메소드에 대하여 알아보겠습니다. 어떤 변수를 그룹 별로 분석하고 싶습니다. 예를 들어, 섹터가 그룹이라면 groupby(‘섹터’)[‘수익률’].mean() 명령으로 섹터별로 각 섹터에 속하는 종목들의 수익율 평균울 구할 수 있습니다. 하지만 그룹 변수가 없고 연속형 변수를 구간으로 나누어 그룹화하고 싶은 경우 pd.cut() 나 pd.qcut() 을 이용합니다. pd.cut 은 직접 구간을 지정해 그룹을 만들고, pd.qcut 은 분위 수를 이용하여 구간을 만듭니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">Series</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># 십 분위수로 구간 생성</span>
<span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">Series</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">])</span> <span class="c1"># bins 인수를 이용하면  (a1, a2], (a2, a3]로 구간 생성</span>
</pre></div>
</div>
<p>np.arange(100) 을 이용하여 0 부터 99까지 값을 생성한 후 pd.qcut 와 pd.cut 을 사용 해 보겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">a_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">a_list</span><span class="p">})</span> 
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>a</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>10 이하의 숫자와 90 초과의 숫자는 해댱 구간이 없어서 그룹핑이 되지 않았습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rank</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">90</span><span class="p">])</span>
<span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">rank</span><span class="p">)[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;min&#39;</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">,</span><span class="s1">&#39;count&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>min</th>
      <th>max</th>
      <th>count</th>
    </tr>
    <tr>
      <th>a</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>(10, 25]</th>
      <td>11</td>
      <td>25</td>
      <td>15</td>
    </tr>
    <tr>
      <th>(25, 75]</th>
      <td>26</td>
      <td>75</td>
      <td>50</td>
    </tr>
    <tr>
      <th>(75, 90]</th>
      <td>76</td>
      <td>90</td>
      <td>15</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>bins 구간이 모든 값을 포함하도록 하기 위해서는 아래와 같이 bins 를 설정합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rank</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
<span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">rank</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;min&#39;</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">,</span><span class="s1">&#39;count&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }

    .dataframe thead tr:last-of-type th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="3" halign="left">a</th>
    </tr>
    <tr>
      <th></th>
      <th>min</th>
      <th>max</th>
      <th>count</th>
    </tr>
    <tr>
      <th>a</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>(-inf, 10.0]</th>
      <td>0</td>
      <td>10</td>
      <td>11</td>
    </tr>
    <tr>
      <th>(10.0, 25.0]</th>
      <td>11</td>
      <td>25</td>
      <td>15</td>
    </tr>
    <tr>
      <th>(25.0, 75.0]</th>
      <td>26</td>
      <td>75</td>
      <td>50</td>
    </tr>
    <tr>
      <th>(75.0, 90.0]</th>
      <td>76</td>
      <td>90</td>
      <td>15</td>
    </tr>
    <tr>
      <th>(90.0, inf]</th>
      <td>91</td>
      <td>99</td>
      <td>9</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>이번에는 제가 주로 활용하는 pd.qcut 입니다. pd.cut 은 bins 로 구간을 설정해야 하나,
qcut 는 q 인수로 분위수를 이용하여 구간을 만듭니다. 아래 결과를 보시면 q 의 역할을 아실 수 있을 것이라고 생각합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rank</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">rank</span><span class="p">)[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;min&#39;</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">,</span><span class="s1">&#39;count&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>min</th>
      <th>max</th>
      <th>count</th>
    </tr>
    <tr>
      <th>a</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>(-0.001, 9.9]</th>
      <td>0</td>
      <td>9</td>
      <td>10</td>
    </tr>
    <tr>
      <th>(9.9, 19.8]</th>
      <td>10</td>
      <td>19</td>
      <td>10</td>
    </tr>
    <tr>
      <th>(19.8, 29.7]</th>
      <td>20</td>
      <td>29</td>
      <td>10</td>
    </tr>
    <tr>
      <th>(29.7, 39.6]</th>
      <td>30</td>
      <td>39</td>
      <td>10</td>
    </tr>
    <tr>
      <th>(39.6, 49.5]</th>
      <td>40</td>
      <td>49</td>
      <td>10</td>
    </tr>
    <tr>
      <th>(49.5, 59.4]</th>
      <td>50</td>
      <td>59</td>
      <td>10</td>
    </tr>
    <tr>
      <th>(59.4, 69.3]</th>
      <td>60</td>
      <td>69</td>
      <td>10</td>
    </tr>
    <tr>
      <th>(69.3, 79.2]</th>
      <td>70</td>
      <td>79</td>
      <td>10</td>
    </tr>
    <tr>
      <th>(79.2, 89.1]</th>
      <td>80</td>
      <td>89</td>
      <td>10</td>
    </tr>
    <tr>
      <th>(89.1, 99.0]</th>
      <td>90</td>
      <td>99</td>
      <td>10</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rank</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">rank</span><span class="p">)[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;min&#39;</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">,</span><span class="s1">&#39;count&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>min</th>
      <th>max</th>
      <th>count</th>
    </tr>
    <tr>
      <th>a</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>(-0.001, 19.8]</th>
      <td>0</td>
      <td>19</td>
      <td>20</td>
    </tr>
    <tr>
      <th>(19.8, 39.6]</th>
      <td>20</td>
      <td>39</td>
      <td>20</td>
    </tr>
    <tr>
      <th>(39.6, 59.4]</th>
      <td>40</td>
      <td>59</td>
      <td>20</td>
    </tr>
    <tr>
      <th>(59.4, 79.2]</th>
      <td>60</td>
      <td>79</td>
      <td>20</td>
    </tr>
    <tr>
      <th>(79.2, 99.0]</th>
      <td>80</td>
      <td>99</td>
      <td>20</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<span id="document-chapter2/2.2.4_Useful_Techniques"></span><section id="resample">
<h3>Resample<a class="headerlink" href="#resample" title="Permalink to this headline">#</a></h3>
<p>Resample 은 시간데이터를 다른 시간 단위로 변경하고 싶을 때 활용합니다. 예를 들면, 초 단위 데이터를 일단위 혹은 월단위 데이터로 변경 할 수 있습니다. 연습을 위하여 시간 레벨의 데이터가 필요합니다. 시간레벨 데이터는 FinanceDataReader 패키지에서 제공하는 일봉 데이터를 활용하겠습니다. FinanceDataReader 는 이승준님이 금융자료 분석을 하시는 분들을 위하여 만들어 주신 정말 유용한 패키지입니다. 자세한 내용은 아래 링크에 설명이 되어 있습니다.
<a class="reference external" href="https://financedata.github.io/posts/finance-data-reader-users-guide.html">https://financedata.github.io/posts/finance-data-reader-users-guide.html</a> 또한, 이승준님이 Pycon 에서 엑셀에 비하여 파이썬의 장점에 대하여 강연하시는 내용이 유투브에 있습니다. <a class="reference external" href="https://www.youtube.com/watch?v=w7Q_eKN5r-I">https://www.youtube.com/watch?v=w7Q_eKN5r-I</a></p>
</section>
<section id="financedatareader">
<h3>FinanceDataReader<a class="headerlink" href="#financedatareader" title="Permalink to this headline">#</a></h3>
<p>FinanceDataReader 를 import 합니다. DataReader 함수에 종목코드, 시작일, 종료일을 인수로 넣어주면 아래와 같이 일봉데이터를 리턴합니다. 출력해보면 Date 가 index 로 되어 있음을 알 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span>

<span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;005930&#39;</span> <span class="c1"># 삼성전자</span>
<span class="n">stock_data</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2021-01-03&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2021-12-31&#39;</span><span class="p">)</span> 

<span class="n">stock_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span> <span class="c1"># head 메소드는 처음 5 row 만 출력합니다.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_6963e_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >Open</th>
      <th class="col_heading level0 col1" >High</th>
      <th class="col_heading level0 col2" >Low</th>
      <th class="col_heading level0 col3" >Close</th>
      <th class="col_heading level0 col4" >Volume</th>
      <th class="col_heading level0 col5" >Change</th>
    </tr>
    <tr>
      <th class="index_name level0" >Date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_6963e_level0_row0" class="row_heading level0 row0" >2021-01-04 00:00:00</th>
      <td id="T_6963e_row0_col0" class="data row0 col0" >81000</td>
      <td id="T_6963e_row0_col1" class="data row0 col1" >84400</td>
      <td id="T_6963e_row0_col2" class="data row0 col2" >80200</td>
      <td id="T_6963e_row0_col3" class="data row0 col3" >83000</td>
      <td id="T_6963e_row0_col4" class="data row0 col4" >38655276</td>
      <td id="T_6963e_row0_col5" class="data row0 col5" >0.024691</td>
    </tr>
    <tr>
      <th id="T_6963e_level0_row1" class="row_heading level0 row1" >2021-01-05 00:00:00</th>
      <td id="T_6963e_row1_col0" class="data row1 col0" >81600</td>
      <td id="T_6963e_row1_col1" class="data row1 col1" >83900</td>
      <td id="T_6963e_row1_col2" class="data row1 col2" >81600</td>
      <td id="T_6963e_row1_col3" class="data row1 col3" >83900</td>
      <td id="T_6963e_row1_col4" class="data row1 col4" >35335669</td>
      <td id="T_6963e_row1_col5" class="data row1 col5" >0.010843</td>
    </tr>
    <tr>
      <th id="T_6963e_level0_row2" class="row_heading level0 row2" >2021-01-06 00:00:00</th>
      <td id="T_6963e_row2_col0" class="data row2 col0" >83300</td>
      <td id="T_6963e_row2_col1" class="data row2 col1" >84500</td>
      <td id="T_6963e_row2_col2" class="data row2 col2" >82100</td>
      <td id="T_6963e_row2_col3" class="data row2 col3" >82200</td>
      <td id="T_6963e_row2_col4" class="data row2 col4" >42089013</td>
      <td id="T_6963e_row2_col5" class="data row2 col5" >-0.020262</td>
    </tr>
    <tr>
      <th id="T_6963e_level0_row3" class="row_heading level0 row3" >2021-01-07 00:00:00</th>
      <td id="T_6963e_row3_col0" class="data row3 col0" >82800</td>
      <td id="T_6963e_row3_col1" class="data row3 col1" >84200</td>
      <td id="T_6963e_row3_col2" class="data row3 col2" >82700</td>
      <td id="T_6963e_row3_col3" class="data row3 col3" >82900</td>
      <td id="T_6963e_row3_col4" class="data row3 col4" >32644642</td>
      <td id="T_6963e_row3_col5" class="data row3 col5" >0.008516</td>
    </tr>
    <tr>
      <th id="T_6963e_level0_row4" class="row_heading level0 row4" >2021-01-08 00:00:00</th>
      <td id="T_6963e_row4_col0" class="data row4 col0" >83300</td>
      <td id="T_6963e_row4_col1" class="data row4 col1" >90000</td>
      <td id="T_6963e_row4_col2" class="data row4 col2" >83000</td>
      <td id="T_6963e_row4_col3" class="data row4 col3" >88800</td>
      <td id="T_6963e_row4_col4" class="data row4 col4" >59013307</td>
      <td id="T_6963e_row4_col5" class="data row4 col5" >0.071170</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<br>
각 월별 종가의 평균, 최대값, 최소값을 알아봅니다. 월별로 요약하면 index 에는 월의 마지막 날짜가 되는 것을 유의하세요. head 메소드로 출력을 5 열로 제한합니다. pd.options 로 소숫점 이하는 보이지 않도록 합니다. 시간이 index 가 되어 있을 때 resample 이 가능합니다. 
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
<span class="n">stock_data</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span> <span class="c1"># 처음 5개만 출력</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_72789_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >mean</th>
      <th class="col_heading level0 col1" >max</th>
      <th class="col_heading level0 col2" >min</th>
    </tr>
    <tr>
      <th class="index_name level0" >Date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_72789_level0_row0" class="row_heading level0 row0" >2021-01-31 00:00:00</th>
      <td id="T_72789_row0_col0" class="data row0 col0" >86565.000000</td>
      <td id="T_72789_row0_col1" class="data row0 col1" >91000</td>
      <td id="T_72789_row0_col2" class="data row0 col2" >82000</td>
    </tr>
    <tr>
      <th id="T_72789_level0_row1" class="row_heading level0 row1" >2021-02-28 00:00:00</th>
      <td id="T_72789_row1_col0" class="data row1 col0" >83127.777778</td>
      <td id="T_72789_row1_col1" class="data row1 col1" >85300</td>
      <td id="T_72789_row1_col2" class="data row1 col2" >81600</td>
    </tr>
    <tr>
      <th id="T_72789_level0_row2" class="row_heading level0 row2" >2021-03-31 00:00:00</th>
      <td id="T_72789_row2_col0" class="data row2 col0" >82072.727273</td>
      <td id="T_72789_row2_col1" class="data row2 col1" >84000</td>
      <td id="T_72789_row2_col2" class="data row2 col2" >80900</td>
    </tr>
    <tr>
      <th id="T_72789_level0_row3" class="row_heading level0 row3" >2021-04-30 00:00:00</th>
      <td id="T_72789_row3_col0" class="data row3 col0" >83586.363636</td>
      <td id="T_72789_row3_col1" class="data row3 col1" >86000</td>
      <td id="T_72789_row3_col2" class="data row3 col2" >81500</td>
    </tr>
    <tr>
      <th id="T_72789_level0_row4" class="row_heading level0 row4" >2021-05-31 00:00:00</th>
      <td id="T_72789_row4_col0" class="data row4 col0" >80521.052632</td>
      <td id="T_72789_row4_col1" class="data row4 col1" >83200</td>
      <td id="T_72789_row4_col2" class="data row4 col2" >78500</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>주별로 요약할 수 도 있습니다. 이번에는 resample(‘W’) 라고 해 줍니다. Resample 이 정말 유용한 기능이라는 것을 직감하셨을 것으로 생각합니다. 역시 한 주(월요일 ~ 일요일)의 마지막날이 Index 로 들어가 있습니다. 디폴트는 일요일입니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
<span class="n">stock_data</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;W&#39;</span><span class="p">)[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_23904_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >mean</th>
      <th class="col_heading level0 col1" >max</th>
      <th class="col_heading level0 col2" >min</th>
    </tr>
    <tr>
      <th class="index_name level0" >Date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_23904_level0_row0" class="row_heading level0 row0" >2021-01-10 00:00:00</th>
      <td id="T_23904_row0_col0" class="data row0 col0" >84160.000000</td>
      <td id="T_23904_row0_col1" class="data row0 col1" >88800</td>
      <td id="T_23904_row0_col2" class="data row0 col2" >82200</td>
    </tr>
    <tr>
      <th id="T_23904_level0_row1" class="row_heading level0 row1" >2021-01-17 00:00:00</th>
      <td id="T_23904_row1_col0" class="data row1 col0" >89800.000000</td>
      <td id="T_23904_row1_col1" class="data row1 col1" >91000</td>
      <td id="T_23904_row1_col2" class="data row1 col2" >88000</td>
    </tr>
    <tr>
      <th id="T_23904_level0_row2" class="row_heading level0 row2" >2021-01-24 00:00:00</th>
      <td id="T_23904_row2_col0" class="data row2 col0" >86820.000000</td>
      <td id="T_23904_row2_col1" class="data row2 col1" >88100</td>
      <td id="T_23904_row2_col2" class="data row2 col2" >85000</td>
    </tr>
    <tr>
      <th id="T_23904_level0_row3" class="row_heading level0 row3" >2021-01-31 00:00:00</th>
      <td id="T_23904_row3_col0" class="data row3 col0" >85480.000000</td>
      <td id="T_23904_row3_col1" class="data row3 col1" >89400</td>
      <td id="T_23904_row3_col2" class="data row3 col2" >82000</td>
    </tr>
    <tr>
      <th id="T_23904_level0_row4" class="row_heading level0 row4" >2021-02-07 00:00:00</th>
      <td id="T_23904_row4_col0" class="data row4 col0" >83600.000000</td>
      <td id="T_23904_row4_col1" class="data row4 col1" >84600</td>
      <td id="T_23904_row4_col2" class="data row4 col2" >82500</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<span id="document-chapter2/2.2.5_Useful_Techniques"></span><section id="pickle">
<h3>Pickle<a class="headerlink" href="#pickle" title="Permalink to this headline">#</a></h3>
<p>Pickle 은 사전적으로 절여서 저장해 놓는다는 말인데요. 파이썬에서 데이터를 저장해 놓을 때 쓰는 패키지입니다. 파이썬 언어로 만들어진 데이터는 RAM 메모리에 존재합니다. 따라서, 컴퓨터가 꺼지면 자동으로 데이터가 사라지게 됩니다. 그래서, 저는 pickle 를 이용해서 데이터 작업 중간에 데이터를 저장합니다. 파이썬 DataFrame 의 저장은 csv, excel, json 등 다양한 형식으로 저장할 수 있으나, 파이썬의 데이터 타입을 손상시키지 않고, 원형대로 저장하고 불러올 수 있는 pickle 이 제일 편리합니다. 삼성전자 일봉데이터를 가져와서 피클로 저장해 보겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span> 

<span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;005930&#39;</span> <span class="c1"># 삼성전자</span>
<span class="n">stock_data</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2021-01-03&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2021-12-31&#39;</span><span class="p">)</span> 

<span class="n">stock_data</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;stock_data.pkl&#39;</span><span class="p">)</span> <span class="c1"># 디렉토리를 지정하지 않으면 현재 작업 폴더에 저장이 됩니다.</span>
</pre></div>
</div>
</div>
</div>
<br>
이번에는 저장된 pickle 파일을 불러와 출력해 보겠습니다. read_pickle 을 이용하면 데이터가 손상되지 않고, 원형 그대로 복원되었음을 알 수 있습니다.<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">stock_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;stock_data.pkl&#39;</span><span class="p">)</span>
<span class="n">stock_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_70d70_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >Open</th>
      <th class="col_heading level0 col1" >High</th>
      <th class="col_heading level0 col2" >Low</th>
      <th class="col_heading level0 col3" >Close</th>
      <th class="col_heading level0 col4" >Volume</th>
      <th class="col_heading level0 col5" >Change</th>
    </tr>
    <tr>
      <th class="index_name level0" >Date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_70d70_level0_row0" class="row_heading level0 row0" >2021-01-04 00:00:00</th>
      <td id="T_70d70_row0_col0" class="data row0 col0" >81000</td>
      <td id="T_70d70_row0_col1" class="data row0 col1" >84400</td>
      <td id="T_70d70_row0_col2" class="data row0 col2" >80200</td>
      <td id="T_70d70_row0_col3" class="data row0 col3" >83000</td>
      <td id="T_70d70_row0_col4" class="data row0 col4" >38655276</td>
      <td id="T_70d70_row0_col5" class="data row0 col5" >0.024691</td>
    </tr>
    <tr>
      <th id="T_70d70_level0_row1" class="row_heading level0 row1" >2021-01-05 00:00:00</th>
      <td id="T_70d70_row1_col0" class="data row1 col0" >81600</td>
      <td id="T_70d70_row1_col1" class="data row1 col1" >83900</td>
      <td id="T_70d70_row1_col2" class="data row1 col2" >81600</td>
      <td id="T_70d70_row1_col3" class="data row1 col3" >83900</td>
      <td id="T_70d70_row1_col4" class="data row1 col4" >35335669</td>
      <td id="T_70d70_row1_col5" class="data row1 col5" >0.010843</td>
    </tr>
    <tr>
      <th id="T_70d70_level0_row2" class="row_heading level0 row2" >2021-01-06 00:00:00</th>
      <td id="T_70d70_row2_col0" class="data row2 col0" >83300</td>
      <td id="T_70d70_row2_col1" class="data row2 col1" >84500</td>
      <td id="T_70d70_row2_col2" class="data row2 col2" >82100</td>
      <td id="T_70d70_row2_col3" class="data row2 col3" >82200</td>
      <td id="T_70d70_row2_col4" class="data row2 col4" >42089013</td>
      <td id="T_70d70_row2_col5" class="data row2 col5" >-0.020262</td>
    </tr>
    <tr>
      <th id="T_70d70_level0_row3" class="row_heading level0 row3" >2021-01-07 00:00:00</th>
      <td id="T_70d70_row3_col0" class="data row3 col0" >82800</td>
      <td id="T_70d70_row3_col1" class="data row3 col1" >84200</td>
      <td id="T_70d70_row3_col2" class="data row3 col2" >82700</td>
      <td id="T_70d70_row3_col3" class="data row3 col3" >82900</td>
      <td id="T_70d70_row3_col4" class="data row3 col4" >32644642</td>
      <td id="T_70d70_row3_col5" class="data row3 col5" >0.008516</td>
    </tr>
    <tr>
      <th id="T_70d70_level0_row4" class="row_heading level0 row4" >2021-01-08 00:00:00</th>
      <td id="T_70d70_row4_col0" class="data row4 col0" >83300</td>
      <td id="T_70d70_row4_col1" class="data row4 col1" >90000</td>
      <td id="T_70d70_row4_col2" class="data row4 col2" >83000</td>
      <td id="T_70d70_row4_col3" class="data row4 col3" >88800</td>
      <td id="T_70d70_row4_col4" class="data row4 col4" >59013307</td>
      <td id="T_70d70_row4_col5" class="data row4 col5" >0.071170</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<br>
pickle 모듈을 이용하여 binary 파일로 저장하는 것도 가능합니다. 특히 pickle 모듈로 파일을 저장하고 읽을 때는 저장하는 환경의 Pandas 버전과 읽는 환경의 Pandas 버전이 동일해야 에러가 발생하지 않습니다. <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;stock_data.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>    <span class="c1"># Binary 파일로 저징</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">stock_data</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;stock_data.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>    <span class="c1"># 저장된 binary 파일 읽기</span>
    <span class="n">stock_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stock_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_76568_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >Open</th>
      <th class="col_heading level0 col1" >High</th>
      <th class="col_heading level0 col2" >Low</th>
      <th class="col_heading level0 col3" >Close</th>
      <th class="col_heading level0 col4" >Volume</th>
      <th class="col_heading level0 col5" >Change</th>
    </tr>
    <tr>
      <th class="index_name level0" >Date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_76568_level0_row0" class="row_heading level0 row0" >2021-01-04 00:00:00</th>
      <td id="T_76568_row0_col0" class="data row0 col0" >81000</td>
      <td id="T_76568_row0_col1" class="data row0 col1" >84400</td>
      <td id="T_76568_row0_col2" class="data row0 col2" >80200</td>
      <td id="T_76568_row0_col3" class="data row0 col3" >83000</td>
      <td id="T_76568_row0_col4" class="data row0 col4" >38655276</td>
      <td id="T_76568_row0_col5" class="data row0 col5" >0.024691</td>
    </tr>
    <tr>
      <th id="T_76568_level0_row1" class="row_heading level0 row1" >2021-01-05 00:00:00</th>
      <td id="T_76568_row1_col0" class="data row1 col0" >81600</td>
      <td id="T_76568_row1_col1" class="data row1 col1" >83900</td>
      <td id="T_76568_row1_col2" class="data row1 col2" >81600</td>
      <td id="T_76568_row1_col3" class="data row1 col3" >83900</td>
      <td id="T_76568_row1_col4" class="data row1 col4" >35335669</td>
      <td id="T_76568_row1_col5" class="data row1 col5" >0.010843</td>
    </tr>
    <tr>
      <th id="T_76568_level0_row2" class="row_heading level0 row2" >2021-01-06 00:00:00</th>
      <td id="T_76568_row2_col0" class="data row2 col0" >83300</td>
      <td id="T_76568_row2_col1" class="data row2 col1" >84500</td>
      <td id="T_76568_row2_col2" class="data row2 col2" >82100</td>
      <td id="T_76568_row2_col3" class="data row2 col3" >82200</td>
      <td id="T_76568_row2_col4" class="data row2 col4" >42089013</td>
      <td id="T_76568_row2_col5" class="data row2 col5" >-0.020262</td>
    </tr>
    <tr>
      <th id="T_76568_level0_row3" class="row_heading level0 row3" >2021-01-07 00:00:00</th>
      <td id="T_76568_row3_col0" class="data row3 col0" >82800</td>
      <td id="T_76568_row3_col1" class="data row3 col1" >84200</td>
      <td id="T_76568_row3_col2" class="data row3 col2" >82700</td>
      <td id="T_76568_row3_col3" class="data row3 col3" >82900</td>
      <td id="T_76568_row3_col4" class="data row3 col4" >32644642</td>
      <td id="T_76568_row3_col5" class="data row3 col5" >0.008516</td>
    </tr>
    <tr>
      <th id="T_76568_level0_row4" class="row_heading level0 row4" >2021-01-08 00:00:00</th>
      <td id="T_76568_row4_col0" class="data row4 col0" >83300</td>
      <td id="T_76568_row4_col1" class="data row4 col1" >90000</td>
      <td id="T_76568_row4_col2" class="data row4 col2" >83000</td>
      <td id="T_76568_row4_col3" class="data row4 col3" >88800</td>
      <td id="T_76568_row4_col4" class="data row4 col4" >59013307</td>
      <td id="T_76568_row4_col5" class="data row4 col5" >0.071170</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<span id="document-chapter2/2.2.6_Useful_Techniques"></span><section id="shift">
<h3>Shift<a class="headerlink" href="#shift" title="Permalink to this headline">#</a></h3>
<p>Shift 은 이전 row 나 이후 row 에 있는 값을 가져올 수 있는 메소드입니다. 일단 삼성전자 일봉을 가져오겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span> 

<span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;005930&#39;</span> <span class="c1"># 삼성전자</span>
<span class="n">stock_data</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2021-01-03&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2021-12-31&#39;</span><span class="p">)</span> 

<span class="n">stock_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_4a764_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >Open</th>
      <th class="col_heading level0 col1" >High</th>
      <th class="col_heading level0 col2" >Low</th>
      <th class="col_heading level0 col3" >Close</th>
      <th class="col_heading level0 col4" >Volume</th>
      <th class="col_heading level0 col5" >Change</th>
    </tr>
    <tr>
      <th class="index_name level0" >Date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_4a764_level0_row0" class="row_heading level0 row0" >2021-01-04 00:00:00</th>
      <td id="T_4a764_row0_col0" class="data row0 col0" >81000</td>
      <td id="T_4a764_row0_col1" class="data row0 col1" >84400</td>
      <td id="T_4a764_row0_col2" class="data row0 col2" >80200</td>
      <td id="T_4a764_row0_col3" class="data row0 col3" >83000</td>
      <td id="T_4a764_row0_col4" class="data row0 col4" >38655276</td>
      <td id="T_4a764_row0_col5" class="data row0 col5" >0.024691</td>
    </tr>
    <tr>
      <th id="T_4a764_level0_row1" class="row_heading level0 row1" >2021-01-05 00:00:00</th>
      <td id="T_4a764_row1_col0" class="data row1 col0" >81600</td>
      <td id="T_4a764_row1_col1" class="data row1 col1" >83900</td>
      <td id="T_4a764_row1_col2" class="data row1 col2" >81600</td>
      <td id="T_4a764_row1_col3" class="data row1 col3" >83900</td>
      <td id="T_4a764_row1_col4" class="data row1 col4" >35335669</td>
      <td id="T_4a764_row1_col5" class="data row1 col5" >0.010843</td>
    </tr>
    <tr>
      <th id="T_4a764_level0_row2" class="row_heading level0 row2" >2021-01-06 00:00:00</th>
      <td id="T_4a764_row2_col0" class="data row2 col0" >83300</td>
      <td id="T_4a764_row2_col1" class="data row2 col1" >84500</td>
      <td id="T_4a764_row2_col2" class="data row2 col2" >82100</td>
      <td id="T_4a764_row2_col3" class="data row2 col3" >82200</td>
      <td id="T_4a764_row2_col4" class="data row2 col4" >42089013</td>
      <td id="T_4a764_row2_col5" class="data row2 col5" >-0.020262</td>
    </tr>
    <tr>
      <th id="T_4a764_level0_row3" class="row_heading level0 row3" >2021-01-07 00:00:00</th>
      <td id="T_4a764_row3_col0" class="data row3 col0" >82800</td>
      <td id="T_4a764_row3_col1" class="data row3 col1" >84200</td>
      <td id="T_4a764_row3_col2" class="data row3 col2" >82700</td>
      <td id="T_4a764_row3_col3" class="data row3 col3" >82900</td>
      <td id="T_4a764_row3_col4" class="data row3 col4" >32644642</td>
      <td id="T_4a764_row3_col5" class="data row3 col5" >0.008516</td>
    </tr>
    <tr>
      <th id="T_4a764_level0_row4" class="row_heading level0 row4" >2021-01-08 00:00:00</th>
      <td id="T_4a764_row4_col0" class="data row4 col0" >83300</td>
      <td id="T_4a764_row4_col1" class="data row4 col1" >90000</td>
      <td id="T_4a764_row4_col2" class="data row4 col2" >83000</td>
      <td id="T_4a764_row4_col3" class="data row4 col3" >88800</td>
      <td id="T_4a764_row4_col4" class="data row4 col4" >59013307</td>
      <td id="T_4a764_row4_col5" class="data row4 col5" >0.071170</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<br>
일봉 데이터에서 전날의 종가를 당일로 가져와 보겠습니다. 아래 예제를 보시면 2021년 1월 5일 'Previous Close' 컬럼에 1월 4일 종가가 들어가 있습니다. 1월 4일은 전날이 없어서 NaN (값없음) 처리 되었습니다. <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Previous Close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">stock_data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_d9d39_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >Open</th>
      <th class="col_heading level0 col1" >High</th>
      <th class="col_heading level0 col2" >Low</th>
      <th class="col_heading level0 col3" >Close</th>
      <th class="col_heading level0 col4" >Volume</th>
      <th class="col_heading level0 col5" >Change</th>
      <th class="col_heading level0 col6" >Previous Close</th>
    </tr>
    <tr>
      <th class="index_name level0" >Date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_d9d39_level0_row0" class="row_heading level0 row0" >2021-01-04 00:00:00</th>
      <td id="T_d9d39_row0_col0" class="data row0 col0" >81000</td>
      <td id="T_d9d39_row0_col1" class="data row0 col1" >84400</td>
      <td id="T_d9d39_row0_col2" class="data row0 col2" >80200</td>
      <td id="T_d9d39_row0_col3" class="data row0 col3" >83000</td>
      <td id="T_d9d39_row0_col4" class="data row0 col4" >38655276</td>
      <td id="T_d9d39_row0_col5" class="data row0 col5" >0.024691</td>
      <td id="T_d9d39_row0_col6" class="data row0 col6" >nan</td>
    </tr>
    <tr>
      <th id="T_d9d39_level0_row1" class="row_heading level0 row1" >2021-01-05 00:00:00</th>
      <td id="T_d9d39_row1_col0" class="data row1 col0" >81600</td>
      <td id="T_d9d39_row1_col1" class="data row1 col1" >83900</td>
      <td id="T_d9d39_row1_col2" class="data row1 col2" >81600</td>
      <td id="T_d9d39_row1_col3" class="data row1 col3" >83900</td>
      <td id="T_d9d39_row1_col4" class="data row1 col4" >35335669</td>
      <td id="T_d9d39_row1_col5" class="data row1 col5" >0.010843</td>
      <td id="T_d9d39_row1_col6" class="data row1 col6" >83000.000000</td>
    </tr>
    <tr>
      <th id="T_d9d39_level0_row2" class="row_heading level0 row2" >2021-01-06 00:00:00</th>
      <td id="T_d9d39_row2_col0" class="data row2 col0" >83300</td>
      <td id="T_d9d39_row2_col1" class="data row2 col1" >84500</td>
      <td id="T_d9d39_row2_col2" class="data row2 col2" >82100</td>
      <td id="T_d9d39_row2_col3" class="data row2 col3" >82200</td>
      <td id="T_d9d39_row2_col4" class="data row2 col4" >42089013</td>
      <td id="T_d9d39_row2_col5" class="data row2 col5" >-0.020262</td>
      <td id="T_d9d39_row2_col6" class="data row2 col6" >83900.000000</td>
    </tr>
    <tr>
      <th id="T_d9d39_level0_row3" class="row_heading level0 row3" >2021-01-07 00:00:00</th>
      <td id="T_d9d39_row3_col0" class="data row3 col0" >82800</td>
      <td id="T_d9d39_row3_col1" class="data row3 col1" >84200</td>
      <td id="T_d9d39_row3_col2" class="data row3 col2" >82700</td>
      <td id="T_d9d39_row3_col3" class="data row3 col3" >82900</td>
      <td id="T_d9d39_row3_col4" class="data row3 col4" >32644642</td>
      <td id="T_d9d39_row3_col5" class="data row3 col5" >0.008516</td>
      <td id="T_d9d39_row3_col6" class="data row3 col6" >82200.000000</td>
    </tr>
    <tr>
      <th id="T_d9d39_level0_row4" class="row_heading level0 row4" >2021-01-08 00:00:00</th>
      <td id="T_d9d39_row4_col0" class="data row4 col0" >83300</td>
      <td id="T_d9d39_row4_col1" class="data row4 col1" >90000</td>
      <td id="T_d9d39_row4_col2" class="data row4 col2" >83000</td>
      <td id="T_d9d39_row4_col3" class="data row4 col3" >88800</td>
      <td id="T_d9d39_row4_col4" class="data row4 col4" >59013307</td>
      <td id="T_d9d39_row4_col5" class="data row4 col5" >0.071170</td>
      <td id="T_d9d39_row4_col6" class="data row4 col6" >82900.000000</td>
    </tr>
    <tr>
      <th id="T_d9d39_level0_row5" class="row_heading level0 row5" >2021-01-11 00:00:00</th>
      <td id="T_d9d39_row5_col0" class="data row5 col0" >90000</td>
      <td id="T_d9d39_row5_col1" class="data row5 col1" >96800</td>
      <td id="T_d9d39_row5_col2" class="data row5 col2" >89500</td>
      <td id="T_d9d39_row5_col3" class="data row5 col3" >91000</td>
      <td id="T_d9d39_row5_col4" class="data row5 col4" >90306177</td>
      <td id="T_d9d39_row5_col5" class="data row5 col5" >0.024775</td>
      <td id="T_d9d39_row5_col6" class="data row5 col6" >88800.000000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<br>
이제 아주 단순한 전략을 구현해 보겠습니다. 구현해 볼 단순 전략은 '전날 종가보다 오늘 종가가 높으면 내일 시가에 매수하고 내일 종가에 매도' 입니다. 결과가 어떨지 정말 궁금합니다. 이 전략을 구현하면 수익율이 어떻게 될 지 테스트 해보겠습니다. 먼저 전날 종가보다 오늘 종가가 높은 날을 찾아야 합니다. 전날 종가는 이미 만들어서 'Previous Close' 컬럼에 저장해 두었습니다. 오늘 종가와 전날 종가를 비교한 후, True 이면 1 되도록 하겠습니다. 조건 (stock_data['Close'] > stock_data['Previous Close']) 는 True/False 를 반환합니다. 그래서, astype(int) 를 이용해서 정수로 변환합니다.
<p>그 다음 수익율 데이터를 만들어 보겠습니다. 내일의 시가는 stock_data[‘Open’].shift(-1), 내일의 종가는 stock_data[‘Close’].shift(-1) 로 가져오면 됩니다. 결과를 컬럼 ‘return’ 에 넣겠습니다. shift(1) 는 전날의 정보를 shift(-1) 은 다음날의 데이터를 가져옵니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Previous Close&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 매수 시그널 생성</span>
<span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 전략의 수익율</span>
<span class="n">stock_data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_b58b8_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >Open</th>
      <th class="col_heading level0 col1" >High</th>
      <th class="col_heading level0 col2" >Low</th>
      <th class="col_heading level0 col3" >Close</th>
      <th class="col_heading level0 col4" >Volume</th>
      <th class="col_heading level0 col5" >Change</th>
      <th class="col_heading level0 col6" >Previous Close</th>
      <th class="col_heading level0 col7" >buy</th>
      <th class="col_heading level0 col8" >return</th>
    </tr>
    <tr>
      <th class="index_name level0" >Date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
      <th class="blank col7" >&nbsp;</th>
      <th class="blank col8" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_b58b8_level0_row0" class="row_heading level0 row0" >2021-01-04 00:00:00</th>
      <td id="T_b58b8_row0_col0" class="data row0 col0" >81000</td>
      <td id="T_b58b8_row0_col1" class="data row0 col1" >84400</td>
      <td id="T_b58b8_row0_col2" class="data row0 col2" >80200</td>
      <td id="T_b58b8_row0_col3" class="data row0 col3" >83000</td>
      <td id="T_b58b8_row0_col4" class="data row0 col4" >38655276</td>
      <td id="T_b58b8_row0_col5" class="data row0 col5" >0.024691</td>
      <td id="T_b58b8_row0_col6" class="data row0 col6" >nan</td>
      <td id="T_b58b8_row0_col7" class="data row0 col7" >0</td>
      <td id="T_b58b8_row0_col8" class="data row0 col8" >1.028186</td>
    </tr>
    <tr>
      <th id="T_b58b8_level0_row1" class="row_heading level0 row1" >2021-01-05 00:00:00</th>
      <td id="T_b58b8_row1_col0" class="data row1 col0" >81600</td>
      <td id="T_b58b8_row1_col1" class="data row1 col1" >83900</td>
      <td id="T_b58b8_row1_col2" class="data row1 col2" >81600</td>
      <td id="T_b58b8_row1_col3" class="data row1 col3" >83900</td>
      <td id="T_b58b8_row1_col4" class="data row1 col4" >35335669</td>
      <td id="T_b58b8_row1_col5" class="data row1 col5" >0.010843</td>
      <td id="T_b58b8_row1_col6" class="data row1 col6" >83000.000000</td>
      <td id="T_b58b8_row1_col7" class="data row1 col7" >1</td>
      <td id="T_b58b8_row1_col8" class="data row1 col8" >0.986795</td>
    </tr>
    <tr>
      <th id="T_b58b8_level0_row2" class="row_heading level0 row2" >2021-01-06 00:00:00</th>
      <td id="T_b58b8_row2_col0" class="data row2 col0" >83300</td>
      <td id="T_b58b8_row2_col1" class="data row2 col1" >84500</td>
      <td id="T_b58b8_row2_col2" class="data row2 col2" >82100</td>
      <td id="T_b58b8_row2_col3" class="data row2 col3" >82200</td>
      <td id="T_b58b8_row2_col4" class="data row2 col4" >42089013</td>
      <td id="T_b58b8_row2_col5" class="data row2 col5" >-0.020262</td>
      <td id="T_b58b8_row2_col6" class="data row2 col6" >83900.000000</td>
      <td id="T_b58b8_row2_col7" class="data row2 col7" >0</td>
      <td id="T_b58b8_row2_col8" class="data row2 col8" >1.001208</td>
    </tr>
    <tr>
      <th id="T_b58b8_level0_row3" class="row_heading level0 row3" >2021-01-07 00:00:00</th>
      <td id="T_b58b8_row3_col0" class="data row3 col0" >82800</td>
      <td id="T_b58b8_row3_col1" class="data row3 col1" >84200</td>
      <td id="T_b58b8_row3_col2" class="data row3 col2" >82700</td>
      <td id="T_b58b8_row3_col3" class="data row3 col3" >82900</td>
      <td id="T_b58b8_row3_col4" class="data row3 col4" >32644642</td>
      <td id="T_b58b8_row3_col5" class="data row3 col5" >0.008516</td>
      <td id="T_b58b8_row3_col6" class="data row3 col6" >82200.000000</td>
      <td id="T_b58b8_row3_col7" class="data row3 col7" >1</td>
      <td id="T_b58b8_row3_col8" class="data row3 col8" >1.066026</td>
    </tr>
    <tr>
      <th id="T_b58b8_level0_row4" class="row_heading level0 row4" >2021-01-08 00:00:00</th>
      <td id="T_b58b8_row4_col0" class="data row4 col0" >83300</td>
      <td id="T_b58b8_row4_col1" class="data row4 col1" >90000</td>
      <td id="T_b58b8_row4_col2" class="data row4 col2" >83000</td>
      <td id="T_b58b8_row4_col3" class="data row4 col3" >88800</td>
      <td id="T_b58b8_row4_col4" class="data row4 col4" >59013307</td>
      <td id="T_b58b8_row4_col5" class="data row4 col5" >0.071170</td>
      <td id="T_b58b8_row4_col6" class="data row4 col6" >82900.000000</td>
      <td id="T_b58b8_row4_col7" class="data row4 col7" >1</td>
      <td id="T_b58b8_row4_col8" class="data row4 col8" >1.011111</td>
    </tr>
    <tr>
      <th id="T_b58b8_level0_row5" class="row_heading level0 row5" >2021-01-11 00:00:00</th>
      <td id="T_b58b8_row5_col0" class="data row5 col0" >90000</td>
      <td id="T_b58b8_row5_col1" class="data row5 col1" >96800</td>
      <td id="T_b58b8_row5_col2" class="data row5 col2" >89500</td>
      <td id="T_b58b8_row5_col3" class="data row5 col3" >91000</td>
      <td id="T_b58b8_row5_col4" class="data row5 col4" >90306177</td>
      <td id="T_b58b8_row5_col5" class="data row5 col5" >0.024775</td>
      <td id="T_b58b8_row5_col6" class="data row5 col6" >88800.000000</td>
      <td id="T_b58b8_row5_col7" class="data row5 col7" >1</td>
      <td id="T_b58b8_row5_col8" class="data row5 col8" >1.003322</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<br>
이제 buy 시그널이 1 인 날의 수익율과 0 인 날의 수익율을 groupby 을 이용해서 비교해보겠습니다. 결과가 실망입니다. 좋은 전략이 아닌 것 같습니다. 100 원을 투자했으면 평균 기대수익율이 99.8 원입니다. 여기서 평균 수익율은 buy 가 1 인 날 중 랜덤한 날에 투자했을 때 기대할 수 있는 수익율이 0.998 (0.2% 손실) 이라는 의미입니다.  describe 메소드로 수익율의 분포도 확인해 보겠습니다. buy 가 1 인 날(매수)은 0 인 날에 비하여 평균도 낮고, 변동성(std) 이 더 큽니다. 차라리 전날 종가보다 오늘 종가가 높을 때 매수하는 것이 더 좋을 것 같습니다. <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>

<span class="n">stock_data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># NaN(값 없음) 열 전부 제거</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stock_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;buy&#39;</span><span class="p">)[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="c1"># 평균 비교</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stock_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;buy&#39;</span><span class="p">)[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span> <span class="c1"># 분포 비교</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>buy
0   0.999
1   0.998
Name: return, dtype: float64


      count  mean   std   min   25%   50%   75%   max
buy                                                  
0   136.000 0.999 0.011 0.970 0.992 1.000 1.005 1.033
1   110.000 0.998 0.013 0.975 0.990 0.997 1.004 1.066
</pre></div>
</div>
</div>
</div>
<br>
위에서 구현한 단순 전략은 손실을 보는 전략입니다. 이번에는 만약 우리가 100 원을 투자했으면 110 영업일 이후에 얼마나 손해를 보는 지 확인 해 보겠습니다. 위 describe 결과에서 buy 가 1 인 날은 110일 입니다. 이번에 쓸 메소드는 prod 입니
다. prod 는 값을 다 곱하라는 뜻입니다. 만약 당일 수익율이 0.9 이고 다음날 1.1 이면, 최종 수익율은 0.99 (=0.9 x 1.1) 가 됩니다. 아래 결과에서와 같이 단순 전략으로 2021년 초에 삼성전자에 100원을 투자하면 110 일 이후인 2021년 연말에는 잔고가 81.1 원이 됩니다. 약 19% 의 손실이 발생했습니다.<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">stock_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;buy&#39;</span><span class="p">)[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prod</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>buy
0   0.843
1   0.811
Name: return, dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<span id="document-chapter2/2.2.7_Useful_Techniques"></span><section id="rolling">
<h3>Rolling<a class="headerlink" href="#rolling" title="Permalink to this headline">#</a></h3>
<p>주식을 하신 분들은 이동평균선에 대하여 많이 들어보셨을 것이라고 생각합니다. rolling 은 이동평균선을 간단하게 만들어줄 수 있는 메소드입니다. 예제를 보시면 금방 이해가 되 실 것이라고 생각합니다. 일단 삼성전자 일봉을 가져오겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span> 

<span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;005930&#39;</span> <span class="c1"># 삼성전자</span>
<span class="n">stock_data</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2021-01-03&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2021-12-31&#39;</span><span class="p">)</span> 

<span class="n">stock_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_7d30b_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >Open</th>
      <th class="col_heading level0 col1" >High</th>
      <th class="col_heading level0 col2" >Low</th>
      <th class="col_heading level0 col3" >Close</th>
      <th class="col_heading level0 col4" >Volume</th>
      <th class="col_heading level0 col5" >Change</th>
    </tr>
    <tr>
      <th class="index_name level0" >Date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_7d30b_level0_row0" class="row_heading level0 row0" >2021-01-04 00:00:00</th>
      <td id="T_7d30b_row0_col0" class="data row0 col0" >81000</td>
      <td id="T_7d30b_row0_col1" class="data row0 col1" >84400</td>
      <td id="T_7d30b_row0_col2" class="data row0 col2" >80200</td>
      <td id="T_7d30b_row0_col3" class="data row0 col3" >83000</td>
      <td id="T_7d30b_row0_col4" class="data row0 col4" >38655276</td>
      <td id="T_7d30b_row0_col5" class="data row0 col5" >0.024691</td>
    </tr>
    <tr>
      <th id="T_7d30b_level0_row1" class="row_heading level0 row1" >2021-01-05 00:00:00</th>
      <td id="T_7d30b_row1_col0" class="data row1 col0" >81600</td>
      <td id="T_7d30b_row1_col1" class="data row1 col1" >83900</td>
      <td id="T_7d30b_row1_col2" class="data row1 col2" >81600</td>
      <td id="T_7d30b_row1_col3" class="data row1 col3" >83900</td>
      <td id="T_7d30b_row1_col4" class="data row1 col4" >35335669</td>
      <td id="T_7d30b_row1_col5" class="data row1 col5" >0.010843</td>
    </tr>
    <tr>
      <th id="T_7d30b_level0_row2" class="row_heading level0 row2" >2021-01-06 00:00:00</th>
      <td id="T_7d30b_row2_col0" class="data row2 col0" >83300</td>
      <td id="T_7d30b_row2_col1" class="data row2 col1" >84500</td>
      <td id="T_7d30b_row2_col2" class="data row2 col2" >82100</td>
      <td id="T_7d30b_row2_col3" class="data row2 col3" >82200</td>
      <td id="T_7d30b_row2_col4" class="data row2 col4" >42089013</td>
      <td id="T_7d30b_row2_col5" class="data row2 col5" >-0.020262</td>
    </tr>
    <tr>
      <th id="T_7d30b_level0_row3" class="row_heading level0 row3" >2021-01-07 00:00:00</th>
      <td id="T_7d30b_row3_col0" class="data row3 col0" >82800</td>
      <td id="T_7d30b_row3_col1" class="data row3 col1" >84200</td>
      <td id="T_7d30b_row3_col2" class="data row3 col2" >82700</td>
      <td id="T_7d30b_row3_col3" class="data row3 col3" >82900</td>
      <td id="T_7d30b_row3_col4" class="data row3 col4" >32644642</td>
      <td id="T_7d30b_row3_col5" class="data row3 col5" >0.008516</td>
    </tr>
    <tr>
      <th id="T_7d30b_level0_row4" class="row_heading level0 row4" >2021-01-08 00:00:00</th>
      <td id="T_7d30b_row4_col0" class="data row4 col0" >83300</td>
      <td id="T_7d30b_row4_col1" class="data row4 col1" >90000</td>
      <td id="T_7d30b_row4_col2" class="data row4 col2" >83000</td>
      <td id="T_7d30b_row4_col3" class="data row4 col3" >88800</td>
      <td id="T_7d30b_row4_col4" class="data row4 col4" >59013307</td>
      <td id="T_7d30b_row4_col5" class="data row4 col5" >0.071170</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<br>
일봉의 종가에 대하여 5 일 이동평균선을 만들어 '5 day moving average' 라는 이름의 컬럼에 담았습니다. rolling(5) 은 5 개 row 로 만들어진 창(window) 을 한 단계씩 진행하라는 뜻이고, mean() 을 한 이유는 각 창의 평균값을 구하라는 뜻입니다. 처음 4개의 row 에는 5 일의 창이 만들어지지 않으므로 'NaN'(값 없음) 이 되고 처음으로 시작하는 '5 day moving average' 값은 2021년 1월 8일부터 시작하게 됩니다. 2021년 1월 8일의 5일 이동평균선 값 84,160 은 1월 4일 ~ 1월 8일까지 5일 종가들의 평균값입니다. <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;5 day moving average&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">stock_data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_3118d_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >Open</th>
      <th class="col_heading level0 col1" >High</th>
      <th class="col_heading level0 col2" >Low</th>
      <th class="col_heading level0 col3" >Close</th>
      <th class="col_heading level0 col4" >Volume</th>
      <th class="col_heading level0 col5" >Change</th>
      <th class="col_heading level0 col6" >5 day moving average</th>
    </tr>
    <tr>
      <th class="index_name level0" >Date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_3118d_level0_row0" class="row_heading level0 row0" >2021-01-04 00:00:00</th>
      <td id="T_3118d_row0_col0" class="data row0 col0" >81000</td>
      <td id="T_3118d_row0_col1" class="data row0 col1" >84400</td>
      <td id="T_3118d_row0_col2" class="data row0 col2" >80200</td>
      <td id="T_3118d_row0_col3" class="data row0 col3" >83000</td>
      <td id="T_3118d_row0_col4" class="data row0 col4" >38655276</td>
      <td id="T_3118d_row0_col5" class="data row0 col5" >0.024691</td>
      <td id="T_3118d_row0_col6" class="data row0 col6" >nan</td>
    </tr>
    <tr>
      <th id="T_3118d_level0_row1" class="row_heading level0 row1" >2021-01-05 00:00:00</th>
      <td id="T_3118d_row1_col0" class="data row1 col0" >81600</td>
      <td id="T_3118d_row1_col1" class="data row1 col1" >83900</td>
      <td id="T_3118d_row1_col2" class="data row1 col2" >81600</td>
      <td id="T_3118d_row1_col3" class="data row1 col3" >83900</td>
      <td id="T_3118d_row1_col4" class="data row1 col4" >35335669</td>
      <td id="T_3118d_row1_col5" class="data row1 col5" >0.010843</td>
      <td id="T_3118d_row1_col6" class="data row1 col6" >nan</td>
    </tr>
    <tr>
      <th id="T_3118d_level0_row2" class="row_heading level0 row2" >2021-01-06 00:00:00</th>
      <td id="T_3118d_row2_col0" class="data row2 col0" >83300</td>
      <td id="T_3118d_row2_col1" class="data row2 col1" >84500</td>
      <td id="T_3118d_row2_col2" class="data row2 col2" >82100</td>
      <td id="T_3118d_row2_col3" class="data row2 col3" >82200</td>
      <td id="T_3118d_row2_col4" class="data row2 col4" >42089013</td>
      <td id="T_3118d_row2_col5" class="data row2 col5" >-0.020262</td>
      <td id="T_3118d_row2_col6" class="data row2 col6" >nan</td>
    </tr>
    <tr>
      <th id="T_3118d_level0_row3" class="row_heading level0 row3" >2021-01-07 00:00:00</th>
      <td id="T_3118d_row3_col0" class="data row3 col0" >82800</td>
      <td id="T_3118d_row3_col1" class="data row3 col1" >84200</td>
      <td id="T_3118d_row3_col2" class="data row3 col2" >82700</td>
      <td id="T_3118d_row3_col3" class="data row3 col3" >82900</td>
      <td id="T_3118d_row3_col4" class="data row3 col4" >32644642</td>
      <td id="T_3118d_row3_col5" class="data row3 col5" >0.008516</td>
      <td id="T_3118d_row3_col6" class="data row3 col6" >nan</td>
    </tr>
    <tr>
      <th id="T_3118d_level0_row4" class="row_heading level0 row4" >2021-01-08 00:00:00</th>
      <td id="T_3118d_row4_col0" class="data row4 col0" >83300</td>
      <td id="T_3118d_row4_col1" class="data row4 col1" >90000</td>
      <td id="T_3118d_row4_col2" class="data row4 col2" >83000</td>
      <td id="T_3118d_row4_col3" class="data row4 col3" >88800</td>
      <td id="T_3118d_row4_col4" class="data row4 col4" >59013307</td>
      <td id="T_3118d_row4_col5" class="data row4 col5" >0.071170</td>
      <td id="T_3118d_row4_col6" class="data row4 col6" >84160.000000</td>
    </tr>
    <tr>
      <th id="T_3118d_level0_row5" class="row_heading level0 row5" >2021-01-11 00:00:00</th>
      <td id="T_3118d_row5_col0" class="data row5 col0" >90000</td>
      <td id="T_3118d_row5_col1" class="data row5 col1" >96800</td>
      <td id="T_3118d_row5_col2" class="data row5 col2" >89500</td>
      <td id="T_3118d_row5_col3" class="data row5 col3" >91000</td>
      <td id="T_3118d_row5_col4" class="data row5 col4" >90306177</td>
      <td id="T_3118d_row5_col5" class="data row5 col5" >0.024775</td>
      <td id="T_3118d_row5_col6" class="data row5 col6" >85760.000000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<br>
같은 방식으로 20일 이동평균선도 만들어 보겠습니다. 그리고 골든크로스(5일 이동평균선이 20일 이동평균선을 뚫고 올라가는) 지점이 어디 인지도 알아보겠습니다. 5일 이동평균선과 동일하게 20일 이동평균선은 20번째 열부터 존재합니다. <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;20 day moving average&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">stock_data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_28d73_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >Open</th>
      <th class="col_heading level0 col1" >High</th>
      <th class="col_heading level0 col2" >Low</th>
      <th class="col_heading level0 col3" >Close</th>
      <th class="col_heading level0 col4" >Volume</th>
      <th class="col_heading level0 col5" >Change</th>
      <th class="col_heading level0 col6" >5 day moving average</th>
      <th class="col_heading level0 col7" >20 day moving average</th>
    </tr>
    <tr>
      <th class="index_name level0" >Date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
      <th class="blank col7" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_28d73_level0_row0" class="row_heading level0 row0" >2021-01-04 00:00:00</th>
      <td id="T_28d73_row0_col0" class="data row0 col0" >81000</td>
      <td id="T_28d73_row0_col1" class="data row0 col1" >84400</td>
      <td id="T_28d73_row0_col2" class="data row0 col2" >80200</td>
      <td id="T_28d73_row0_col3" class="data row0 col3" >83000</td>
      <td id="T_28d73_row0_col4" class="data row0 col4" >38655276</td>
      <td id="T_28d73_row0_col5" class="data row0 col5" >0.024691</td>
      <td id="T_28d73_row0_col6" class="data row0 col6" >nan</td>
      <td id="T_28d73_row0_col7" class="data row0 col7" >nan</td>
    </tr>
    <tr>
      <th id="T_28d73_level0_row1" class="row_heading level0 row1" >2021-01-05 00:00:00</th>
      <td id="T_28d73_row1_col0" class="data row1 col0" >81600</td>
      <td id="T_28d73_row1_col1" class="data row1 col1" >83900</td>
      <td id="T_28d73_row1_col2" class="data row1 col2" >81600</td>
      <td id="T_28d73_row1_col3" class="data row1 col3" >83900</td>
      <td id="T_28d73_row1_col4" class="data row1 col4" >35335669</td>
      <td id="T_28d73_row1_col5" class="data row1 col5" >0.010843</td>
      <td id="T_28d73_row1_col6" class="data row1 col6" >nan</td>
      <td id="T_28d73_row1_col7" class="data row1 col7" >nan</td>
    </tr>
    <tr>
      <th id="T_28d73_level0_row2" class="row_heading level0 row2" >2021-01-06 00:00:00</th>
      <td id="T_28d73_row2_col0" class="data row2 col0" >83300</td>
      <td id="T_28d73_row2_col1" class="data row2 col1" >84500</td>
      <td id="T_28d73_row2_col2" class="data row2 col2" >82100</td>
      <td id="T_28d73_row2_col3" class="data row2 col3" >82200</td>
      <td id="T_28d73_row2_col4" class="data row2 col4" >42089013</td>
      <td id="T_28d73_row2_col5" class="data row2 col5" >-0.020262</td>
      <td id="T_28d73_row2_col6" class="data row2 col6" >nan</td>
      <td id="T_28d73_row2_col7" class="data row2 col7" >nan</td>
    </tr>
    <tr>
      <th id="T_28d73_level0_row3" class="row_heading level0 row3" >2021-01-07 00:00:00</th>
      <td id="T_28d73_row3_col0" class="data row3 col0" >82800</td>
      <td id="T_28d73_row3_col1" class="data row3 col1" >84200</td>
      <td id="T_28d73_row3_col2" class="data row3 col2" >82700</td>
      <td id="T_28d73_row3_col3" class="data row3 col3" >82900</td>
      <td id="T_28d73_row3_col4" class="data row3 col4" >32644642</td>
      <td id="T_28d73_row3_col5" class="data row3 col5" >0.008516</td>
      <td id="T_28d73_row3_col6" class="data row3 col6" >nan</td>
      <td id="T_28d73_row3_col7" class="data row3 col7" >nan</td>
    </tr>
    <tr>
      <th id="T_28d73_level0_row4" class="row_heading level0 row4" >2021-01-08 00:00:00</th>
      <td id="T_28d73_row4_col0" class="data row4 col0" >83300</td>
      <td id="T_28d73_row4_col1" class="data row4 col1" >90000</td>
      <td id="T_28d73_row4_col2" class="data row4 col2" >83000</td>
      <td id="T_28d73_row4_col3" class="data row4 col3" >88800</td>
      <td id="T_28d73_row4_col4" class="data row4 col4" >59013307</td>
      <td id="T_28d73_row4_col5" class="data row4 col5" >0.071170</td>
      <td id="T_28d73_row4_col6" class="data row4 col6" >84160.000000</td>
      <td id="T_28d73_row4_col7" class="data row4 col7" >nan</td>
    </tr>
    <tr>
      <th id="T_28d73_level0_row5" class="row_heading level0 row5" >2021-01-11 00:00:00</th>
      <td id="T_28d73_row5_col0" class="data row5 col0" >90000</td>
      <td id="T_28d73_row5_col1" class="data row5 col1" >96800</td>
      <td id="T_28d73_row5_col2" class="data row5 col2" >89500</td>
      <td id="T_28d73_row5_col3" class="data row5 col3" >91000</td>
      <td id="T_28d73_row5_col4" class="data row5 col4" >90306177</td>
      <td id="T_28d73_row5_col5" class="data row5 col5" >0.024775</td>
      <td id="T_28d73_row5_col6" class="data row5 col6" >85760.000000</td>
      <td id="T_28d73_row5_col7" class="data row5 col7" >nan</td>
    </tr>
    <tr>
      <th id="T_28d73_level0_row6" class="row_heading level0 row6" >2021-01-12 00:00:00</th>
      <td id="T_28d73_row6_col0" class="data row6 col0" >90300</td>
      <td id="T_28d73_row6_col1" class="data row6 col1" >91400</td>
      <td id="T_28d73_row6_col2" class="data row6 col2" >87800</td>
      <td id="T_28d73_row6_col3" class="data row6 col3" >90600</td>
      <td id="T_28d73_row6_col4" class="data row6 col4" >48682416</td>
      <td id="T_28d73_row6_col5" class="data row6 col5" >-0.004396</td>
      <td id="T_28d73_row6_col6" class="data row6 col6" >87100.000000</td>
      <td id="T_28d73_row6_col7" class="data row6 col7" >nan</td>
    </tr>
    <tr>
      <th id="T_28d73_level0_row7" class="row_heading level0 row7" >2021-01-13 00:00:00</th>
      <td id="T_28d73_row7_col0" class="data row7 col0" >89800</td>
      <td id="T_28d73_row7_col1" class="data row7 col1" >91200</td>
      <td id="T_28d73_row7_col2" class="data row7 col2" >89100</td>
      <td id="T_28d73_row7_col3" class="data row7 col3" >89700</td>
      <td id="T_28d73_row7_col4" class="data row7 col4" >36068848</td>
      <td id="T_28d73_row7_col5" class="data row7 col5" >-0.009934</td>
      <td id="T_28d73_row7_col6" class="data row7 col6" >88600.000000</td>
      <td id="T_28d73_row7_col7" class="data row7 col7" >nan</td>
    </tr>
    <tr>
      <th id="T_28d73_level0_row8" class="row_heading level0 row8" >2021-01-14 00:00:00</th>
      <td id="T_28d73_row8_col0" class="data row8 col0" >88700</td>
      <td id="T_28d73_row8_col1" class="data row8 col1" >90000</td>
      <td id="T_28d73_row8_col2" class="data row8 col2" >88700</td>
      <td id="T_28d73_row8_col3" class="data row8 col3" >89700</td>
      <td id="T_28d73_row8_col4" class="data row8 col4" >26393970</td>
      <td id="T_28d73_row8_col5" class="data row8 col5" >0.000000</td>
      <td id="T_28d73_row8_col6" class="data row8 col6" >89960.000000</td>
      <td id="T_28d73_row8_col7" class="data row8 col7" >nan</td>
    </tr>
    <tr>
      <th id="T_28d73_level0_row9" class="row_heading level0 row9" >2021-01-15 00:00:00</th>
      <td id="T_28d73_row9_col0" class="data row9 col0" >89800</td>
      <td id="T_28d73_row9_col1" class="data row9 col1" >91800</td>
      <td id="T_28d73_row9_col2" class="data row9 col2" >88000</td>
      <td id="T_28d73_row9_col3" class="data row9 col3" >88000</td>
      <td id="T_28d73_row9_col4" class="data row9 col4" >33431809</td>
      <td id="T_28d73_row9_col5" class="data row9 col5" >-0.018952</td>
      <td id="T_28d73_row9_col6" class="data row9 col6" >89800.000000</td>
      <td id="T_28d73_row9_col7" class="data row9 col7" >nan</td>
    </tr>
    <tr>
      <th id="T_28d73_level0_row10" class="row_heading level0 row10" >2021-01-18 00:00:00</th>
      <td id="T_28d73_row10_col0" class="data row10 col0" >86600</td>
      <td id="T_28d73_row10_col1" class="data row10 col1" >87300</td>
      <td id="T_28d73_row10_col2" class="data row10 col2" >84100</td>
      <td id="T_28d73_row10_col3" class="data row10 col3" >85000</td>
      <td id="T_28d73_row10_col4" class="data row10 col4" >43227951</td>
      <td id="T_28d73_row10_col5" class="data row10 col5" >-0.034091</td>
      <td id="T_28d73_row10_col6" class="data row10 col6" >88600.000000</td>
      <td id="T_28d73_row10_col7" class="data row10 col7" >nan</td>
    </tr>
    <tr>
      <th id="T_28d73_level0_row11" class="row_heading level0 row11" >2021-01-19 00:00:00</th>
      <td id="T_28d73_row11_col0" class="data row11 col0" >84500</td>
      <td id="T_28d73_row11_col1" class="data row11 col1" >88000</td>
      <td id="T_28d73_row11_col2" class="data row11 col2" >83600</td>
      <td id="T_28d73_row11_col3" class="data row11 col3" >87000</td>
      <td id="T_28d73_row11_col4" class="data row11 col4" >39895044</td>
      <td id="T_28d73_row11_col5" class="data row11 col5" >0.023529</td>
      <td id="T_28d73_row11_col6" class="data row11 col6" >87880.000000</td>
      <td id="T_28d73_row11_col7" class="data row11 col7" >nan</td>
    </tr>
    <tr>
      <th id="T_28d73_level0_row12" class="row_heading level0 row12" >2021-01-20 00:00:00</th>
      <td id="T_28d73_row12_col0" class="data row12 col0" >89000</td>
      <td id="T_28d73_row12_col1" class="data row12 col1" >89000</td>
      <td id="T_28d73_row12_col2" class="data row12 col2" >86500</td>
      <td id="T_28d73_row12_col3" class="data row12 col3" >87200</td>
      <td id="T_28d73_row12_col4" class="data row12 col4" >25211127</td>
      <td id="T_28d73_row12_col5" class="data row12 col5" >0.002299</td>
      <td id="T_28d73_row12_col6" class="data row12 col6" >87380.000000</td>
      <td id="T_28d73_row12_col7" class="data row12 col7" >nan</td>
    </tr>
    <tr>
      <th id="T_28d73_level0_row13" class="row_heading level0 row13" >2021-01-21 00:00:00</th>
      <td id="T_28d73_row13_col0" class="data row13 col0" >87500</td>
      <td id="T_28d73_row13_col1" class="data row13 col1" >88600</td>
      <td id="T_28d73_row13_col2" class="data row13 col2" >86500</td>
      <td id="T_28d73_row13_col3" class="data row13 col3" >88100</td>
      <td id="T_28d73_row13_col4" class="data row13 col4" >25318011</td>
      <td id="T_28d73_row13_col5" class="data row13 col5" >0.010321</td>
      <td id="T_28d73_row13_col6" class="data row13 col6" >87060.000000</td>
      <td id="T_28d73_row13_col7" class="data row13 col7" >nan</td>
    </tr>
    <tr>
      <th id="T_28d73_level0_row14" class="row_heading level0 row14" >2021-01-22 00:00:00</th>
      <td id="T_28d73_row14_col0" class="data row14 col0" >89000</td>
      <td id="T_28d73_row14_col1" class="data row14 col1" >89700</td>
      <td id="T_28d73_row14_col2" class="data row14 col2" >86800</td>
      <td id="T_28d73_row14_col3" class="data row14 col3" >86800</td>
      <td id="T_28d73_row14_col4" class="data row14 col4" >30861661</td>
      <td id="T_28d73_row14_col5" class="data row14 col5" >-0.014756</td>
      <td id="T_28d73_row14_col6" class="data row14 col6" >86820.000000</td>
      <td id="T_28d73_row14_col7" class="data row14 col7" >nan</td>
    </tr>
    <tr>
      <th id="T_28d73_level0_row15" class="row_heading level0 row15" >2021-01-25 00:00:00</th>
      <td id="T_28d73_row15_col0" class="data row15 col0" >87000</td>
      <td id="T_28d73_row15_col1" class="data row15 col1" >89900</td>
      <td id="T_28d73_row15_col2" class="data row15 col2" >86300</td>
      <td id="T_28d73_row15_col3" class="data row15 col3" >89400</td>
      <td id="T_28d73_row15_col4" class="data row15 col4" >27258534</td>
      <td id="T_28d73_row15_col5" class="data row15 col5" >0.029954</td>
      <td id="T_28d73_row15_col6" class="data row15 col6" >87700.000000</td>
      <td id="T_28d73_row15_col7" class="data row15 col7" >nan</td>
    </tr>
    <tr>
      <th id="T_28d73_level0_row16" class="row_heading level0 row16" >2021-01-26 00:00:00</th>
      <td id="T_28d73_row16_col0" class="data row16 col0" >88800</td>
      <td id="T_28d73_row16_col1" class="data row16 col1" >89200</td>
      <td id="T_28d73_row16_col2" class="data row16 col2" >86500</td>
      <td id="T_28d73_row16_col3" class="data row16 col3" >86700</td>
      <td id="T_28d73_row16_col4" class="data row16 col4" >33178936</td>
      <td id="T_28d73_row16_col5" class="data row16 col5" >-0.030201</td>
      <td id="T_28d73_row16_col6" class="data row16 col6" >87640.000000</td>
      <td id="T_28d73_row16_col7" class="data row16 col7" >nan</td>
    </tr>
    <tr>
      <th id="T_28d73_level0_row17" class="row_heading level0 row17" >2021-01-27 00:00:00</th>
      <td id="T_28d73_row17_col0" class="data row17 col0" >86600</td>
      <td id="T_28d73_row17_col1" class="data row17 col1" >87700</td>
      <td id="T_28d73_row17_col2" class="data row17 col2" >85600</td>
      <td id="T_28d73_row17_col3" class="data row17 col3" >85600</td>
      <td id="T_28d73_row17_col4" class="data row17 col4" >26423070</td>
      <td id="T_28d73_row17_col5" class="data row17 col5" >-0.012687</td>
      <td id="T_28d73_row17_col6" class="data row17 col6" >87320.000000</td>
      <td id="T_28d73_row17_col7" class="data row17 col7" >nan</td>
    </tr>
    <tr>
      <th id="T_28d73_level0_row18" class="row_heading level0 row18" >2021-01-28 00:00:00</th>
      <td id="T_28d73_row18_col0" class="data row18 col0" >83200</td>
      <td id="T_28d73_row18_col1" class="data row18 col1" >85600</td>
      <td id="T_28d73_row18_col2" class="data row18 col2" >83200</td>
      <td id="T_28d73_row18_col3" class="data row18 col3" >83700</td>
      <td id="T_28d73_row18_col4" class="data row18 col4" >31859808</td>
      <td id="T_28d73_row18_col5" class="data row18 col5" >-0.022196</td>
      <td id="T_28d73_row18_col6" class="data row18 col6" >86440.000000</td>
      <td id="T_28d73_row18_col7" class="data row18 col7" >nan</td>
    </tr>
    <tr>
      <th id="T_28d73_level0_row19" class="row_heading level0 row19" >2021-01-29 00:00:00</th>
      <td id="T_28d73_row19_col0" class="data row19 col0" >84500</td>
      <td id="T_28d73_row19_col1" class="data row19 col1" >85000</td>
      <td id="T_28d73_row19_col2" class="data row19 col2" >82000</td>
      <td id="T_28d73_row19_col3" class="data row19 col3" >82000</td>
      <td id="T_28d73_row19_col4" class="data row19 col4" >39615978</td>
      <td id="T_28d73_row19_col5" class="data row19 col5" >-0.020311</td>
      <td id="T_28d73_row19_col6" class="data row19 col6" >85480.000000</td>
      <td id="T_28d73_row19_col7" class="data row19 col7" >86565.000000</td>
    </tr>
    <tr>
      <th id="T_28d73_level0_row20" class="row_heading level0 row20" >2021-02-01 00:00:00</th>
      <td id="T_28d73_row20_col0" class="data row20 col0" >81700</td>
      <td id="T_28d73_row20_col1" class="data row20 col1" >83400</td>
      <td id="T_28d73_row20_col2" class="data row20 col2" >81000</td>
      <td id="T_28d73_row20_col3" class="data row20 col3" >83000</td>
      <td id="T_28d73_row20_col4" class="data row20 col4" >28046832</td>
      <td id="T_28d73_row20_col5" class="data row20 col5" >0.012195</td>
      <td id="T_28d73_row20_col6" class="data row20 col6" >84200.000000</td>
      <td id="T_28d73_row20_col7" class="data row20 col7" >86565.000000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<br>
우선 NaN 으로 표시가 된 값이 없는 모든 열을 제거하고 싶습니다. dropna 라는 메소드도 활용할 것인데요. dropna 를 하면 NaN 가 있는 모든 열을 제거합니다. 제거한 후 자기 자신을 덮어쓰라고 명령하는 것은 inplace=True 라는 인수인데요. 새로운 DataFrame 을 만들지 않고 dropna(inplace=True) 하여 값이 없는 모든 열을 제거한 후, 자기 자신을 덮어쓰도록 하겠습니다.<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stock_data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># NaN 이 있는 모든 row 제거</span>
<span class="n">stock_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_ca700_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >Open</th>
      <th class="col_heading level0 col1" >High</th>
      <th class="col_heading level0 col2" >Low</th>
      <th class="col_heading level0 col3" >Close</th>
      <th class="col_heading level0 col4" >Volume</th>
      <th class="col_heading level0 col5" >Change</th>
      <th class="col_heading level0 col6" >5 day moving average</th>
      <th class="col_heading level0 col7" >20 day moving average</th>
    </tr>
    <tr>
      <th class="index_name level0" >Date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
      <th class="blank col7" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_ca700_level0_row0" class="row_heading level0 row0" >2021-01-29 00:00:00</th>
      <td id="T_ca700_row0_col0" class="data row0 col0" >84500</td>
      <td id="T_ca700_row0_col1" class="data row0 col1" >85000</td>
      <td id="T_ca700_row0_col2" class="data row0 col2" >82000</td>
      <td id="T_ca700_row0_col3" class="data row0 col3" >82000</td>
      <td id="T_ca700_row0_col4" class="data row0 col4" >39615978</td>
      <td id="T_ca700_row0_col5" class="data row0 col5" >-0.020311</td>
      <td id="T_ca700_row0_col6" class="data row0 col6" >85480.000000</td>
      <td id="T_ca700_row0_col7" class="data row0 col7" >86565.000000</td>
    </tr>
    <tr>
      <th id="T_ca700_level0_row1" class="row_heading level0 row1" >2021-02-01 00:00:00</th>
      <td id="T_ca700_row1_col0" class="data row1 col0" >81700</td>
      <td id="T_ca700_row1_col1" class="data row1 col1" >83400</td>
      <td id="T_ca700_row1_col2" class="data row1 col2" >81000</td>
      <td id="T_ca700_row1_col3" class="data row1 col3" >83000</td>
      <td id="T_ca700_row1_col4" class="data row1 col4" >28046832</td>
      <td id="T_ca700_row1_col5" class="data row1 col5" >0.012195</td>
      <td id="T_ca700_row1_col6" class="data row1 col6" >84200.000000</td>
      <td id="T_ca700_row1_col7" class="data row1 col7" >86565.000000</td>
    </tr>
    <tr>
      <th id="T_ca700_level0_row2" class="row_heading level0 row2" >2021-02-02 00:00:00</th>
      <td id="T_ca700_row2_col0" class="data row2 col0" >84100</td>
      <td id="T_ca700_row2_col1" class="data row2 col1" >86400</td>
      <td id="T_ca700_row2_col2" class="data row2 col2" >83700</td>
      <td id="T_ca700_row2_col3" class="data row2 col3" >84400</td>
      <td id="T_ca700_row2_col4" class="data row2 col4" >26302077</td>
      <td id="T_ca700_row2_col5" class="data row2 col5" >0.016867</td>
      <td id="T_ca700_row2_col6" class="data row2 col6" >83740.000000</td>
      <td id="T_ca700_row2_col7" class="data row2 col7" >86590.000000</td>
    </tr>
    <tr>
      <th id="T_ca700_level0_row3" class="row_heading level0 row3" >2021-02-03 00:00:00</th>
      <td id="T_ca700_row3_col0" class="data row3 col0" >84800</td>
      <td id="T_ca700_row3_col1" class="data row3 col1" >85400</td>
      <td id="T_ca700_row3_col2" class="data row3 col2" >83400</td>
      <td id="T_ca700_row3_col3" class="data row3 col3" >84600</td>
      <td id="T_ca700_row3_col4" class="data row3 col4" >22112205</td>
      <td id="T_ca700_row3_col5" class="data row3 col5" >0.002370</td>
      <td id="T_ca700_row3_col6" class="data row3 col6" >83540.000000</td>
      <td id="T_ca700_row3_col7" class="data row3 col7" >86710.000000</td>
    </tr>
    <tr>
      <th id="T_ca700_level0_row4" class="row_heading level0 row4" >2021-02-04 00:00:00</th>
      <td id="T_ca700_row4_col0" class="data row4 col0" >83500</td>
      <td id="T_ca700_row4_col1" class="data row4 col1" >83800</td>
      <td id="T_ca700_row4_col2" class="data row4 col2" >82100</td>
      <td id="T_ca700_row4_col3" class="data row4 col3" >82500</td>
      <td id="T_ca700_row4_col4" class="data row4 col4" >24171688</td>
      <td id="T_ca700_row4_col5" class="data row4 col5" >-0.024823</td>
      <td id="T_ca700_row4_col6" class="data row4 col6" >83300.000000</td>
      <td id="T_ca700_row4_col7" class="data row4 col7" >86690.000000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<br>
이제 5일 이동평균선이 20일 이동평균선보다 작았다가 커지는 지점을 찾으면 됩니다. DataFrame 의 필터링에 대하여는 아직 다루지 않았습니다. 설명을 드리면, df(DataFrame) 에서 원하는 row 를 가져오고 싶을 때는 df[조건] 처럼 대괄호 안에 조건을 넣어 주면 됩니다. 아래에서 stock_data['cross_flag'==1] 은 stock_data 에서 True 인 열과 False 인 열을 구분하는 역할을 합니다.  stock_data['cross_flag'].shift(1)==0 은 전 날의 cross_flag 값이 0 인 경우를 찾는 것인데요. 결국 전날은 cross_flag 값이 0, 당일은 cross_flag 값이 1 날을 찾는 조건이 됩니다. 최종 결과를 보시면 2021년은 3월 3일에 최초 골든크로스가 일어났습니다. <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;cross_flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;5 day moving average&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;20 day moving average&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># True/False 결과 값을 1/0 으로 바꿔줌</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">stock_data</span><span class="p">[(</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;cross_flag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;cross_flag&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)]</span> <span class="c1"># 조건 - 전날에는 5일 이평선이 20일 이평선보다 작거나 같아는데, 당일은 5일 이평선이 20일 이평선 보다 커짐</span>
<span class="n">s</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_849b8_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >Open</th>
      <th class="col_heading level0 col1" >High</th>
      <th class="col_heading level0 col2" >Low</th>
      <th class="col_heading level0 col3" >Close</th>
      <th class="col_heading level0 col4" >Volume</th>
      <th class="col_heading level0 col5" >Change</th>
      <th class="col_heading level0 col6" >5 day moving average</th>
      <th class="col_heading level0 col7" >20 day moving average</th>
      <th class="col_heading level0 col8" >cross_flag</th>
    </tr>
    <tr>
      <th class="index_name level0" >Date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
      <th class="blank col7" >&nbsp;</th>
      <th class="blank col8" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_849b8_level0_row0" class="row_heading level0 row0" >2021-03-03 00:00:00</th>
      <td id="T_849b8_row0_col0" class="data row0 col0" >83500</td>
      <td id="T_849b8_row0_col1" class="data row0 col1" >84000</td>
      <td id="T_849b8_row0_col2" class="data row0 col2" >82800</td>
      <td id="T_849b8_row0_col3" class="data row0 col3" >84000</td>
      <td id="T_849b8_row0_col4" class="data row0 col4" >19882132</td>
      <td id="T_849b8_row0_col5" class="data row0 col5" >0.004785</td>
      <td id="T_849b8_row0_col6" class="data row0 col6" >83480.000000</td>
      <td id="T_849b8_row0_col7" class="data row0 col7" >83195.000000</td>
      <td id="T_849b8_row0_col8" class="data row0 col8" >1</td>
    </tr>
    <tr>
      <th id="T_849b8_level0_row1" class="row_heading level0 row1" >2021-03-18 00:00:00</th>
      <td id="T_849b8_row1_col0" class="data row1 col0" >82800</td>
      <td id="T_849b8_row1_col1" class="data row1 col1" >83800</td>
      <td id="T_849b8_row1_col2" class="data row1 col2" >82600</td>
      <td id="T_849b8_row1_col3" class="data row1 col3" >82900</td>
      <td id="T_849b8_row1_col4" class="data row1 col4" >18585244</td>
      <td id="T_849b8_row1_col5" class="data row1 col5" >0.007290</td>
      <td id="T_849b8_row1_col6" class="data row1 col6" >82520.000000</td>
      <td id="T_849b8_row1_col7" class="data row1 col7" >82485.000000</td>
      <td id="T_849b8_row1_col8" class="data row1 col8" >1</td>
    </tr>
    <tr>
      <th id="T_849b8_level0_row2" class="row_heading level0 row2" >2021-04-02 00:00:00</th>
      <td id="T_849b8_row2_col0" class="data row2 col0" >84000</td>
      <td id="T_849b8_row2_col1" class="data row2 col1" >85200</td>
      <td id="T_849b8_row2_col2" class="data row2 col2" >83900</td>
      <td id="T_849b8_row2_col3" class="data row2 col3" >84800</td>
      <td id="T_849b8_row2_col4" class="data row2 col4" >22997538</td>
      <td id="T_849b8_row2_col5" class="data row2 col5" >0.022919</td>
      <td id="T_849b8_row2_col6" class="data row2 col6" >82580.000000</td>
      <td id="T_849b8_row2_col7" class="data row2 col7" >82060.000000</td>
      <td id="T_849b8_row2_col8" class="data row2 col8" >1</td>
    </tr>
    <tr>
      <th id="T_849b8_level0_row3" class="row_heading level0 row3" >2021-06-03 00:00:00</th>
      <td id="T_849b8_row3_col0" class="data row3 col0" >81300</td>
      <td id="T_849b8_row3_col1" class="data row3 col1" >83000</td>
      <td id="T_849b8_row3_col2" class="data row3 col2" >81100</td>
      <td id="T_849b8_row3_col3" class="data row3 col3" >82800</td>
      <td id="T_849b8_row3_col4" class="data row3 col4" >29546007</td>
      <td id="T_849b8_row3_col5" class="data row3 col5" >0.024752</td>
      <td id="T_849b8_row3_col6" class="data row3 col6" >80960.000000</td>
      <td id="T_849b8_row3_col7" class="data row3 col7" >80490.000000</td>
      <td id="T_849b8_row3_col8" class="data row3 col8" >1</td>
    </tr>
    <tr>
      <th id="T_849b8_level0_row4" class="row_heading level0 row4" >2021-06-29 00:00:00</th>
      <td id="T_849b8_row4_col0" class="data row4 col0" >81900</td>
      <td id="T_849b8_row4_col1" class="data row4 col1" >82100</td>
      <td id="T_849b8_row4_col2" class="data row4 col2" >80800</td>
      <td id="T_849b8_row4_col3" class="data row4 col3" >81000</td>
      <td id="T_849b8_row4_col4" class="data row4 col4" >15744317</td>
      <td id="T_849b8_row4_col5" class="data row4 col5" >-0.010989</td>
      <td id="T_849b8_row4_col6" class="data row4 col6" >81160.000000</td>
      <td id="T_849b8_row4_col7" class="data row4 col7" >81150.000000</td>
      <td id="T_849b8_row4_col8" class="data row4 col8" >1</td>
    </tr>
    <tr>
      <th id="T_849b8_level0_row5" class="row_heading level0 row5" >2021-08-04 00:00:00</th>
      <td id="T_849b8_row5_col0" class="data row5 col0" >82200</td>
      <td id="T_849b8_row5_col1" class="data row5 col1" >83100</td>
      <td id="T_849b8_row5_col2" class="data row5 col2" >81800</td>
      <td id="T_849b8_row5_col3" class="data row5 col3" >82900</td>
      <td id="T_849b8_row5_col4" class="data row5 col4" >25642368</td>
      <td id="T_849b8_row5_col5" class="data row5 col5" >0.018428</td>
      <td id="T_849b8_row5_col6" class="data row5 col6" >80220.000000</td>
      <td id="T_849b8_row5_col7" class="data row5 col7" >79590.000000</td>
      <td id="T_849b8_row5_col8" class="data row5 col8" >1</td>
    </tr>
    <tr>
      <th id="T_849b8_level0_row6" class="row_heading level0 row6" >2021-09-03 00:00:00</th>
      <td id="T_849b8_row6_col0" class="data row6 col0" >76400</td>
      <td id="T_849b8_row6_col1" class="data row6 col1" >76700</td>
      <td id="T_849b8_row6_col2" class="data row6 col2" >76000</td>
      <td id="T_849b8_row6_col3" class="data row6 col3" >76600</td>
      <td id="T_849b8_row6_col4" class="data row6 col4" >12096419</td>
      <td id="T_849b8_row6_col5" class="data row6 col5" >0.007895</td>
      <td id="T_849b8_row6_col6" class="data row6 col6" >76140.000000</td>
      <td id="T_849b8_row6_col7" class="data row6 col7" >76060.000000</td>
      <td id="T_849b8_row6_col8" class="data row6 col8" >1</td>
    </tr>
    <tr>
      <th id="T_849b8_level0_row7" class="row_heading level0 row7" >2021-11-03 00:00:00</th>
      <td id="T_849b8_row7_col0" class="data row7 col0" >71700</td>
      <td id="T_849b8_row7_col1" class="data row7 col1" >71700</td>
      <td id="T_849b8_row7_col2" class="data row7 col2" >70100</td>
      <td id="T_849b8_row7_col3" class="data row7 col3" >70400</td>
      <td id="T_849b8_row7_col4" class="data row7 col4" >12770428</td>
      <td id="T_849b8_row7_col5" class="data row7 col5" >-0.015385</td>
      <td id="T_849b8_row7_col6" class="data row7 col6" >70460.000000</td>
      <td id="T_849b8_row7_col7" class="data row7 col7" >70355.000000</td>
      <td id="T_849b8_row7_col8" class="data row7 col8" >1</td>
    </tr>
    <tr>
      <th id="T_849b8_level0_row8" class="row_heading level0 row8" >2021-11-15 00:00:00</th>
      <td id="T_849b8_row8_col0" class="data row8 col0" >71700</td>
      <td id="T_849b8_row8_col1" class="data row8 col1" >71900</td>
      <td id="T_849b8_row8_col2" class="data row8 col2" >70900</td>
      <td id="T_849b8_row8_col3" class="data row8 col3" >71400</td>
      <td id="T_849b8_row8_col4" class="data row8 col4" >12420710</td>
      <td id="T_849b8_row8_col5" class="data row8 col5" >0.011331</td>
      <td id="T_849b8_row8_col6" class="data row8 col6" >70520.000000</td>
      <td id="T_849b8_row8_col7" class="data row8 col7" >70460.000000</td>
      <td id="T_849b8_row8_col8" class="data row8 col8" >1</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
</div>
</section>
<span id="document-chapter2/2.3.0_Visualization"></span><section id="id1">
<h2><strong>시각화</strong><a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<p>이번 장에서는 데이터를 시각화하는 방법등을 배워보겠습니다.</p>
<div class="toctree-wrapper compound">
<span id="document-chapter2/2.3.1_Visualization"></span><section id="pandas-plot">
<h3>Pandas Plot<a class="headerlink" href="#pandas-plot" title="Permalink to this headline">#</a></h3>
<p>주식에서 많이 활용할 그래프는 Line Chart 와 Bar Chart 입니다. 보통 주가의 흐름은 Line Chart 로 표시하고, 거래량은 Bar Chat 로 표시합니다. 이 두 가지를 연습해 보겠습니다. 그래프는 DataFrame 에서도 만들 수 있습니다. 복잡한 그래프를 그리려면 Matplotlib 를 이용하는데요. 이번 섹션에는 Pandas 에서 제공하는 Plot 을 이용하겠습니다. 먼저 DataFrame 에서 제공하는 plot 메소드로 간단하게 그리는 법을 연습하겠습니다. 삼성전자 일봉을 가져옵니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span> 
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;005930&#39;</span> <span class="c1"># 삼성전자</span>
<span class="n">stock_data</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2021-01-03&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2021-12-31&#39;</span><span class="p">)</span> 

<span class="n">stock_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Volume</th>
      <th>Change</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2021-01-04</th>
      <td>81000</td>
      <td>84400</td>
      <td>80200</td>
      <td>83000</td>
      <td>38655276</td>
      <td>0.024691</td>
    </tr>
    <tr>
      <th>2021-01-05</th>
      <td>81600</td>
      <td>83900</td>
      <td>81600</td>
      <td>83900</td>
      <td>35335669</td>
      <td>0.010843</td>
    </tr>
    <tr>
      <th>2021-01-06</th>
      <td>83300</td>
      <td>84500</td>
      <td>82100</td>
      <td>82200</td>
      <td>42089013</td>
      <td>-0.020262</td>
    </tr>
    <tr>
      <th>2021-01-07</th>
      <td>82800</td>
      <td>84200</td>
      <td>82700</td>
      <td>82900</td>
      <td>32644642</td>
      <td>0.008516</td>
    </tr>
    <tr>
      <th>2021-01-08</th>
      <td>83300</td>
      <td>90000</td>
      <td>83000</td>
      <td>88800</td>
      <td>59013307</td>
      <td>0.071170</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>먼저 종가를 Line Chart 로 그려봅니다. 2021년 주가흐름이 내리막입니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;Date&#39;&gt;
</pre></div>
</div>
<img alt="_images/2.3.1_Visualization_3_1.png" src="_images/2.3.1_Visualization_3_1.png" />
</div>
</div>
<br>
위 그래프를 조금 크게 그리고 싶습니다. 인수에 figsize=(15,5) 라고 넣어줍니다. 차트에 제목도 추가 하고 싶습니다. 인수에 title = 'Samsung Electronics' 라고 넣어줍니다. <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Samsung Electronics&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:title={&#39;center&#39;:&#39;Samsung Electronics&#39;}, xlabel=&#39;Date&#39;&gt;
</pre></div>
</div>
<img alt="_images/2.3.1_Visualization_5_1.png" src="_images/2.3.1_Visualization_5_1.png" />
</div>
</div>
<br> 
이번에는 거래량을 Bar Chart 로 그리고 싶습니다. 인수 kind='bar' 를 넣어서 Bar Chat 를 그리고 싶다는 것을 알려줍니다.<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Samsung Electronics&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:title={&#39;center&#39;:&#39;Samsung Electronics&#39;}, xlabel=&#39;Date&#39;&gt;
</pre></div>
</div>
<img alt="_images/2.3.1_Visualization_7_1.png" src="_images/2.3.1_Visualization_7_1.png" />
</div>
</div>
<p>Bar 별로 X 값(일) 을 표시하다 보니, X 축의 날짜가 보이질 않습니다. loc[시작일:종료일] 를 이용해서 1월의 거래량만을 보겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stock_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2021-01-04&#39;</span><span class="p">:</span><span class="s1">&#39;2021-01-31&#39;</span><span class="p">][</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Samsung Electronics&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:title={&#39;center&#39;:&#39;Samsung Electronics&#39;}, xlabel=&#39;Date&#39;&gt;
</pre></div>
</div>
<img alt="_images/2.3.1_Visualization_9_1.png" src="_images/2.3.1_Visualization_9_1.png" />
</div>
</div>
<p>역시 X 축 값이 너무 깁니다. 년-월-일만 표시하고 싶습니다. 이번에는 stock_data 의 인덱스를 strftime 을 이용해서 년-월-일 의 문자열로 바꿔주고 다시 그래프를 그립니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="n">stock_data2</span> <span class="o">=</span> <span class="n">stock_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># 새로운 DataFrame 생성하고, 새로운 DataFrame 의 index 타입을 변경 </span>
<span class="n">stock_data2</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">stock_data</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="c1"># Date 으로 되어 있는 index 값을 원하는 모양의 문자열로 변환</span>
<span class="n">stock_data2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2021-01-04&#39;</span><span class="p">:</span><span class="s1">&#39;2021-01-31&#39;</span><span class="p">][</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Samsung Electronics&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:title={&#39;center&#39;:&#39;Samsung Electronics&#39;}&gt;
</pre></div>
</div>
<img alt="_images/2.3.1_Visualization_11_1.png" src="_images/2.3.1_Visualization_11_1.png" />
</div>
</div>
<p><br> 이제 주가 Line Chart 와 거래량 Bar Chat 를 한 Chart 에 그리고 싶은 욕구가 생깁니다. Pandas Plot 에서 가능은 한데 복잡합니다. 이 부분은 matplotlib 에서 하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
</section>
<span id="document-chapter2/2.3.2_Visualization"></span><section id="matplotlib">
<h3>Matplotlib<a class="headerlink" href="#matplotlib" title="Permalink to this headline">#</a></h3>
<p>전 단원에서 Pandas 에서 제공하는 Plot 으로 Chart 를 그리는 연습을 했습니다. 이번에는 시각화 패키지인 Matplotlib 를 이용해서 Chart 를 만들어 보겠습니다. 다시 삼성전자 일봉을 가져옵니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span> 
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;005930&#39;</span> <span class="c1"># 삼성전자</span>
<span class="n">stock_data</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2021-01-03&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2021-12-31&#39;</span><span class="p">)</span> 

<span class="n">stock_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_f00b1_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >Open</th>
      <th class="col_heading level0 col1" >High</th>
      <th class="col_heading level0 col2" >Low</th>
      <th class="col_heading level0 col3" >Close</th>
      <th class="col_heading level0 col4" >Volume</th>
      <th class="col_heading level0 col5" >Change</th>
    </tr>
    <tr>
      <th class="index_name level0" >Date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_f00b1_level0_row0" class="row_heading level0 row0" >2021-01-04 00:00:00</th>
      <td id="T_f00b1_row0_col0" class="data row0 col0" >81000</td>
      <td id="T_f00b1_row0_col1" class="data row0 col1" >84400</td>
      <td id="T_f00b1_row0_col2" class="data row0 col2" >80200</td>
      <td id="T_f00b1_row0_col3" class="data row0 col3" >83000</td>
      <td id="T_f00b1_row0_col4" class="data row0 col4" >38655276</td>
      <td id="T_f00b1_row0_col5" class="data row0 col5" >0.024691</td>
    </tr>
    <tr>
      <th id="T_f00b1_level0_row1" class="row_heading level0 row1" >2021-01-05 00:00:00</th>
      <td id="T_f00b1_row1_col0" class="data row1 col0" >81600</td>
      <td id="T_f00b1_row1_col1" class="data row1 col1" >83900</td>
      <td id="T_f00b1_row1_col2" class="data row1 col2" >81600</td>
      <td id="T_f00b1_row1_col3" class="data row1 col3" >83900</td>
      <td id="T_f00b1_row1_col4" class="data row1 col4" >35335669</td>
      <td id="T_f00b1_row1_col5" class="data row1 col5" >0.010843</td>
    </tr>
    <tr>
      <th id="T_f00b1_level0_row2" class="row_heading level0 row2" >2021-01-06 00:00:00</th>
      <td id="T_f00b1_row2_col0" class="data row2 col0" >83300</td>
      <td id="T_f00b1_row2_col1" class="data row2 col1" >84500</td>
      <td id="T_f00b1_row2_col2" class="data row2 col2" >82100</td>
      <td id="T_f00b1_row2_col3" class="data row2 col3" >82200</td>
      <td id="T_f00b1_row2_col4" class="data row2 col4" >42089013</td>
      <td id="T_f00b1_row2_col5" class="data row2 col5" >-0.020262</td>
    </tr>
    <tr>
      <th id="T_f00b1_level0_row3" class="row_heading level0 row3" >2021-01-07 00:00:00</th>
      <td id="T_f00b1_row3_col0" class="data row3 col0" >82800</td>
      <td id="T_f00b1_row3_col1" class="data row3 col1" >84200</td>
      <td id="T_f00b1_row3_col2" class="data row3 col2" >82700</td>
      <td id="T_f00b1_row3_col3" class="data row3 col3" >82900</td>
      <td id="T_f00b1_row3_col4" class="data row3 col4" >32644642</td>
      <td id="T_f00b1_row3_col5" class="data row3 col5" >0.008516</td>
    </tr>
    <tr>
      <th id="T_f00b1_level0_row4" class="row_heading level0 row4" >2021-01-08 00:00:00</th>
      <td id="T_f00b1_row4_col0" class="data row4 col0" >83300</td>
      <td id="T_f00b1_row4_col1" class="data row4 col1" >90000</td>
      <td id="T_f00b1_row4_col2" class="data row4 col2" >83000</td>
      <td id="T_f00b1_row4_col3" class="data row4 col3" >88800</td>
      <td id="T_f00b1_row4_col4" class="data row4 col4" >59013307</td>
      <td id="T_f00b1_row4_col5" class="data row4 col5" >0.071170</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> Matplotlib 패키지를 import 합니다. 두번째 줄에 %matplotlib inline 같이 적어줍니다. 두번째 줄은 쥬피터노트북의 아웃풋 창에 Chart 를 볼 수 있게 해주는 기능을 합니다. 먼저 plt.figure 을 이용하여 chart 의 크기를 결정해줍니다. plt.plot() 를 해보면 박스만 있습니다. 이제 chart 를 추가하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2.3.2_Visualization_3_0.png" src="_images/2.3.2_Visualization_3_0.png" />
</div>
</div>
<p><br> 삼성전자 종가 line를 추가했습니다. plt.title 를 이용해서 제목도 넣어줍니다. color=’orangered’ 인수를 넣어 line 색상도 빨간 오렌지 색으로 바꿔줍니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Samsung Electronics&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2.3.2_Visualization_5_0.png" src="_images/2.3.2_Visualization_5_0.png" />
</div>
</div>
<p><br> 이번에는 거래량 Bar Chart 를 추가합니다. 먼저 plt.subplots 에서 fig 와 ax 객체를 받아옵니다. fig 는 그래프의 사이즈 객체이고, ax 는 축 객체입니다. 주가와 거래량은 크기가 서로 틀리므로 두 개의 Y 축이 필요합니다. 원래의 축 ax 에 ax.twinx() 를 선언해서 새로운 축 ax2 을 만들어 줍니다. Bar Chart 는 ax2 축(오른쪽)에 그립니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Samsung Electronics&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="n">stock_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2.3.2_Visualization_7_0.png" src="_images/2.3.2_Visualization_7_0.png" />
</div>
</div>
<p><br> 만들어진 그래프에 set_ylabel 로 왼쪽, 오른쪽 Y 축에 레이블을 추가합니다. 그리고  각 축 ax, ax2 에 legend(위치) 를 표시하도록 합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Samsung Electronics&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Price&#39;</span><span class="p">)</span> <span class="c1"># legend(범례)에 표시될 레이블 추가</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span> <span class="c1"># 새로운 축 만듦</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="n">stock_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Volume&#39;</span><span class="p">)</span> <span class="c1"># legend(범례)에 표시될 레이블 추가</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Price&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Volume&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 범례 표시 () 안은 위치</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 범례 표시 () 안은 위치 </span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2.3.2_Visualization_9_0.png" src="_images/2.3.2_Visualization_9_0.png" />
</div>
</div>
<p><br> 이번에는 주가와 거래량 그래프를 나누어 그려보겠습니다. plt.subplots 에서 그래프를 그릴 박스의 갯수를 정해줍니다. 아래는 한 라인에 두 개의 박스를 만들겠다는 의미입니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2.3.2_Visualization_11_0.png" src="_images/2.3.2_Visualization_11_0.png" />
</div>
</div>
<p><br> 아래와 같이 2 개의 박스가 나왔습니다. 여기서 ax 는 2 개가 생성됩니다. 첫 번재 박스는 ax[0] 이고, 두 번째 박스는 ax[1] 이 됩니다. ax[0] 에 주가 그래프를 그리고 두 번째 박스 ax[1] 에 거래량 그래프를 그립니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Price&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="n">stock_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Volume&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;BarContainer object of 248 artists&gt;
</pre></div>
</div>
<img alt="_images/2.3.2_Visualization_13_1.png" src="_images/2.3.2_Visualization_13_1.png" />
</div>
</div>
<p><br> ax[0] 에 제목과 ylabel 를 넣어보겠습니다. 레전드도 추가합니다. 거래량 그래프도 동일하게 작업할 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Price&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="n">stock_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Volume&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Samsung Electronic Stock Price&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Stock Price&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x26732dfd760&gt;
</pre></div>
</div>
<img alt="_images/2.3.2_Visualization_15_1.png" src="_images/2.3.2_Visualization_15_1.png" />
</div>
</div>
</section>
</div>
</section>
<span id="document-chapter2/2.4.0_Volatility_Breakout"></span><section id="id1">
<h2><strong>변동성 돌파전략 구현</strong><a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<p>여기까지 배운 내용을 토대로 래리윌리암스의 변동성 돌파전략을 구현해보겠습니다.</p>
<div class="toctree-wrapper compound">
<span id="document-chapter2/2.4.1_Volatility_Breakout"></span><section id="id1">
<h3>변동성 돌파전략 1<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>변동성 돌파전략은 래리 윌리암스가 개발한 전략인데요. 이 전략으로 윌리암스는 주식투자 대회에서 많은 상을 받았다고 하네요. 심지어 딸에게 이 전략을 전수해 주었다고 합니다. 전략은 아주 간단합니다. ‘전날 고가와 저가의 차’에 상수 K (0.4 ~ 0.6) 를 곱하여 변동성 값 V 를 만듭니다. 그리고 당일 장이 시작하면 시가에 이 변동성 값 V 를 더한 값을 매수 가격으로 설정합니다. 장 중에 매수 가격을 돌파하면 무조건 매수합니다. 그리고 다음날 장 시작할 때 전량 매도하는 전략입니다. 다음 링크는 변동성 돌파전략에 관련하여 참고할만한 블로그 입니다. <a class="reference external" href="https://blog.naver.com/niolpa/222436997945">https://blog.naver.com/niolpa/222436997945</a> 다시 삼성전자 일봉을 가져옵니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span> 

<span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;005930&#39;</span> <span class="c1"># 삼성전자</span>
<span class="n">stock_data</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2021-01-03&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2021-12-31&#39;</span><span class="p">)</span> 
<span class="n">stock_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_38ddf_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >Open</th>
      <th class="col_heading level0 col1" >High</th>
      <th class="col_heading level0 col2" >Low</th>
      <th class="col_heading level0 col3" >Close</th>
      <th class="col_heading level0 col4" >Volume</th>
      <th class="col_heading level0 col5" >Change</th>
    </tr>
    <tr>
      <th class="index_name level0" >Date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_38ddf_level0_row0" class="row_heading level0 row0" >2021-01-04 00:00:00</th>
      <td id="T_38ddf_row0_col0" class="data row0 col0" >81000</td>
      <td id="T_38ddf_row0_col1" class="data row0 col1" >84400</td>
      <td id="T_38ddf_row0_col2" class="data row0 col2" >80200</td>
      <td id="T_38ddf_row0_col3" class="data row0 col3" >83000</td>
      <td id="T_38ddf_row0_col4" class="data row0 col4" >38655276</td>
      <td id="T_38ddf_row0_col5" class="data row0 col5" >0.024691</td>
    </tr>
    <tr>
      <th id="T_38ddf_level0_row1" class="row_heading level0 row1" >2021-01-05 00:00:00</th>
      <td id="T_38ddf_row1_col0" class="data row1 col0" >81600</td>
      <td id="T_38ddf_row1_col1" class="data row1 col1" >83900</td>
      <td id="T_38ddf_row1_col2" class="data row1 col2" >81600</td>
      <td id="T_38ddf_row1_col3" class="data row1 col3" >83900</td>
      <td id="T_38ddf_row1_col4" class="data row1 col4" >35335669</td>
      <td id="T_38ddf_row1_col5" class="data row1 col5" >0.010843</td>
    </tr>
    <tr>
      <th id="T_38ddf_level0_row2" class="row_heading level0 row2" >2021-01-06 00:00:00</th>
      <td id="T_38ddf_row2_col0" class="data row2 col0" >83300</td>
      <td id="T_38ddf_row2_col1" class="data row2 col1" >84500</td>
      <td id="T_38ddf_row2_col2" class="data row2 col2" >82100</td>
      <td id="T_38ddf_row2_col3" class="data row2 col3" >82200</td>
      <td id="T_38ddf_row2_col4" class="data row2 col4" >42089013</td>
      <td id="T_38ddf_row2_col5" class="data row2 col5" >-0.020262</td>
    </tr>
    <tr>
      <th id="T_38ddf_level0_row3" class="row_heading level0 row3" >2021-01-07 00:00:00</th>
      <td id="T_38ddf_row3_col0" class="data row3 col0" >82800</td>
      <td id="T_38ddf_row3_col1" class="data row3 col1" >84200</td>
      <td id="T_38ddf_row3_col2" class="data row3 col2" >82700</td>
      <td id="T_38ddf_row3_col3" class="data row3 col3" >82900</td>
      <td id="T_38ddf_row3_col4" class="data row3 col4" >32644642</td>
      <td id="T_38ddf_row3_col5" class="data row3 col5" >0.008516</td>
    </tr>
    <tr>
      <th id="T_38ddf_level0_row4" class="row_heading level0 row4" >2021-01-08 00:00:00</th>
      <td id="T_38ddf_row4_col0" class="data row4 col0" >83300</td>
      <td id="T_38ddf_row4_col1" class="data row4 col1" >90000</td>
      <td id="T_38ddf_row4_col2" class="data row4 col2" >83000</td>
      <td id="T_38ddf_row4_col3" class="data row4 col3" >88800</td>
      <td id="T_38ddf_row4_col4" class="data row4 col4" >59013307</td>
      <td id="T_38ddf_row4_col5" class="data row4 col5" >0.071170</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> K = 0.5 라고 하고 전날의 고가와 저가를 이용하여 변동성 값 V 를 구합니다. 그리고 시가를 더하여 매수가격을 만듭니다. shift(1) 은 바로 위에 있는 row 를 참조하게 됩니다. 따라서 전날 데이터가 됩니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">K</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">K</span>  <span class="c1"># 전날 고가에서 저가를 뺀 값에 K 를 곱함</span>
<span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span>  <span class="c1"># 변동성 값 V 에 당일 시가를 더하여 매수가를 만듦</span>
</pre></div>
</div>
</div>
</div>
<p><br> 만약 buy_price 가 당일 고가와 저가 사이의 값이라면 매수할 기회가 있었을 것입니다. 매수 여부를 ‘buy’ 라는 컬럼에 저장합니다. 그리고 수익율 ‘return’ 을 생성합니다. 수익율은 다음날 시가를 매수가격로 나눈 값이 됩니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 매수 기회 있으면 1 아니면 0</span>
<span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">]</span> <span class="c1"># 다음 날 시가를 이용하여 수익율 계산</span>
</pre></div>
</div>
</div>
</div>
<p><br> 이제 ‘buy’ = 1 인 날의 평균 수익율을 구해봅니다. 0.2% 기대수익율(일) 을 얻을 수 있는 전략입니다. 여기서 기대 수익율이란 매수를 한 날 중 랜덤한 어떤 날의 기대 수익율입니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stock_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;buy&#39;</span><span class="p">)[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>buy
0    0.985780
1    1.002018
Name: return, dtype: float64
</pre></div>
</div>
</div>
</div>
<p><br> 다른 종목도 테스트할 수 있게 이 전략을 함수로 만들어 봅니다. 리턴은 평균수익율(일) 과 최대 손실율(일)로 하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 위 내용을 모아서 함수로 만듦</span>
<span class="k">def</span> <span class="nf">avg_return</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
    <span class="n">stock</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">code</span><span class="p">,</span>  <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2021-01-03&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2021-12-31&#39;</span><span class="p">)</span>    
    <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">K</span>
    <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span>
    <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">stock</span><span class="p">[</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">stock</span><span class="p">[</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

<span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">avg_return</span><span class="p">(</span><span class="s1">&#39;005930&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="c1"># 참고로 아래와 같이 f-string 이용하여 출력을 이쁘게 할 수 있습니다.</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; 평균 수익율: </span><span class="si">{</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">5.2%</span><span class="si">}</span><span class="s1"> 최대 손실: </span><span class="si">{</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">5.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.002018419449279 0.9574350469872858
 평균 수익율: 0.20% 최대 손실: -4.26%
</pre></div>
</div>
</div>
</div>
<p><br> 다른 종목의 결과값도 함 보겠습니다. 네이버(035420)와 현대차(005380)를 함 볼까요? 삼성전자보다 더 안 좋은 결과가 나왔습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">avg_return</span><span class="p">(</span><span class="s1">&#39;035420&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;네이버 평균 수익율: </span><span class="si">{</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">5.2%</span><span class="si">}</span><span class="s1"> 최대 손실: </span><span class="si">{</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">5.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">avg_return</span><span class="p">(</span><span class="s1">&#39;005380&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;현대차 평균 수익율: </span><span class="si">{</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">5.2%</span><span class="si">}</span><span class="s1"> 최대 손실: </span><span class="si">{</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">5.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9902550213520191 0.9214501510574018
네이버 평균 수익율: -0.97% 최대 손실: -7.85%


0.9940220644638738 0.9295499021526419
현대차 평균 수익율: -0.60% 최대 손실: -7.05%
</pre></div>
</div>
</div>
</div>
<p><br> 이번에는 누적 수익율도 궁금합니다. 즉, 2021년 1월 3일 100 원을 투자하면 2021년 12월 31일 얼마가 되어 있을까요? 함수의 리턴 값에 누적 수익율을 추가합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">avg_return</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
    <span class="n">stock</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">code</span><span class="p">,</span>  <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2021-01-03&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2021-12-31&#39;</span><span class="p">)</span>    
    <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">K</span>
    <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span>
    <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">stock</span><span class="p">[</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">stock</span><span class="p">[</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">stock</span><span class="p">[</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span>

<span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">avg_return</span><span class="p">(</span><span class="s1">&#39;005930&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

<span class="c1"># 참고로 아래와 같이 f-string 이용하여 출력을 이쁘게 할 수 있습니다.</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; 평균 수익율: </span><span class="si">{</span><span class="n">a</span><span class="si">:</span><span class="s1">5.2%</span><span class="si">}</span><span class="s1"> 최대 손실: </span><span class="si">{</span><span class="n">b</span><span class="si">:</span><span class="s1">5.2%</span><span class="si">}</span><span class="s1"> 누적수익율: </span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s1">5.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.002018419449279 0.9574350469872858 1.1843972916348044
 평균 수익율: 100.20% 최대 손실: 95.74% 누적수익율: 118.44%
</pre></div>
</div>
</div>
</div>
<p><br> 네이버의 누적 수익율은 58.2%, 현대차의 누적 수익율은 38.7% 입니다. 즉 2021년 초에 각 각 100 원을 투자했다면 연말에 네이버는 40원, 현대차는 56원이 되어 있습니다. 실제 장에서는 원하는 가격에 매수 매도를 할 수 없으므로 실전 수익율은 아니겠지만 예상 수익율을 추정해 볼 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">avg_return</span><span class="p">(</span><span class="s1">&#39;035420&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;네이버 평균 수익율: </span><span class="si">{</span><span class="n">a</span><span class="si">:</span><span class="s1">5.2%</span><span class="si">}</span><span class="s1"> 최대 손실: </span><span class="si">{</span><span class="n">b</span><span class="si">:</span><span class="s1">5.2%</span><span class="si">}</span><span class="s1"> 누적수익율: </span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s1">5.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">avg_return</span><span class="p">(</span><span class="s1">&#39;005380&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;현대차 평균 수익율: </span><span class="si">{</span><span class="n">a</span><span class="si">:</span><span class="s1">5.2%</span><span class="si">}</span><span class="s1"> 최대 손실: </span><span class="si">{</span><span class="n">b</span><span class="si">:</span><span class="s1">5.2%</span><span class="si">}</span><span class="s1"> 누적수익율: </span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s1">5.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>네이버 평균 수익율: 99.03% 최대 손실: 92.15% 누적수익율: 40.87%
현대차 평균 수익율: 99.40% 최대 손실: 92.95% 누적수익율: 56.69%
</pre></div>
</div>
</div>
</div>
</section>
<section id="k">
<h3>K 값 찾기<a class="headerlink" href="#k" title="Permalink to this headline">#</a></h3>
<p>이전 단원에서 래리 윌리암스의 변동성 돌파전략을 파이썬으로 구현해봤습니다. K 값을 왜 0.5 로 했을까? 다른 K 는 어떨까 궁금해 집니다. 래리윌리암스는 K 값을 0.4 ~ 0.6 으로 추천했습니다. K 가 높아지면 매수 가격이 올라가므로 매수가격에 살 수 있는 기회가 적어지는 문제가 있습니다. K 가 낮아지면 쉽게 매수를 하므로 과연 변동성 돌파를 하고 있는지 의심이 듭니다. 이 번에는 삼성전자 K 값이 얼마일 때, 가장 좋은 결과가 나오는 지 알아보겠습니다. 삼성전자 2021년 일봉과 전 단원에서 만들어 놓은 함수를 가져옵니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span> 

<span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;005930&#39;</span> <span class="c1"># 삼성전자</span>
<span class="n">stock_data</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2021-01-03&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2021-12-31&#39;</span><span class="p">)</span> 
<span class="n">stock_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_7e6ec_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >Open</th>
      <th class="col_heading level0 col1" >High</th>
      <th class="col_heading level0 col2" >Low</th>
      <th class="col_heading level0 col3" >Close</th>
      <th class="col_heading level0 col4" >Volume</th>
      <th class="col_heading level0 col5" >Change</th>
    </tr>
    <tr>
      <th class="index_name level0" >Date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_7e6ec_level0_row0" class="row_heading level0 row0" >2021-01-04 00:00:00</th>
      <td id="T_7e6ec_row0_col0" class="data row0 col0" >81000</td>
      <td id="T_7e6ec_row0_col1" class="data row0 col1" >84400</td>
      <td id="T_7e6ec_row0_col2" class="data row0 col2" >80200</td>
      <td id="T_7e6ec_row0_col3" class="data row0 col3" >83000</td>
      <td id="T_7e6ec_row0_col4" class="data row0 col4" >38655276</td>
      <td id="T_7e6ec_row0_col5" class="data row0 col5" >0.024691</td>
    </tr>
    <tr>
      <th id="T_7e6ec_level0_row1" class="row_heading level0 row1" >2021-01-05 00:00:00</th>
      <td id="T_7e6ec_row1_col0" class="data row1 col0" >81600</td>
      <td id="T_7e6ec_row1_col1" class="data row1 col1" >83900</td>
      <td id="T_7e6ec_row1_col2" class="data row1 col2" >81600</td>
      <td id="T_7e6ec_row1_col3" class="data row1 col3" >83900</td>
      <td id="T_7e6ec_row1_col4" class="data row1 col4" >35335669</td>
      <td id="T_7e6ec_row1_col5" class="data row1 col5" >0.010843</td>
    </tr>
    <tr>
      <th id="T_7e6ec_level0_row2" class="row_heading level0 row2" >2021-01-06 00:00:00</th>
      <td id="T_7e6ec_row2_col0" class="data row2 col0" >83300</td>
      <td id="T_7e6ec_row2_col1" class="data row2 col1" >84500</td>
      <td id="T_7e6ec_row2_col2" class="data row2 col2" >82100</td>
      <td id="T_7e6ec_row2_col3" class="data row2 col3" >82200</td>
      <td id="T_7e6ec_row2_col4" class="data row2 col4" >42089013</td>
      <td id="T_7e6ec_row2_col5" class="data row2 col5" >-0.020262</td>
    </tr>
    <tr>
      <th id="T_7e6ec_level0_row3" class="row_heading level0 row3" >2021-01-07 00:00:00</th>
      <td id="T_7e6ec_row3_col0" class="data row3 col0" >82800</td>
      <td id="T_7e6ec_row3_col1" class="data row3 col1" >84200</td>
      <td id="T_7e6ec_row3_col2" class="data row3 col2" >82700</td>
      <td id="T_7e6ec_row3_col3" class="data row3 col3" >82900</td>
      <td id="T_7e6ec_row3_col4" class="data row3 col4" >32644642</td>
      <td id="T_7e6ec_row3_col5" class="data row3 col5" >0.008516</td>
    </tr>
    <tr>
      <th id="T_7e6ec_level0_row4" class="row_heading level0 row4" >2021-01-08 00:00:00</th>
      <td id="T_7e6ec_row4_col0" class="data row4 col0" >83300</td>
      <td id="T_7e6ec_row4_col1" class="data row4 col1" >90000</td>
      <td id="T_7e6ec_row4_col2" class="data row4 col2" >83000</td>
      <td id="T_7e6ec_row4_col3" class="data row4 col3" >88800</td>
      <td id="T_7e6ec_row4_col4" class="data row4 col4" >59013307</td>
      <td id="T_7e6ec_row4_col5" class="data row4 col5" >0.071170</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">avg_return</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
    <span class="n">stock</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">code</span><span class="p">,</span>  <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2021-01-03&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2021-12-31&#39;</span><span class="p">)</span>    
    <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">K</span>
    <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span>
    <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">stock</span><span class="p">[</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">stock</span><span class="p">[</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

<span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">avg_return</span><span class="p">(</span><span class="s1">&#39;005930&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; 평균 수익율: </span><span class="si">{</span><span class="n">a</span><span class="si">:</span><span class="s1">5.2%</span><span class="si">}</span><span class="s1"> 최대 손실: </span><span class="si">{</span><span class="n">b</span><span class="si">:</span><span class="s1">5.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 평균 수익율: 100.20% 최대 손실: 95.74%
</pre></div>
</div>
</div>
</div>
<p><br> 이제 K 를 조금씩 올려가면서 평균 수익율이 최대가 되는 지점을 알아보겠습니다. K 늘 조금씩 증가시켜가면서 For Loop 를 이용하면 좋을 것 같습니다. 그리고 각 K 에서 평균수익율과 최대손실을 list 에 담습니다.
테스트 할 K 는 numpy 에서 제공하는 linspace(시작 값, 종료 값) 를 이용합니다. linspace 는 num(인수 중 하나) 을 지정하지 않으면 50개의 등 간격 구간으로 된 list 를 반환합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Line space Test</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">k_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">r_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">w_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)):</span> <span class="c1"># 0.2 ~ 0.8 까지 50 구간 list </span>
    <span class="n">r</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">avg_return</span><span class="p">(</span><span class="s1">&#39;005930&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

    <span class="n">k_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>       
    <span class="n">r_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">w_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

    
<span class="n">outcome</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="n">k_list</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">r_list</span><span class="p">,</span> <span class="s1">&#39;worst&#39;</span><span class="p">:</span> <span class="n">w_list</span><span class="p">})</span>    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.         0.11111111 0.22222222 0.33333333 0.44444444 0.55555556
 0.66666667 0.77777778 0.88888889 1.        ]
</pre></div>
</div>
</div>
</div>
<p><br>위 50 개 결과를 Pandas Plot 그려보겠습니다. 파란색 라인이 평균 기대 수익율이고 빨간색 라인이 최대 손실입니다. 둘 다 값이 높아야 좋은 전략일 것 입니다. 그래프를 보시면 K = 0.4 보다는 k = 0.6 이 더 좋은 선택으로 판단됩니다. 기대 수익율이 제일 높은 K 는 0.67 입니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">outcome</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">)[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">outcome</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">)[</span><span class="s1">&#39;worst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Avergage Return vs. The Worst Return&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Avg. Return&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;The Worst Return&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2.4.1_Volatility_Breakout_22_0.png" src="_images/2.4.1_Volatility_Breakout_22_0.png" />
</div>
</div>
<p><br> 이번에는 위 라인을 rolling 을 이용하여 부드럽게 해 보겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">outcome</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">)[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">outcome</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">)[</span><span class="s1">&#39;worst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Avergage Return vs. The Worst Return&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Avg. Return&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;The Worst Return&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2.4.1_Volatility_Breakout_24_0.png" src="_images/2.4.1_Volatility_Breakout_24_0.png" />
</div>
</div>
<p>2021년 데이터에서는 K 가 0.4 근처보다는 0.6 근처가 더 좋은 전략으로 관찰되었습니다. 과연 2022년도 그럴지 궁금합니다. 2022년 1분기 데이터를 이용해 보겠습니다. 다른 결과가 나왔습니다. K= 0.5 가 더 좋은 것 같습니다. 과거에 좋은 K 가 현재에도 좋은 K 가 아닌 것 같습니다. 단순이 과거 K 를 이용하는 것이 좋은 방법이 아니라는 것을 알았습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">avg_return</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
    <span class="n">stock</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">code</span><span class="p">,</span>  <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2022-01-03&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2022-03-31&#39;</span><span class="p">)</span>    <span class="c1"># 2022년 1분기 데이터</span>
    <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">K</span>
    <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span>
    <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">stock</span><span class="p">[</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">stock</span><span class="p">[</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

<span class="n">k_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">r_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">w_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)):</span> <span class="c1"># 0.2 ~ 0.8 까지 50 구간 list </span>
    <span class="n">r</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">avg_return</span><span class="p">(</span><span class="s1">&#39;005930&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

    <span class="n">k_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>       
    <span class="n">r_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">w_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    
<span class="n">outcome</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="n">k_list</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">r_list</span><span class="p">,</span> <span class="s1">&#39;worst&#39;</span><span class="p">:</span> <span class="n">w_list</span><span class="p">})</span>   

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">outcome</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">)[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">outcome</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">)[</span><span class="s1">&#39;worst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Avergage Return vs. The Worst Return&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Avg. Return&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;The Worst Return&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2.4.1_Volatility_Breakout_26_0.png" src="_images/2.4.1_Volatility_Breakout_26_0.png" />
</div>
</div>
</section>
<section id="id2">
<h3>종목 찾기<a class="headerlink" href="#id2" title="Permalink to this headline">#</a></h3>
<p>이전 단원에서 최적의 K 를 찾아보았는데요. 이번에는 K 를 고정하고 최적의 종목을 찾아보겠습니다. 코스피로 한정해서 종목을 찾아보겠습니다. FinanceDataReaer 의 StockListing 메소드의 인수로 ‘KOSPI’ 를 넣으면 코스피 모든 종목을 반환합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span> 
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">kospi_df</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">StockListing</span><span class="p">(</span><span class="s1">&#39;KOSPI&#39;</span><span class="p">)</span>
<span class="n">kospi_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_8998e_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >Symbol</th>
      <th class="col_heading level0 col1" >Market</th>
      <th class="col_heading level0 col2" >Name</th>
      <th class="col_heading level0 col3" >Sector</th>
      <th class="col_heading level0 col4" >Industry</th>
      <th class="col_heading level0 col5" >ListingDate</th>
      <th class="col_heading level0 col6" >SettleMonth</th>
      <th class="col_heading level0 col7" >Representative</th>
      <th class="col_heading level0 col8" >HomePage</th>
      <th class="col_heading level0 col9" >Region</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_8998e_level0_row0" class="row_heading level0 row0" >1</th>
      <td id="T_8998e_row0_col0" class="data row0 col0" >095570</td>
      <td id="T_8998e_row0_col1" class="data row0 col1" >KOSPI</td>
      <td id="T_8998e_row0_col2" class="data row0 col2" >AJ네트웍스</td>
      <td id="T_8998e_row0_col3" class="data row0 col3" >산업용 기계 및 장비 임대업</td>
      <td id="T_8998e_row0_col4" class="data row0 col4" >렌탈(파렛트, OA장비, 건설장비)</td>
      <td id="T_8998e_row0_col5" class="data row0 col5" >2015-08-21 00:00:00</td>
      <td id="T_8998e_row0_col6" class="data row0 col6" >12월</td>
      <td id="T_8998e_row0_col7" class="data row0 col7" >박대현, 손삼달</td>
      <td id="T_8998e_row0_col8" class="data row0 col8" >http://www.ajnet.co.kr</td>
      <td id="T_8998e_row0_col9" class="data row0 col9" >서울특별시</td>
    </tr>
    <tr>
      <th id="T_8998e_level0_row1" class="row_heading level0 row1" >2</th>
      <td id="T_8998e_row1_col0" class="data row1 col0" >006840</td>
      <td id="T_8998e_row1_col1" class="data row1 col1" >KOSPI</td>
      <td id="T_8998e_row1_col2" class="data row1 col2" >AK홀딩스</td>
      <td id="T_8998e_row1_col3" class="data row1 col3" >기타 금융업</td>
      <td id="T_8998e_row1_col4" class="data row1 col4" >지주사업</td>
      <td id="T_8998e_row1_col5" class="data row1 col5" >1999-08-11 00:00:00</td>
      <td id="T_8998e_row1_col6" class="data row1 col6" >12월</td>
      <td id="T_8998e_row1_col7" class="data row1 col7" >채형석, 이석주(각자 대표이사)</td>
      <td id="T_8998e_row1_col8" class="data row1 col8" >http://www.aekyunggroup.co.kr</td>
      <td id="T_8998e_row1_col9" class="data row1 col9" >서울특별시</td>
    </tr>
    <tr>
      <th id="T_8998e_level0_row2" class="row_heading level0 row2" >6</th>
      <td id="T_8998e_row2_col0" class="data row2 col0" >152100</td>
      <td id="T_8998e_row2_col1" class="data row2 col1" >KOSPI</td>
      <td id="T_8998e_row2_col2" class="data row2 col2" >ARIRANG 200</td>
      <td id="T_8998e_row2_col3" class="data row2 col3" >nan</td>
      <td id="T_8998e_row2_col4" class="data row2 col4" >nan</td>
      <td id="T_8998e_row2_col5" class="data row2 col5" >NaT</td>
      <td id="T_8998e_row2_col6" class="data row2 col6" >nan</td>
      <td id="T_8998e_row2_col7" class="data row2 col7" >nan</td>
      <td id="T_8998e_row2_col8" class="data row2 col8" >nan</td>
      <td id="T_8998e_row2_col9" class="data row2 col9" >nan</td>
    </tr>
    <tr>
      <th id="T_8998e_level0_row3" class="row_heading level0 row3" >7</th>
      <td id="T_8998e_row3_col0" class="data row3 col0" >295820</td>
      <td id="T_8998e_row3_col1" class="data row3 col1" >KOSPI</td>
      <td id="T_8998e_row3_col2" class="data row3 col2" >ARIRANG 200동일가중</td>
      <td id="T_8998e_row3_col3" class="data row3 col3" >nan</td>
      <td id="T_8998e_row3_col4" class="data row3 col4" >nan</td>
      <td id="T_8998e_row3_col5" class="data row3 col5" >NaT</td>
      <td id="T_8998e_row3_col6" class="data row3 col6" >nan</td>
      <td id="T_8998e_row3_col7" class="data row3 col7" >nan</td>
      <td id="T_8998e_row3_col8" class="data row3 col8" >nan</td>
      <td id="T_8998e_row3_col9" class="data row3 col9" >nan</td>
    </tr>
    <tr>
      <th id="T_8998e_level0_row4" class="row_heading level0 row4" >8</th>
      <td id="T_8998e_row4_col0" class="data row4 col0" >253150</td>
      <td id="T_8998e_row4_col1" class="data row4 col1" >KOSPI</td>
      <td id="T_8998e_row4_col2" class="data row4 col2" >ARIRANG 200선물레버리지</td>
      <td id="T_8998e_row4_col3" class="data row4 col3" >nan</td>
      <td id="T_8998e_row4_col4" class="data row4 col4" >nan</td>
      <td id="T_8998e_row4_col5" class="data row4 col5" >NaT</td>
      <td id="T_8998e_row4_col6" class="data row4 col6" >nan</td>
      <td id="T_8998e_row4_col7" class="data row4 col7" >nan</td>
      <td id="T_8998e_row4_col8" class="data row4 col8" >nan</td>
      <td id="T_8998e_row4_col9" class="data row4 col9" >nan</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> nunique() 은 유니크한 종목 수를 세는 메소드입니다. 6,361 개의 종목이 있습니다. Sector 가 비어있는 종목의 경우는 일반적인 회사의 종목이 아닌 것인 것으로 보입니다. Sector 가 비어있는 종목은 제외하겠습니다. 이제 820 개의 종목만 남았습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">kospi_df</span><span class="p">[</span><span class="s1">&#39;Symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">kospi_df</span><span class="p">[</span><span class="o">~</span><span class="n">kospi_df</span><span class="p">[</span><span class="s1">&#39;Sector&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][</span><span class="s1">&#39;Symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6151
821
</pre></div>
</div>
</div>
</div>
<p><br> kospi_df 에서 필요한 컬럼 ‘Symbol’ 과 ‘Name’ 두 개만 kospi_list DataFrame 에 저장합니다. 그리고 종목코드 ‘Symbol’ 과 ‘Name’ 을 각 각 ‘code’ 외 ‘name’ 으로 바꿔줍니다. 그리고 나중을 위해서 결과물을 pickle 파일로 저장도 합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kospi_list</span> <span class="o">=</span> <span class="n">kospi_df</span><span class="p">[</span><span class="o">~</span><span class="n">kospi_df</span><span class="p">[</span><span class="s1">&#39;Sector&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()][[</span><span class="s1">&#39;Symbol&#39;</span><span class="p">,</span><span class="s1">&#39;Name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Symbol&#39;</span><span class="p">:</span><span class="s1">&#39;code&#39;</span><span class="p">,</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span><span class="s1">&#39;name&#39;</span><span class="p">})</span>
<span class="n">kospi_list</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;kospi_list.pkl&#39;</span><span class="p">)</span>
<span class="n">kospi_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kospi_list.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><br> 이제 변동성 돌파 전략의 수익율을 계산하는 함수를 불러옵니다. 일단 K 는 0.5 로 고정합니다. 모든 코스피 종목을 For-Loop 하면서 가장 수익율이 좋은 종목을 찾으면 됩니다. Loop 를 돌 때마다 종목이름, 종목코드, 평균수익율, 최대손실, 누적수익율을 list 에 저장합니다. 마지막으로 모든 list 를 모아서 하나의 DataFrame 으로 저장합니다. 800 개가 넘는 종목을 Loop 로 하나 씩 하니 시간이 많이 걸립니다. time 모듈을 이용해 총 데이터 처리시간도 측정해 봅니다. 2021년 변동성 돌파전략으로 매수할 수 있는 날이 50일 미만 경우는 무시하도록 if 문을 만들었습니다. 최종 결과를 pickle 로 저장합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">K</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="k">def</span> <span class="nf">avg_r2</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">K</span><span class="p">):</span>
    <span class="n">stock</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">code</span><span class="p">,</span>  <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2021-01-03&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2021-12-31&#39;</span><span class="p">)</span>    
    <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">K</span>
    <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span>
    <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stock</span><span class="p">[</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">stock</span><span class="p">[</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">stock</span><span class="p">[</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">stock</span><span class="p">[</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span>

<span class="n">code_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">name_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">return_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">worst_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">cumul_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kospi_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> <span class="n">kospi_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]):</span>

    <span class="n">n</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">avg_r2</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">:</span> <span class="c1"># 최소한 50일 이상 거래일 존재해야 진행</span>

        <span class="n">code_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="n">name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">return_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">worst_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="n">cumul_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="k">continue</span>

<span class="n">outcome</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">code_list</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name_list</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">return_list</span><span class="p">,</span> <span class="s1">&#39;worst&#39;</span><span class="p">:</span> <span class="n">worst_list</span><span class="p">,</span> <span class="s1">&#39;cumul&#39;</span><span class="p">:</span> <span class="n">cumul_list</span><span class="p">})</span>    
<span class="n">outcome</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;outcome.pkl&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;총 프로세싱 시간 </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>총 프로세싱 시간 125.55444192886353
</pre></div>
</div>
</div>
</div>
<p><br> 저장된 결과물 outcome 을 ‘return’ 값의 내림차순으로 함 보겠습니다. 수익율이 좋은 종목 Top 3 는 ‘조일알미늄’, ‘한전기술’, ‘포스코스틸리온’ 이였습니다. Top 10 에서 최대손실율을 동시에 고려하면, 2021년에는 ‘미원화학’이 좋아 보입니다. 미원화학을 2021년 초부터 변동성 돌파전략으로 매수 매도를 했으면 2021년 연말에는 원금의 2.9배가 되어 있었을 것입니다. 하지만, 지나간 일입니다. 이 책의 4장부터는 데이터 분석으로 미래를 예측하는 방법을 다룹니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">outcome</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_7602d_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >code</th>
      <th class="col_heading level0 col1" >name</th>
      <th class="col_heading level0 col2" >return</th>
      <th class="col_heading level0 col3" >worst</th>
      <th class="col_heading level0 col4" >cumul</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_7602d_level0_row0" class="row_heading level0 row0" >570</th>
      <td id="T_7602d_row0_col0" class="data row0 col0" >018470</td>
      <td id="T_7602d_row0_col1" class="data row0 col1" >조일알미늄</td>
      <td id="T_7602d_row0_col2" class="data row0 col2" >1.017648</td>
      <td id="T_7602d_row0_col3" class="data row0 col3" >0.907132</td>
      <td id="T_7602d_row0_col4" class="data row0 col4" >4.549524</td>
    </tr>
    <tr>
      <th id="T_7602d_level0_row1" class="row_heading level0 row1" >722</th>
      <td id="T_7602d_row1_col0" class="data row1 col0" >052690</td>
      <td id="T_7602d_row1_col1" class="data row1 col1" >한전기술</td>
      <td id="T_7602d_row1_col2" class="data row1 col2" >1.017243</td>
      <td id="T_7602d_row1_col3" class="data row1 col3" >0.932258</td>
      <td id="T_7602d_row1_col4" class="data row1 col4" >5.318219</td>
    </tr>
    <tr>
      <th id="T_7602d_level0_row2" class="row_heading level0 row2" >645</th>
      <td id="T_7602d_row2_col0" class="data row2 col0" >058430</td>
      <td id="T_7602d_row2_col1" class="data row2 col1" >포스코스틸리온</td>
      <td id="T_7602d_row2_col2" class="data row2 col2" >1.016921</td>
      <td id="T_7602d_row2_col3" class="data row2 col3" >0.868904</td>
      <td id="T_7602d_row2_col4" class="data row2 col4" >3.838723</td>
    </tr>
    <tr>
      <th id="T_7602d_level0_row3" class="row_heading level0 row3" >275</th>
      <td id="T_7602d_row3_col0" class="data row3 col0" >092200</td>
      <td id="T_7602d_row3_col1" class="data row3 col1" >디아이씨</td>
      <td id="T_7602d_row3_col2" class="data row3 col2" >1.016628</td>
      <td id="T_7602d_row3_col3" class="data row3 col3" >0.896846</td>
      <td id="T_7602d_row3_col4" class="data row3 col4" >3.478830</td>
    </tr>
    <tr>
      <th id="T_7602d_level0_row4" class="row_heading level0 row4" >546</th>
      <td id="T_7602d_row4_col0" class="data row4 col0" >008500</td>
      <td id="T_7602d_row4_col1" class="data row4 col1" >일정실업</td>
      <td id="T_7602d_row4_col2" class="data row4 col2" >1.016182</td>
      <td id="T_7602d_row4_col3" class="data row4 col3" >0.928633</td>
      <td id="T_7602d_row4_col4" class="data row4 col4" >4.006988</td>
    </tr>
    <tr>
      <th id="T_7602d_level0_row5" class="row_heading level0 row5" >318</th>
      <td id="T_7602d_row5_col0" class="data row5 col0" >134380</td>
      <td id="T_7602d_row5_col1" class="data row5 col1" >미원화학</td>
      <td id="T_7602d_row5_col2" class="data row5 col2" >1.015959</td>
      <td id="T_7602d_row5_col3" class="data row5 col3" >0.966864</td>
      <td id="T_7602d_row5_col4" class="data row5 col4" >2.918914</td>
    </tr>
    <tr>
      <th id="T_7602d_level0_row6" class="row_heading level0 row6" >667</th>
      <td id="T_7602d_row6_col0" class="data row6 col0" >004090</td>
      <td id="T_7602d_row6_col1" class="data row6 col1" >한국석유</td>
      <td id="T_7602d_row6_col2" class="data row6 col2" >1.015428</td>
      <td id="T_7602d_row6_col3" class="data row6 col3" >0.914433</td>
      <td id="T_7602d_row6_col4" class="data row6 col4" >2.984814</td>
    </tr>
    <tr>
      <th id="T_7602d_level0_row7" class="row_heading level0 row7" >773</th>
      <td id="T_7602d_row7_col0" class="data row7 col0" >010690</td>
      <td id="T_7602d_row7_col1" class="data row7 col1" >화신</td>
      <td id="T_7602d_row7_col2" class="data row7 col2" >1.014677</td>
      <td id="T_7602d_row7_col3" class="data row7 col3" >0.921250</td>
      <td id="T_7602d_row7_col4" class="data row7 col4" >3.405889</td>
    </tr>
    <tr>
      <th id="T_7602d_level0_row8" class="row_heading level0 row8" >226</th>
      <td id="T_7602d_row8_col0" class="data row8 col0" >001440</td>
      <td id="T_7602d_row8_col1" class="data row8 col1" >대한전선</td>
      <td id="T_7602d_row8_col2" class="data row8 col2" >1.014668</td>
      <td id="T_7602d_row8_col3" class="data row8 col3" >0.706109</td>
      <td id="T_7602d_row8_col4" class="data row8 col4" >3.403380</td>
    </tr>
    <tr>
      <th id="T_7602d_level0_row9" class="row_heading level0 row9" >594</th>
      <td id="T_7602d_row9_col0" class="data row9 col0" >001620</td>
      <td id="T_7602d_row9_col1" class="data row9 col1" >케이비아이동국실업</td>
      <td id="T_7602d_row9_col2" class="data row9 col2" >1.014626</td>
      <td id="T_7602d_row9_col3" class="data row9 col3" >0.932897</td>
      <td id="T_7602d_row9_col4" class="data row9 col4" >3.121872</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> 미원화학의 2021년 주가흐름을 함 보겠습니다. 2021년 3월에 급등이 있었습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;134380&#39;</span> <span class="c1"># 미원화학</span>
<span class="n">stock_data</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2021-01-03&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2021-12-31&#39;</span><span class="p">)</span> 
<span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;Date&#39;&gt;
</pre></div>
</div>
<img alt="_images/2.4.1_Volatility_Breakout_38_1.png" src="_images/2.4.1_Volatility_Breakout_38_1.png" />
</div>
</div>
</section>
<span id="document-chapter2/2.4.2_Volatility_Breakout"></span><section id="id1">
<h3>변동성 돌파전략 2<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>외부 데이터를 이용하여 윌리암스의 변동성 돌파전략을 개선해보겠습니다.</p>
</section>
<section id="id2">
<h3>주가지수 데이터로 전략 개선<a class="headerlink" href="#id2" title="Permalink to this headline">#</a></h3>
<p>변동성 돌파전략은 시장이 좋을 때 활용하면 효과가 더 좋을 것 같습니다. 아무래도 상승장에서는 전일의 변동성을 돌파할 올라갈 확률이 높지 않을까요? 코스피 주가지수 데이터를 불러와서, 전일 코스피 주가지수의 수익율(종가 기준) 2%이상 발생한 경우만 매수를  하면 어떤 결과가 나오는 지 테스트 해 보겠습니다. 매수일을 기준으로 2% 수익률이상으로 하면 더 좋을 것 같으나, 매수일의 종가 기준 수익율은 알 수 가 없기 때문에 전일을 기준으로 합니다. 먼저 지수데이터를 가져와서 종가 수익율을 계산합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span> 
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">kospi_index</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s1">&#39;KS11&#39;</span><span class="p">,</span>  <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2021-01-03&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2021-12-31&#39;</span><span class="p">)</span> 
<span class="n">kospi_index</span><span class="p">[</span><span class="s1">&#39;kospi_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kospi_index</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">kospi_index</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">kospi_index</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;kospi_index.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>지수 데이터를 이용하면, 조건이 추가되므로 매수할 기회가 적어집니다. 지수데이터를 이용함으로써 예상수익율(일)이 0.3% 에서 1.6% 으로 올라갔습니다. 예상 최저수익율도 올라가서 리스크를 상당히 줄일 수 가 있습니다. 단, 매수 횟 수가 낮아 누적 수익율도 낮아졌습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kospi_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kospi_index.pkl&#39;</span><span class="p">)</span>
<span class="n">kospi_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kospi_list.pkl&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">avg_return</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">deci</span><span class="p">):</span>
    
    <span class="n">stock</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2021-01-03&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2021-12-31&#39;</span><span class="p">)</span>       
    <span class="n">stock_data</span> <span class="o">=</span> <span class="n">stock</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">kospi_index</span><span class="p">[</span><span class="s1">&#39;kospi_return&#39;</span><span class="p">],</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
    <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">K</span>
    <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span>
    <span class="n">stock_data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># shift함수 이용으로 생긴 빈 셀 제거</span>
    
    <span class="k">if</span> <span class="n">deci</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># 지수 데이터를 이용한 경우</span>
        <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;kospi_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.02</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        
    <span class="k">else</span><span class="p">:</span> <span class="c1"># 지수 데이터를 이용하지 않은 경우 </span>
        <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        
    <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">]</span>
    
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stock_data</span><span class="p">[</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">stock_data</span><span class="p">[</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">stock_data</span><span class="p">[</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">stock_data</span><span class="p">[</span><span class="n">stock_data</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span>


<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------- 지수 데이터를 이용하지 않은 경우 ---------------&#39;</span><span class="p">)</span>
<span class="n">symbol_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">name_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">obs_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">return_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">worst_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">cumul_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kospi_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span>  <span class="n">kospi_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]):</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">avg_return</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1"># 수익율 값이 존재하고, 최소한 한번 이상 거래일 존재해야 진행</span>
        <span class="n">symbol_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="n">name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">obs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>  <span class="c1"># 매수 횟 수</span>
        <span class="n">return_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>    
        <span class="n">worst_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="n">cumul_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="k">continue</span>
    
<span class="n">outcome_0</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol_list</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name_list</span><span class="p">,</span> <span class="s1">&#39;num_obs&#39;</span><span class="p">:</span> <span class="n">obs_list</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">return_list</span><span class="p">,</span> <span class="s1">&#39;worst&#39;</span><span class="p">:</span> <span class="n">worst_list</span><span class="p">,</span> <span class="s1">&#39;cumul&#39;</span><span class="p">:</span> <span class="n">cumul_list</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">outcome_0</span><span class="p">[[</span><span class="s1">&#39;num_obs&#39;</span><span class="p">,</span><span class="s1">&#39;return&#39;</span><span class="p">,</span><span class="s1">&#39;worst&#39;</span><span class="p">,</span><span class="s1">&#39;cumul&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;------------- 지수 데이터를 이용한 경우 ---------------&#39;</span><span class="p">)</span>
<span class="n">symbol_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">name_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">obs_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">return_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">worst_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">cumul_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kospi_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">][:</span><span class="mi">50</span><span class="p">],</span>  <span class="n">kospi_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][:</span><span class="mi">50</span><span class="p">]):</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">avg_return</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>    
   
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">:</span>  <span class="c1"># 수익율 값이 존재하고, 최소한 한번 이상 거래일 존재해야 진행</span>
        <span class="n">symbol_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="n">name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">obs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="c1"># 매수 횟 수</span>
        <span class="n">return_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>    
        <span class="n">worst_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="n">cumul_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="k">continue</span>
    
<span class="n">outcome_1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">symbol_list</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name_list</span><span class="p">,</span>  <span class="s1">&#39;num_obs&#39;</span><span class="p">:</span> <span class="n">obs_list</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span> <span class="n">return_list</span><span class="p">,</span> <span class="s1">&#39;worst&#39;</span><span class="p">:</span> <span class="n">worst_list</span><span class="p">,</span> <span class="s1">&#39;cumul&#39;</span><span class="p">:</span> <span class="n">cumul_list</span><span class="p">})</span>  
<span class="nb">print</span><span class="p">(</span><span class="n">outcome_1</span><span class="p">[[</span><span class="s1">&#39;num_obs&#39;</span><span class="p">,</span><span class="s1">&#39;return&#39;</span><span class="p">,</span><span class="s1">&#39;worst&#39;</span><span class="p">,</span><span class="s1">&#39;cumul&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>------------- 지수 데이터를 이용하지 않은 경우 ---------------
          num_obs      return       worst       cumul
count  813.000000  813.000000  813.000000  813.000000
mean    92.398524    1.003090    0.901086    1.327235
std     15.477971    0.004127    0.143681    0.538553
min      2.000000    0.972844    0.000000    0.000000
25%     88.000000    1.000790    0.898420    1.043979
50%     94.000000    1.002838    0.931694    1.255082
75%    101.000000    1.005134    0.953390    1.514587
max    127.000000    1.017648    1.000000    5.318219


------------- 지수 데이터를 이용한 경우 ---------------
         num_obs     return      worst      cumul
count  49.000000  49.000000  49.000000  49.000000
mean    2.632653   1.016589   0.999325   1.040317
std     0.950743   0.019532   0.023266   0.044871
min     1.000000   0.975929   0.930901   0.927857
25%     2.000000   1.005605   0.984810   1.015540
50%     3.000000   1.011357   1.000000   1.029940
75%     3.000000   1.025377   1.010989   1.060224
max     4.000000   1.095283   1.066127   1.184608
</pre></div>
</div>
</div>
</div>
</section>
</div>
</section>
</div>
<div class="toctree-wrapper compound">
<span id="document-chapter3/3.1.0_Use_Case"></span><section id="id1">
<h2><strong>데이터분석 활용사례</strong><a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<p>데이터 분석이 현장에서 어떻게 활용되고 있는 지 산업별로 케이스를 만들어 보았습니다.</p>
<div class="toctree-wrapper compound">
<span id="document-chapter3/3.1.1_Use_Case"></span><section id="id1">
<h3>보험사 사례<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>산업 분야과 관계없이 데이터분석가로 일하는 과정은 대부분 비슷한 일련의 과정을 겪습니다.</p>
<ol class="simple">
<li><p>문제점 파악</p></li>
<li><p>정보 수집 및 전문가 인터뷰</p></li>
<li><p>가설 설정</p></li>
<li><p>가설 검증을 위한 데이터 수집 및 분석</p></li>
<li><p>검정과정에서 발견된 결과을 이용하여 해결책 개발</p></li>
<li><p>해결책 테스트 및 해결책의 효과 측정</p></li>
</ol>
<p>쉬운 이해를 위하여 보험회사 사례를 들어보겠습니다. 보험회사 영업회의 시간입니다. 영업 상무님이 코로나로 대면 채널이 어려워 텔레마케팅을 시도해 볼 계획인데, 워낙 반응율이 낮아(반응율 1%, 즉 100 명에게 전화하면 1명이 보험가입), 걱정이라고 하십니다. 그리고 신입 데이터사이언티스인 홍철에게 좋은 방법이 있겠냐고 물어봅니다. 홍철은 고민하다가</p>
<p>(1) 문제점파악: 전화로 보험을 잘 구매할 고객 군을 타겟팅해서 텔레마케팅을 하면 어떻겠냐고 대답합니다. 상무님은 그게 된다면 좋겠지만, 가능하겠냐고 반문하셨고. 이런 저런 이야기로 회의가 마무리 되었습니다. 홍철은 회의 후 자리로 돌아와 고민에 빠졌습니다. 신입으로 데이터사이언티스의 가치를 보여줄 좋은 기회인데, 어떻게 텔레마케팅에 반응율이 좋은 고객군을 찾아낼 수 있을까?</p>
<p>(2) 정보 수집 및 전문가 인터뷰: 일단 전화영업 담당자 인터뷰를 통해 관련 지식과 가설 설정에 도움이 될 만한 정보를 수집해 봅니다. 전화영업 담당자는 주로 인구통계에 의한 결과를 공유해 줍니다. 고령자고, 남성이 더 반응율이 좋다고 합니다. 아주 좋은 정보를 얻었습니다. 또 다른 담당자를 만났습니다. 이 분은 누구에게 전화를 하는 것보다는 어떤 텔레마케터가 전화를 하느냐가 더 중요하다고 합니다. 성과가 좋은 텔레마케터는 연령대에 상관없이 좋은 반응율을 보인다고 합니다. 또 좋은 정보를 얻었습니다. 텔레마케터 지인이 있어, 개인적으로 만나봤습니다. 이 분은 일단 전화를 받을 시간이 있는 사람에게 전화를 해야 한다고 합니다. 아무래도 블루칼라보다는 사무직이 전화받을 시간이 있는 것 같다라고 귀띰을 해 줍니다. 홍철은 소득에 관련해서도 물어봅니다. 하지만 전화를 받는 사람의 소득은 잘 모르겠다고 합니다.</p>
<p>(3)  가설 설정: 현재까지 정보를 바탕으로 몇 가지 가설을 세웁니다.​ 여기서 가설이란 “아마 이런 이유일 때문일 것이다” 하고 추정해보는 것입니다. 예를 들어 의사가 환자를 진단하는 절차도 비슷할 것입니다. 환자가 들어왔습니다. “아랫 배 많이 아픕니다” 라고 이야기를 합니다. 그러면, 의사는 (1) 상한 음식을 먹어서 장염이 발생했나? (2) 화장실을 자주 못가서 그렇나? (3) 아랫 배에 충격이 있었나? 등 여러가지 가설을 설정하고 환자와의 대화를 통하여 해답을 얻을 것입니다.</p>
<p>텔레마케터 담당자와 인터뷰를 통하여 새울 수 있는 가설은 아래와 같습니다. 좋은 가설은 업무 경험에서 나옵니다.</p>
<blockquote>
<div><ul class="simple">
<li><p>고령자일수록, 남성일 수록 반응율이 좋다.</p></li>
<li><p>반응율은 연령대와 상관없이 텔레마케터의 능력에 달려있다.</p></li>
<li><p>전화를 받을 시간적 여유가 있는 사람이 반응율이 좋다.</p></li>
<li><p>소득이 많을 수록 반응율이 좋다.</p></li>
</ul>
</div></blockquote>
<p>위 가설을 증명하기 위해서는 데이터를 수집해야 합니다. 하지만, 신규고객을 대상으로 테스트 마케팅을 하지 않는 이상, 위 정보를 얻을 수 는 없습니다. 가장 좋은 방법은 기존 고객을 대상으로 한 과거 캠페인 데이터를 수집하는 것입니다. 과거 기존 고객을 대상으로 한 캠페인 로그파일을 추출합니다. 기존 고객을 대상으로 교차판매 캠페인이므로 반응(신규 보험가입) 여부와 고객 프로파일이 존재합니다.
​
(4) 가설 검증을 위한 데이터 수집 및 분석:  연령별, 성별로 반응율은 분석합니다. 각 텔레마케터 별 연령, 성별 분석도 합니다. 텔레마케터의 프로파일과 대상고객사의 프로파일도 비교합니다. 시간적인 여유가 있는 고객인지는 모르겠습니다. 하지만, 직업군으로 추정해볼 수있습니다. 다행이 보험심사에 수집한 직업군 정보가 있습니다. 사무직이 현장직보다는 시간적인 여유가 있을 거라고 생각합니다. 직업군별로 반응율을 분석합니다. 또 고객의 소득은 모르겠습니다. 하지만, 거주지의 특성으로 소득을 추정해 봅니다. 상식적으로 도곡동 타워팰리스 거주자가 중소도시 아파트 거주자보다는 고소득일 확율이 높습니다.</p>
<p>(5) 검정과정에서 발견된 결과를 이용하여 해결책 개발: 가설 검정 분석에서 여러가지 분석결과를 얻었습니다. 연령별, 성별 평균 반응율, 직업군별 평균 반응율, 소득별 평균 반응율이 알게 되었습니다. 반응율에 유의미한 변수(피쳐) 등을 알아내었고, 반응율이 높은 고객군을 만들어보기로 하였습니다. 분류할 변수가 많아 고객군을 추출하기가 좀 어렵습니다. 이를 해결하기 위해 통계 스코어링 모델을 만들기로 합니다. 반응은 예/아니오는 이진 분류이므로 로지스틱회귀모델을 만들어서 고객 스코어링를 합니다. 그리고 스코어가 높은 순으로 마케팅 대상고객을 선정합니다.</p>
<p>(6) 해결책 테스트 및 해결책의 효과 측정: 로지스틱 회귀모델이 얼마나 효과있는 지 알기 위해서 약 1천명의 고객은 랜덤하게 추출하고, 1천명은 모델 스코어에 의해 추출합니다. 그리고 테스트 텔레마케팅을 하고 반응율의 차이를 비교합니다. 랜덤하게 뽑힌 대상은 이전과 동일하게 1%의 반응율을 보였고, 모델을 통하여 뽑인 대상은 2% 반응율을 보였습니다. 즉 2천명을 랜덤하게 뽑았으면 20명의 신규고객을 얻었을 것이고, 회귀 모델로 2천명을 뽑았으면 40명의 고객이 생겼을 것입니다. 이 번 캠페인에서는 천명씩 테스트 했으므로 30명(10명 + 20명) 의 고객이 생겼습니다. 즉 모델로 10명의 고객을 더 획득하였고, 한 고객이 가져오는 현금흐름의 현재가치가 100 만원이라면, 이번 테스트 마케팅에서 보여준 모델의 가치는 1천만원 됩니다.</p>
<p>참고로 데이터분석가 해결책을 만드는 방법은 맥킨지 컨설팅이 해결책을 제시하는 방법과 유사합니다. 맥킨지 컨설팅이 고객의 문제를 해결하기 위해서는 중요하게 생각하는 3 요소는 다음과 같습니다. 첫번째, 선입견없이 아무것도 모른다고 생각하고 문제에 접근할 것(zero based), 두 번째, 생각을 MECE(Mutually Exclusive Collectively Exhaustive) 하게 구조화할 것. 세번째, 가설기반으로 분석하고 해결책을 만들 것(Hypothesis driven). 이 중에 세번째가 빠르게 해결책을 찾는 핵심입니다. 데이터 마이닝이라는 접근법도 있습니다. 가능한 모든데이터를 한 곳에 집중시켜 분석함으로써 알 수 없었던 새로운 통찰을 알아내는 방법인데요. 대표적인 예가 월마트의 기저기와 맥주 에피소드(별도 에피소드 설명)입니다. 하지만, 이 방법은 시간이 오래걸리고, 유의미한 결과를 얻지 못하는 경우도 종종 있습니다. 사례 3 번에서 간단하게 소개하도록 하겠습니다.</p>
</section>
<span id="document-chapter3/3.1.2_Use_Case"></span><section id="id1">
<h3>신용카드사 사례<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>이 번 사례는 약간 기술적인 내용을 다루어 보겠습니다. 김대리는 머신러닝 석사를 취득하고, 신용카드 사에 입사한 인재입니다. 김대리는 고객데이터 분석을 통해 신용카드 신청자의 연체가능성을 추정하고, 이에 따라 신용카드의 신용한도를 결정하는 신용관리 부서에서 일하고 있습니다. 보통 신용한도는 연체 가능성에 따라 결정하게 됩니다. 연체가능성이 낮으면 높은 신용한도를, 연체가능성이 높으면 낮은 신용한도를 받게 되는 것입니다. 연체 가능성을 파악하기 위해서 신용카드 신청자의 다양한 정보를 분석합니다. 크게 두 가지 데이터 소스가 있습니다. 카드 발급 신청서에 기입한 개인 정보와 크레딧 뷰로우(신용 금융 정보를 집중 관리 하는 기관) 데이터입니다. 신용카드 신청서에는 연령, 성별, 주소, 직업 등의 정보를 기입하도록 되어 있습니다. 크레딧 뷰로우에서는 신청자의 타 은행 신용 정보가 공유되고 있습니다. 대출을 받아보신 분은 경험하셨을 것이라고 생각합니다. 대출 신청을 하면, 담당 금융사는 타 금융사의 대출정보도 조회할 수 있습니다. 이 정보를 크레딧뷰로우가 제공하게 됩니다. 신용 대출액 혹은 카드 현금서비스 사용여부 등이 대표적인 예입니다. 신용카드사에서는 이런 모든 정보를 종합하여 정교한 연체 확률 모델을 개발, 관리하고 있으며, 신규 가입 요청이 들어오면, 신청자의 데이터가 연체 확률 예측 모델의 입력변수로 들어가게 되고, 예측 모델은 연체 확률을 추정하게 됩니다. 연체 예측 모델을 만들기 위해 신용관리 부서에서는 다양한 가설 검증과 데이터 분석으로 예측모델을 개발하고 운영하고 있습니다.</p>
<p>어느날, 재미교포 카스트로씨가 카드사를 방문을 했습니다. 미국에 어렸을 적에 부모님과 같이 이민을 갔다가 다시 한국에 역이민을 왔는데 신용카드가 필요하다는 것입니다. 김대리는 고민에 빠졌습니다. 카스트로씨 같은 경우는 아직 국내 신용거래가 없어, 크레딧 뷰로에 데이터가 존재하지 않습니다. 카드 신청서 개인 정보도 제한적입니다. 예를 들어, 자가 보유 여부, 주택담보대출 여부 등의 정보가 없습니다. 즉, 운용하고 있는 연체 확률 모델을 활용할 수 가 없는 것입니다.</p>
<p>김대리는 이 문제를 해결하기 위해 사내에 있는 통계자료를 수집했습니다. 수집된 통계자료는 연령대별, 성별, 거주지별, 직장별로 평균 연체확률(아래 그림) 이 있습니다. 카스트로씨가 제공할 수 있는 개인정보는 (1) 연령, (2) 성별, (3) 거주지, (4) 직장정보가 전부였습니다. 김대리가 수집한 통계자료는 아래와 같습니다. 그리고 카스트로씨에 해당하는 부분을 회색으로 표시했습니다. 아래 정보를 이용하여 카스트로씨의 연체 확률을 추정할 수 있을까요?</p>
<p><img src="../_images/연체확률.PNG" width="800" height="200"></img></p>
<p>좋은 아이디어가 떠오르지 않았습니다. 김 대리는 이전 직장상사 오 부장님께 전화를 걸었습니다. 오 부장님은 신용분석으로 경력이 20년이상 되신 분이라, 비슷한 경험이 있으실 것이라고 생각했는데, 정말 좋은 해결책을 알려주셨습니다. 오즈(odds) 를 이용한 방법이였습니다. 오즈(odds)란 ‘이벤트가 일어나지 않을 확률’ 대비 ‘이벤트가 일어날 확률’을 의미합니다. 김대리의 문제에서 오즈(odds) 는 (연체할 확률 / 연체하지 않을 확률) 로 계산이 될 수 있습니다. 아래는 오즈(odds) 계산 결과입니다.</p>
<p><img src="../_images/연체오즈비.PNG" width="800" height="200"></img></p>
<p>또한, 오즈비(odds ratio) 에 대한 이해가 필요합니다. 카스트로씨 연령에 대한 오즈(odds) 는 0.026 이고, 전체 오즈(odds) 는 0.027 이므로, 전체 대비 연령의 오즈비(odds ratio) 는 0.026 를 0.027 로 나눈 0.961 입니다 . 이 값을 의미는 카스트로씨의 연체에 대한 odds 는 전체 odds 대비 96.1% 낮다고 해석할 수 있습니다. 따라서 아무런 정보가 없는 카스트로씨의 오즈는 0.027 이였지만, 카스트로씨가 30대라는 사실을 알면 우리는 오즈를 조금 줄일 수 있습니다. 카스트로씨가 30대라는 정보를 입수하면, 카스트로씨의 오즈(odds) 는 0.027 * (0.026/0.027) 로 변경됩니다.</p>
<p>같은 방법으로 많은 정보가 많을 수록 카스트로씨의  odds 가 구체화 됩니다. 연령, 성별, 거주지, 지역 정보를 반영하면 카스트로 씨의 odds ratio 는 아래 공식으로 계산을 할 수 있습니다. 카스트로씨의 odds = (전체 odds) * (연령 odds ratio) * (성별 odds ratio) * (거주지 odds ratio) * (직장 odds ratio). 이 공식의 계산 결과는 0.029 가 됩니다. 오즈(odds) 는 P / (1-P)  즉, ‘연체할 확률’ / ‘연체하지 않을 확률’이므로 P 로 풀어쓰면, 연체 확률 P 는 odds / (1 + odds) 가 됩니다. P 를 계산하면 카스트로씨가 연체할 확률은 2.79% 가 됩니다. 따라서 김대리는 연체확률 2.79% 에 해당하는 신용한도를 부여하면 합리적인 결정이라고 할 수 있습니다. 특히 신용관리 부서는 “왜 그런 결론을 내렸는지?” 에 대하여 고객에게 설명을 할 수 있어야 합니다. 예를 들면 “내 옆집은 신용한도가 천만원인데 나는 오백만원이가요? 등의 민원이 있을 수 있습니다. 머신러닝 기반 모델 들은 명확한 해석이 불가능해서 이런 종류의 민원을 근본적으로 해결하지 못합니다. 통계 기반의 모델은 결과에 대한 설명이 가능하므로 이런 종류의 민원에 대응이 가능합니다. 따라서 많은 금융기관이 통계적인 모델링 방식을 아직 선호하고 있습니다.</p>
<p>이 사례에서 데이터 분석을 공부하셨던 분들은 로지스틱 회귀분석과 비슷하다고 느끼 셨을 것입니다. 맞습니다. 위 해결책은 로지스틱 회귀분석 모델링과 동일합니다.
참고로 로지스틱 회귀모델은</p>
<p><span class="math notranslate nohighlight">\( \ln(odds) \)</span> 를 <span class="math notranslate nohighlight">\( _X \)</span> 의 선형조합 <span class="math notranslate nohighlight">\( (b_0 + b_1 \cdot x_1 + b_2 \cdot x_2 + b_3 \cdot x_3 + b_4  \cdot x_4) \)</span>  의 형태로 설명하는 모델입니다.</p>
<p><span class="math notranslate nohighlight">\( (카스트로씨 \ odds) \ 는 \ (전체 \ odds) * (연령\ odds\ ratio) * (성별\ odds\ ratio) * (거주지\ odds\ ratio) * (직장\ odds\ ratio) \)</span><br />
로 추정할 수 있다고 사례에서 설명드렸습니다.</p>
<p>양변에 <span class="math notranslate nohighlight">\(log\)</span> 를 씌우면,</p>
<p><span class="math notranslate nohighlight">\( \ln(카스트로씨\ odds) = \ln(전체\ odds)  + \ln(연령\ odds\ ratio) + \ln(성별\ odds\ ratio)\)</span><br />
<span class="math notranslate nohighlight">\( + \ln(거주지\ odds\ ratio) + \ln(직장\ odds\ ratio) + \ln(직장\ odds\ ratio) \)</span></p>
<p>따라서,</p>
<p><span class="math notranslate nohighlight">\( \ln(전체\ odds)\ 는 \ b_0 \)</span>,  <span class="math notranslate nohighlight">\( \ln(연령\ odds\ ratio)\ 는\ (b_1 \cdot x_1) \)</span> 에 해당한다는 것을 알 수 있습니다.<br />
<span class="math notranslate nohighlight">\( x_1 \)</span> 이 (0,1) 의 바이너리 값이라면 <span class="math notranslate nohighlight">\( b_1 \)</span> 은 해당 연령의 <span class="math notranslate nohighlight">\( odds\ ratio \)</span> 에 <span class="math notranslate nohighlight">\( log \)</span> 를 한 값임을 알 수 있습니다.</p>
<br>
* 주석: 각 정보가 독립인 경우에 계산이 성립함
</section>
<span id="document-chapter3/3.1.3_Use_Case"></span><section id="id1">
<h3>소매업 사례<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>문제해결을 위하여 데이터분석을 하는 경우가 대부분입니다.  처음 보험사 사례에서 설명드린 것과 같이 가설을 세우고, 가설을 검증하기 위하여 데이터분석을 합니다. 검증된 가설은 문제해결의 근거가 됩니다. 다른 접근법은 데이터베이스를 알고리즘으로 분석해 패턴을 찾아내는 방법인데, 이를 데이터마이닝 접근법이라고 부릅니다. 이 번 사례에서는 데이터 마이닝 사례 두 가지를 소개하겠습니다.</p>
<p>월마트는 미국의 큰 소매업체입니다. 우리나라 이마트 정도가 비슷할 것 같은데요. 카트에 사고 싶은 물건을 담고, 계산대에서 일괄로 지불합니다. 그 때 구매내역이 찍힌 영수증이 발행됩니다. 이 데이터는 월마트 내부 전산시스템에도 동일하게 저장이 되게 됩니다. 데이터분석가가 어떤 상품들이 같이 판매가 되는지 궁금해 분석을 해 보았습니다. 이 분석은 장바구니 분석(Market Basket Analysis)라고도 부릅니다. 이상하게 금요일 오후에 맥주와 아기 기저귀와 같은 영수증에 동일하게 찍히는 경우가 많다는 것이 분석 결과로 도출되었습니다. 이 사실을 영업총괄 매니저에게 보고를 했고, 총괄 매니저는 맥주 옆에 기저귀를 같이 진열을 해 보았습니다. 그 결과는 맥주와 아기 기저귀 매출이 두 배로 증가했습니다. 의아하게 생각한 매니저는 금요일 진열대 옆에서 어떤 고객들이 맥주와 기저귀를 같이 구매를 하는 지 관찰 해 보았습니다. 알고 보니, 금요일 퇴근한 젊은 아빠들이 스트레스를 받은 표정(와이프의 요청으로 퇴근 후에 피곤한 몸을 이끌고 마트에 온 것으로 추정)으로 기저귀를 사러왔다가 맥주도 같이 사가는 것이였습니다. 이렇듯 데이터마이닝으로 생각하지 못했던 통찰(Insight)를 얻을 수 도 있습니다.</p>
<p>이번에는 타겟 사례입니다. 타겟은 미국의 카탈로그 소매업체입니다. 타겟은 임산부를 위한 특별한 프로모션을 준비했고, 임산부에게 임신기간 중 필요한 다양한 상품을 소개하는 카탈로그 준비했습니다. 일단 임신을 하게되면, 출산과 육아기간 동안 필요한 제품들이 정해져 있는데요. 타겟은 그것을 노리고 대대적인 프로모션을 계획한 것입니다. 카탈로그는 독자 이름으로 우편 배달이 되는데요. 이 임산부용 카탈로그가 어느 한 여고생 집으로 배달이 된 것이였습니다. 그 사실은 안 학생 아버지는 화가 잔뜩 나서 회사에 전화를 걸어 항의했습니다. “우리 아이가 고등학생인데, 무슨 임산부 카탈로를 보내느냐? 당장 담당자가 직접와서 사과를 하지 않으면 업체를 고소하겠다”  그런데 몇 일 후 학생은 아버지에게 이런 이런 일로 임신을 했다고 고백을 하게되었습니다. 타겟의 고객 담당자는 몇 일 후 집으로 찾아왔고, 아버지는 이 사실을 이야기 할 수 밖에 없었습니다. 그렇다면, 타겟은 이 여고생이 임신한 사실을 어떻게 알았을까요?  타겟의 데이터 분석가는 임산부의 구매특성에 대하여 분석을 했었는데요. 대부분의 고객은 임신을 하게되면, 피부 로션과 헤어 샴푸를 화학성분이 없고, 향이 강하지 않은 오가닉 제품으로 변경한다는 사실을 발견했습니다. 바로 그 여고생이 제품을 오가닉으로 갑자기 변경한 고객 중의 하나였던 것입니다. 물론 연령을 고려하지 않은 타겟팅을 한 잘못이 있다고 생각됩니다. 타겟의 에피소드 역시 구매이력 데이터베이스를 분석하다가 예상하지 못한 것을 발견하고 마케팅에 활용한 데이터마이닝 사례 중 하나입니다.</p>
</section>
<span id="document-chapter3/3.1.4_Use_Case"></span><section id="id1">
<h3>제조업 사례 (난이도 상)<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>제조업의 데이터분석은 금융업이나 소매업보다 조금 더 복잡합니다.  이 제조업 사례의 문제를 풀기 위해서는 두 가지 지식이 필요한데요. 하나는 최소자승법(Least Square Method)이고 다른 하나는 선형계획법(Linear Programming) 입니다.  철강업체 A 에서 환경관리를 담당하고 있는 여과장은 용해 후에 최종적으로 납품되는 Alloy(금속합금) 의 성분에 독성이 강한 X 물질이 다량 함유 되어 있다는 것을 알았습니다. 이 독성물질 X 는 함유율이 임계점 0.05% 이상되었을 때 독성이 강하게 나타납니다. 따라서, 최종 합금 Alloy 에 독성 물질이 0.05% 이하가 되도록 관리를 하고 싶습니다. Alloy 는 10 개의 공급 업체에서 금속 Scrap (스크랩) 를 납품받은 후, 몇 개의 업체 Scrap 을 선별 후, 용해해서 만듭니다. 첫 번째 문제는 각 업체에서 공급하는 Scrap 에 함유되어 있는 X 물질의 함유율을 정확히 모르고, 두 번째 문제는 X 물질의 함유율이 낮을 수 록 Scrap 단가가 비싸다는 것입니다. X 물질 함유율이 낮은 Scrap 만을 골라서 용해를 하면 독성 물질 X 함유율을 0.05% 이하로 관리할 수 있으나, 비용 증가의 문제가 생깁니다. 결국 풀고자하는 문제는 최소한의 비용으로 독성물질의 함유율이 0.05% 이하가 되도록 Alloy 합금을 만드는 것입니다.</p>
<p>여과장은 아래와 같이 배치( Batch) 데이터베이스를 만들었습니다. 아래 테이블은 샘플 배치 3 개를 보여주고 있습니다. 예를 들어 첫 번째 배치 B123 에는 3 개 업체의 Scrap 이 각 13톤, 5톤, 12톤이 투입되었습니다. 최종적으로 30 톤의 Alloy 가 만들어졌는데요. 독성물질 X 의 함유량을 측정해 보니 0.07% 가 들어있었고, 이 배치는 0.05% 를 넘어갔으므로 불합격입니다.  만약 여과장이 각 업체  Scrap 의 X 함유율 P1 ~ P10 을 알고 있다면, 최소비용으로 Alloy 를 만드는 방법을 선형계획법을 풀 수 가 있습니다. 먼저 선형 계획법으로 문제를 풀어보겠습니다.</p>
<img src="..\_images\배치데이터.png" width="800" height="200"><p>위 문제를 선형 계획법으로 도식화하면 아래와 같습니다. 배치의 총 비용을 목적함수으로 하고, 목적함수를 최소화하는 투입량  Wi  을 찾습니다. 단, 투입 후 물질 X 의 함유량이 0.05% 이하여야 한다는 제약이 있습니다.  아래에서 각 <span class="math notranslate nohighlight">\( W,\ C,\ P \)</span> 는  다음을 의미합니다.
<span class="math notranslate nohighlight">\( W \)</span>: Weight, <span class="math notranslate nohighlight">\( C \)</span>: Cost,  <span class="math notranslate nohighlight">\( P \)</span>: Proportion</p>
<p><strong>Minimize</strong> <span class="math notranslate nohighlight">\( \sum\ \)</span> <span class="math notranslate nohighlight">\( [ W_i \)</span> * <span class="math notranslate nohighlight">\( C_i  \ ] \)</span> (비용 목적함수) for <span class="math notranslate nohighlight">\( vendor = i \)</span></p>
<p><strong>(제약식)</strong></p>
<p><span class="math notranslate nohighlight">\( [ W_i \)</span>* <span class="math notranslate nohighlight">\( P_i  \ ] \)</span> <span class="math notranslate nohighlight">\(\ &lt;= \)</span> <span class="math notranslate nohighlight">\(∑ \ W_i \ * \ 0.05\% \)</span> (물질 X 의 함유량 제약)<br />
<span class="math notranslate nohighlight">\( \sum\ W_i \)</span>  =  (필요한 총 톤 수 제약)</p>
<p>이제 여과장은 각 업체의 물질 X 함유량 P 만 알면 위 선형계획법을 활용하여 최소비용으로 Alloy 를 생산하는 업체별 Scrap 투입량  W 를 알아낼 수 있습니다. 파이썬에서 선형계획법(Linear Programming) 은 PuLp 라이브러리에서 구현할 수 있습니다..</p>
<p>문제는 어떻게  함유량 P1 ~ P10 를 알아내는냐입니다. 사실 이 문제를 푸는 방법은 여러가지가 있습니다. 여과장은 최소자승법으로 문제를 풀었는데요. 어떻게 풀었는지 함 보겠습니다.  만약 우리가 P1 ~ P10 을 알고 있다면 각 배치별 물질 X 의 총량은 아래와 같이 추정할 수 있을 것입니다. 그렇다면 추정치 함유량과 실제 함유량의 차이가 최소가 되는 P1 ~ P10 을 찾는 것입니다.</p>
<img src="..\_images\함유량X.png" width="400" height="100"></section>
</div>
</section>
</div>
<div class="toctree-wrapper compound">
<span id="document-chapter4/4.0.0_My_Strategy"></span><section id="id1">
<h2><strong>데이터분석으로 나만의 전략 만들기</strong><a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<br>
주식 데이터로 데이터분석를 하는 과정을 보험회사 사례를 활용하여 풀어보겠습니다. 먼저 문제점은 주식으로 수익을 내고 싶은데 손실이 난다는 것입니다. 주식 투자는 기간에 따라 장기투자와 단기투자로 나눌 수 있고, 그 중 단기 투자가 데이터 분석에는 더 적합합니다. 왜냐하면 데이터 분석은 통계적인 접근이 필요한데 단기 투자가 많은 테스트 결과를 확보할 수 있기 때문입니다. 장기투자의 경우는 가치투자에 더 가까습니다. 테스트 결과을 얻는데 까지 시간이 많이 필요합니다. 데이터분석의 가치를 통계적으로 보여주기는 단기 투자가 사례로 더 적절합니다.</br>     
<br>
보험회사 사례의 과정을 따라 데이터 분석을 해 보겠습니다.
<blockquote>
<div><ol class="simple">
<li><p>문제점 파악과 정의</p></li>
<li><p>정보 수집 및 전문가 인터뷰</p></li>
<li><p>가설 설정</p></li>
<li><p>가설 검증을 위한 데이터 수집 및 분석</p></li>
<li><p>검정과정에서 발견된 결과물을 이용하여 해결책 개발</p></li>
<li><p>해결책 테스트 및 해결책의 효과 측정</p></li>
</ol>
</div></blockquote>
<p><br> 문제의 정의부터 해결책 개발까지의 과정을 도식화해 보았습니다. 문제를 먼저 구조화하고 가설을 만들면 각 가설 검증이 왜 필요한지 이해하기 쉽고, 가설들의 중복을 피할 수 있습니다.</p>
<p><img src="../_images/Solving_Process.png" width="800" height="450"></img></p>
<p><img src="../_images/Problem_Definition.png" width="800" height="450"></img></p>
<p><img src="../_images/Problem_Structure.png" width="800" height="450"></img></p>
<p><img src="../_images/Hypothesis_Development.png" width="800" height="450"></img></p>
<p><img src="../_images/Solution_Development.png" width="800" height="450"></img></p>
</section>
<span id="document-chapter4/4.1.0_My_Strategy"></span><section id="id1">
<h2><strong>문제점 파악</strong><a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<p>주식 매매에 데이터 분석을 활용하는 이유는 간단합니다. 단기 경험으로는 주가가 상승할 종목을 찾기가 상당히 어렵다는 것입니다. 일단 종목이 수 천개 입니다. 수천 개의 종목을 수작업으로 종목별 분석은 거의 불가능할 것 같습니다. 엑셀의 도움을 받을 수 도 있겠으나, 엑셀로 수천개의 종목과 몇 년치 데이터를 다루는 것도 어렵습니다.  따라서 파이썬을 이용해 데이터를 수집하고 분석하여 확률적으로 주가가 상승할 종목을 찾는 알고리즘을 만들고자 합니다. 주식매매 관련하여 데이터분석이 의사결정에 도움을 줄 수 있는 부분은 아래와 같습니다.</p>
<blockquote>
<div><ol class="simple">
<li><p>매수 종목 선정</p></li>
<li><p>매수 및 매도 시점 결정</p></li>
</ol>
</div></blockquote>
<br>
이 책에서는 1번을 중점적으로 다루고,. 2 번 문제는 간단하게 논의해 보도록 하겠습니다.
<p>이제 문제점이 파악되었으면 타겟(예측할) 변수의 결정이 가능합니다.</p>
<p>모델링에서 예측하고자하는 변수를 타겟변수(통계모델에서는 종속변수)라고 합니다. 단기매매를 위한 예측모델에서 우리의 타겟변수는 매수 후 1 주일(5 영업일) 동안의 주가변동입니다. 타겟변수를 어떻게 정의하는냐는 예측모델의 성공과 실패를 결정하는 중요한 요소입니다. 여기서 데이터 분석의 경험이 많은 분석가와 신입 분석가의 차이가 발생하게 됩니다.</p>
<p>모델의 선택에 대하여 시계열 모델을 우선적으로 생각해 볼 수 있습니다. 시계열 모델은 (T-n) .. (T-3), (T-2), (T-1) 주가 정보를 이용하여 T 시점의 주가 예측하는 방법입니다. 시계열 모델의 경우는 가격 자체를 예측하기 보다는 가격의 변동성(예를 들면 수익율) 을 시계열 변수로 해야 정상성(Stationary) 를 만족하게 됩니다. 정상성은 통계 시계열 모델에서 특히 중요합니다. 또한 머신러닝 및 딥러닝 시계열 모델 등도 학습이 잘 되려면 정상적을 만족해야 합니다. (시계열 모델에서 왜 정상성을 확보해야 하는 이유에 대하여 별도 기술). 하지만 시계열모델은 과거의 주가 흐름이 미래에도 반복한다는 기본 가정이 있습니다.  문제는 주가흐름은 이 가정을 만족하기가 어렵다는 것입니다.  따라서 시계열모델 접근보다는 과거 주가정보의 특징이 요약된 피쳐를 입력변수로 활용하고 매수 후 일 주일간(5 영업일)의 수익률을 예측하는 모델을 구현할 것입니다.​</p>
<p>가상의 익절 수익율(예를 들어 익절 5%)을 설정하고 매도를 합니다. 매도 후, 수익이 발생한 경우는 1, 나머지는 0 인 타겟변수를 생성합니다. 타겟변수의 특이값(예를 들어 10% 이상 익절) 이 모두 1 로 치환되므로 모델의 입력변수가 타겟변수의 변화에 민감하게 반응하지 않게 됩니다. 일반적으로 이진 분류 모델의 경우 타겟변수에 입력변수가 민감에게 반응하지 않기 때문에 모델 적합이 잘됩니다. 이는 오버피팅(과적합)을 피하기 위한 한 방법이기도 합니다. 예측모델링을 공부하신 분들은 잘 아시겠지만, 이진 타겟변수에 대하여 다양한 모델을 활용할 수 있습니다. 이진 분류의 문제는 로지스틱 회귀분석이 대표적인 모델입니다. 요약하면 과거의 주가 및 거래량 정보를 요약하며 피쳐를 만든 후, 피쳐들을 이용하여 수익/손해를 추정하는 모델입니다.</p>
</section>
<span id="document-chapter4/4.2.0_My_Strategy"></span><section id="id1">
<h2><strong>정보 수집 및 전문가 인터뷰</strong><a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<br>   
요즘은 유투브에 전문가들이 주식관련 동영상을 많이 올려주십니다. 다시한번 감사드립니다. 유투브가 아니였으면 주식관련된 정보를 얻는데 더 많은 시간이 필요했을 겁입니다. 캔들차트를 보여주시면서 이럴 때 주가가 상승하고, 저럴 때 하락한다 설명해주십니다. 저도 주식에 대한 문외한이라 다양한 컨텐츠를 봤습니다. 이 책의 목적은 데이터분석을 배워서 자신만의 추천모델을 만는 것이므로 분봉이나 틱 데이터가 필요한 정교한 모델(정확한 매수 매도 시점이 필요한 경우) 보다는 일봉으로도 충분히 모델링을 할 수 있는 단기 매매(1 주일이내 매도) 모델을 만들어 보겠습니다. 우리 주린이는 학습을 통해서 전문가의 지식을 최대한 이용해야 합니다. 사전 지식없이 모든 데이터를 다 모아서 분석하다가 생각지도 못한 좋은 통찰을 얻을 수 도 있습니다. 앞서 언급한 것과 같이 그것을 데이터 마이닝 접근법이라고 합니다. 마이닝을 통하여 전문가도 생각하지  못한 좋은 통찰을 얻을 수 도 있으나, 많은 시간과 노력이 필요합니다. 우리는 가설 수립 및 검정으로 신속하게 해결책을 찾아낼 것입니다.
</section>
<span id="document-chapter4/4.3.0_My_Strategy"></span><section id="id1">
<h2><strong>가설 설정</strong><a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<p>유투브및 여러 블로그에서 얻은 정보를 바탕으로 몇 가지 가설을 세웠습니다. 여기서 가설이란 이런 경우 주가가 상승한다하는 가정입니다. 아래는 제가 찾은 정보입니다. 독자분들은 더 좋은 가설을 세우실 수 있을 것이라고 생각합니다. 가설의 깊이가 예측 모델의 성능을 좌우합니다.</p>
<ul class="simple">
<li><p>변동성이 크고 거래량이 몰린 종목이 주가가 상승한다.</p></li>
<li><p>5일 이동 평균선이 오늘 종가보다 위에 위치해 있다.</p></li>
<li><p>위 꼬리가 긴 양봉이 자주 발생한다.</p></li>
<li><p>거래량이 종종 크게 터지며 매집의 흔적을 보인다.</p></li>
<li><p>주가지수보다 더 좋은 수익율을 자주 보여준다.</p></li>
<li><p>동종업계의 평균 수익률보다 좋은 수익률을 보여준다.</p></li>
<li><p>개인투자자보다는 투신/사모펀드 등이 매수를 많이 한다.</p></li>
</ul>
<p>마지막 가설(투자자)의 경우는 증권사 API 등을 활용하여 데이터를 추출을 해야하므로 별도의 공부가 필요합니다. 모델의 입력변수로 활용하지는 않겠습니다.</p>
<p>아래는 몇 가지 가설에 대한 차트 예시입니다. 우리가 데이터 분석으로 증명하고 싶은 것은 “각 패턴이 통계적으로 유의미하게 자주 발생하는가?” 입니다.</p>
<ul class="simple">
<li><p><strong>5일 이동 평균선이 오늘 종가보다 위에 위치해 있다.</strong><br />
아래 3월 15일 노란색 부분을 매수 시점이라고 가정을 하면 5일 이동 평균선(녹색선)보다 종가가 아래에 위치해 있다가, 향후 이동평균선을 따라가는 모양을 보여주고 있습니다.
<img src="../_images/종가가5일이평선보다아래.PNG" width="800" height="500"></img></p></li>
</ul>
<ul class="simple">
<li><p><strong>거래량이 종종 크게 터지며 매집의 흔적을 보인다.</strong><br />
아래 차트에서 6월 10일 매수시점이라고 하면 급 상승 전에 거래량이 크게 자주 발생한 것을 확인할 수 있습니다.
<img src="../_images/거래량이터지며매집흔적.PNG" width="800" height="500"></img></p></li>
</ul>
<ul class="simple">
<li><p><strong>위 꼬리가 긴 양봉이 자주 발생한다.</strong><br />
아래 차트에서 2월 21일 매수시점이라고 하면 주가 상승전에 긴 꼬리 양봉이 자주 발생하는 것을 확인할 수 있습니다.
<img src="../_images/위꼬리가긴양봉자주발생.PNG" width="800" height="500"></img></p></li>
</ul>
<ul class="simple">
<li><p><strong>주가지수보다 더 좋은 수익율을 자주 보여준다.</strong><br />
아래 2월 14일을 매수 시점으로 본다면 주가지수가 계속 하락하는 구간에서도 지에스이의 주가는 우상향하고 있었습니다.
<img src="../_images/주가지수보다좋은수익률.PNG" width="800" height="400"></img></p></li>
</ul>
</section>
<span id="document-chapter4/4.4.0_Data_Collection"></span><section id="id1">
<h2><strong>데이터 수집 및 분석</strong><a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<p>이 부분이 데이터분석에서 가장 많은 시간이 필요한 부분입니다. 데이터를 수집해야하고 분석할 수 있는 모양으로 데이터 가공을 해야합니다. 다행이 일봉데이터는 데이터 크렌징은 필요없습니다. 하지만, 판다스 라이브러리를 이용하여 많은 가공이 필요합니다. 이 부분은 피쳐 엔지니어링이라고도 부릅니다.</p>
<p>일봉 데이터 수집은 웹크롤링으로 수집할 수 도 있고, 파이썬 라이브러리로도 수집이 가능합니다. 일봉 데이터에는 시종고저 값과 거래량 값이 기본적으로 제공됩니다. 우리는 이렇게 5개의 데이터를 이용하여 위 가설을 검정 해 볼 것 입니다.</p>
<div class="toctree-wrapper compound">
<span id="document-chapter4/4.4.1_Data_Collection"></span><section id="id1">
<h3>일봉 데이터 가져오기<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
</section>
<section id="financedatareader">
<h3>FinanceDataReader 로 일봉 데이터 가져오기<a class="headerlink" href="#financedatareader" title="Permalink to this headline">#</a></h3>
<p>가설 분석과 수익율 예측 모델링은 변동성이 큰 코스닥 종목만을 대상으로 하겠습니다.
가설검정을 위하여 과거 수 개월치의 일봉데이터가 필요합니다. 우선 데이터를 종목별로 가져오기 위해서 FinanceDataReader 의 Stocklisting 메소드에서 코스닥의 종목 코드와 정보를 불러옵니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span> 
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">bs4</span>

<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kosdaq_df</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">StockListing</span><span class="p">(</span><span class="s1">&#39;KOSDAQ&#39;</span><span class="p">)</span>
<span class="n">kosdaq_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_65f97_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >Symbol</th>
      <th class="col_heading level0 col1" >Market</th>
      <th class="col_heading level0 col2" >Name</th>
      <th class="col_heading level0 col3" >Sector</th>
      <th class="col_heading level0 col4" >Industry</th>
      <th class="col_heading level0 col5" >ListingDate</th>
      <th class="col_heading level0 col6" >SettleMonth</th>
      <th class="col_heading level0 col7" >Representative</th>
      <th class="col_heading level0 col8" >HomePage</th>
      <th class="col_heading level0 col9" >Region</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_65f97_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_65f97_row0_col0" class="data row0 col0" >060310</td>
      <td id="T_65f97_row0_col1" class="data row0 col1" >KOSDAQ</td>
      <td id="T_65f97_row0_col2" class="data row0 col2" >3S</td>
      <td id="T_65f97_row0_col3" class="data row0 col3" >전자부품 제조업</td>
      <td id="T_65f97_row0_col4" class="data row0 col4" >반도체 웨이퍼 캐리어</td>
      <td id="T_65f97_row0_col5" class="data row0 col5" >2002-04-23 00:00:00</td>
      <td id="T_65f97_row0_col6" class="data row0 col6" >03월</td>
      <td id="T_65f97_row0_col7" class="data row0 col7" >김세완</td>
      <td id="T_65f97_row0_col8" class="data row0 col8" >http://www.3sref.com</td>
      <td id="T_65f97_row0_col9" class="data row0 col9" >서울특별시</td>
    </tr>
    <tr>
      <th id="T_65f97_level0_row1" class="row_heading level0 row1" >3</th>
      <td id="T_65f97_row1_col0" class="data row1 col0" >054620</td>
      <td id="T_65f97_row1_col1" class="data row1 col1" >KOSDAQ</td>
      <td id="T_65f97_row1_col2" class="data row1 col2" >APS홀딩스</td>
      <td id="T_65f97_row1_col3" class="data row1 col3" >기타 금융업</td>
      <td id="T_65f97_row1_col4" class="data row1 col4" >인터넷 트래픽 솔루션</td>
      <td id="T_65f97_row1_col5" class="data row1 col5" >2001-12-04 00:00:00</td>
      <td id="T_65f97_row1_col6" class="data row1 col6" >12월</td>
      <td id="T_65f97_row1_col7" class="data row1 col7" >정기로</td>
      <td id="T_65f97_row1_col8" class="data row1 col8" >http://www.apsholdings.co.kr</td>
      <td id="T_65f97_row1_col9" class="data row1 col9" >경기도</td>
    </tr>
    <tr>
      <th id="T_65f97_level0_row2" class="row_heading level0 row2" >4</th>
      <td id="T_65f97_row2_col0" class="data row2 col0" >265520</td>
      <td id="T_65f97_row2_col1" class="data row2 col1" >KOSDAQ</td>
      <td id="T_65f97_row2_col2" class="data row2 col2" >AP시스템</td>
      <td id="T_65f97_row2_col3" class="data row2 col3" >특수 목적용 기계 제조업</td>
      <td id="T_65f97_row2_col4" class="data row2 col4" >디스플레이 제조 장비</td>
      <td id="T_65f97_row2_col5" class="data row2 col5" >2017-04-07 00:00:00</td>
      <td id="T_65f97_row2_col6" class="data row2 col6" >12월</td>
      <td id="T_65f97_row2_col7" class="data row2 col7" >김영주</td>
      <td id="T_65f97_row2_col8" class="data row2 col8" >http://www.apsystems.co.kr</td>
      <td id="T_65f97_row2_col9" class="data row2 col9" >경기도</td>
    </tr>
    <tr>
      <th id="T_65f97_level0_row3" class="row_heading level0 row3" >5</th>
      <td id="T_65f97_row3_col0" class="data row3 col0" >211270</td>
      <td id="T_65f97_row3_col1" class="data row3 col1" >KOSDAQ</td>
      <td id="T_65f97_row3_col2" class="data row3 col2" >AP위성</td>
      <td id="T_65f97_row3_col3" class="data row3 col3" >통신 및 방송 장비 제조업</td>
      <td id="T_65f97_row3_col4" class="data row3 col4" >위성통신 단말기</td>
      <td id="T_65f97_row3_col5" class="data row3 col5" >2016-03-04 00:00:00</td>
      <td id="T_65f97_row3_col6" class="data row3 col6" >12월</td>
      <td id="T_65f97_row3_col7" class="data row3 col7" >류장수</td>
      <td id="T_65f97_row3_col8" class="data row3 col8" >http://www.apsi.co.kr</td>
      <td id="T_65f97_row3_col9" class="data row3 col9" >서울특별시</td>
    </tr>
    <tr>
      <th id="T_65f97_level0_row4" class="row_heading level0 row4" >60</th>
      <td id="T_65f97_row4_col0" class="data row4 col0" >032790</td>
      <td id="T_65f97_row4_col1" class="data row4 col1" >KOSDAQ</td>
      <td id="T_65f97_row4_col2" class="data row4 col2" >BNGT</td>
      <td id="T_65f97_row4_col3" class="data row4 col3" >기계장비 및 관련 물품 도매업</td>
      <td id="T_65f97_row4_col4" class="data row4 col4" >Bio 이종장기 사업, ICT 프린터 현상기</td>
      <td id="T_65f97_row4_col5" class="data row4 col5" >1997-06-26 00:00:00</td>
      <td id="T_65f97_row4_col6" class="data row4 col6" >12월</td>
      <td id="T_65f97_row4_col7" class="data row4 col7" >조상환</td>
      <td id="T_65f97_row4_col8" class="data row4 col8" >http://www.mgenplus.com</td>
      <td id="T_65f97_row4_col9" class="data row4 col9" >서울특별시</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> 섹터가 정의되지 않은 종목과 2021년 1월 1일 이후 상장된 종목은 제외하겠습니다. 종 1422 개의 종목이 있습니다. 독자분이 책을 보시는 시점에는 종목 수가 바뀌어 있을 것입니다.<br />
kosdaq_df 에서 필요한 컬럼 ‘Symbol’ 과 ‘Name’ 두 개만 kosdaq_list 에 저장합니다. 그리고 종목코드 ‘Symbol’ 과 ‘Name’ 을 각 각 ‘code’ 외 ‘name’ 으로 바꿔줍니다. 그리고 나중을 위해서 결과물을 pickle 파일로 저장도 합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">kosdaq_df</span><span class="p">[</span><span class="s1">&#39;Symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>

<span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="n">kosdaq_df</span><span class="p">[</span><span class="s1">&#39;ListingDate&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="s1">&#39;2021-01-01&#39;</span><span class="p">)</span> <span class="c1"># 2021년 1월 1일 이후 상장된 종목</span>
<span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="n">kosdaq_df</span><span class="p">[</span><span class="s1">&#39;Sector&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span> <span class="c1"># 섹터 값이 비어있음</span>
<span class="nb">print</span><span class="p">(</span><span class="n">kosdaq_df</span><span class="p">[</span><span class="o">~</span><span class="n">c1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">c2</span><span class="p">][</span><span class="s1">&#39;Symbol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>  <span class="c1"># c1 이 아니고 c2 가 아닌 종목의 갯 수</span>

<span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">kosdaq_df</span><span class="p">[</span><span class="o">~</span><span class="n">c1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">c2</span><span class="p">][[</span><span class="s1">&#39;Symbol&#39;</span><span class="p">,</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span><span class="s1">&#39;Sector&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Symbol&#39;</span><span class="p">:</span><span class="s1">&#39;code&#39;</span><span class="p">,</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;Sector&#39;</span><span class="p">:</span><span class="s1">&#39;sector&#39;</span><span class="p">})</span>
<span class="n">kosdaq_list</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1582
1416
</pre></div>
</div>
</div>
</div>
<p><br> 저장한 pickle 파일을 읽고, sector 가 몇개나 있는 지 세어봅니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span>
<span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>132
</pre></div>
</div>
</div>
</div>
<p><br> For Loop 에서 kosdaq_list 의 종목코드와 종목이름을 하나씩 불러서 DataReader 로 2021년 1월 3일부터 2022년 3월 31일까지 일봉데이터를 수집합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">price_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]):</span>  <span class="c1"># 코스닥 모든 종목에서 대하여 반복</span>
    <span class="n">daily_price</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">code</span><span class="p">,</span>  <span class="n">start</span><span class="o">=</span><span class="s1">&#39;2021-01-03&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;2022-03-31&#39;</span><span class="p">)</span> <span class="c1"># 종목, 일봉, 데이터 갯수</span>
    <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
    <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">price_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">price_data</span><span class="p">,</span> <span class="n">daily_price</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>   

<span class="n">price_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>
<span class="n">price_data</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span> <span class="n">price_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="c1"># 컬럼 이름 소문자로 변경</span>
<span class="n">price_data</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;stock_data_from_fdr.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><br> 저장한 pickle 파일을 다시 읽어 첫 5 라인을 head 메소드로 찍어보면 아래와 같습니다. 여기서 date가 인덱스로 처리되어 있다는 것을 기억해주시면 좋습니다. 타이핑 편의를 위해 컬럼이름을 소문자료 변경하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">price_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;stock_data_from_fdr.pkl&#39;</span><span class="p">)</span>
<span class="n">price_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_660d6_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >open</th>
      <th class="col_heading level0 col1" >high</th>
      <th class="col_heading level0 col2" >low</th>
      <th class="col_heading level0 col3" >close</th>
      <th class="col_heading level0 col4" >volume</th>
      <th class="col_heading level0 col5" >change</th>
      <th class="col_heading level0 col6" >code</th>
      <th class="col_heading level0 col7" >name</th>
    </tr>
    <tr>
      <th class="index_name level0" >date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
      <th class="blank col7" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_660d6_level0_row0" class="row_heading level0 row0" >2021-01-04 00:00:00</th>
      <td id="T_660d6_row0_col0" class="data row0 col0" >2185</td>
      <td id="T_660d6_row0_col1" class="data row0 col1" >2320</td>
      <td id="T_660d6_row0_col2" class="data row0 col2" >2135</td>
      <td id="T_660d6_row0_col3" class="data row0 col3" >2260</td>
      <td id="T_660d6_row0_col4" class="data row0 col4" >588133</td>
      <td id="T_660d6_row0_col5" class="data row0 col5" >0.043880</td>
      <td id="T_660d6_row0_col6" class="data row0 col6" >060310</td>
      <td id="T_660d6_row0_col7" class="data row0 col7" >3S</td>
    </tr>
    <tr>
      <th id="T_660d6_level0_row1" class="row_heading level0 row1" >2021-01-05 00:00:00</th>
      <td id="T_660d6_row1_col0" class="data row1 col0" >2270</td>
      <td id="T_660d6_row1_col1" class="data row1 col1" >2285</td>
      <td id="T_660d6_row1_col2" class="data row1 col2" >2200</td>
      <td id="T_660d6_row1_col3" class="data row1 col3" >2250</td>
      <td id="T_660d6_row1_col4" class="data row1 col4" >410263</td>
      <td id="T_660d6_row1_col5" class="data row1 col5" >-0.004425</td>
      <td id="T_660d6_row1_col6" class="data row1 col6" >060310</td>
      <td id="T_660d6_row1_col7" class="data row1 col7" >3S</td>
    </tr>
    <tr>
      <th id="T_660d6_level0_row2" class="row_heading level0 row2" >2021-01-06 00:00:00</th>
      <td id="T_660d6_row2_col0" class="data row2 col0" >2225</td>
      <td id="T_660d6_row2_col1" class="data row2 col1" >2310</td>
      <td id="T_660d6_row2_col2" class="data row2 col2" >2215</td>
      <td id="T_660d6_row2_col3" class="data row2 col3" >2290</td>
      <td id="T_660d6_row2_col4" class="data row2 col4" >570349</td>
      <td id="T_660d6_row2_col5" class="data row2 col5" >0.017778</td>
      <td id="T_660d6_row2_col6" class="data row2 col6" >060310</td>
      <td id="T_660d6_row2_col7" class="data row2 col7" >3S</td>
    </tr>
    <tr>
      <th id="T_660d6_level0_row3" class="row_heading level0 row3" >2021-01-07 00:00:00</th>
      <td id="T_660d6_row3_col0" class="data row3 col0" >2290</td>
      <td id="T_660d6_row3_col1" class="data row3 col1" >2340</td>
      <td id="T_660d6_row3_col2" class="data row3 col2" >2240</td>
      <td id="T_660d6_row3_col3" class="data row3 col3" >2290</td>
      <td id="T_660d6_row3_col4" class="data row3 col4" >519777</td>
      <td id="T_660d6_row3_col5" class="data row3 col5" >0.000000</td>
      <td id="T_660d6_row3_col6" class="data row3 col6" >060310</td>
      <td id="T_660d6_row3_col7" class="data row3 col7" >3S</td>
    </tr>
    <tr>
      <th id="T_660d6_level0_row4" class="row_heading level0 row4" >2021-01-08 00:00:00</th>
      <td id="T_660d6_row4_col0" class="data row4 col0" >2300</td>
      <td id="T_660d6_row4_col1" class="data row4 col1" >2315</td>
      <td id="T_660d6_row4_col2" class="data row4 col2" >2225</td>
      <td id="T_660d6_row4_col3" class="data row4 col3" >2245</td>
      <td id="T_660d6_row4_col4" class="data row4 col4" >462568</td>
      <td id="T_660d6_row4_col5" class="data row4 col5" >-0.019651</td>
      <td id="T_660d6_row4_col6" class="data row4 col6" >060310</td>
      <td id="T_660d6_row4_col7" class="data row4 col7" >3S</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> 몇 개의 종목이 있고, 각 종목별 일봉의 갯 수 가 몇 개인지 확인해 보겠습니다. 종목 수는 1417 개, 307 개의 일봉이 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">price_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">price_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;min&#39;</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1417
min    307
max    307
Name: close, dtype: int64
</pre></div>
</div>
</div>
</div>
<br><p><br></br></p>
</section>
<section id="id2">
<h3>네이버 증권 웹크롤링으로 일봉 데이터 가져오기<a class="headerlink" href="#id2" title="Permalink to this headline">#</a></h3>
<p>이 번에는 네이버 증권 차트 <em>(네이버 차트 예시 필요)</em> 에서 데이터를 가져오는 방법도 시도해 보겠습니다. 웹 크롤링은 코드가 복잡합니다. 첫 번째 방법인 FinanceDataReader 로 추출하는 방법을 추천드립니다.<br />
다시 pickle 파일을 읽습니다. make_price_data 함수는 ‘종목’, ‘추출단위’, ‘데이터 건수’ 를 인자로 네이버증권에서 데이터를 가져오는 함수입니다. 인자는 작은 따옴표에 넣어야 합니다. 셀트리온 헬스케어(091990) 의 일봉 데이터를 최근 300 일 가져오고 싶다면  make_price_data(‘091990’, ‘day’, ‘300’) 와 같이 호출합니다. 이 함수를 for 문을 이용해 모든 코스닥 종목에서 대하여 호출하고, 각 결과를 price_data 라는 데이터프레임에 담습니다.
for 문을 돌리고 결과를 concat 함수로 연속으로 저장하는 방법은 자주 활용되는 기법입니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 네이버 증권 차트에서 데이터 크롤링</span>

<span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">make_price_data</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">timeframe</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://fchart.stock.naver.com/sise.nhn?symbol=&#39;</span> <span class="o">+</span> <span class="n">code</span> <span class="o">+</span> <span class="s1">&#39;&amp;timeframe=&#39;</span> <span class="o">+</span> <span class="n">timeframe</span> <span class="o">+</span> <span class="s1">&#39;&amp;count=&#39;</span> <span class="o">+</span> <span class="n">count</span> <span class="o">+</span> <span class="s1">&#39;&amp;requestType=0&#39;</span>
    <span class="n">price_data</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">price_data_bs</span> <span class="o">=</span> <span class="n">bs4</span><span class="o">.</span><span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">price_data</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;lxml&#39;</span><span class="p">)</span>
    <span class="n">item_list</span> <span class="o">=</span> <span class="n">price_data_bs</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s1">&#39;item&#39;</span><span class="p">)</span>

    <span class="n">date_list</span> <span class="o">=</span> <span class="p">[]</span> 
    <span class="n">open_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">high_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">low_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">close_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">trade_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">item_list</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
        <span class="n">date_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">open_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">high_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">low_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">close_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">trade_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>        

    <span class="n">price_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;open&#39;</span><span class="p">:</span> <span class="n">open_list</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">high_list</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">low_list</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">close_list</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">trade_list</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">date_list</span><span class="p">)</span>            
    <span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
    <span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">num_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="s1">&#39;high&#39;</span><span class="p">,</span><span class="s1">&#39;low&#39;</span><span class="p">,</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span>
    <span class="n">char_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">price_df</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">char_vars</span> <span class="o">+</span> <span class="n">num_vars</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">num_vars</span><span class="p">:</span>
        <span class="n">price_df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>

    <span class="n">price_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">price_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">price_df</span>

<span class="n">price_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]):</span>  <span class="c1"># 코스닥 모든 종목에서 대하여 반복</span>
    <span class="n">daily_price</span> <span class="o">=</span> <span class="n">make_price_data</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;307&#39;</span><span class="p">)</span> <span class="c1"># 종목, 일봉, 데이터 갯수</span>
    <span class="n">price_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">price_data</span><span class="p">,</span> <span class="n">daily_price</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>   

<span class="n">price_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>
<span class="n">price_data</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;stock_data_from_naver.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><br> 저장한 pickle 파일을 다시 읽어 첫 5 라인을 head 메소드로 찍어보면 아래와 같습니다. 여기서 date가 인덱스로 처리되어 있다는 것을 기억해주시면 좋습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">price_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;stock_data_from_naver.pkl&#39;</span><span class="p">)</span>
<span class="n">price_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_b17e6_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >code</th>
      <th class="col_heading level0 col1" >name</th>
      <th class="col_heading level0 col2" >open</th>
      <th class="col_heading level0 col3" >high</th>
      <th class="col_heading level0 col4" >low</th>
      <th class="col_heading level0 col5" >close</th>
      <th class="col_heading level0 col6" >volume</th>
    </tr>
    <tr>
      <th class="index_name level0" >date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_b17e6_level0_row0" class="row_heading level0 row0" >2021-03-23 00:00:00</th>
      <td id="T_b17e6_row0_col0" class="data row0 col0" >060310</td>
      <td id="T_b17e6_row0_col1" class="data row0 col1" >3S</td>
      <td id="T_b17e6_row0_col2" class="data row0 col2" >2525</td>
      <td id="T_b17e6_row0_col3" class="data row0 col3" >2525</td>
      <td id="T_b17e6_row0_col4" class="data row0 col4" >2390</td>
      <td id="T_b17e6_row0_col5" class="data row0 col5" >2410</td>
      <td id="T_b17e6_row0_col6" class="data row0 col6" >245741</td>
    </tr>
    <tr>
      <th id="T_b17e6_level0_row1" class="row_heading level0 row1" >2021-03-24 00:00:00</th>
      <td id="T_b17e6_row1_col0" class="data row1 col0" >060310</td>
      <td id="T_b17e6_row1_col1" class="data row1 col1" >3S</td>
      <td id="T_b17e6_row1_col2" class="data row1 col2" >2410</td>
      <td id="T_b17e6_row1_col3" class="data row1 col3" >2420</td>
      <td id="T_b17e6_row1_col4" class="data row1 col4" >2350</td>
      <td id="T_b17e6_row1_col5" class="data row1 col5" >2410</td>
      <td id="T_b17e6_row1_col6" class="data row1 col6" >156213</td>
    </tr>
    <tr>
      <th id="T_b17e6_level0_row2" class="row_heading level0 row2" >2021-03-25 00:00:00</th>
      <td id="T_b17e6_row2_col0" class="data row2 col0" >060310</td>
      <td id="T_b17e6_row2_col1" class="data row2 col1" >3S</td>
      <td id="T_b17e6_row2_col2" class="data row2 col2" >2410</td>
      <td id="T_b17e6_row2_col3" class="data row2 col3" >2510</td>
      <td id="T_b17e6_row2_col4" class="data row2 col4" >2400</td>
      <td id="T_b17e6_row2_col5" class="data row2 col5" >2465</td>
      <td id="T_b17e6_row2_col6" class="data row2 col6" >288725</td>
    </tr>
    <tr>
      <th id="T_b17e6_level0_row3" class="row_heading level0 row3" >2021-03-26 00:00:00</th>
      <td id="T_b17e6_row3_col0" class="data row3 col0" >060310</td>
      <td id="T_b17e6_row3_col1" class="data row3 col1" >3S</td>
      <td id="T_b17e6_row3_col2" class="data row3 col2" >2480</td>
      <td id="T_b17e6_row3_col3" class="data row3 col3" >2480</td>
      <td id="T_b17e6_row3_col4" class="data row3 col4" >2400</td>
      <td id="T_b17e6_row3_col5" class="data row3 col5" >2410</td>
      <td id="T_b17e6_row3_col6" class="data row3 col6" >195825</td>
    </tr>
    <tr>
      <th id="T_b17e6_level0_row4" class="row_heading level0 row4" >2021-03-29 00:00:00</th>
      <td id="T_b17e6_row4_col0" class="data row4 col0" >060310</td>
      <td id="T_b17e6_row4_col1" class="data row4 col1" >3S</td>
      <td id="T_b17e6_row4_col2" class="data row4 col2" >2410</td>
      <td id="T_b17e6_row4_col3" class="data row4 col3" >2435</td>
      <td id="T_b17e6_row4_col4" class="data row4 col4" >2350</td>
      <td id="T_b17e6_row4_col5" class="data row4 col5" >2385</td>
      <td id="T_b17e6_row4_col6" class="data row4 col6" >194419</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> 몇 개의 종목이 있고, 각 종목별 일봉의 갯 수 가 몇 개인지 확인해 보겠습니다. 종목 수는 1422 개, 307 개의 일봉이 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">price_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">price_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;min&#39;</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1417
min    307
max    307
Name: close, dtype: int64
</pre></div>
</div>
</div>
</div>
<p><br></br></p>
</section>
<section id="pykrx">
<h3>Pykrx 로 일봉 데이터 가져오기<a class="headerlink" href="#pykrx" title="Permalink to this headline">#</a></h3>
<p>일봉을 가져올 수 있는 또 다른 라이브러러는 pykrx 입니다. 주피터노트북 상에서 설치할때는 !pip install pykrx 과 같이 앞이 ‘!’ 느낌표 후에 명령어를 타이핑합니다. 셀을 실행하면 주피터노트북 상에서 설치가 진행됩니다. 저는 아나콘다 프롬프트에서 설치하는 것을 선호합니다. 왜냐하면 설치 과정을 볼 수 있기 때문입니다. 아나콘다 프롬프트에서 아래와 같이 설치를 합니다. 잘 작동하는 지 삼성전자 일봉을 몇 개만 호출해 봅니다. 컬럼이 한글로 되어 있는 것이 이전 패키지와 다른 점입니다.</p>
<p><img src="../_images/Install_Pykrx.PNG" width="800" height="350"></img></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pykrx</span> <span class="kn">import</span> <span class="n">stock</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">stock</span><span class="o">.</span><span class="n">get_market_ohlcv</span><span class="p">(</span><span class="s1">&#39;20220104&#39;</span><span class="p">,</span><span class="s1">&#39;20220108&#39;</span><span class="p">,</span><span class="s1">&#39;005930&#39;</span><span class="p">)</span> <span class="c1"># 메소드 작동을 확인</span>
<span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_5c7fc_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >시가</th>
      <th class="col_heading level0 col1" >고가</th>
      <th class="col_heading level0 col2" >저가</th>
      <th class="col_heading level0 col3" >종가</th>
      <th class="col_heading level0 col4" >거래량</th>
    </tr>
    <tr>
      <th class="index_name level0" >날짜</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_5c7fc_level0_row0" class="row_heading level0 row0" >2022-01-04 00:00:00</th>
      <td id="T_5c7fc_row0_col0" class="data row0 col0" >78800</td>
      <td id="T_5c7fc_row0_col1" class="data row0 col1" >79200</td>
      <td id="T_5c7fc_row0_col2" class="data row0 col2" >78300</td>
      <td id="T_5c7fc_row0_col3" class="data row0 col3" >78700</td>
      <td id="T_5c7fc_row0_col4" class="data row0 col4" >12427416</td>
    </tr>
    <tr>
      <th id="T_5c7fc_level0_row1" class="row_heading level0 row1" >2022-01-05 00:00:00</th>
      <td id="T_5c7fc_row1_col0" class="data row1 col0" >78800</td>
      <td id="T_5c7fc_row1_col1" class="data row1 col1" >79000</td>
      <td id="T_5c7fc_row1_col2" class="data row1 col2" >76400</td>
      <td id="T_5c7fc_row1_col3" class="data row1 col3" >77400</td>
      <td id="T_5c7fc_row1_col4" class="data row1 col4" >25470640</td>
    </tr>
    <tr>
      <th id="T_5c7fc_level0_row2" class="row_heading level0 row2" >2022-01-06 00:00:00</th>
      <td id="T_5c7fc_row2_col0" class="data row2 col0" >76700</td>
      <td id="T_5c7fc_row2_col1" class="data row2 col1" >77600</td>
      <td id="T_5c7fc_row2_col2" class="data row2 col2" >76600</td>
      <td id="T_5c7fc_row2_col3" class="data row2 col3" >76900</td>
      <td id="T_5c7fc_row2_col4" class="data row2 col4" >12931954</td>
    </tr>
    <tr>
      <th id="T_5c7fc_level0_row3" class="row_heading level0 row3" >2022-01-07 00:00:00</th>
      <td id="T_5c7fc_row3_col0" class="data row3 col0" >78100</td>
      <td id="T_5c7fc_row3_col1" class="data row3 col1" >78400</td>
      <td id="T_5c7fc_row3_col2" class="data row3 col2" >77400</td>
      <td id="T_5c7fc_row3_col3" class="data row3 col3" >78300</td>
      <td id="T_5c7fc_row3_col4" class="data row3 col4" >15163757</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span>

<span class="n">price_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]):</span>  <span class="c1"># 코스닥 모든 종목에서 대하여 반복</span>
    <span class="n">daily_price</span> <span class="o">=</span>  <span class="n">stock</span><span class="o">.</span><span class="n">get_market_ohlcv</span><span class="p">(</span><span class="n">fromdate</span><span class="o">=</span><span class="s1">&#39;2021-01-03&#39;</span><span class="p">,</span> <span class="n">todate</span><span class="o">=</span><span class="s1">&#39;2022-03-31&#39;</span><span class="p">,</span> <span class="n">ticker</span><span class="o">=</span><span class="n">code</span><span class="p">)</span> <span class="c1"># 종목, 일봉, 데이터 갯수</span>
    <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
    <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">price_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">price_data</span><span class="p">,</span> <span class="n">daily_price</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>   

<span class="n">price_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>
<span class="n">price_data</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="s1">&#39;high&#39;</span><span class="p">,</span><span class="s1">&#39;low&#39;</span><span class="p">,</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span><span class="s1">&#39;code&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="c1"># 컬럼 이름 영문자로 변경</span>
<span class="n">price_data</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;stock_data_from_pykrx.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">price_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;stock_data_from_pykrx.pkl&#39;</span><span class="p">)</span>
<span class="n">price_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_a5a6d_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >open</th>
      <th class="col_heading level0 col1" >high</th>
      <th class="col_heading level0 col2" >low</th>
      <th class="col_heading level0 col3" >close</th>
      <th class="col_heading level0 col4" >volume</th>
      <th class="col_heading level0 col5" >code</th>
      <th class="col_heading level0 col6" >name</th>
    </tr>
    <tr>
      <th class="index_name level0" >date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_a5a6d_level0_row0" class="row_heading level0 row0" >2021-01-04 00:00:00</th>
      <td id="T_a5a6d_row0_col0" class="data row0 col0" >2185</td>
      <td id="T_a5a6d_row0_col1" class="data row0 col1" >2320</td>
      <td id="T_a5a6d_row0_col2" class="data row0 col2" >2135</td>
      <td id="T_a5a6d_row0_col3" class="data row0 col3" >2260</td>
      <td id="T_a5a6d_row0_col4" class="data row0 col4" >588133</td>
      <td id="T_a5a6d_row0_col5" class="data row0 col5" >060310</td>
      <td id="T_a5a6d_row0_col6" class="data row0 col6" >3S</td>
    </tr>
    <tr>
      <th id="T_a5a6d_level0_row1" class="row_heading level0 row1" >2021-01-05 00:00:00</th>
      <td id="T_a5a6d_row1_col0" class="data row1 col0" >2270</td>
      <td id="T_a5a6d_row1_col1" class="data row1 col1" >2285</td>
      <td id="T_a5a6d_row1_col2" class="data row1 col2" >2200</td>
      <td id="T_a5a6d_row1_col3" class="data row1 col3" >2250</td>
      <td id="T_a5a6d_row1_col4" class="data row1 col4" >410263</td>
      <td id="T_a5a6d_row1_col5" class="data row1 col5" >060310</td>
      <td id="T_a5a6d_row1_col6" class="data row1 col6" >3S</td>
    </tr>
    <tr>
      <th id="T_a5a6d_level0_row2" class="row_heading level0 row2" >2021-01-06 00:00:00</th>
      <td id="T_a5a6d_row2_col0" class="data row2 col0" >2225</td>
      <td id="T_a5a6d_row2_col1" class="data row2 col1" >2310</td>
      <td id="T_a5a6d_row2_col2" class="data row2 col2" >2215</td>
      <td id="T_a5a6d_row2_col3" class="data row2 col3" >2290</td>
      <td id="T_a5a6d_row2_col4" class="data row2 col4" >570349</td>
      <td id="T_a5a6d_row2_col5" class="data row2 col5" >060310</td>
      <td id="T_a5a6d_row2_col6" class="data row2 col6" >3S</td>
    </tr>
    <tr>
      <th id="T_a5a6d_level0_row3" class="row_heading level0 row3" >2021-01-07 00:00:00</th>
      <td id="T_a5a6d_row3_col0" class="data row3 col0" >2290</td>
      <td id="T_a5a6d_row3_col1" class="data row3 col1" >2340</td>
      <td id="T_a5a6d_row3_col2" class="data row3 col2" >2240</td>
      <td id="T_a5a6d_row3_col3" class="data row3 col3" >2290</td>
      <td id="T_a5a6d_row3_col4" class="data row3 col4" >519777</td>
      <td id="T_a5a6d_row3_col5" class="data row3 col5" >060310</td>
      <td id="T_a5a6d_row3_col6" class="data row3 col6" >3S</td>
    </tr>
    <tr>
      <th id="T_a5a6d_level0_row4" class="row_heading level0 row4" >2021-01-08 00:00:00</th>
      <td id="T_a5a6d_row4_col0" class="data row4 col0" >2300</td>
      <td id="T_a5a6d_row4_col1" class="data row4 col1" >2315</td>
      <td id="T_a5a6d_row4_col2" class="data row4 col2" >2225</td>
      <td id="T_a5a6d_row4_col3" class="data row4 col3" >2245</td>
      <td id="T_a5a6d_row4_col4" class="data row4 col4" >462568</td>
      <td id="T_a5a6d_row4_col5" class="data row4 col5" >060310</td>
      <td id="T_a5a6d_row4_col6" class="data row4 col6" >3S</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<span id="document-chapter4/4.4.2_Data_Collection"></span><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<section id="id1">
<h3>코스닥 인덱스 데이터<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>코스닥 인덱스 데이터는 FinanceDataReader 로 데이터를 수집해 보겠습니다.
사용법에 대한 설명은 아래 링크에 자세하게 되어 있습니다.
<a class="reference external" href="https://financedata.github.io/posts/finance-data-reader-users-guide.html">https://financedata.github.io/posts/finance-data-reader-users-guide.html</a></p>
<p>FinanceDataReader 는 국내 주식 데이터 뿐만 아니라 해외 데이터도 수집이 가능합니다. 환율, 암호화폐 등의 데이터도 제공됩니다.
이승준님이 개발해서 무료로 제공해 주시는 파이썬 라이브러리입니다. 금융데이터를 쉽게 수집할 수 있게 해 주신 이승준님께 다시 한 번 깊은 감사를 드립니다.</p>
<p>FinanceDataReader 를 fdr 이름으로 import 하시고, fdr.DataReader 함수에서 KQ11 를 호출하시면 결과값을 얻을 수 있습니다.
fdr.DataReader(‘KQ11’, ‘2021’) 에서 ‘KQ11’ 는 코스닥 지수 종목을 의미하고 ‘2021’ 은 2021 년부터 데이터를 가져오라는 뜻 입니다.</p>
<p>Pandas 에서 제공하는 plot 를 이용하여 2021년 부터 코스닥 지수 시계열 데이터를 그려보았습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kosdaq_index</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s1">&#39;KQ11&#39;</span><span class="p">,</span> <span class="s1">&#39;2021&#39;</span><span class="p">)</span> <span class="c1"># 데이터 호출</span>
<span class="n">kosdaq_index</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="s1">&#39;high&#39;</span><span class="p">,</span><span class="s1">&#39;low&#39;</span><span class="p">,</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span><span class="s1">&#39;change&#39;</span><span class="p">]</span> <span class="c1"># 컬럼명 변경</span>
<span class="n">kosdaq_index</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;date&#39;</span> <span class="c1"># 인덱스 이름 생성</span>
<span class="n">kosdaq_index</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># 인덱스(날짜) 로 정렬 </span>
<span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 수익율 : 전 날 종가대비 당일 종가</span>
<span class="n">kosdaq_index</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_index.pkl&#39;</span><span class="p">)</span> <span class="c1"># 피클로 저장</span>

<span class="c1"># 차트 생성</span>
<span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;KOSDAQ Index&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;KOSDAQ Index&#39;)
</pre></div>
</div>
<img alt="_images/4.4.2_Data_Collection_2_1.png" src="_images/4.4.2_Data_Collection_2_1.png" />
</div>
</div>
<p>일별 수익율 그래프도 함 그려보겠습니다. 2021년 3월부터 2021년 8월까지는 수익율의 변동성이 비교적 적어보입니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 차트 생성</span>
<span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;KOSDAQ Index Daily Return&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;KOSDAQ Index Daily Return&#39;)
</pre></div>
</div>
<img alt="_images/4.4.2_Data_Collection_4_1.png" src="_images/4.4.2_Data_Collection_4_1.png" />
</div>
</div>
<p>저장된 Pickle 파일을 읽어서 첫 5 행 출력해 봅니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kosdaq_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_index.pkl&#39;</span><span class="p">)</span> 
<span class="n">kosdaq_index</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_c529d_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >close</th>
      <th class="col_heading level0 col1" >open</th>
      <th class="col_heading level0 col2" >high</th>
      <th class="col_heading level0 col3" >low</th>
      <th class="col_heading level0 col4" >volume</th>
      <th class="col_heading level0 col5" >change</th>
      <th class="col_heading level0 col6" >kosdaq_return</th>
    </tr>
    <tr>
      <th class="index_name level0" >date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_c529d_level0_row0" class="row_heading level0 row0" >2021-01-04 00:00:00</th>
      <td id="T_c529d_row0_col0" class="data row0 col0" >977.620</td>
      <td id="T_c529d_row0_col1" class="data row0 col1" >968.860</td>
      <td id="T_c529d_row0_col2" class="data row0 col2" >977.620</td>
      <td id="T_c529d_row0_col3" class="data row0 col3" >960.520</td>
      <td id="T_c529d_row0_col4" class="data row0 col4" >1700000000.000</td>
      <td id="T_c529d_row0_col5" class="data row0 col5" >0.009</td>
      <td id="T_c529d_row0_col6" class="data row0 col6" >nan</td>
    </tr>
    <tr>
      <th id="T_c529d_level0_row1" class="row_heading level0 row1" >2021-01-05 00:00:00</th>
      <td id="T_c529d_row1_col0" class="data row1 col0" >985.760</td>
      <td id="T_c529d_row1_col1" class="data row1 col1" >976.430</td>
      <td id="T_c529d_row1_col2" class="data row1 col2" >985.760</td>
      <td id="T_c529d_row1_col3" class="data row1 col3" >965.530</td>
      <td id="T_c529d_row1_col4" class="data row1 col4" >1810000000.000</td>
      <td id="T_c529d_row1_col5" class="data row1 col5" >0.008</td>
      <td id="T_c529d_row1_col6" class="data row1 col6" >1.008</td>
    </tr>
    <tr>
      <th id="T_c529d_level0_row2" class="row_heading level0 row2" >2021-01-06 00:00:00</th>
      <td id="T_c529d_row2_col0" class="data row2 col0" >981.390</td>
      <td id="T_c529d_row2_col1" class="data row2 col1" >987.250</td>
      <td id="T_c529d_row2_col2" class="data row2 col2" >990.880</td>
      <td id="T_c529d_row2_col3" class="data row2 col3" >977.370</td>
      <td id="T_c529d_row2_col4" class="data row2 col4" >1980000000.000</td>
      <td id="T_c529d_row2_col5" class="data row2 col5" >-0.004</td>
      <td id="T_c529d_row2_col6" class="data row2 col6" >0.996</td>
    </tr>
    <tr>
      <th id="T_c529d_level0_row3" class="row_heading level0 row3" >2021-01-07 00:00:00</th>
      <td id="T_c529d_row3_col0" class="data row3 col0" >988.860</td>
      <td id="T_c529d_row3_col1" class="data row3 col1" >983.280</td>
      <td id="T_c529d_row3_col2" class="data row3 col2" >993.910</td>
      <td id="T_c529d_row3_col3" class="data row3 col3" >982.270</td>
      <td id="T_c529d_row3_col4" class="data row3 col4" >2260000000.000</td>
      <td id="T_c529d_row3_col5" class="data row3 col5" >0.008</td>
      <td id="T_c529d_row3_col6" class="data row3 col6" >1.008</td>
    </tr>
    <tr>
      <th id="T_c529d_level0_row4" class="row_heading level0 row4" >2021-01-08 00:00:00</th>
      <td id="T_c529d_row4_col0" class="data row4 col0" >987.790</td>
      <td id="T_c529d_row4_col1" class="data row4 col1" >990.700</td>
      <td id="T_c529d_row4_col2" class="data row4 col2" >995.220</td>
      <td id="T_c529d_row4_col3" class="data row4 col3" >978.120</td>
      <td id="T_c529d_row4_col4" class="data row4 col4" >2560000000.000</td>
      <td id="T_c529d_row4_col5" class="data row4 col5" >-0.001</td>
      <td id="T_c529d_row4_col6" class="data row4 col6" >0.999</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<span id="document-chapter4/4.4.3_Data_Collection"></span><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<section id="id1">
<h3>종목별 일봉 데이터와 코스피 지수 데이터와 결합<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>앞에서 저장한 종목 리스트, 코스닥 종목별 주가 데이터와 지수 데이터를 읽습니다. 인덱스(날짜) 의 최소값과 최대값을 확인해 봅니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">price_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;stock_data_from_fdr.pkl&#39;</span><span class="p">)</span> <span class="c1"># 주가 정보</span>
<span class="n">kosdaq_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_index.pkl&#39;</span><span class="p">)</span> <span class="c1"># 지수 정보</span>
<span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span> <span class="c1"># 종목 정보</span>

<span class="nb">print</span><span class="p">(</span><span class="n">price_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">price_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">kosdaq_index</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">kosdaq_index</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-01-04 00:00:00 2022-03-31 00:00:00
2021-01-04 00:00:00 2022-06-24 00:00:00
</pre></div>
</div>
</div>
</div>
<p><br> 나중에 검정할 가설 중 하나가 “주가가 상승할 확률이 높은 종목은 마켓이 안 좋을 때(즉 지표가 빠질 때) 수익율이 좋았다” 입니다. 이 가설을 검증하기 위해 두 데이타셋을 병합합니다. 두 데이터를 종목별 날짜별로 병합을 해야 ‘종목 수익율’과 ‘코스닥 지수 수익율’을 비교할 수 있습니다.</p>
<p>price_data 를 기준으로 kosdaq_index 데이터의 지수 수익율을 추가합니다. price_data 에 날짜를 Index 로 left merge 를 하면 주가지수 정보를 추가할 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">merged</span> <span class="o">=</span> <span class="n">price_data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">],</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">merged</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_f179f_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >open</th>
      <th class="col_heading level0 col1" >high</th>
      <th class="col_heading level0 col2" >low</th>
      <th class="col_heading level0 col3" >close</th>
      <th class="col_heading level0 col4" >volume</th>
      <th class="col_heading level0 col5" >change</th>
      <th class="col_heading level0 col6" >code</th>
      <th class="col_heading level0 col7" >name</th>
      <th class="col_heading level0 col8" >kosdaq_return</th>
    </tr>
    <tr>
      <th class="index_name level0" >date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
      <th class="blank col7" >&nbsp;</th>
      <th class="blank col8" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_f179f_level0_row0" class="row_heading level0 row0" >2021-01-04 00:00:00</th>
      <td id="T_f179f_row0_col0" class="data row0 col0" >2185</td>
      <td id="T_f179f_row0_col1" class="data row0 col1" >2320</td>
      <td id="T_f179f_row0_col2" class="data row0 col2" >2135</td>
      <td id="T_f179f_row0_col3" class="data row0 col3" >2260</td>
      <td id="T_f179f_row0_col4" class="data row0 col4" >588133</td>
      <td id="T_f179f_row0_col5" class="data row0 col5" >0.043880</td>
      <td id="T_f179f_row0_col6" class="data row0 col6" >060310</td>
      <td id="T_f179f_row0_col7" class="data row0 col7" >3S</td>
      <td id="T_f179f_row0_col8" class="data row0 col8" >nan</td>
    </tr>
    <tr>
      <th id="T_f179f_level0_row1" class="row_heading level0 row1" >2021-01-04 00:00:00</th>
      <td id="T_f179f_row1_col0" class="data row1 col0" >8220</td>
      <td id="T_f179f_row1_col1" class="data row1 col1" >8270</td>
      <td id="T_f179f_row1_col2" class="data row1 col2" >7960</td>
      <td id="T_f179f_row1_col3" class="data row1 col3" >8000</td>
      <td id="T_f179f_row1_col4" class="data row1 col4" >300316</td>
      <td id="T_f179f_row1_col5" class="data row1 col5" >-0.025579</td>
      <td id="T_f179f_row1_col6" class="data row1 col6" >054620</td>
      <td id="T_f179f_row1_col7" class="data row1 col7" >APS홀딩스</td>
      <td id="T_f179f_row1_col8" class="data row1 col8" >nan</td>
    </tr>
    <tr>
      <th id="T_f179f_level0_row2" class="row_heading level0 row2" >2021-01-04 00:00:00</th>
      <td id="T_f179f_row2_col0" class="data row2 col0" >25100</td>
      <td id="T_f179f_row2_col1" class="data row2 col1" >25600</td>
      <td id="T_f179f_row2_col2" class="data row2 col2" >24800</td>
      <td id="T_f179f_row2_col3" class="data row2 col3" >25500</td>
      <td id="T_f179f_row2_col4" class="data row2 col4" >415285</td>
      <td id="T_f179f_row2_col5" class="data row2 col5" >0.026157</td>
      <td id="T_f179f_row2_col6" class="data row2 col6" >265520</td>
      <td id="T_f179f_row2_col7" class="data row2 col7" >AP시스템</td>
      <td id="T_f179f_row2_col8" class="data row2 col8" >nan</td>
    </tr>
    <tr>
      <th id="T_f179f_level0_row3" class="row_heading level0 row3" >2021-01-04 00:00:00</th>
      <td id="T_f179f_row3_col0" class="data row3 col0" >7960</td>
      <td id="T_f179f_row3_col1" class="data row3 col1" >8470</td>
      <td id="T_f179f_row3_col2" class="data row3 col2" >7790</td>
      <td id="T_f179f_row3_col3" class="data row3 col3" >8330</td>
      <td id="T_f179f_row3_col4" class="data row3 col4" >424730</td>
      <td id="T_f179f_row3_col5" class="data row3 col5" >0.051768</td>
      <td id="T_f179f_row3_col6" class="data row3 col6" >211270</td>
      <td id="T_f179f_row3_col7" class="data row3 col7" >AP위성</td>
      <td id="T_f179f_row3_col8" class="data row3 col8" >nan</td>
    </tr>
    <tr>
      <th id="T_f179f_level0_row4" class="row_heading level0 row4" >2021-01-04 00:00:00</th>
      <td id="T_f179f_row4_col0" class="data row4 col0" >0</td>
      <td id="T_f179f_row4_col1" class="data row4 col1" >0</td>
      <td id="T_f179f_row4_col2" class="data row4 col2" >0</td>
      <td id="T_f179f_row4_col3" class="data row4 col3" >4075</td>
      <td id="T_f179f_row4_col4" class="data row4 col4" >0</td>
      <td id="T_f179f_row4_col5" class="data row4 col5" >0.000000</td>
      <td id="T_f179f_row4_col6" class="data row4 col6" >032790</td>
      <td id="T_f179f_row4_col7" class="data row4 col7" >BNGT</td>
      <td id="T_f179f_row4_col8" class="data row4 col8" >nan</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br>가설 검정을 위해 미리 컬럼을 생성합니다. 코스닥 지수 수익율이 1 보다 적을 때, 종목의 수익율이 1 보다 크면 1, 아니면 0 을 생성합니다. 그 값을 win_market 이라는 새로운 컬럼에 저장합니다. 아래오와 같이 np.where 구문을 사용했는데요.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;win_market&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">c1</span><span class="o">&amp;</span><span class="n">c2</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>이 메소드는 np.where(조건, 조건이 참일 때 값, 조건이 거짓일 때 값)와 같이 처리를 합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">return_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]:</span>  
    
    <span class="n">stock_return</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">merged</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    <span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 종목별 전일 종가 대비 당일 종가 수익율</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># 수익율 1 보다 작음. 당일 종가가 전일 종가보다 낮음 (코스닥 지표)</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># 수익율 1 보다 큼. 당일 종가가 전일 종가보다 큼 (개별 종목)</span>
    <span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;win_market&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">c1</span><span class="o">&amp;</span><span class="n">c2</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># C1 과 C2 조건을 동시에 만족하면 1, 아니면 0</span>
    <span class="n">return_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">return_all</span><span class="p">,</span> <span class="n">stock_return</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> 
    
<span class="n">return_all</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;return_all.pkl&#39;</span><span class="p">)</span>       
</pre></div>
</div>
</div>
</div>
<p><br> 값이 잘 들어갔는 지 head 메소드로 첫 번째 행 5 개를 출력해 봅니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">return_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;return_all.pkl&#39;</span><span class="p">)</span>  
<span class="n">return_all</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_fdc41_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >open</th>
      <th class="col_heading level0 col1" >high</th>
      <th class="col_heading level0 col2" >low</th>
      <th class="col_heading level0 col3" >close</th>
      <th class="col_heading level0 col4" >volume</th>
      <th class="col_heading level0 col5" >change</th>
      <th class="col_heading level0 col6" >code</th>
      <th class="col_heading level0 col7" >name</th>
      <th class="col_heading level0 col8" >kosdaq_return</th>
      <th class="col_heading level0 col9" >return</th>
      <th class="col_heading level0 col10" >win_market</th>
    </tr>
    <tr>
      <th class="index_name level0" >date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
      <th class="blank col7" >&nbsp;</th>
      <th class="blank col8" >&nbsp;</th>
      <th class="blank col9" >&nbsp;</th>
      <th class="blank col10" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_fdc41_level0_row0" class="row_heading level0 row0" >2021-01-04 00:00:00</th>
      <td id="T_fdc41_row0_col0" class="data row0 col0" >2185</td>
      <td id="T_fdc41_row0_col1" class="data row0 col1" >2320</td>
      <td id="T_fdc41_row0_col2" class="data row0 col2" >2135</td>
      <td id="T_fdc41_row0_col3" class="data row0 col3" >2260</td>
      <td id="T_fdc41_row0_col4" class="data row0 col4" >588133</td>
      <td id="T_fdc41_row0_col5" class="data row0 col5" >0.043880</td>
      <td id="T_fdc41_row0_col6" class="data row0 col6" >060310</td>
      <td id="T_fdc41_row0_col7" class="data row0 col7" >3S</td>
      <td id="T_fdc41_row0_col8" class="data row0 col8" >nan</td>
      <td id="T_fdc41_row0_col9" class="data row0 col9" >nan</td>
      <td id="T_fdc41_row0_col10" class="data row0 col10" >0</td>
    </tr>
    <tr>
      <th id="T_fdc41_level0_row1" class="row_heading level0 row1" >2021-01-05 00:00:00</th>
      <td id="T_fdc41_row1_col0" class="data row1 col0" >2270</td>
      <td id="T_fdc41_row1_col1" class="data row1 col1" >2285</td>
      <td id="T_fdc41_row1_col2" class="data row1 col2" >2200</td>
      <td id="T_fdc41_row1_col3" class="data row1 col3" >2250</td>
      <td id="T_fdc41_row1_col4" class="data row1 col4" >410263</td>
      <td id="T_fdc41_row1_col5" class="data row1 col5" >-0.004425</td>
      <td id="T_fdc41_row1_col6" class="data row1 col6" >060310</td>
      <td id="T_fdc41_row1_col7" class="data row1 col7" >3S</td>
      <td id="T_fdc41_row1_col8" class="data row1 col8" >1.008326</td>
      <td id="T_fdc41_row1_col9" class="data row1 col9" >0.995575</td>
      <td id="T_fdc41_row1_col10" class="data row1 col10" >0</td>
    </tr>
    <tr>
      <th id="T_fdc41_level0_row2" class="row_heading level0 row2" >2021-01-06 00:00:00</th>
      <td id="T_fdc41_row2_col0" class="data row2 col0" >2225</td>
      <td id="T_fdc41_row2_col1" class="data row2 col1" >2310</td>
      <td id="T_fdc41_row2_col2" class="data row2 col2" >2215</td>
      <td id="T_fdc41_row2_col3" class="data row2 col3" >2290</td>
      <td id="T_fdc41_row2_col4" class="data row2 col4" >570349</td>
      <td id="T_fdc41_row2_col5" class="data row2 col5" >0.017778</td>
      <td id="T_fdc41_row2_col6" class="data row2 col6" >060310</td>
      <td id="T_fdc41_row2_col7" class="data row2 col7" >3S</td>
      <td id="T_fdc41_row2_col8" class="data row2 col8" >0.995567</td>
      <td id="T_fdc41_row2_col9" class="data row2 col9" >1.017778</td>
      <td id="T_fdc41_row2_col10" class="data row2 col10" >1</td>
    </tr>
    <tr>
      <th id="T_fdc41_level0_row3" class="row_heading level0 row3" >2021-01-07 00:00:00</th>
      <td id="T_fdc41_row3_col0" class="data row3 col0" >2290</td>
      <td id="T_fdc41_row3_col1" class="data row3 col1" >2340</td>
      <td id="T_fdc41_row3_col2" class="data row3 col2" >2240</td>
      <td id="T_fdc41_row3_col3" class="data row3 col3" >2290</td>
      <td id="T_fdc41_row3_col4" class="data row3 col4" >519777</td>
      <td id="T_fdc41_row3_col5" class="data row3 col5" >0.000000</td>
      <td id="T_fdc41_row3_col6" class="data row3 col6" >060310</td>
      <td id="T_fdc41_row3_col7" class="data row3 col7" >3S</td>
      <td id="T_fdc41_row3_col8" class="data row3 col8" >1.007612</td>
      <td id="T_fdc41_row3_col9" class="data row3 col9" >1.000000</td>
      <td id="T_fdc41_row3_col10" class="data row3 col10" >0</td>
    </tr>
    <tr>
      <th id="T_fdc41_level0_row4" class="row_heading level0 row4" >2021-01-08 00:00:00</th>
      <td id="T_fdc41_row4_col0" class="data row4 col0" >2300</td>
      <td id="T_fdc41_row4_col1" class="data row4 col1" >2315</td>
      <td id="T_fdc41_row4_col2" class="data row4 col2" >2225</td>
      <td id="T_fdc41_row4_col3" class="data row4 col3" >2245</td>
      <td id="T_fdc41_row4_col4" class="data row4 col4" >462568</td>
      <td id="T_fdc41_row4_col5" class="data row4 col5" >-0.019651</td>
      <td id="T_fdc41_row4_col6" class="data row4 col6" >060310</td>
      <td id="T_fdc41_row4_col7" class="data row4 col7" >3S</td>
      <td id="T_fdc41_row4_col8" class="data row4 col8" >0.998918</td>
      <td id="T_fdc41_row4_col9" class="data row4 col9" >0.980349</td>
      <td id="T_fdc41_row4_col10" class="data row4 col10" >0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>가설 검정 시 자세히 다루겠지만, win_market 의 비율과 종목별 수익율과의 관계를 간단하게 조사하겠습니다. 이번에 scatter plot 를 함 그려보겠습니다. Scatter plot 에는 x 축의 값과 y 축의 값을 인수로 넣어주면 됩니다. 그래프를 보니 두 값 사이에 상관성이 높아 보입니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">return_all</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)[</span><span class="s1">&#39;win_market&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 종목별 win_market의 비율</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">return_all</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 종목별 평균 수익율 </span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="p">,</span> <span class="n">y</span><span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">% o</span><span class="s1">f Win Market&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Avg. Return&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0, 0.5, &#39;Avg. Return&#39;)
</pre></div>
</div>
<img alt="_images/4.4.3_Data_Collection_10_1.png" src="_images/4.4.3_Data_Collection_10_1.png" />
</div>
</div>
</section>
<span id="document-chapter4/4.4.4_Data_Processing"></span><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.expand_frame_repr&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="id1">
<h3>가설 검증을 위한 데이터 처리<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>앞서 만든 return_all (주가 데이터에 지수데이터가 추가된 파일) 을 아래와 같이 로드하고, Missing Data 는 제거합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">return_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;return_all.pkl&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>  
<span class="n">return_all</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">return_all</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">return_all</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_172b9_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >open</th>
      <th class="col_heading level0 col1" >high</th>
      <th class="col_heading level0 col2" >low</th>
      <th class="col_heading level0 col3" >close</th>
      <th class="col_heading level0 col4" >volume</th>
      <th class="col_heading level0 col5" >change</th>
      <th class="col_heading level0 col6" >code</th>
      <th class="col_heading level0 col7" >name</th>
      <th class="col_heading level0 col8" >kosdaq_return</th>
      <th class="col_heading level0 col9" >return</th>
      <th class="col_heading level0 col10" >win_market</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_172b9_level0_row0" class="row_heading level0 row0" >2021-01-05</th>
      <td id="T_172b9_row0_col0" class="data row0 col0" >2270</td>
      <td id="T_172b9_row0_col1" class="data row0 col1" >2285</td>
      <td id="T_172b9_row0_col2" class="data row0 col2" >2200</td>
      <td id="T_172b9_row0_col3" class="data row0 col3" >2250</td>
      <td id="T_172b9_row0_col4" class="data row0 col4" >410263</td>
      <td id="T_172b9_row0_col5" class="data row0 col5" >-0.004425</td>
      <td id="T_172b9_row0_col6" class="data row0 col6" >060310</td>
      <td id="T_172b9_row0_col7" class="data row0 col7" >3S</td>
      <td id="T_172b9_row0_col8" class="data row0 col8" >1.008326</td>
      <td id="T_172b9_row0_col9" class="data row0 col9" >0.995575</td>
      <td id="T_172b9_row0_col10" class="data row0 col10" >0</td>
    </tr>
    <tr>
      <th id="T_172b9_level0_row1" class="row_heading level0 row1" >2021-01-06</th>
      <td id="T_172b9_row1_col0" class="data row1 col0" >2225</td>
      <td id="T_172b9_row1_col1" class="data row1 col1" >2310</td>
      <td id="T_172b9_row1_col2" class="data row1 col2" >2215</td>
      <td id="T_172b9_row1_col3" class="data row1 col3" >2290</td>
      <td id="T_172b9_row1_col4" class="data row1 col4" >570349</td>
      <td id="T_172b9_row1_col5" class="data row1 col5" >0.017778</td>
      <td id="T_172b9_row1_col6" class="data row1 col6" >060310</td>
      <td id="T_172b9_row1_col7" class="data row1 col7" >3S</td>
      <td id="T_172b9_row1_col8" class="data row1 col8" >0.995567</td>
      <td id="T_172b9_row1_col9" class="data row1 col9" >1.017778</td>
      <td id="T_172b9_row1_col10" class="data row1 col10" >1</td>
    </tr>
    <tr>
      <th id="T_172b9_level0_row2" class="row_heading level0 row2" >2021-01-07</th>
      <td id="T_172b9_row2_col0" class="data row2 col0" >2290</td>
      <td id="T_172b9_row2_col1" class="data row2 col1" >2340</td>
      <td id="T_172b9_row2_col2" class="data row2 col2" >2240</td>
      <td id="T_172b9_row2_col3" class="data row2 col3" >2290</td>
      <td id="T_172b9_row2_col4" class="data row2 col4" >519777</td>
      <td id="T_172b9_row2_col5" class="data row2 col5" >0.000000</td>
      <td id="T_172b9_row2_col6" class="data row2 col6" >060310</td>
      <td id="T_172b9_row2_col7" class="data row2 col7" >3S</td>
      <td id="T_172b9_row2_col8" class="data row2 col8" >1.007612</td>
      <td id="T_172b9_row2_col9" class="data row2 col9" >1.000000</td>
      <td id="T_172b9_row2_col10" class="data row2 col10" >0</td>
    </tr>
    <tr>
      <th id="T_172b9_level0_row3" class="row_heading level0 row3" >2021-01-08</th>
      <td id="T_172b9_row3_col0" class="data row3 col0" >2300</td>
      <td id="T_172b9_row3_col1" class="data row3 col1" >2315</td>
      <td id="T_172b9_row3_col2" class="data row3 col2" >2225</td>
      <td id="T_172b9_row3_col3" class="data row3 col3" >2245</td>
      <td id="T_172b9_row3_col4" class="data row3 col4" >462568</td>
      <td id="T_172b9_row3_col5" class="data row3 col5" >-0.019651</td>
      <td id="T_172b9_row3_col6" class="data row3 col6" >060310</td>
      <td id="T_172b9_row3_col7" class="data row3 col7" >3S</td>
      <td id="T_172b9_row3_col8" class="data row3 col8" >0.998918</td>
      <td id="T_172b9_row3_col9" class="data row3 col9" >0.980349</td>
      <td id="T_172b9_row3_col10" class="data row3 col10" >0</td>
    </tr>
    <tr>
      <th id="T_172b9_level0_row4" class="row_heading level0 row4" >2021-01-11</th>
      <td id="T_172b9_row4_col0" class="data row4 col0" >2230</td>
      <td id="T_172b9_row4_col1" class="data row4 col1" >2275</td>
      <td id="T_172b9_row4_col2" class="data row4 col2" >2130</td>
      <td id="T_172b9_row4_col3" class="data row4 col3" >2175</td>
      <td id="T_172b9_row4_col4" class="data row4 col4" >409057</td>
      <td id="T_172b9_row4_col5" class="data row4 col5" >-0.031180</td>
      <td id="T_172b9_row4_col6" class="data row4 col6" >060310</td>
      <td id="T_172b9_row4_col7" class="data row4 col7" >3S</td>
      <td id="T_172b9_row4_col8" class="data row4 col8" >0.988702</td>
      <td id="T_172b9_row4_col9" class="data row4 col9" >0.968820</td>
      <td id="T_172b9_row4_col10" class="data row4 col10" >0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br>일주일(5영업일)을 수익율의 관찰 기간으로 하고, 관찰 기간 동안 주가 상승이 있으면 저희가 세운 가설들을 유의미한 가설로 판단하겠습니다. 여기서 주가 상승의 기준은  “종가 매수 일부터 다음 5 영업일 동안 최고 종가 수익율” 하겠습니다.</p>
<p>첫 번째 종목 060310 에 대하여 처리를 먼저 해 보겠습니다. df[‘close’] * shift(-1) 은 다음 영업일의 종가 수익율을 참조하고, df[‘close’]*shift(-2) 은 그 다음의 영업일의 종가 수익율을 참조합니다. 따라서 매수 후 2 영업일 후, 종가 수익율은 { df[‘close’] * shift(-1) } * { df[‘close’] * shift(-2) } 로 계산됩니다. 이렇게 1 영업일, 2 영업일, 3 영업일, 4 영업일, 5 영업일 후 종가 수익율을 새로운 컬럼에 생성하고, 그 중에서 가장 큰 수익율을 고르면 됩니다. 생성된 컬럼 중 가장 큰 값은 max(axis=1) 로 찾습니다. 참고로 max() 에서는 axis=0 이 Default 라서 axis=1 로 정해주지 않으면 열에서 가장 큰 값을 찾게 됩니다. 이 부분을 유의해 주세요.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;060310&#39;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">return_all</span><span class="p">[</span><span class="n">return_all</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="c1"># 1 일후 종가 수익률</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;close_r2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="c1"># 2 일후 종가 수익률</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;close_r3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="c1"># 3 일후 종가 수익률</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;close_r4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="c1"># 4 일후 종가 수익률</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="c1"># 5 일후 종가 수익률</span>

<span class="sd">&#39;&#39;&#39; 위 코드와 같은 결과</span>
<span class="sd">df[&#39;return_1&#39;] = df[&#39;return&#39;].shift(-1)</span>
<span class="sd">df[&#39;return_2&#39;] = df[&#39;return&#39;].shift(-2)*df[&#39;return&#39;].shift(-1)</span>
<span class="sd">df[&#39;return_3&#39;] = df[&#39;return&#39;].shift(-3)*df[&#39;return&#39;].shift(-2)*df[&#39;return&#39;].shift(-1)</span>
<span class="sd">df[&#39;return_4&#39;] = df[&#39;return&#39;].shift(-4)*df[&#39;return&#39;].shift(-3)*df[&#39;return&#39;].shift(-2)*df[&#39;return&#39;].shift(-1)</span>
<span class="sd">df[&#39;return_5&#39;] = df[&#39;return&#39;].shift(-5)*df[&#39;return&#39;].shift(-4)*df[&#39;return&#39;].shift(-3)*df[&#39;return&#39;].shift(-2)*df[&#39;return&#39;].shift(-1)</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 주어지 컬럼에서 최대 값을 찾고 &#39;target&#39; 에 저장</span>
<span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># 주어진 컬럼 중에 missing 값이 있으면 행을 제거(dropna)하고, 자신을 덮어 씀(inplace=True).</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_6d918_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >open</th>
      <th class="col_heading level0 col1" >high</th>
      <th class="col_heading level0 col2" >low</th>
      <th class="col_heading level0 col3" >close</th>
      <th class="col_heading level0 col4" >volume</th>
      <th class="col_heading level0 col5" >change</th>
      <th class="col_heading level0 col6" >code</th>
      <th class="col_heading level0 col7" >name</th>
      <th class="col_heading level0 col8" >kosdaq_return</th>
      <th class="col_heading level0 col9" >return</th>
      <th class="col_heading level0 col10" >win_market</th>
      <th class="col_heading level0 col11" >close_r1</th>
      <th class="col_heading level0 col12" >close_r2</th>
      <th class="col_heading level0 col13" >close_r3</th>
      <th class="col_heading level0 col14" >close_r4</th>
      <th class="col_heading level0 col15" >close_r5</th>
      <th class="col_heading level0 col16" >target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_6d918_level0_row0" class="row_heading level0 row0" >2021-01-05</th>
      <td id="T_6d918_row0_col0" class="data row0 col0" >2270</td>
      <td id="T_6d918_row0_col1" class="data row0 col1" >2285</td>
      <td id="T_6d918_row0_col2" class="data row0 col2" >2200</td>
      <td id="T_6d918_row0_col3" class="data row0 col3" >2250</td>
      <td id="T_6d918_row0_col4" class="data row0 col4" >410263</td>
      <td id="T_6d918_row0_col5" class="data row0 col5" >-0.004425</td>
      <td id="T_6d918_row0_col6" class="data row0 col6" >060310</td>
      <td id="T_6d918_row0_col7" class="data row0 col7" >3S</td>
      <td id="T_6d918_row0_col8" class="data row0 col8" >1.008326</td>
      <td id="T_6d918_row0_col9" class="data row0 col9" >0.995575</td>
      <td id="T_6d918_row0_col10" class="data row0 col10" >0</td>
      <td id="T_6d918_row0_col11" class="data row0 col11" >1.017778</td>
      <td id="T_6d918_row0_col12" class="data row0 col12" >1.017778</td>
      <td id="T_6d918_row0_col13" class="data row0 col13" >0.997778</td>
      <td id="T_6d918_row0_col14" class="data row0 col14" >0.966667</td>
      <td id="T_6d918_row0_col15" class="data row0 col15" >0.971111</td>
      <td id="T_6d918_row0_col16" class="data row0 col16" >1.017778</td>
    </tr>
    <tr>
      <th id="T_6d918_level0_row1" class="row_heading level0 row1" >2021-01-06</th>
      <td id="T_6d918_row1_col0" class="data row1 col0" >2225</td>
      <td id="T_6d918_row1_col1" class="data row1 col1" >2310</td>
      <td id="T_6d918_row1_col2" class="data row1 col2" >2215</td>
      <td id="T_6d918_row1_col3" class="data row1 col3" >2290</td>
      <td id="T_6d918_row1_col4" class="data row1 col4" >570349</td>
      <td id="T_6d918_row1_col5" class="data row1 col5" >0.017778</td>
      <td id="T_6d918_row1_col6" class="data row1 col6" >060310</td>
      <td id="T_6d918_row1_col7" class="data row1 col7" >3S</td>
      <td id="T_6d918_row1_col8" class="data row1 col8" >0.995567</td>
      <td id="T_6d918_row1_col9" class="data row1 col9" >1.017778</td>
      <td id="T_6d918_row1_col10" class="data row1 col10" >1</td>
      <td id="T_6d918_row1_col11" class="data row1 col11" >1.000000</td>
      <td id="T_6d918_row1_col12" class="data row1 col12" >0.980349</td>
      <td id="T_6d918_row1_col13" class="data row1 col13" >0.949782</td>
      <td id="T_6d918_row1_col14" class="data row1 col14" >0.954148</td>
      <td id="T_6d918_row1_col15" class="data row1 col15" >0.949782</td>
      <td id="T_6d918_row1_col16" class="data row1 col16" >1.000000</td>
    </tr>
    <tr>
      <th id="T_6d918_level0_row2" class="row_heading level0 row2" >2021-01-07</th>
      <td id="T_6d918_row2_col0" class="data row2 col0" >2290</td>
      <td id="T_6d918_row2_col1" class="data row2 col1" >2340</td>
      <td id="T_6d918_row2_col2" class="data row2 col2" >2240</td>
      <td id="T_6d918_row2_col3" class="data row2 col3" >2290</td>
      <td id="T_6d918_row2_col4" class="data row2 col4" >519777</td>
      <td id="T_6d918_row2_col5" class="data row2 col5" >0.000000</td>
      <td id="T_6d918_row2_col6" class="data row2 col6" >060310</td>
      <td id="T_6d918_row2_col7" class="data row2 col7" >3S</td>
      <td id="T_6d918_row2_col8" class="data row2 col8" >1.007612</td>
      <td id="T_6d918_row2_col9" class="data row2 col9" >1.000000</td>
      <td id="T_6d918_row2_col10" class="data row2 col10" >0</td>
      <td id="T_6d918_row2_col11" class="data row2 col11" >0.980349</td>
      <td id="T_6d918_row2_col12" class="data row2 col12" >0.949782</td>
      <td id="T_6d918_row2_col13" class="data row2 col13" >0.954148</td>
      <td id="T_6d918_row2_col14" class="data row2 col14" >0.949782</td>
      <td id="T_6d918_row2_col15" class="data row2 col15" >0.958515</td>
      <td id="T_6d918_row2_col16" class="data row2 col16" >0.980349</td>
    </tr>
    <tr>
      <th id="T_6d918_level0_row3" class="row_heading level0 row3" >2021-01-08</th>
      <td id="T_6d918_row3_col0" class="data row3 col0" >2300</td>
      <td id="T_6d918_row3_col1" class="data row3 col1" >2315</td>
      <td id="T_6d918_row3_col2" class="data row3 col2" >2225</td>
      <td id="T_6d918_row3_col3" class="data row3 col3" >2245</td>
      <td id="T_6d918_row3_col4" class="data row3 col4" >462568</td>
      <td id="T_6d918_row3_col5" class="data row3 col5" >-0.019651</td>
      <td id="T_6d918_row3_col6" class="data row3 col6" >060310</td>
      <td id="T_6d918_row3_col7" class="data row3 col7" >3S</td>
      <td id="T_6d918_row3_col8" class="data row3 col8" >0.998918</td>
      <td id="T_6d918_row3_col9" class="data row3 col9" >0.980349</td>
      <td id="T_6d918_row3_col10" class="data row3 col10" >0</td>
      <td id="T_6d918_row3_col11" class="data row3 col11" >0.968820</td>
      <td id="T_6d918_row3_col12" class="data row3 col12" >0.973274</td>
      <td id="T_6d918_row3_col13" class="data row3 col13" >0.968820</td>
      <td id="T_6d918_row3_col14" class="data row3 col14" >0.977728</td>
      <td id="T_6d918_row3_col15" class="data row3 col15" >0.973274</td>
      <td id="T_6d918_row3_col16" class="data row3 col16" >0.977728</td>
    </tr>
    <tr>
      <th id="T_6d918_level0_row4" class="row_heading level0 row4" >2021-01-11</th>
      <td id="T_6d918_row4_col0" class="data row4 col0" >2230</td>
      <td id="T_6d918_row4_col1" class="data row4 col1" >2275</td>
      <td id="T_6d918_row4_col2" class="data row4 col2" >2130</td>
      <td id="T_6d918_row4_col3" class="data row4 col3" >2175</td>
      <td id="T_6d918_row4_col4" class="data row4 col4" >409057</td>
      <td id="T_6d918_row4_col5" class="data row4 col5" >-0.031180</td>
      <td id="T_6d918_row4_col6" class="data row4 col6" >060310</td>
      <td id="T_6d918_row4_col7" class="data row4 col7" >3S</td>
      <td id="T_6d918_row4_col8" class="data row4 col8" >0.988702</td>
      <td id="T_6d918_row4_col9" class="data row4 col9" >0.968820</td>
      <td id="T_6d918_row4_col10" class="data row4 col10" >0</td>
      <td id="T_6d918_row4_col11" class="data row4 col11" >1.004598</td>
      <td id="T_6d918_row4_col12" class="data row4 col12" >1.000000</td>
      <td id="T_6d918_row4_col13" class="data row4 col13" >1.009195</td>
      <td id="T_6d918_row4_col14" class="data row4 col14" >1.004598</td>
      <td id="T_6d918_row4_col15" class="data row4 col15" >1.002299</td>
      <td id="T_6d918_row4_col16" class="data row4 col16" >1.009195</td>
    </tr>
    <tr>
      <th id="T_6d918_level0_row5" class="row_heading level0 row5" >2021-01-12</th>
      <td id="T_6d918_row5_col0" class="data row5 col0" >2165</td>
      <td id="T_6d918_row5_col1" class="data row5 col1" >2225</td>
      <td id="T_6d918_row5_col2" class="data row5 col2" >2125</td>
      <td id="T_6d918_row5_col3" class="data row5 col3" >2185</td>
      <td id="T_6d918_row5_col4" class="data row5 col4" >244835</td>
      <td id="T_6d918_row5_col5" class="data row5 col5" >0.004598</td>
      <td id="T_6d918_row5_col6" class="data row5 col6" >060310</td>
      <td id="T_6d918_row5_col7" class="data row5 col7" >3S</td>
      <td id="T_6d918_row5_col8" class="data row5 col8" >0.997020</td>
      <td id="T_6d918_row5_col9" class="data row5 col9" >1.004598</td>
      <td id="T_6d918_row5_col10" class="data row5 col10" >1</td>
      <td id="T_6d918_row5_col11" class="data row5 col11" >0.995423</td>
      <td id="T_6d918_row5_col12" class="data row5 col12" >1.004577</td>
      <td id="T_6d918_row5_col13" class="data row5 col13" >1.000000</td>
      <td id="T_6d918_row5_col14" class="data row5 col14" >0.997712</td>
      <td id="T_6d918_row5_col15" class="data row5 col15" >1.013730</td>
      <td id="T_6d918_row5_col16" class="data row5 col16" >1.013730</td>
    </tr>
    <tr>
      <th id="T_6d918_level0_row6" class="row_heading level0 row6" >2021-01-13</th>
      <td id="T_6d918_row6_col0" class="data row6 col0" >2185</td>
      <td id="T_6d918_row6_col1" class="data row6 col1" >2210</td>
      <td id="T_6d918_row6_col2" class="data row6 col2" >2170</td>
      <td id="T_6d918_row6_col3" class="data row6 col3" >2175</td>
      <td id="T_6d918_row6_col4" class="data row6 col4" >127817</td>
      <td id="T_6d918_row6_col5" class="data row6 col5" >-0.004577</td>
      <td id="T_6d918_row6_col6" class="data row6 col6" >060310</td>
      <td id="T_6d918_row6_col7" class="data row6 col7" >3S</td>
      <td id="T_6d918_row6_col8" class="data row6 col8" >1.005556</td>
      <td id="T_6d918_row6_col9" class="data row6 col9" >0.995423</td>
      <td id="T_6d918_row6_col10" class="data row6 col10" >0</td>
      <td id="T_6d918_row6_col11" class="data row6 col11" >1.009195</td>
      <td id="T_6d918_row6_col12" class="data row6 col12" >1.004598</td>
      <td id="T_6d918_row6_col13" class="data row6 col13" >1.002299</td>
      <td id="T_6d918_row6_col14" class="data row6 col14" >1.018391</td>
      <td id="T_6d918_row6_col15" class="data row6 col15" >1.022989</td>
      <td id="T_6d918_row6_col16" class="data row6 col16" >1.022989</td>
    </tr>
    <tr>
      <th id="T_6d918_level0_row7" class="row_heading level0 row7" >2021-01-14</th>
      <td id="T_6d918_row7_col0" class="data row7 col0" >2180</td>
      <td id="T_6d918_row7_col1" class="data row7 col1" >2205</td>
      <td id="T_6d918_row7_col2" class="data row7 col2" >2150</td>
      <td id="T_6d918_row7_col3" class="data row7 col3" >2195</td>
      <td id="T_6d918_row7_col4" class="data row7 col4" >174996</td>
      <td id="T_6d918_row7_col5" class="data row7 col5" >0.009195</td>
      <td id="T_6d918_row7_col6" class="data row7 col6" >060310</td>
      <td id="T_6d918_row7_col7" class="data row7 col7" >3S</td>
      <td id="T_6d918_row7_col8" class="data row7 col8" >1.001185</td>
      <td id="T_6d918_row7_col9" class="data row7 col9" >1.009195</td>
      <td id="T_6d918_row7_col10" class="data row7 col10" >0</td>
      <td id="T_6d918_row7_col11" class="data row7 col11" >0.995444</td>
      <td id="T_6d918_row7_col12" class="data row7 col12" >0.993166</td>
      <td id="T_6d918_row7_col13" class="data row7 col13" >1.009112</td>
      <td id="T_6d918_row7_col14" class="data row7 col14" >1.013667</td>
      <td id="T_6d918_row7_col15" class="data row7 col15" >1.029613</td>
      <td id="T_6d918_row7_col16" class="data row7 col16" >1.029613</td>
    </tr>
    <tr>
      <th id="T_6d918_level0_row8" class="row_heading level0 row8" >2021-01-15</th>
      <td id="T_6d918_row8_col0" class="data row8 col0" >2190</td>
      <td id="T_6d918_row8_col1" class="data row8 col1" >2265</td>
      <td id="T_6d918_row8_col2" class="data row8 col2" >2185</td>
      <td id="T_6d918_row8_col3" class="data row8 col3" >2185</td>
      <td id="T_6d918_row8_col4" class="data row8 col4" >345872</td>
      <td id="T_6d918_row8_col5" class="data row8 col5" >-0.004556</td>
      <td id="T_6d918_row8_col6" class="data row8 col6" >060310</td>
      <td id="T_6d918_row8_col7" class="data row8 col7" >3S</td>
      <td id="T_6d918_row8_col8" class="data row8 col8" >0.983831</td>
      <td id="T_6d918_row8_col9" class="data row8 col9" >0.995444</td>
      <td id="T_6d918_row8_col10" class="data row8 col10" >0</td>
      <td id="T_6d918_row8_col11" class="data row8 col11" >0.997712</td>
      <td id="T_6d918_row8_col12" class="data row8 col12" >1.013730</td>
      <td id="T_6d918_row8_col13" class="data row8 col13" >1.018307</td>
      <td id="T_6d918_row8_col14" class="data row8 col14" >1.034325</td>
      <td id="T_6d918_row8_col15" class="data row8 col15" >1.032037</td>
      <td id="T_6d918_row8_col16" class="data row8 col16" >1.034325</td>
    </tr>
    <tr>
      <th id="T_6d918_level0_row9" class="row_heading level0 row9" >2021-01-18</th>
      <td id="T_6d918_row9_col0" class="data row9 col0" >2185</td>
      <td id="T_6d918_row9_col1" class="data row9 col1" >2220</td>
      <td id="T_6d918_row9_col2" class="data row9 col2" >2150</td>
      <td id="T_6d918_row9_col3" class="data row9 col3" >2180</td>
      <td id="T_6d918_row9_col4" class="data row9 col4" >251311</td>
      <td id="T_6d918_row9_col5" class="data row9 col5" >-0.002288</td>
      <td id="T_6d918_row9_col6" class="data row9 col6" >060310</td>
      <td id="T_6d918_row9_col7" class="data row9 col7" >3S</td>
      <td id="T_6d918_row9_col8" class="data row9 col8" >0.979501</td>
      <td id="T_6d918_row9_col9" class="data row9 col9" >0.997712</td>
      <td id="T_6d918_row9_col10" class="data row9 col10" >0</td>
      <td id="T_6d918_row9_col11" class="data row9 col11" >1.016055</td>
      <td id="T_6d918_row9_col12" class="data row9 col12" >1.020642</td>
      <td id="T_6d918_row9_col13" class="data row9 col13" >1.036697</td>
      <td id="T_6d918_row9_col14" class="data row9 col14" >1.034404</td>
      <td id="T_6d918_row9_col15" class="data row9 col15" >1.052752</td>
      <td id="T_6d918_row9_col16" class="data row9 col16" >1.052752</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br>이제 모든 종목에 대하여 For loop 로 매수 종가로 매도 시 수익율을 최대값을 생성합니다. ‘max_close’ 의 분포를 보니 평균은 1.033, 최소값 0.326, 최대값 3.703 입니다. 단, max_close 는 가설 검정으로 활용할 지표입니다. 매수 후, 몇 번 째 영업일이 최고 수익율인지 알 수 없기 때문에 기간 중 최고 수익율을 이용합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span>

<span class="n">mdl_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">return_all</span><span class="p">[</span><span class="n">return_all</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close_r2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close_r3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close_r4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 주어지 컬럼에서 최대 값을 찾음</span>
    <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># 주어진 컬럼 중에 missing 값이 있으면 행을 제거(dropna)하고, 자신을 덮어 씀(inplace=True).</span>
    
    <span class="n">mdl_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">mdl_data</span><span class="p">,</span> <span class="n">df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>    
    
<span class="n">mdl_data</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;mdl_data.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><br> ‘max_close’ 의 분포를 확인합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mdl_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;mdl_data.pkl&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mdl_data</span><span class="p">[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count   426,517.00
mean          1.03
std           0.07
min           0.33
10%           0.98
20%           0.99
50%           1.02
80%           1.06
90%           1.10
max           3.70
Name: max_close, dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="br">
<h3><br> 매도 전략 데이터 프로세싱<a class="headerlink" href="#br" title="Permalink to this headline">#</a></h3>
<p>모델 개발을 위해서는 매도 전략에 따는 수익을 계산을 할 수 있어야 합니다. 이번 장에서는 기본적인 몇 가지 전략의 수익율을 계산해보겠습니다. 저장해 둔 mdl_data pickle 파일을 읽습니다. mdl_data 는 수익률 결과값이 있는 데이터입니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mdl_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;mdl_data.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><br> <strong>매도 전략 1 - 모든 종목 종가 매수 후, 5 영업일 기간 6% 익절 매도</strong><br />
한가지 전략을 테스트 해 보겠습니다. 모든 종목을 같은 금액으로 매일 종가 매수합니다. 매수 후 5 영업일 동안 수익율이 6% 이상되면 곧바로 익절합니다. 나머지 종목은 5 영업일에 전부 종가 매도하면 수익율은 어떻게 될까요?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span>

<span class="n">data_all_5</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="n">ub</span> <span class="o">=</span> <span class="mf">1.06</span>

<span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]:</span>
    
    <span class="c1"># 종목별 처리</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">mdl_data</span><span class="p">[</span><span class="n">mdl_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># 고가, 저가, 종가 수익율</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]:</span>

        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;high_r&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>      
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;low_r&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>   
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close_r&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>    
        
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;max_high&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[[</span><span class="s1">&#39;high_r1&#39;</span><span class="p">,</span><span class="s1">&#39;high_r2&#39;</span><span class="p">,</span><span class="s1">&#39;high_r3&#39;</span><span class="p">,</span><span class="s1">&#39;high_r4&#39;</span><span class="p">,</span><span class="s1">&#39;high_r5&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ub</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 5 영업일 최고가 중 최고가         </span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ub_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;max_high&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> <span class="n">ub</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close_r5&#39;</span><span class="p">])</span> <span class="c1"># 종가 수익률이 6% 이면 매도, 아니면 마지막 5 영업일 수익률</span>
       
    <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   
    <span class="n">data_all_5</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">data_all_5</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">data_all_5</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;data_all_5.pkl&#39;</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_all_5</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_da80a_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >open</th>
      <th class="col_heading level0 col1" >high</th>
      <th class="col_heading level0 col2" >low</th>
      <th class="col_heading level0 col3" >close</th>
      <th class="col_heading level0 col4" >volume</th>
      <th class="col_heading level0 col5" >change</th>
      <th class="col_heading level0 col6" >code</th>
      <th class="col_heading level0 col7" >name</th>
      <th class="col_heading level0 col8" >kosdaq_return</th>
      <th class="col_heading level0 col9" >return</th>
      <th class="col_heading level0 col10" >win_market</th>
      <th class="col_heading level0 col11" >close_r1</th>
      <th class="col_heading level0 col12" >close_r2</th>
      <th class="col_heading level0 col13" >close_r3</th>
      <th class="col_heading level0 col14" >close_r4</th>
      <th class="col_heading level0 col15" >close_r5</th>
      <th class="col_heading level0 col16" >max_close</th>
      <th class="col_heading level0 col17" >high_r1</th>
      <th class="col_heading level0 col18" >low_r1</th>
      <th class="col_heading level0 col19" >high_r2</th>
      <th class="col_heading level0 col20" >low_r2</th>
      <th class="col_heading level0 col21" >high_r3</th>
      <th class="col_heading level0 col22" >low_r3</th>
      <th class="col_heading level0 col23" >high_r4</th>
      <th class="col_heading level0 col24" >low_r4</th>
      <th class="col_heading level0 col25" >high_r5</th>
      <th class="col_heading level0 col26" >low_r5</th>
      <th class="col_heading level0 col27" >max_high</th>
      <th class="col_heading level0 col28" >ub_return</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_da80a_level0_row0" class="row_heading level0 row0" >2021-01-05</th>
      <td id="T_da80a_row0_col0" class="data row0 col0" >13000</td>
      <td id="T_da80a_row0_col1" class="data row0 col1" >13050</td>
      <td id="T_da80a_row0_col2" class="data row0 col2" >12750</td>
      <td id="T_da80a_row0_col3" class="data row0 col3" >12900</td>
      <td id="T_da80a_row0_col4" class="data row0 col4" >190192</td>
      <td id="T_da80a_row0_col5" class="data row0 col5" >-0.011494</td>
      <td id="T_da80a_row0_col6" class="data row0 col6" >238490</td>
      <td id="T_da80a_row0_col7" class="data row0 col7" >힘스</td>
      <td id="T_da80a_row0_col8" class="data row0 col8" >1.008326</td>
      <td id="T_da80a_row0_col9" class="data row0 col9" >0.988506</td>
      <td id="T_da80a_row0_col10" class="data row0 col10" >0</td>
      <td id="T_da80a_row0_col11" class="data row0 col11" >1.015504</td>
      <td id="T_da80a_row0_col12" class="data row0 col12" >1.015504</td>
      <td id="T_da80a_row0_col13" class="data row0 col13" >1.003876</td>
      <td id="T_da80a_row0_col14" class="data row0 col14" >1.011628</td>
      <td id="T_da80a_row0_col15" class="data row0 col15" >1.038760</td>
      <td id="T_da80a_row0_col16" class="data row0 col16" >1.038760</td>
      <td id="T_da80a_row0_col17" class="data row0 col17" >1.031008</td>
      <td id="T_da80a_row0_col18" class="data row0 col18" >0.984496</td>
      <td id="T_da80a_row0_col19" class="data row0 col19" >1.034884</td>
      <td id="T_da80a_row0_col20" class="data row0 col20" >1.007752</td>
      <td id="T_da80a_row0_col21" class="data row0 col21" >1.027132</td>
      <td id="T_da80a_row0_col22" class="data row0 col22" >0.992248</td>
      <td id="T_da80a_row0_col23" class="data row0 col23" >1.011628</td>
      <td id="T_da80a_row0_col24" class="data row0 col24" >0.965116</td>
      <td id="T_da80a_row0_col25" class="data row0 col25" >1.081395</td>
      <td id="T_da80a_row0_col26" class="data row0 col26" >1.007752</td>
      <td id="T_da80a_row0_col27" class="data row0 col27" >1</td>
      <td id="T_da80a_row0_col28" class="data row0 col28" >1.060000</td>
    </tr>
    <tr>
      <th id="T_da80a_level0_row1" class="row_heading level0 row1" >2021-01-06</th>
      <td id="T_da80a_row1_col0" class="data row1 col0" >13050</td>
      <td id="T_da80a_row1_col1" class="data row1 col1" >13300</td>
      <td id="T_da80a_row1_col2" class="data row1 col2" >12700</td>
      <td id="T_da80a_row1_col3" class="data row1 col3" >13100</td>
      <td id="T_da80a_row1_col4" class="data row1 col4" >287008</td>
      <td id="T_da80a_row1_col5" class="data row1 col5" >0.015504</td>
      <td id="T_da80a_row1_col6" class="data row1 col6" >238490</td>
      <td id="T_da80a_row1_col7" class="data row1 col7" >힘스</td>
      <td id="T_da80a_row1_col8" class="data row1 col8" >0.995567</td>
      <td id="T_da80a_row1_col9" class="data row1 col9" >1.015504</td>
      <td id="T_da80a_row1_col10" class="data row1 col10" >1</td>
      <td id="T_da80a_row1_col11" class="data row1 col11" >1.000000</td>
      <td id="T_da80a_row1_col12" class="data row1 col12" >0.988550</td>
      <td id="T_da80a_row1_col13" class="data row1 col13" >0.996183</td>
      <td id="T_da80a_row1_col14" class="data row1 col14" >1.022901</td>
      <td id="T_da80a_row1_col15" class="data row1 col15" >1.015267</td>
      <td id="T_da80a_row1_col16" class="data row1 col16" >1.022901</td>
      <td id="T_da80a_row1_col17" class="data row1 col17" >1.019084</td>
      <td id="T_da80a_row1_col18" class="data row1 col18" >0.992366</td>
      <td id="T_da80a_row1_col19" class="data row1 col19" >1.011450</td>
      <td id="T_da80a_row1_col20" class="data row1 col20" >0.977099</td>
      <td id="T_da80a_row1_col21" class="data row1 col21" >0.996183</td>
      <td id="T_da80a_row1_col22" class="data row1 col22" >0.950382</td>
      <td id="T_da80a_row1_col23" class="data row1 col23" >1.064885</td>
      <td id="T_da80a_row1_col24" class="data row1 col24" >0.992366</td>
      <td id="T_da80a_row1_col25" class="data row1 col25" >1.045802</td>
      <td id="T_da80a_row1_col26" class="data row1 col26" >1.003817</td>
      <td id="T_da80a_row1_col27" class="data row1 col27" >1</td>
      <td id="T_da80a_row1_col28" class="data row1 col28" >1.060000</td>
    </tr>
    <tr>
      <th id="T_da80a_level0_row2" class="row_heading level0 row2" >2021-01-07</th>
      <td id="T_da80a_row2_col0" class="data row2 col0" >13200</td>
      <td id="T_da80a_row2_col1" class="data row2 col1" >13350</td>
      <td id="T_da80a_row2_col2" class="data row2 col2" >13000</td>
      <td id="T_da80a_row2_col3" class="data row2 col3" >13100</td>
      <td id="T_da80a_row2_col4" class="data row2 col4" >203149</td>
      <td id="T_da80a_row2_col5" class="data row2 col5" >0.000000</td>
      <td id="T_da80a_row2_col6" class="data row2 col6" >238490</td>
      <td id="T_da80a_row2_col7" class="data row2 col7" >힘스</td>
      <td id="T_da80a_row2_col8" class="data row2 col8" >1.007612</td>
      <td id="T_da80a_row2_col9" class="data row2 col9" >1.000000</td>
      <td id="T_da80a_row2_col10" class="data row2 col10" >0</td>
      <td id="T_da80a_row2_col11" class="data row2 col11" >0.988550</td>
      <td id="T_da80a_row2_col12" class="data row2 col12" >0.996183</td>
      <td id="T_da80a_row2_col13" class="data row2 col13" >1.022901</td>
      <td id="T_da80a_row2_col14" class="data row2 col14" >1.015267</td>
      <td id="T_da80a_row2_col15" class="data row2 col15" >1.007634</td>
      <td id="T_da80a_row2_col16" class="data row2 col16" >1.022901</td>
      <td id="T_da80a_row2_col17" class="data row2 col17" >1.011450</td>
      <td id="T_da80a_row2_col18" class="data row2 col18" >0.977099</td>
      <td id="T_da80a_row2_col19" class="data row2 col19" >0.996183</td>
      <td id="T_da80a_row2_col20" class="data row2 col20" >0.950382</td>
      <td id="T_da80a_row2_col21" class="data row2 col21" >1.064885</td>
      <td id="T_da80a_row2_col22" class="data row2 col22" >0.992366</td>
      <td id="T_da80a_row2_col23" class="data row2 col23" >1.045802</td>
      <td id="T_da80a_row2_col24" class="data row2 col24" >1.003817</td>
      <td id="T_da80a_row2_col25" class="data row2 col25" >1.019084</td>
      <td id="T_da80a_row2_col26" class="data row2 col26" >1.000000</td>
      <td id="T_da80a_row2_col27" class="data row2 col27" >1</td>
      <td id="T_da80a_row2_col28" class="data row2 col28" >1.060000</td>
    </tr>
    <tr>
      <th id="T_da80a_level0_row3" class="row_heading level0 row3" >2021-01-08</th>
      <td id="T_da80a_row3_col0" class="data row3 col0" >13200</td>
      <td id="T_da80a_row3_col1" class="data row3 col1" >13250</td>
      <td id="T_da80a_row3_col2" class="data row3 col2" >12800</td>
      <td id="T_da80a_row3_col3" class="data row3 col3" >12950</td>
      <td id="T_da80a_row3_col4" class="data row3 col4" >209722</td>
      <td id="T_da80a_row3_col5" class="data row3 col5" >-0.011450</td>
      <td id="T_da80a_row3_col6" class="data row3 col6" >238490</td>
      <td id="T_da80a_row3_col7" class="data row3 col7" >힘스</td>
      <td id="T_da80a_row3_col8" class="data row3 col8" >0.998918</td>
      <td id="T_da80a_row3_col9" class="data row3 col9" >0.988550</td>
      <td id="T_da80a_row3_col10" class="data row3 col10" >0</td>
      <td id="T_da80a_row3_col11" class="data row3 col11" >1.007722</td>
      <td id="T_da80a_row3_col12" class="data row3 col12" >1.034749</td>
      <td id="T_da80a_row3_col13" class="data row3 col13" >1.027027</td>
      <td id="T_da80a_row3_col14" class="data row3 col14" >1.019305</td>
      <td id="T_da80a_row3_col15" class="data row3 col15" >1.027027</td>
      <td id="T_da80a_row3_col16" class="data row3 col16" >1.034749</td>
      <td id="T_da80a_row3_col17" class="data row3 col17" >1.007722</td>
      <td id="T_da80a_row3_col18" class="data row3 col18" >0.961390</td>
      <td id="T_da80a_row3_col19" class="data row3 col19" >1.077220</td>
      <td id="T_da80a_row3_col20" class="data row3 col20" >1.003861</td>
      <td id="T_da80a_row3_col21" class="data row3 col21" >1.057915</td>
      <td id="T_da80a_row3_col22" class="data row3 col22" >1.015444</td>
      <td id="T_da80a_row3_col23" class="data row3 col23" >1.030888</td>
      <td id="T_da80a_row3_col24" class="data row3 col24" >1.011583</td>
      <td id="T_da80a_row3_col25" class="data row3 col25" >1.073359</td>
      <td id="T_da80a_row3_col26" class="data row3 col26" >1.019305</td>
      <td id="T_da80a_row3_col27" class="data row3 col27" >1</td>
      <td id="T_da80a_row3_col28" class="data row3 col28" >1.060000</td>
    </tr>
    <tr>
      <th id="T_da80a_level0_row4" class="row_heading level0 row4" >2021-01-11</th>
      <td id="T_da80a_row4_col0" class="data row4 col0" >12850</td>
      <td id="T_da80a_row4_col1" class="data row4 col1" >13050</td>
      <td id="T_da80a_row4_col2" class="data row4 col2" >12450</td>
      <td id="T_da80a_row4_col3" class="data row4 col3" >13050</td>
      <td id="T_da80a_row4_col4" class="data row4 col4" >365602</td>
      <td id="T_da80a_row4_col5" class="data row4 col5" >0.007722</td>
      <td id="T_da80a_row4_col6" class="data row4 col6" >238490</td>
      <td id="T_da80a_row4_col7" class="data row4 col7" >힘스</td>
      <td id="T_da80a_row4_col8" class="data row4 col8" >0.988702</td>
      <td id="T_da80a_row4_col9" class="data row4 col9" >1.007722</td>
      <td id="T_da80a_row4_col10" class="data row4 col10" >1</td>
      <td id="T_da80a_row4_col11" class="data row4 col11" >1.026820</td>
      <td id="T_da80a_row4_col12" class="data row4 col12" >1.019157</td>
      <td id="T_da80a_row4_col13" class="data row4 col13" >1.011494</td>
      <td id="T_da80a_row4_col14" class="data row4 col14" >1.019157</td>
      <td id="T_da80a_row4_col15" class="data row4 col15" >1.038314</td>
      <td id="T_da80a_row4_col16" class="data row4 col16" >1.038314</td>
      <td id="T_da80a_row4_col17" class="data row4 col17" >1.068966</td>
      <td id="T_da80a_row4_col18" class="data row4 col18" >0.996169</td>
      <td id="T_da80a_row4_col19" class="data row4 col19" >1.049808</td>
      <td id="T_da80a_row4_col20" class="data row4 col20" >1.007663</td>
      <td id="T_da80a_row4_col21" class="data row4 col21" >1.022989</td>
      <td id="T_da80a_row4_col22" class="data row4 col22" >1.003831</td>
      <td id="T_da80a_row4_col23" class="data row4 col23" >1.065134</td>
      <td id="T_da80a_row4_col24" class="data row4 col24" >1.011494</td>
      <td id="T_da80a_row4_col25" class="data row4 col25" >1.068966</td>
      <td id="T_da80a_row4_col26" class="data row4 col26" >0.996169</td>
      <td id="T_da80a_row4_col27" class="data row4 col27" >1</td>
      <td id="T_da80a_row4_col28" class="data row4 col28" >1.060000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> 수익률의 분포를 확인합니다. 수익이 되는 전략은 아닙니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_all_5</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;data_all_5.pkl&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_all_5</span><span class="p">[</span><span class="s1">&#39;ub_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_all_5</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;max_high&#39;</span><span class="p">)[</span><span class="s1">&#39;ub_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count   419,432.00
mean          1.00
std           0.06
min           0.29
1%            0.84
10%           0.93
50%           1.00
90%           1.06
99%           1.06
max           1.06
Name: ub_return, dtype: float64
              count  mean  std  min  25%  50%  75%  max
max_high                                               
0        280,145.00  0.97 0.05 0.29 0.95 0.98 1.00 1.06
1        139,287.00  1.06 0.00 1.06 1.06 1.06 1.06 1.06
</pre></div>
</div>
</div>
</div>
<p><br> <strong>매도 전략 2 - 모든 종목을 종가 매수 후, 아래와 같은 순서로 매도</strong></p>
<ol class="simple">
<li><p>익일 고가가 당일 고가 보다 크면 2 영업일 시가 매도</p></li>
<li><p>1 조건 만족하지 않으면 2 영업일 종가 매도</p></li>
</ol>
<p>위와 같은 매도 전략은 수익율이 어떻게 될까요?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span>

<span class="n">data_all_5</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">final_r</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    
    <span class="k">if</span>   <span class="n">x</span><span class="p">[</span><span class="s1">&#39;high_r0&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;high_r1&#39;</span><span class="p">]:</span>  <span class="c1">#  (당일 고가/매수 종가) 비율이 (익일 고가/매수 종가) 비율 값이 작으면 2 영업일 시가 매도     </span>
        <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;open_r2&#39;</span><span class="p">]</span>    
    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;close_r2&#39;</span><span class="p">]</span> <span class="c1"># 매도 안된 종목은 전부 2 영업일 종가 매도         </span>
    
<span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]:</span>    
    
    <span class="c1"># 종목별 처리</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">mdl_data</span><span class="p">[</span><span class="n">mdl_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># 최고/최저 수익율</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>

        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;high_r&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>        
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close_r&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;open_r&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>
        
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;final_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">final_r</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 각 row 에 대하여 final_r 함수를 적용</span>
                                                                                                                                                 
    <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;close_r0&#39;</span><span class="p">,</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span> <span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;high_r0&#39;</span><span class="p">,</span> <span class="s1">&#39;high_r1&#39;</span><span class="p">,</span> <span class="s1">&#39;open_r2&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   <span class="c1"># 데아터 처리 중 missing 값이 사용된 경우는 제거</span>
    <span class="n">data_all_5</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">data_all_5</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">data_all_5</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;data_all_5.pkl&#39;</span><span class="p">)</span>    
</pre></div>
</div>
</div>
</div>
<p><br> 수익률을 확인합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_all_5</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;data_all_5.pkl&#39;</span><span class="p">)</span>  
<span class="n">data_all_5</span><span class="p">[</span><span class="s1">&#39;final_return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count   423,683.00
mean          1.00
std           0.05
min           0.00
1%            0.89
10%           0.96
50%           1.00
90%           1.04
99%           1.15
max           1.69
Name: final_return, dtype: float64
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h3><br> 매수 전략 데이터 프로세싱<a class="headerlink" href="#id2" title="Permalink to this headline">#</a></h3>
<p>모델 개발을 위해서는 매수 전략에 따라 매수 종목을 결정할 수 있어야 합니다. 이번 장에서는 기본적인 매수 종목을 찾는 데이터처리를 진행해 보겠습니다. 결과 수익률 데이터가 있는
mdl_data pickle 파일을 읽습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mdl_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;mdl_data.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><br> <strong>매수 전략 1 - 시장 수익율보다 더 좋은 수익율을 보인 종목을 매수</strong><br />
시장 수익율보다 더 좋은 수익율을 보인 종목을 알기 위해 4.4.5 절에 ‘win_market’ 이라는 변수를 생성했습니다. 이것을 이용할 것인데요. 더 의미있는 지표를 생성하기 위해서 과거 60일 누적 합을 보겠습니다. 수익율은 max_close(5 영업일 중 최고 종가 수익율) 이용하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span>

<span class="n">data_all_6</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]:</span>
    
    <span class="c1"># 종목별 처리</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">mdl_data</span><span class="p">[</span><span class="n">mdl_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># 과거 60일 win_market 누적 합</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;win_market_sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;win_market&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># 과거 60일 누적합</span>
    
    <span class="c1"># 고가, 저가, 종가 수익율</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]:</span>

        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;high_r&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>      
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;low_r&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>   
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close_r&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>    
        
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 5 영업일 종가 수익율 중 최고 값</span>
    <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;win_market_sum&#39;</span><span class="p">,</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># missing 이 있는 행은 제거   </span>
 
    <span class="n">data_all_6</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">data_all_6</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">data_all_6</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;data_all_6.pkl&#39;</span><span class="p">)</span>    
<span class="n">data_all_6</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_e0c95_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >open</th>
      <th class="col_heading level0 col1" >high</th>
      <th class="col_heading level0 col2" >low</th>
      <th class="col_heading level0 col3" >close</th>
      <th class="col_heading level0 col4" >volume</th>
      <th class="col_heading level0 col5" >change</th>
      <th class="col_heading level0 col6" >code</th>
      <th class="col_heading level0 col7" >name</th>
      <th class="col_heading level0 col8" >kosdaq_return</th>
      <th class="col_heading level0 col9" >return</th>
      <th class="col_heading level0 col10" >win_market</th>
      <th class="col_heading level0 col11" >close_r1</th>
      <th class="col_heading level0 col12" >close_r2</th>
      <th class="col_heading level0 col13" >close_r3</th>
      <th class="col_heading level0 col14" >close_r4</th>
      <th class="col_heading level0 col15" >close_r5</th>
      <th class="col_heading level0 col16" >max_close</th>
      <th class="col_heading level0 col17" >win_market_sum</th>
      <th class="col_heading level0 col18" >high_r1</th>
      <th class="col_heading level0 col19" >low_r1</th>
      <th class="col_heading level0 col20" >high_r2</th>
      <th class="col_heading level0 col21" >low_r2</th>
      <th class="col_heading level0 col22" >high_r3</th>
      <th class="col_heading level0 col23" >low_r3</th>
      <th class="col_heading level0 col24" >high_r4</th>
      <th class="col_heading level0 col25" >low_r4</th>
      <th class="col_heading level0 col26" >high_r5</th>
      <th class="col_heading level0 col27" >low_r5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_e0c95_level0_row0" class="row_heading level0 row0" >2021-04-01</th>
      <td id="T_e0c95_row0_col0" class="data row0 col0" >13100</td>
      <td id="T_e0c95_row0_col1" class="data row0 col1" >13650</td>
      <td id="T_e0c95_row0_col2" class="data row0 col2" >13100</td>
      <td id="T_e0c95_row0_col3" class="data row0 col3" >13400</td>
      <td id="T_e0c95_row0_col4" class="data row0 col4" >194185</td>
      <td id="T_e0c95_row0_col5" class="data row0 col5" >0.022901</td>
      <td id="T_e0c95_row0_col6" class="data row0 col6" >238490</td>
      <td id="T_e0c95_row0_col7" class="data row0 col7" >힘스</td>
      <td id="T_e0c95_row0_col8" class="data row0 col8" >1.010051</td>
      <td id="T_e0c95_row0_col9" class="data row0 col9" >1.022901</td>
      <td id="T_e0c95_row0_col10" class="data row0 col10" >0</td>
      <td id="T_e0c95_row0_col11" class="data row0 col11" >1.007463</td>
      <td id="T_e0c95_row0_col12" class="data row0 col12" >1.022388</td>
      <td id="T_e0c95_row0_col13" class="data row0 col13" >1.018657</td>
      <td id="T_e0c95_row0_col14" class="data row0 col14" >1.041045</td>
      <td id="T_e0c95_row0_col15" class="data row0 col15" >1.026119</td>
      <td id="T_e0c95_row0_col16" class="data row0 col16" >1.041045</td>
      <td id="T_e0c95_row0_col17" class="data row0 col17" >9.000000</td>
      <td id="T_e0c95_row0_col18" class="data row0 col18" >1.018657</td>
      <td id="T_e0c95_row0_col19" class="data row0 col19" >0.992537</td>
      <td id="T_e0c95_row0_col20" class="data row0 col20" >1.029851</td>
      <td id="T_e0c95_row0_col21" class="data row0 col21" >1.000000</td>
      <td id="T_e0c95_row0_col22" class="data row0 col22" >1.037313</td>
      <td id="T_e0c95_row0_col23" class="data row0 col23" >1.007463</td>
      <td id="T_e0c95_row0_col24" class="data row0 col24" >1.041045</td>
      <td id="T_e0c95_row0_col25" class="data row0 col25" >1.007463</td>
      <td id="T_e0c95_row0_col26" class="data row0 col26" >1.048507</td>
      <td id="T_e0c95_row0_col27" class="data row0 col27" >1.026119</td>
    </tr>
    <tr>
      <th id="T_e0c95_level0_row1" class="row_heading level0 row1" >2021-04-02</th>
      <td id="T_e0c95_row1_col0" class="data row1 col0" >13500</td>
      <td id="T_e0c95_row1_col1" class="data row1 col1" >13650</td>
      <td id="T_e0c95_row1_col2" class="data row1 col2" >13300</td>
      <td id="T_e0c95_row1_col3" class="data row1 col3" >13500</td>
      <td id="T_e0c95_row1_col4" class="data row1 col4" >136673</td>
      <td id="T_e0c95_row1_col5" class="data row1 col5" >0.007463</td>
      <td id="T_e0c95_row1_col6" class="data row1 col6" >238490</td>
      <td id="T_e0c95_row1_col7" class="data row1 col7" >힘스</td>
      <td id="T_e0c95_row1_col8" class="data row1 col8" >1.004463</td>
      <td id="T_e0c95_row1_col9" class="data row1 col9" >1.007463</td>
      <td id="T_e0c95_row1_col10" class="data row1 col10" >0</td>
      <td id="T_e0c95_row1_col11" class="data row1 col11" >1.014815</td>
      <td id="T_e0c95_row1_col12" class="data row1 col12" >1.011111</td>
      <td id="T_e0c95_row1_col13" class="data row1 col13" >1.033333</td>
      <td id="T_e0c95_row1_col14" class="data row1 col14" >1.018519</td>
      <td id="T_e0c95_row1_col15" class="data row1 col15" >1.022222</td>
      <td id="T_e0c95_row1_col16" class="data row1 col16" >1.033333</td>
      <td id="T_e0c95_row1_col17" class="data row1 col17" >9.000000</td>
      <td id="T_e0c95_row1_col18" class="data row1 col18" >1.022222</td>
      <td id="T_e0c95_row1_col19" class="data row1 col19" >0.992593</td>
      <td id="T_e0c95_row1_col20" class="data row1 col20" >1.029630</td>
      <td id="T_e0c95_row1_col21" class="data row1 col21" >1.000000</td>
      <td id="T_e0c95_row1_col22" class="data row1 col22" >1.033333</td>
      <td id="T_e0c95_row1_col23" class="data row1 col23" >1.000000</td>
      <td id="T_e0c95_row1_col24" class="data row1 col24" >1.040741</td>
      <td id="T_e0c95_row1_col25" class="data row1 col25" >1.018519</td>
      <td id="T_e0c95_row1_col26" class="data row1 col26" >1.029630</td>
      <td id="T_e0c95_row1_col27" class="data row1 col27" >1.014815</td>
    </tr>
    <tr>
      <th id="T_e0c95_level0_row2" class="row_heading level0 row2" >2021-04-05</th>
      <td id="T_e0c95_row2_col0" class="data row2 col0" >13600</td>
      <td id="T_e0c95_row2_col1" class="data row2 col1" >13800</td>
      <td id="T_e0c95_row2_col2" class="data row2 col2" >13400</td>
      <td id="T_e0c95_row2_col3" class="data row2 col3" >13700</td>
      <td id="T_e0c95_row2_col4" class="data row2 col4" >219062</td>
      <td id="T_e0c95_row2_col5" class="data row2 col5" >0.014815</td>
      <td id="T_e0c95_row2_col6" class="data row2 col6" >238490</td>
      <td id="T_e0c95_row2_col7" class="data row2 col7" >힘스</td>
      <td id="T_e0c95_row2_col8" class="data row2 col8" >0.999670</td>
      <td id="T_e0c95_row2_col9" class="data row2 col9" >1.014815</td>
      <td id="T_e0c95_row2_col10" class="data row2 col10" >1</td>
      <td id="T_e0c95_row2_col11" class="data row2 col11" >0.996350</td>
      <td id="T_e0c95_row2_col12" class="data row2 col12" >1.018248</td>
      <td id="T_e0c95_row2_col13" class="data row2 col13" >1.003650</td>
      <td id="T_e0c95_row2_col14" class="data row2 col14" >1.007299</td>
      <td id="T_e0c95_row2_col15" class="data row2 col15" >0.992701</td>
      <td id="T_e0c95_row2_col16" class="data row2 col16" >1.018248</td>
      <td id="T_e0c95_row2_col17" class="data row2 col17" >9.000000</td>
      <td id="T_e0c95_row2_col18" class="data row2 col18" >1.014599</td>
      <td id="T_e0c95_row2_col19" class="data row2 col19" >0.985401</td>
      <td id="T_e0c95_row2_col20" class="data row2 col20" >1.018248</td>
      <td id="T_e0c95_row2_col21" class="data row2 col21" >0.985401</td>
      <td id="T_e0c95_row2_col22" class="data row2 col22" >1.025547</td>
      <td id="T_e0c95_row2_col23" class="data row2 col23" >1.003650</td>
      <td id="T_e0c95_row2_col24" class="data row2 col24" >1.014599</td>
      <td id="T_e0c95_row2_col25" class="data row2 col25" >1.000000</td>
      <td id="T_e0c95_row2_col26" class="data row2 col26" >1.010949</td>
      <td id="T_e0c95_row2_col27" class="data row2 col27" >0.989051</td>
    </tr>
    <tr>
      <th id="T_e0c95_level0_row3" class="row_heading level0 row3" >2021-04-06</th>
      <td id="T_e0c95_row3_col0" class="data row3 col0" >13800</td>
      <td id="T_e0c95_row3_col1" class="data row3 col1" >13900</td>
      <td id="T_e0c95_row3_col2" class="data row3 col2" >13500</td>
      <td id="T_e0c95_row3_col3" class="data row3 col3" >13650</td>
      <td id="T_e0c95_row3_col4" class="data row3 col4" >135914</td>
      <td id="T_e0c95_row3_col5" class="data row3 col5" >-0.003650</td>
      <td id="T_e0c95_row3_col6" class="data row3 col6" >238490</td>
      <td id="T_e0c95_row3_col7" class="data row3 col7" >힘스</td>
      <td id="T_e0c95_row3_col8" class="data row3 col8" >0.998824</td>
      <td id="T_e0c95_row3_col9" class="data row3 col9" >0.996350</td>
      <td id="T_e0c95_row3_col10" class="data row3 col10" >0</td>
      <td id="T_e0c95_row3_col11" class="data row3 col11" >1.021978</td>
      <td id="T_e0c95_row3_col12" class="data row3 col12" >1.007326</td>
      <td id="T_e0c95_row3_col13" class="data row3 col13" >1.010989</td>
      <td id="T_e0c95_row3_col14" class="data row3 col14" >0.996337</td>
      <td id="T_e0c95_row3_col15" class="data row3 col15" >1.003663</td>
      <td id="T_e0c95_row3_col16" class="data row3 col16" >1.021978</td>
      <td id="T_e0c95_row3_col17" class="data row3 col17" >9.000000</td>
      <td id="T_e0c95_row3_col18" class="data row3 col18" >1.021978</td>
      <td id="T_e0c95_row3_col19" class="data row3 col19" >0.989011</td>
      <td id="T_e0c95_row3_col20" class="data row3 col20" >1.029304</td>
      <td id="T_e0c95_row3_col21" class="data row3 col21" >1.007326</td>
      <td id="T_e0c95_row3_col22" class="data row3 col22" >1.018315</td>
      <td id="T_e0c95_row3_col23" class="data row3 col23" >1.003663</td>
      <td id="T_e0c95_row3_col24" class="data row3 col24" >1.014652</td>
      <td id="T_e0c95_row3_col25" class="data row3 col25" >0.992674</td>
      <td id="T_e0c95_row3_col26" class="data row3 col26" >1.007326</td>
      <td id="T_e0c95_row3_col27" class="data row3 col27" >0.996337</td>
    </tr>
    <tr>
      <th id="T_e0c95_level0_row4" class="row_heading level0 row4" >2021-04-07</th>
      <td id="T_e0c95_row4_col0" class="data row4 col0" >13700</td>
      <td id="T_e0c95_row4_col1" class="data row4 col1" >13950</td>
      <td id="T_e0c95_row4_col2" class="data row4 col2" >13500</td>
      <td id="T_e0c95_row4_col3" class="data row4 col3" >13950</td>
      <td id="T_e0c95_row4_col4" class="data row4 col4" >195408</td>
      <td id="T_e0c95_row4_col5" class="data row4 col5" >0.021978</td>
      <td id="T_e0c95_row4_col6" class="data row4 col6" >238490</td>
      <td id="T_e0c95_row4_col7" class="data row4 col7" >힘스</td>
      <td id="T_e0c95_row4_col8" class="data row4 col8" >1.004739</td>
      <td id="T_e0c95_row4_col9" class="data row4 col9" >1.021978</td>
      <td id="T_e0c95_row4_col10" class="data row4 col10" >0</td>
      <td id="T_e0c95_row4_col11" class="data row4 col11" >0.985663</td>
      <td id="T_e0c95_row4_col12" class="data row4 col12" >0.989247</td>
      <td id="T_e0c95_row4_col13" class="data row4 col13" >0.974910</td>
      <td id="T_e0c95_row4_col14" class="data row4 col14" >0.982079</td>
      <td id="T_e0c95_row4_col15" class="data row4 col15" >1.017921</td>
      <td id="T_e0c95_row4_col16" class="data row4 col16" >1.017921</td>
      <td id="T_e0c95_row4_col17" class="data row4 col17" >9.000000</td>
      <td id="T_e0c95_row4_col18" class="data row4 col18" >1.007168</td>
      <td id="T_e0c95_row4_col19" class="data row4 col19" >0.985663</td>
      <td id="T_e0c95_row4_col20" class="data row4 col20" >0.996416</td>
      <td id="T_e0c95_row4_col21" class="data row4 col21" >0.982079</td>
      <td id="T_e0c95_row4_col22" class="data row4 col22" >0.992832</td>
      <td id="T_e0c95_row4_col23" class="data row4 col23" >0.971326</td>
      <td id="T_e0c95_row4_col24" class="data row4 col24" >0.985663</td>
      <td id="T_e0c95_row4_col25" class="data row4 col25" >0.974910</td>
      <td id="T_e0c95_row4_col26" class="data row4 col26" >1.021505</td>
      <td id="T_e0c95_row4_col27" class="data row4 col27" >0.971326</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> win_market_sum 에 따른 수익률의 변화를 확인합니다. win_market_sum 이 클수록 수익률이 높아지는 경향이 있다는 것을 확인했습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_all_6</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;data_all_6.pkl&#39;</span><span class="p">)</span>    
<span class="n">ranks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">data_all_6</span><span class="p">[</span><span class="s1">&#39;win_market_sum&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_all_6</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ranks</span><span class="p">)[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">data_all_6</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ranks</span><span class="p">)[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>win_market_sum
(-0.001, 4.0]   1.02
(4.0, 5.0]      1.03
(5.0, 6.0]      1.03
(6.0, 7.0]      1.03
(7.0, 8.0]      1.03
(8.0, 9.0]      1.03
(9.0, 11.0]     1.04
(11.0, 22.0]    1.04
Name: max_close, dtype: float64
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;win_market_sum&#39;&gt;
</pre></div>
</div>
<img alt="_images/4.4.4_Data_Processing_27_2.png" src="_images/4.4.4_Data_Processing_27_2.png" />
</div>
</div>
<p><br> <strong>매수 전략 2 - 섹터 평균 수익율보다 더 높은 수익율을 보인 종목을 매수</strong><br />
kosdaq_list 에 있는 종목별 섹터 정보를 이용하겠습니다. 우선, 종목별 최근 60일 평균 수익율을 rolling 함수를 이용하여 으로 계산합니다. for Loop 을 이용하여 종목에 섹터 정보를 추가합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span>

<span class="n">data_all_6</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">sector</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]):</span>
    
    <span class="c1"># 종목별 처리</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">mdl_data</span><span class="p">[</span><span class="n">mdl_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># 최근 60일 평균 수익율            </span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 종목별 최근 60 일 수익율의 평균</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sector</span>     
  
    <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;return_mean&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
    <span class="n">data_all_6</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">data_all_6</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">data_all_6</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;data_all_6.pkl&#39;</span><span class="p">)</span>   
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_all_6</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;data_all_6.pkl&#39;</span><span class="p">)</span> 
<span class="n">data_all_6</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_db6cf_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >open</th>
      <th class="col_heading level0 col1" >high</th>
      <th class="col_heading level0 col2" >low</th>
      <th class="col_heading level0 col3" >close</th>
      <th class="col_heading level0 col4" >volume</th>
      <th class="col_heading level0 col5" >change</th>
      <th class="col_heading level0 col6" >code</th>
      <th class="col_heading level0 col7" >name</th>
      <th class="col_heading level0 col8" >kosdaq_return</th>
      <th class="col_heading level0 col9" >return</th>
      <th class="col_heading level0 col10" >win_market</th>
      <th class="col_heading level0 col11" >close_r1</th>
      <th class="col_heading level0 col12" >close_r2</th>
      <th class="col_heading level0 col13" >close_r3</th>
      <th class="col_heading level0 col14" >close_r4</th>
      <th class="col_heading level0 col15" >close_r5</th>
      <th class="col_heading level0 col16" >max_close</th>
      <th class="col_heading level0 col17" >return_mean</th>
      <th class="col_heading level0 col18" >sector</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_db6cf_level0_row0" class="row_heading level0 row0" >2021-04-01</th>
      <td id="T_db6cf_row0_col0" class="data row0 col0" >13100</td>
      <td id="T_db6cf_row0_col1" class="data row0 col1" >13650</td>
      <td id="T_db6cf_row0_col2" class="data row0 col2" >13100</td>
      <td id="T_db6cf_row0_col3" class="data row0 col3" >13400</td>
      <td id="T_db6cf_row0_col4" class="data row0 col4" >194185</td>
      <td id="T_db6cf_row0_col5" class="data row0 col5" >0.022901</td>
      <td id="T_db6cf_row0_col6" class="data row0 col6" >238490</td>
      <td id="T_db6cf_row0_col7" class="data row0 col7" >힘스</td>
      <td id="T_db6cf_row0_col8" class="data row0 col8" >1.010051</td>
      <td id="T_db6cf_row0_col9" class="data row0 col9" >1.022901</td>
      <td id="T_db6cf_row0_col10" class="data row0 col10" >0</td>
      <td id="T_db6cf_row0_col11" class="data row0 col11" >1.007463</td>
      <td id="T_db6cf_row0_col12" class="data row0 col12" >1.022388</td>
      <td id="T_db6cf_row0_col13" class="data row0 col13" >1.018657</td>
      <td id="T_db6cf_row0_col14" class="data row0 col14" >1.041045</td>
      <td id="T_db6cf_row0_col15" class="data row0 col15" >1.026119</td>
      <td id="T_db6cf_row0_col16" class="data row0 col16" >1.041045</td>
      <td id="T_db6cf_row0_col17" class="data row0 col17" >1.000755</td>
      <td id="T_db6cf_row0_col18" class="data row0 col18" >특수 목적용 기계 제조업</td>
    </tr>
    <tr>
      <th id="T_db6cf_level0_row1" class="row_heading level0 row1" >2021-04-02</th>
      <td id="T_db6cf_row1_col0" class="data row1 col0" >13500</td>
      <td id="T_db6cf_row1_col1" class="data row1 col1" >13650</td>
      <td id="T_db6cf_row1_col2" class="data row1 col2" >13300</td>
      <td id="T_db6cf_row1_col3" class="data row1 col3" >13500</td>
      <td id="T_db6cf_row1_col4" class="data row1 col4" >136673</td>
      <td id="T_db6cf_row1_col5" class="data row1 col5" >0.007463</td>
      <td id="T_db6cf_row1_col6" class="data row1 col6" >238490</td>
      <td id="T_db6cf_row1_col7" class="data row1 col7" >힘스</td>
      <td id="T_db6cf_row1_col8" class="data row1 col8" >1.004463</td>
      <td id="T_db6cf_row1_col9" class="data row1 col9" >1.007463</td>
      <td id="T_db6cf_row1_col10" class="data row1 col10" >0</td>
      <td id="T_db6cf_row1_col11" class="data row1 col11" >1.014815</td>
      <td id="T_db6cf_row1_col12" class="data row1 col12" >1.011111</td>
      <td id="T_db6cf_row1_col13" class="data row1 col13" >1.033333</td>
      <td id="T_db6cf_row1_col14" class="data row1 col14" >1.018519</td>
      <td id="T_db6cf_row1_col15" class="data row1 col15" >1.022222</td>
      <td id="T_db6cf_row1_col16" class="data row1 col16" >1.033333</td>
      <td id="T_db6cf_row1_col17" class="data row1 col17" >1.001071</td>
      <td id="T_db6cf_row1_col18" class="data row1 col18" >특수 목적용 기계 제조업</td>
    </tr>
    <tr>
      <th id="T_db6cf_level0_row2" class="row_heading level0 row2" >2021-04-05</th>
      <td id="T_db6cf_row2_col0" class="data row2 col0" >13600</td>
      <td id="T_db6cf_row2_col1" class="data row2 col1" >13800</td>
      <td id="T_db6cf_row2_col2" class="data row2 col2" >13400</td>
      <td id="T_db6cf_row2_col3" class="data row2 col3" >13700</td>
      <td id="T_db6cf_row2_col4" class="data row2 col4" >219062</td>
      <td id="T_db6cf_row2_col5" class="data row2 col5" >0.014815</td>
      <td id="T_db6cf_row2_col6" class="data row2 col6" >238490</td>
      <td id="T_db6cf_row2_col7" class="data row2 col7" >힘스</td>
      <td id="T_db6cf_row2_col8" class="data row2 col8" >0.999670</td>
      <td id="T_db6cf_row2_col9" class="data row2 col9" >1.014815</td>
      <td id="T_db6cf_row2_col10" class="data row2 col10" >1</td>
      <td id="T_db6cf_row2_col11" class="data row2 col11" >0.996350</td>
      <td id="T_db6cf_row2_col12" class="data row2 col12" >1.018248</td>
      <td id="T_db6cf_row2_col13" class="data row2 col13" >1.003650</td>
      <td id="T_db6cf_row2_col14" class="data row2 col14" >1.007299</td>
      <td id="T_db6cf_row2_col15" class="data row2 col15" >0.992701</td>
      <td id="T_db6cf_row2_col16" class="data row2 col16" >1.018248</td>
      <td id="T_db6cf_row2_col17" class="data row2 col17" >1.001059</td>
      <td id="T_db6cf_row2_col18" class="data row2 col18" >특수 목적용 기계 제조업</td>
    </tr>
    <tr>
      <th id="T_db6cf_level0_row3" class="row_heading level0 row3" >2021-04-06</th>
      <td id="T_db6cf_row3_col0" class="data row3 col0" >13800</td>
      <td id="T_db6cf_row3_col1" class="data row3 col1" >13900</td>
      <td id="T_db6cf_row3_col2" class="data row3 col2" >13500</td>
      <td id="T_db6cf_row3_col3" class="data row3 col3" >13650</td>
      <td id="T_db6cf_row3_col4" class="data row3 col4" >135914</td>
      <td id="T_db6cf_row3_col5" class="data row3 col5" >-0.003650</td>
      <td id="T_db6cf_row3_col6" class="data row3 col6" >238490</td>
      <td id="T_db6cf_row3_col7" class="data row3 col7" >힘스</td>
      <td id="T_db6cf_row3_col8" class="data row3 col8" >0.998824</td>
      <td id="T_db6cf_row3_col9" class="data row3 col9" >0.996350</td>
      <td id="T_db6cf_row3_col10" class="data row3 col10" >0</td>
      <td id="T_db6cf_row3_col11" class="data row3 col11" >1.021978</td>
      <td id="T_db6cf_row3_col12" class="data row3 col12" >1.007326</td>
      <td id="T_db6cf_row3_col13" class="data row3 col13" >1.010989</td>
      <td id="T_db6cf_row3_col14" class="data row3 col14" >0.996337</td>
      <td id="T_db6cf_row3_col15" class="data row3 col15" >1.003663</td>
      <td id="T_db6cf_row3_col16" class="data row3 col16" >1.021978</td>
      <td id="T_db6cf_row3_col17" class="data row3 col17" >1.000998</td>
      <td id="T_db6cf_row3_col18" class="data row3 col18" >특수 목적용 기계 제조업</td>
    </tr>
    <tr>
      <th id="T_db6cf_level0_row4" class="row_heading level0 row4" >2021-04-07</th>
      <td id="T_db6cf_row4_col0" class="data row4 col0" >13700</td>
      <td id="T_db6cf_row4_col1" class="data row4 col1" >13950</td>
      <td id="T_db6cf_row4_col2" class="data row4 col2" >13500</td>
      <td id="T_db6cf_row4_col3" class="data row4 col3" >13950</td>
      <td id="T_db6cf_row4_col4" class="data row4 col4" >195408</td>
      <td id="T_db6cf_row4_col5" class="data row4 col5" >0.021978</td>
      <td id="T_db6cf_row4_col6" class="data row4 col6" >238490</td>
      <td id="T_db6cf_row4_col7" class="data row4 col7" >힘스</td>
      <td id="T_db6cf_row4_col8" class="data row4 col8" >1.004739</td>
      <td id="T_db6cf_row4_col9" class="data row4 col9" >1.021978</td>
      <td id="T_db6cf_row4_col10" class="data row4 col10" >0</td>
      <td id="T_db6cf_row4_col11" class="data row4 col11" >0.985663</td>
      <td id="T_db6cf_row4_col12" class="data row4 col12" >0.989247</td>
      <td id="T_db6cf_row4_col13" class="data row4 col13" >0.974910</td>
      <td id="T_db6cf_row4_col14" class="data row4 col14" >0.982079</td>
      <td id="T_db6cf_row4_col15" class="data row4 col15" >1.017921</td>
      <td id="T_db6cf_row4_col16" class="data row4 col16" >1.017921</td>
      <td id="T_db6cf_row4_col17" class="data row4 col17" >1.001556</td>
      <td id="T_db6cf_row4_col18" class="data row4 col18" >특수 목적용 기계 제조업</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>최근 60 일 평균수익율 정보를 섹터 별, 일 별로 요약한 값을 추가합니다. 이때 apply 대신 Transform 함수가 이용되었습니다. apply 는 그룹의 숫자 만큼 행을 리턴하나, transform 은 그룹핑 하기 전의 행 수 를 리턴합니다. 그 값을 ‘return over sector’ 라는 변수에 저장합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_all_6</span><span class="p">[</span><span class="s1">&#39;sector_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_all_6</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="n">data_all_6</span><span class="o">.</span><span class="n">index</span><span class="p">])[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">data_all_6</span><span class="p">[</span><span class="s1">&#39;return over sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_all_6</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data_all_6</span><span class="p">[</span><span class="s1">&#39;sector_return&#39;</span><span class="p">])</span> <span class="c1"># 섹터의 평균 수익률 대비 종목 수익률의 비율</span>
</pre></div>
</div>
</div>
</div>
<p>결과를 보니, 섹터를 이용하여 종목을 선정할 때는 섹터 평균 수익율보다 많이 높거나, 많이 낮는 종목을 선정하는 것이 수익율이 좋게 나왔습니다. 섹터 평균 수익율 대비 종목 수익율은 미래 수익율 예측에 도움이 되는 정보입니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
<span class="n">ranks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">data_all_6</span><span class="p">[</span><span class="s1">&#39;return over sector&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_all_6</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ranks</span><span class="p">)[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">]))</span>
<span class="n">data_all_6</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ranks</span><span class="p">)[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                        count  mean   std   min    1%   50%   99%   max
return over sector                                                     
(0.378, 0.974]     34,292.000 1.042 0.086 0.700 0.920 1.022 1.384 2.968
(0.974, 0.984]     34,291.000 1.034 0.067 0.702 0.945 1.018 1.302 2.171
(0.984, 0.99]      34,292.000 1.030 0.061 0.700 0.949 1.016 1.278 2.330
(0.99, 0.994]      34,291.000 1.028 0.059 0.701 0.952 1.014 1.265 2.269
(0.994, 0.999]     34,291.000 1.027 0.058 0.708 0.954 1.013 1.256 2.729
(0.999, 1.002]     34,291.000 1.029 0.066 0.700 0.949 1.013 1.295 3.701
(1.002, 1.007]     34,292.000 1.027 0.059 0.700 0.951 1.012 1.255 3.027
(1.007, 1.013]     34,291.000 1.028 0.062 0.700 0.949 1.013 1.276 3.380
(1.013, 1.026]     34,291.000 1.031 0.067 0.326 0.944 1.014 1.307 2.412
(1.026, 1.399]     34,292.000 1.042 0.103 0.700 0.910 1.019 1.419 3.703
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;return over sector&#39;&gt;
</pre></div>
</div>
<img alt="_images/4.4.4_Data_Processing_34_2.png" src="_images/4.4.4_Data_Processing_34_2.png" />
</div>
</div>
<p>한 섹터에 최소 10 개 이상의 종목이 있어야 섹터의 평균 수익율이 의미가 있을 것 같습니다. 10개 이상의 종목이 있는 섹터만을 매수 대상으로 해서 다시 수익율을 계산해봅니다. 같은 결과를 얻었습니다. 섹터의 평균 수익율보다 아주 낮거나 높은 종목의 수익율의 상승이 높았습니다. 그래프 곡선이 더 부드러워졌습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sector_count</span> <span class="o">=</span> <span class="n">data_all_6</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;sector&#39;</span><span class="p">)[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span>
<span class="n">data_all_6x</span> <span class="o">=</span> <span class="n">data_all_6</span><span class="p">[</span><span class="n">data_all_6</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">sector_count</span><span class="p">[</span><span class="n">sector_count</span><span class="o">&gt;=</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
<span class="n">ranks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">data_all_6x</span><span class="p">[</span><span class="s1">&#39;return over sector&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_all_6x</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ranks</span><span class="p">)[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">]))</span>
<span class="n">data_all_6x</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ranks</span><span class="p">)[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                        count  mean   std   min    1%   50%   99%   max
return over sector                                                     
(0.688, 0.973]     26,887.000 1.042 0.087 0.700 0.918 1.022 1.388 2.968
(0.973, 0.983]     26,886.000 1.034 0.067 0.702 0.944 1.019 1.299 2.171
(0.983, 0.989]     26,886.000 1.030 0.060 0.704 0.948 1.016 1.267 2.286
(0.989, 0.994]     26,886.000 1.028 0.060 0.700 0.952 1.014 1.269 2.194
(0.994, 0.998]     26,889.000 1.027 0.058 0.819 0.954 1.013 1.255 2.729
(0.998, 1.002]     26,883.000 1.026 0.059 0.700 0.954 1.012 1.257 2.652
(1.002, 1.007]     26,886.000 1.027 0.062 0.700 0.950 1.012 1.257 3.027
(1.007, 1.014]     26,886.000 1.028 0.062 0.700 0.949 1.013 1.285 3.380
(1.014, 1.027]     26,886.000 1.031 0.068 0.700 0.943 1.014 1.315 2.412
(1.027, 1.399]     26,887.000 1.043 0.105 0.700 0.909 1.019 1.423 3.703
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;return over sector&#39;&gt;
</pre></div>
</div>
<img alt="_images/4.4.4_Data_Processing_36_2.png" src="_images/4.4.4_Data_Processing_36_2.png" />
</div>
</div>
</section>
</div>
</section>
</div>
<div class="toctree-wrapper compound">
<span id="document-chapter5/5.1.0_Hypothesis"></span><section id="id1">
<h2><strong>가설 검정</strong><a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<p>이번 장에서는 아래 가설들을 하나씩 데이터를 이용하여 검정해 보시는 시간입니다. 유의미한 것으로 증명된 가설은 주가를 예측하는 모델에 입력 피쳐로 들어가게 됩니다.</p>
<ul class="simple">
<li><p>변동성이 크고 거래량이 몰린 종목이 주가가 상승한다.</p></li>
<li><p>5일 이동 평균선이 오늘 종가보다 위에 위치해 있다.</p></li>
<li><p>위 꼬리가 긴 양봉이 자주 발생한다.</p></li>
<li><p>거래량이 종종 크게 터지며 매집의 흔적을 보인다.</p></li>
<li><p>주가지수보다 더 좋은 수익율을 자주 보여준다.</p></li>
<li><p>동종업계의 평균 수익률보다 좋은 수익률을 보여준다.</p></li>
<li><p>개인투자자보다는 투신/사모펀드 등이 매수를 많이 한다.</p></li>
</ul>
<div class="toctree-wrapper compound">
<span id="document-chapter5/5.1.1_Hypothesis_1"></span><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<section id="id1">
<h3>가격 변동성이 크고 거래량이 몰린 종목이 주가가 상승한다.<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>“가격 변동성이 크고 거래량이 몰린 종목이 주가가 상승한다” 라는 가설을 증명하기 위해서는 “가격 변동성이 크다”, “거래량이 몰린다” 등을 표현하는 변수가 필요합니다. 먼저 일봉데이터를 불러옵니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mdl_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;mdl_data.pkl&#39;</span><span class="p">)</span>
<span class="n">mdl_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_20ce7_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >open</th>
      <th class="col_heading level0 col1" >high</th>
      <th class="col_heading level0 col2" >low</th>
      <th class="col_heading level0 col3" >close</th>
      <th class="col_heading level0 col4" >volume</th>
      <th class="col_heading level0 col5" >change</th>
      <th class="col_heading level0 col6" >code</th>
      <th class="col_heading level0 col7" >name</th>
      <th class="col_heading level0 col8" >kosdaq_return</th>
      <th class="col_heading level0 col9" >return</th>
      <th class="col_heading level0 col10" >win_market</th>
      <th class="col_heading level0 col11" >close_r1</th>
      <th class="col_heading level0 col12" >close_r2</th>
      <th class="col_heading level0 col13" >close_r3</th>
      <th class="col_heading level0 col14" >close_r4</th>
      <th class="col_heading level0 col15" >close_r5</th>
      <th class="col_heading level0 col16" >max_close</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_20ce7_level0_row0" class="row_heading level0 row0" >2021-01-05</th>
      <td id="T_20ce7_row0_col0" class="data row0 col0" >2270</td>
      <td id="T_20ce7_row0_col1" class="data row0 col1" >2285</td>
      <td id="T_20ce7_row0_col2" class="data row0 col2" >2200</td>
      <td id="T_20ce7_row0_col3" class="data row0 col3" >2250</td>
      <td id="T_20ce7_row0_col4" class="data row0 col4" >410263</td>
      <td id="T_20ce7_row0_col5" class="data row0 col5" >-0.004425</td>
      <td id="T_20ce7_row0_col6" class="data row0 col6" >060310</td>
      <td id="T_20ce7_row0_col7" class="data row0 col7" >3S</td>
      <td id="T_20ce7_row0_col8" class="data row0 col8" >1.008326</td>
      <td id="T_20ce7_row0_col9" class="data row0 col9" >0.995575</td>
      <td id="T_20ce7_row0_col10" class="data row0 col10" >0</td>
      <td id="T_20ce7_row0_col11" class="data row0 col11" >1.017778</td>
      <td id="T_20ce7_row0_col12" class="data row0 col12" >1.017778</td>
      <td id="T_20ce7_row0_col13" class="data row0 col13" >0.997778</td>
      <td id="T_20ce7_row0_col14" class="data row0 col14" >0.966667</td>
      <td id="T_20ce7_row0_col15" class="data row0 col15" >0.971111</td>
      <td id="T_20ce7_row0_col16" class="data row0 col16" >1.017778</td>
    </tr>
    <tr>
      <th id="T_20ce7_level0_row1" class="row_heading level0 row1" >2021-01-06</th>
      <td id="T_20ce7_row1_col0" class="data row1 col0" >2225</td>
      <td id="T_20ce7_row1_col1" class="data row1 col1" >2310</td>
      <td id="T_20ce7_row1_col2" class="data row1 col2" >2215</td>
      <td id="T_20ce7_row1_col3" class="data row1 col3" >2290</td>
      <td id="T_20ce7_row1_col4" class="data row1 col4" >570349</td>
      <td id="T_20ce7_row1_col5" class="data row1 col5" >0.017778</td>
      <td id="T_20ce7_row1_col6" class="data row1 col6" >060310</td>
      <td id="T_20ce7_row1_col7" class="data row1 col7" >3S</td>
      <td id="T_20ce7_row1_col8" class="data row1 col8" >0.995567</td>
      <td id="T_20ce7_row1_col9" class="data row1 col9" >1.017778</td>
      <td id="T_20ce7_row1_col10" class="data row1 col10" >1</td>
      <td id="T_20ce7_row1_col11" class="data row1 col11" >1.000000</td>
      <td id="T_20ce7_row1_col12" class="data row1 col12" >0.980349</td>
      <td id="T_20ce7_row1_col13" class="data row1 col13" >0.949782</td>
      <td id="T_20ce7_row1_col14" class="data row1 col14" >0.954148</td>
      <td id="T_20ce7_row1_col15" class="data row1 col15" >0.949782</td>
      <td id="T_20ce7_row1_col16" class="data row1 col16" >1.000000</td>
    </tr>
    <tr>
      <th id="T_20ce7_level0_row2" class="row_heading level0 row2" >2021-01-07</th>
      <td id="T_20ce7_row2_col0" class="data row2 col0" >2290</td>
      <td id="T_20ce7_row2_col1" class="data row2 col1" >2340</td>
      <td id="T_20ce7_row2_col2" class="data row2 col2" >2240</td>
      <td id="T_20ce7_row2_col3" class="data row2 col3" >2290</td>
      <td id="T_20ce7_row2_col4" class="data row2 col4" >519777</td>
      <td id="T_20ce7_row2_col5" class="data row2 col5" >0.000000</td>
      <td id="T_20ce7_row2_col6" class="data row2 col6" >060310</td>
      <td id="T_20ce7_row2_col7" class="data row2 col7" >3S</td>
      <td id="T_20ce7_row2_col8" class="data row2 col8" >1.007612</td>
      <td id="T_20ce7_row2_col9" class="data row2 col9" >1.000000</td>
      <td id="T_20ce7_row2_col10" class="data row2 col10" >0</td>
      <td id="T_20ce7_row2_col11" class="data row2 col11" >0.980349</td>
      <td id="T_20ce7_row2_col12" class="data row2 col12" >0.949782</td>
      <td id="T_20ce7_row2_col13" class="data row2 col13" >0.954148</td>
      <td id="T_20ce7_row2_col14" class="data row2 col14" >0.949782</td>
      <td id="T_20ce7_row2_col15" class="data row2 col15" >0.958515</td>
      <td id="T_20ce7_row2_col16" class="data row2 col16" >0.980349</td>
    </tr>
    <tr>
      <th id="T_20ce7_level0_row3" class="row_heading level0 row3" >2021-01-08</th>
      <td id="T_20ce7_row3_col0" class="data row3 col0" >2300</td>
      <td id="T_20ce7_row3_col1" class="data row3 col1" >2315</td>
      <td id="T_20ce7_row3_col2" class="data row3 col2" >2225</td>
      <td id="T_20ce7_row3_col3" class="data row3 col3" >2245</td>
      <td id="T_20ce7_row3_col4" class="data row3 col4" >462568</td>
      <td id="T_20ce7_row3_col5" class="data row3 col5" >-0.019651</td>
      <td id="T_20ce7_row3_col6" class="data row3 col6" >060310</td>
      <td id="T_20ce7_row3_col7" class="data row3 col7" >3S</td>
      <td id="T_20ce7_row3_col8" class="data row3 col8" >0.998918</td>
      <td id="T_20ce7_row3_col9" class="data row3 col9" >0.980349</td>
      <td id="T_20ce7_row3_col10" class="data row3 col10" >0</td>
      <td id="T_20ce7_row3_col11" class="data row3 col11" >0.968820</td>
      <td id="T_20ce7_row3_col12" class="data row3 col12" >0.973274</td>
      <td id="T_20ce7_row3_col13" class="data row3 col13" >0.968820</td>
      <td id="T_20ce7_row3_col14" class="data row3 col14" >0.977728</td>
      <td id="T_20ce7_row3_col15" class="data row3 col15" >0.973274</td>
      <td id="T_20ce7_row3_col16" class="data row3 col16" >0.977728</td>
    </tr>
    <tr>
      <th id="T_20ce7_level0_row4" class="row_heading level0 row4" >2021-01-11</th>
      <td id="T_20ce7_row4_col0" class="data row4 col0" >2230</td>
      <td id="T_20ce7_row4_col1" class="data row4 col1" >2275</td>
      <td id="T_20ce7_row4_col2" class="data row4 col2" >2130</td>
      <td id="T_20ce7_row4_col3" class="data row4 col3" >2175</td>
      <td id="T_20ce7_row4_col4" class="data row4 col4" >409057</td>
      <td id="T_20ce7_row4_col5" class="data row4 col5" >-0.031180</td>
      <td id="T_20ce7_row4_col6" class="data row4 col6" >060310</td>
      <td id="T_20ce7_row4_col7" class="data row4 col7" >3S</td>
      <td id="T_20ce7_row4_col8" class="data row4 col8" >0.988702</td>
      <td id="T_20ce7_row4_col9" class="data row4 col9" >0.968820</td>
      <td id="T_20ce7_row4_col10" class="data row4 col10" >0</td>
      <td id="T_20ce7_row4_col11" class="data row4 col11" >1.004598</td>
      <td id="T_20ce7_row4_col12" class="data row4 col12" >1.000000</td>
      <td id="T_20ce7_row4_col13" class="data row4 col13" >1.009195</td>
      <td id="T_20ce7_row4_col14" class="data row4 col14" >1.004598</td>
      <td id="T_20ce7_row4_col15" class="data row4 col15" >1.002299</td>
      <td id="T_20ce7_row4_col16" class="data row4 col16" >1.009195</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>첫 번째 종목 060310 (종목이름 3S) 에 대하여 가격 변동성 변수를 만들어 보겠습니다. 전 5일 종가의 평균(price_mean), 전 5일 종가의 표준편차(price_std)를 먼저 구합니다. 그리고, 전 5일의 평균 및 표준편차 대비 당일 종가의 수준을 표준화해서 보여주는 값이 ‘price_z’ 입니다. price_z 값이 -1.96 와 +1.96 안에 값이면 95% 신뢰구간 안에 들어갑니다. 즉 -1.96 보다 작거나, 1.96 보다 크면(100 번중 5번 미만으로 일어날 확율) 당일의 종가는 직전 5일의 움직임에 비해 아주 특별하다고 생각할 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">mdl_data</span><span class="p">[</span><span class="n">mdl_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;060310&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># 종목 060310 선택</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;price_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 직전 5일 종가의 평균</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;price_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="c1"># 직전 5일 종가의 표준편차</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;price_mean&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;price_std&#39;</span><span class="p">]</span> <span class="c1"># 직전 5일 종가의 평균 및 표준편차 대비 오늘 종가의 위치</span>
<span class="n">df</span><span class="p">[[</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="s1">&#39;price_mean&#39;</span><span class="p">,</span><span class="s1">&#39;price_std&#39;</span><span class="p">,</span><span class="s1">&#39;price_z&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_6cc4d_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >close</th>
      <th class="col_heading level0 col1" >price_mean</th>
      <th class="col_heading level0 col2" >price_std</th>
      <th class="col_heading level0 col3" >price_z</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_6cc4d_level0_row0" class="row_heading level0 row0" >2021-01-05</th>
      <td id="T_6cc4d_row0_col0" class="data row0 col0" >2250</td>
      <td id="T_6cc4d_row0_col1" class="data row0 col1" >nan</td>
      <td id="T_6cc4d_row0_col2" class="data row0 col2" >nan</td>
      <td id="T_6cc4d_row0_col3" class="data row0 col3" >nan</td>
    </tr>
    <tr>
      <th id="T_6cc4d_level0_row1" class="row_heading level0 row1" >2021-01-06</th>
      <td id="T_6cc4d_row1_col0" class="data row1 col0" >2290</td>
      <td id="T_6cc4d_row1_col1" class="data row1 col1" >nan</td>
      <td id="T_6cc4d_row1_col2" class="data row1 col2" >nan</td>
      <td id="T_6cc4d_row1_col3" class="data row1 col3" >nan</td>
    </tr>
    <tr>
      <th id="T_6cc4d_level0_row2" class="row_heading level0 row2" >2021-01-07</th>
      <td id="T_6cc4d_row2_col0" class="data row2 col0" >2290</td>
      <td id="T_6cc4d_row2_col1" class="data row2 col1" >nan</td>
      <td id="T_6cc4d_row2_col2" class="data row2 col2" >nan</td>
      <td id="T_6cc4d_row2_col3" class="data row2 col3" >nan</td>
    </tr>
    <tr>
      <th id="T_6cc4d_level0_row3" class="row_heading level0 row3" >2021-01-08</th>
      <td id="T_6cc4d_row3_col0" class="data row3 col0" >2245</td>
      <td id="T_6cc4d_row3_col1" class="data row3 col1" >nan</td>
      <td id="T_6cc4d_row3_col2" class="data row3 col2" >nan</td>
      <td id="T_6cc4d_row3_col3" class="data row3 col3" >nan</td>
    </tr>
    <tr>
      <th id="T_6cc4d_level0_row4" class="row_heading level0 row4" >2021-01-11</th>
      <td id="T_6cc4d_row4_col0" class="data row4 col0" >2175</td>
      <td id="T_6cc4d_row4_col1" class="data row4 col1" >2250.000000</td>
      <td id="T_6cc4d_row4_col2" class="data row4 col2" >47.037219</td>
      <td id="T_6cc4d_row4_col3" class="data row4 col3" >-1.594482</td>
    </tr>
    <tr>
      <th id="T_6cc4d_level0_row5" class="row_heading level0 row5" >2021-01-12</th>
      <td id="T_6cc4d_row5_col0" class="data row5 col0" >2185</td>
      <td id="T_6cc4d_row5_col1" class="data row5 col1" >2237.000000</td>
      <td id="T_6cc4d_row5_col2" class="data row5 col2" >55.294665</td>
      <td id="T_6cc4d_row5_col3" class="data row5 col3" >-0.940416</td>
    </tr>
    <tr>
      <th id="T_6cc4d_level0_row6" class="row_heading level0 row6" >2021-01-13</th>
      <td id="T_6cc4d_row6_col0" class="data row6 col0" >2175</td>
      <td id="T_6cc4d_row6_col1" class="data row6 col1" >2214.000000</td>
      <td id="T_6cc4d_row6_col2" class="data row6 col2" >51.526692</td>
      <td id="T_6cc4d_row6_col3" class="data row6 col3" >-0.756889</td>
    </tr>
    <tr>
      <th id="T_6cc4d_level0_row7" class="row_heading level0 row7" >2021-01-14</th>
      <td id="T_6cc4d_row7_col0" class="data row7 col0" >2195</td>
      <td id="T_6cc4d_row7_col1" class="data row7 col1" >2195.000000</td>
      <td id="T_6cc4d_row7_col2" class="data row7 col2" >29.154759</td>
      <td id="T_6cc4d_row7_col3" class="data row7 col3" >0.000000</td>
    </tr>
    <tr>
      <th id="T_6cc4d_level0_row8" class="row_heading level0 row8" >2021-01-15</th>
      <td id="T_6cc4d_row8_col0" class="data row8 col0" >2185</td>
      <td id="T_6cc4d_row8_col1" class="data row8 col1" >2183.000000</td>
      <td id="T_6cc4d_row8_col2" class="data row8 col2" >8.366600</td>
      <td id="T_6cc4d_row8_col3" class="data row8 col3" >0.239046</td>
    </tr>
    <tr>
      <th id="T_6cc4d_level0_row9" class="row_heading level0 row9" >2021-01-18</th>
      <td id="T_6cc4d_row9_col0" class="data row9 col0" >2180</td>
      <td id="T_6cc4d_row9_col1" class="data row9 col1" >2184.000000</td>
      <td id="T_6cc4d_row9_col2" class="data row9 col2" >7.416198</td>
      <td id="T_6cc4d_row9_col3" class="data row9 col3" >-0.539360</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> 전 20일로 비교 구간을 바꾸고 전 종목에 대하여 동일한 계산을 합니다. 그리고 그 결과를 data_h1 에 담습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span>

<span class="n">data_h1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]:</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">mdl_data</span><span class="p">[</span><span class="n">mdl_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 전 20일 평균</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 전 20일 표준편차</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_mean&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_std&#39;</span><span class="p">]</span>  <span class="c1"># 표준화된 Z 값 생성  </span>
    
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 전 20일 평균</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># 전 20일 표준편차</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span>  <span class="c1"># 표준화된 Z 값 생성  </span>
       
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 5 영업일 종가 수익율 중 최고 값</span>
    <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">,</span><span class="s1">&#39;volume_z&#39;</span><span class="p">,</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># missing 이 있는 행은 제거  </span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_std&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)]</span> <span class="c1"># 0 으로 나누는 상황은 없도록 함.</span>
    
    <span class="n">data_h1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">data_h1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">data_h1</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;data_h1.pkl&#39;</span><span class="p">)</span>  
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_h1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;data_h1.pkl&#39;</span><span class="p">)</span>  
<span class="nb">print</span><span class="p">(</span><span class="n">data_h1</span><span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;min&#39;</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">]))</span> <span class="c1"># 최소값과 최대값을 확인함</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_h1</span><span class="p">[</span><span class="s1">&#39;volume_z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;min&#39;</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>min   -4.359
max    4.359
Name: price_z, dtype: float64
min   -2.568
max    4.359
Name: volume_z, dtype: float64
</pre></div>
</div>
</div>
</div>
<p><br> price_z 에 따른 종가 최고 수익률의 변화를 확인합니다. 최근 20일 종가의 평균 대비 오늘 종가가 낮거나 높은 경우 좋은 수익률을 기대할 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rank</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">data_h1</span><span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">data_h1</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">rank</span><span class="p">)[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;price_z&#39;&gt;
</pre></div>
</div>
<img alt="_images/5.1.1_Hypothesis_1_9_1.png" src="_images/5.1.1_Hypothesis_1_9_1.png" />
</div>
</div>
<p><br>최근 20일 대비 거래량이 많을 수 록 더 좋은 수익률을 기대할 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rank</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">data_h1</span><span class="p">[</span><span class="s1">&#39;volume_z&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">data_h1</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">rank</span><span class="p">)[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;volume_z&#39;&gt;
</pre></div>
</div>
<img alt="_images/5.1.1_Hypothesis_1_11_1.png" src="_images/5.1.1_Hypothesis_1_11_1.png" />
</div>
</div>
<p><br> 종가의 표준화 값 price_z 와 거래량의 표준화 값 volume_z 이 서로 직교하는 테이블로 구성하고 평균 수익율을 보니, 가격이 변동성이 높고, 거래량이 몰리는 종목은 평균 수익율이 더 높다는 것이 확인되었습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rank1</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">data_h1</span><span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">rank2</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">data_h1</span><span class="p">[</span><span class="s1">&#39;volume_z&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>

<span class="n">data_h1</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">rank1</span><span class="p">,</span> <span class="n">rank2</span><span class="p">])[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_fdb1a_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="index_name level0" >volume_z</th>
      <th class="col_heading level0 col0" >0</th>
      <th class="col_heading level0 col1" >1</th>
      <th class="col_heading level0 col2" >2</th>
      <th class="col_heading level0 col3" >3</th>
      <th class="col_heading level0 col4" >4</th>
    </tr>
    <tr>
      <th class="index_name level0" >price_z</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_fdb1a_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_fdb1a_row0_col0" class="data row0 col0" >1.031552</td>
      <td id="T_fdb1a_row0_col1" class="data row0 col1" >1.033693</td>
      <td id="T_fdb1a_row0_col2" class="data row0 col2" >1.034862</td>
      <td id="T_fdb1a_row0_col3" class="data row0 col3" >1.038177</td>
      <td id="T_fdb1a_row0_col4" class="data row0 col4" >1.039851</td>
    </tr>
    <tr>
      <th id="T_fdb1a_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_fdb1a_row1_col0" class="data row1 col0" >1.027750</td>
      <td id="T_fdb1a_row1_col1" class="data row1 col1" >1.029263</td>
      <td id="T_fdb1a_row1_col2" class="data row1 col2" >1.030943</td>
      <td id="T_fdb1a_row1_col3" class="data row1 col3" >1.033327</td>
      <td id="T_fdb1a_row1_col4" class="data row1 col4" >1.034607</td>
    </tr>
    <tr>
      <th id="T_fdb1a_level0_row2" class="row_heading level0 row2" >2</th>
      <td id="T_fdb1a_row2_col0" class="data row2 col0" >1.026078</td>
      <td id="T_fdb1a_row2_col1" class="data row2 col1" >1.030034</td>
      <td id="T_fdb1a_row2_col2" class="data row2 col2" >1.029742</td>
      <td id="T_fdb1a_row2_col3" class="data row2 col3" >1.030575</td>
      <td id="T_fdb1a_row2_col4" class="data row2 col4" >1.031971</td>
    </tr>
    <tr>
      <th id="T_fdb1a_level0_row3" class="row_heading level0 row3" >3</th>
      <td id="T_fdb1a_row3_col0" class="data row3 col0" >1.027799</td>
      <td id="T_fdb1a_row3_col1" class="data row3 col1" >1.034619</td>
      <td id="T_fdb1a_row3_col2" class="data row3 col2" >1.034718</td>
      <td id="T_fdb1a_row3_col3" class="data row3 col3" >1.035622</td>
      <td id="T_fdb1a_row3_col4" class="data row3 col4" >1.036636</td>
    </tr>
    <tr>
      <th id="T_fdb1a_level0_row4" class="row_heading level0 row4" >4</th>
      <td id="T_fdb1a_row4_col0" class="data row4 col0" >1.029375</td>
      <td id="T_fdb1a_row4_col1" class="data row4 col1" >1.037509</td>
      <td id="T_fdb1a_row4_col2" class="data row4 col2" >1.038355</td>
      <td id="T_fdb1a_row4_col3" class="data row4 col3" >1.039061</td>
      <td id="T_fdb1a_row4_col4" class="data row4 col4" >1.043562</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<span id="document-chapter5/5.1.2_Hypothesis_2"></span><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<section id="id1">
<h3>5일 이동 평균선이 오늘 종가보다 위에 위치해 있다.<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>rolling(5) 을 이용하여 이동평균선을 만듭니다. 그리고 당일의 종가보다 크면, 1 아니면 0 인 변수 ‘flag’ 을 생성합니다. 이 가설은 검증이 쉬운 것 같습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mdl_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;mdl_data.pkl&#39;</span><span class="p">)</span> <span class="c1"># 수익률 결과가 있는 데이터</span>
<span class="n">mdl_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_1643a_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >open</th>
      <th class="col_heading level0 col1" >high</th>
      <th class="col_heading level0 col2" >low</th>
      <th class="col_heading level0 col3" >close</th>
      <th class="col_heading level0 col4" >volume</th>
      <th class="col_heading level0 col5" >change</th>
      <th class="col_heading level0 col6" >code</th>
      <th class="col_heading level0 col7" >name</th>
      <th class="col_heading level0 col8" >kosdaq_return</th>
      <th class="col_heading level0 col9" >return</th>
      <th class="col_heading level0 col10" >win_market</th>
      <th class="col_heading level0 col11" >close_r1</th>
      <th class="col_heading level0 col12" >close_r2</th>
      <th class="col_heading level0 col13" >close_r3</th>
      <th class="col_heading level0 col14" >close_r4</th>
      <th class="col_heading level0 col15" >close_r5</th>
      <th class="col_heading level0 col16" >max_close</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_1643a_level0_row0" class="row_heading level0 row0" >2021-01-05</th>
      <td id="T_1643a_row0_col0" class="data row0 col0" >2270</td>
      <td id="T_1643a_row0_col1" class="data row0 col1" >2285</td>
      <td id="T_1643a_row0_col2" class="data row0 col2" >2200</td>
      <td id="T_1643a_row0_col3" class="data row0 col3" >2250</td>
      <td id="T_1643a_row0_col4" class="data row0 col4" >410263</td>
      <td id="T_1643a_row0_col5" class="data row0 col5" >-0.004425</td>
      <td id="T_1643a_row0_col6" class="data row0 col6" >060310</td>
      <td id="T_1643a_row0_col7" class="data row0 col7" >3S</td>
      <td id="T_1643a_row0_col8" class="data row0 col8" >1.008326</td>
      <td id="T_1643a_row0_col9" class="data row0 col9" >0.995575</td>
      <td id="T_1643a_row0_col10" class="data row0 col10" >0</td>
      <td id="T_1643a_row0_col11" class="data row0 col11" >1.017778</td>
      <td id="T_1643a_row0_col12" class="data row0 col12" >1.017778</td>
      <td id="T_1643a_row0_col13" class="data row0 col13" >0.997778</td>
      <td id="T_1643a_row0_col14" class="data row0 col14" >0.966667</td>
      <td id="T_1643a_row0_col15" class="data row0 col15" >0.971111</td>
      <td id="T_1643a_row0_col16" class="data row0 col16" >1.017778</td>
    </tr>
    <tr>
      <th id="T_1643a_level0_row1" class="row_heading level0 row1" >2021-01-06</th>
      <td id="T_1643a_row1_col0" class="data row1 col0" >2225</td>
      <td id="T_1643a_row1_col1" class="data row1 col1" >2310</td>
      <td id="T_1643a_row1_col2" class="data row1 col2" >2215</td>
      <td id="T_1643a_row1_col3" class="data row1 col3" >2290</td>
      <td id="T_1643a_row1_col4" class="data row1 col4" >570349</td>
      <td id="T_1643a_row1_col5" class="data row1 col5" >0.017778</td>
      <td id="T_1643a_row1_col6" class="data row1 col6" >060310</td>
      <td id="T_1643a_row1_col7" class="data row1 col7" >3S</td>
      <td id="T_1643a_row1_col8" class="data row1 col8" >0.995567</td>
      <td id="T_1643a_row1_col9" class="data row1 col9" >1.017778</td>
      <td id="T_1643a_row1_col10" class="data row1 col10" >1</td>
      <td id="T_1643a_row1_col11" class="data row1 col11" >1.000000</td>
      <td id="T_1643a_row1_col12" class="data row1 col12" >0.980349</td>
      <td id="T_1643a_row1_col13" class="data row1 col13" >0.949782</td>
      <td id="T_1643a_row1_col14" class="data row1 col14" >0.954148</td>
      <td id="T_1643a_row1_col15" class="data row1 col15" >0.949782</td>
      <td id="T_1643a_row1_col16" class="data row1 col16" >1.000000</td>
    </tr>
    <tr>
      <th id="T_1643a_level0_row2" class="row_heading level0 row2" >2021-01-07</th>
      <td id="T_1643a_row2_col0" class="data row2 col0" >2290</td>
      <td id="T_1643a_row2_col1" class="data row2 col1" >2340</td>
      <td id="T_1643a_row2_col2" class="data row2 col2" >2240</td>
      <td id="T_1643a_row2_col3" class="data row2 col3" >2290</td>
      <td id="T_1643a_row2_col4" class="data row2 col4" >519777</td>
      <td id="T_1643a_row2_col5" class="data row2 col5" >0.000000</td>
      <td id="T_1643a_row2_col6" class="data row2 col6" >060310</td>
      <td id="T_1643a_row2_col7" class="data row2 col7" >3S</td>
      <td id="T_1643a_row2_col8" class="data row2 col8" >1.007612</td>
      <td id="T_1643a_row2_col9" class="data row2 col9" >1.000000</td>
      <td id="T_1643a_row2_col10" class="data row2 col10" >0</td>
      <td id="T_1643a_row2_col11" class="data row2 col11" >0.980349</td>
      <td id="T_1643a_row2_col12" class="data row2 col12" >0.949782</td>
      <td id="T_1643a_row2_col13" class="data row2 col13" >0.954148</td>
      <td id="T_1643a_row2_col14" class="data row2 col14" >0.949782</td>
      <td id="T_1643a_row2_col15" class="data row2 col15" >0.958515</td>
      <td id="T_1643a_row2_col16" class="data row2 col16" >0.980349</td>
    </tr>
    <tr>
      <th id="T_1643a_level0_row3" class="row_heading level0 row3" >2021-01-08</th>
      <td id="T_1643a_row3_col0" class="data row3 col0" >2300</td>
      <td id="T_1643a_row3_col1" class="data row3 col1" >2315</td>
      <td id="T_1643a_row3_col2" class="data row3 col2" >2225</td>
      <td id="T_1643a_row3_col3" class="data row3 col3" >2245</td>
      <td id="T_1643a_row3_col4" class="data row3 col4" >462568</td>
      <td id="T_1643a_row3_col5" class="data row3 col5" >-0.019651</td>
      <td id="T_1643a_row3_col6" class="data row3 col6" >060310</td>
      <td id="T_1643a_row3_col7" class="data row3 col7" >3S</td>
      <td id="T_1643a_row3_col8" class="data row3 col8" >0.998918</td>
      <td id="T_1643a_row3_col9" class="data row3 col9" >0.980349</td>
      <td id="T_1643a_row3_col10" class="data row3 col10" >0</td>
      <td id="T_1643a_row3_col11" class="data row3 col11" >0.968820</td>
      <td id="T_1643a_row3_col12" class="data row3 col12" >0.973274</td>
      <td id="T_1643a_row3_col13" class="data row3 col13" >0.968820</td>
      <td id="T_1643a_row3_col14" class="data row3 col14" >0.977728</td>
      <td id="T_1643a_row3_col15" class="data row3 col15" >0.973274</td>
      <td id="T_1643a_row3_col16" class="data row3 col16" >0.977728</td>
    </tr>
    <tr>
      <th id="T_1643a_level0_row4" class="row_heading level0 row4" >2021-01-11</th>
      <td id="T_1643a_row4_col0" class="data row4 col0" >2230</td>
      <td id="T_1643a_row4_col1" class="data row4 col1" >2275</td>
      <td id="T_1643a_row4_col2" class="data row4 col2" >2130</td>
      <td id="T_1643a_row4_col3" class="data row4 col3" >2175</td>
      <td id="T_1643a_row4_col4" class="data row4 col4" >409057</td>
      <td id="T_1643a_row4_col5" class="data row4 col5" >-0.031180</td>
      <td id="T_1643a_row4_col6" class="data row4 col6" >060310</td>
      <td id="T_1643a_row4_col7" class="data row4 col7" >3S</td>
      <td id="T_1643a_row4_col8" class="data row4 col8" >0.988702</td>
      <td id="T_1643a_row4_col9" class="data row4 col9" >0.968820</td>
      <td id="T_1643a_row4_col10" class="data row4 col10" >0</td>
      <td id="T_1643a_row4_col11" class="data row4 col11" >1.004598</td>
      <td id="T_1643a_row4_col12" class="data row4 col12" >1.000000</td>
      <td id="T_1643a_row4_col13" class="data row4 col13" >1.009195</td>
      <td id="T_1643a_row4_col14" class="data row4 col14" >1.004598</td>
      <td id="T_1643a_row4_col15" class="data row4 col15" >1.002299</td>
      <td id="T_1643a_row4_col16" class="data row4 col16" >1.009195</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span>

<span class="n">data_h2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]:</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">mdl_data</span><span class="p">[</span><span class="n">mdl_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;5day_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 5일 이동평균선</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;5day_ma&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 5일 이동평균선이 종가보다 크면 1, 아니면 0</span>

       
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 5 영업일 종가 수익율 중 최고 값</span>
    <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;5day_ma&#39;</span><span class="p">,</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># missing 이 있는 행은 제거  </span>
    
    <span class="n">data_h2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">data_h2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">data_h2</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;data_h2.pkl&#39;</span><span class="p">)</span>  
</pre></div>
</div>
</div>
</div>
<p><br> ‘flag’ 가 0 인 경우와 1 인 경우를 비교해보니 이 가설은 데이터가 강하게 뒷받침하지 못하고 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_h2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;data_h2.pkl&#39;</span><span class="p">)</span>
<span class="n">data_h2</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;flag&#39;</span><span class="p">)[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_1aa2b_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >count</th>
      <th class="col_heading level0 col1" >mean</th>
      <th class="col_heading level0 col2" >std</th>
      <th class="col_heading level0 col3" >min</th>
      <th class="col_heading level0 col4" >25%</th>
      <th class="col_heading level0 col5" >50%</th>
      <th class="col_heading level0 col6" >75%</th>
      <th class="col_heading level0 col7" >max</th>
    </tr>
    <tr>
      <th class="index_name level0" >flag</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
      <th class="blank col7" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_1aa2b_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_1aa2b_row0_col0" class="data row0 col0" >209501.000</td>
      <td id="T_1aa2b_row0_col1" class="data row0 col1" >1.032</td>
      <td id="T_1aa2b_row0_col2" class="data row0 col2" >0.077</td>
      <td id="T_1aa2b_row0_col3" class="data row0 col3" >0.326</td>
      <td id="T_1aa2b_row0_col4" class="data row0 col4" >1.000</td>
      <td id="T_1aa2b_row0_col5" class="data row0 col5" >1.012</td>
      <td id="T_1aa2b_row0_col6" class="data row0 col6" >1.044</td>
      <td id="T_1aa2b_row0_col7" class="data row0 col7" >3.703</td>
    </tr>
    <tr>
      <th id="T_1aa2b_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_1aa2b_row1_col0" class="data row1 col0" >211348.000</td>
      <td id="T_1aa2b_row1_col1" class="data row1 col1" >1.034</td>
      <td id="T_1aa2b_row1_col2" class="data row1 col2" >0.068</td>
      <td id="T_1aa2b_row1_col3" class="data row1 col3" >0.700</td>
      <td id="T_1aa2b_row1_col4" class="data row1 col4" >0.999</td>
      <td id="T_1aa2b_row1_col5" class="data row1 col5" >1.019</td>
      <td id="T_1aa2b_row1_col6" class="data row1 col6" >1.052</td>
      <td id="T_1aa2b_row1_col7" class="data row1 col7" >3.139</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>T-Test 를 해보겠습니다. T-Test 는 두 집단의 평균이 서로 유의미하게 다른 지 확인하는 검정입니다. 귀무가설이 “두 집단의 평균이 같다” 이기 때문에,  p -value 가 유의수준(0.01) 보다 작으면 귀무가설을 기각합니다. 결과를 보니 P-Value 가 유의수준(0.01) 보다 큽니다. 따라서 귀무가설을 기각할 수 없습니다. 즉, flag 가 0 인 집단과 1 인 집단간의 차가 유의미하지 않은 것으로 판단됩니다. 왜 각 집단에서 샘플을 200 개만 뽑아서 테스트를 하는 지 궁금한 독자도 있으실 것 같습니다. 통계 검정은 샘플의 수가 많아지면 p value 가 작게 나오는 경향이 있습니다. 그렇게 되면 유의미하게 차이가 없는데도, 서로 다르다고 통계 결과가 나오게됩니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">data_h2</span><span class="p">[</span><span class="n">data_h2</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">data_h2</span><span class="p">[</span><span class="n">data_h2</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>

<span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ttest_indResult(statistic=-1.8358785283648644, pvalue=0.06714153725869931)
</pre></div>
</div>
</div>
</div>
<p><br> 위 가설은 비교적 증명하기가 쉬웠습니다. 이번에는 5일선과 20일 이동평균선이 만나는 골든크로스에서 매수를 하면 어떤지 보겠습니다. 골든 크로스에서 매수한다고 더 좋은 수익율을 보장하지 않는 것 같습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span>

<span class="n">data_h2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]:</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">mdl_data</span><span class="p">[</span><span class="n">mdl_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;5day_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 5일 이동평균선</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;20day_ma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 20일 이동평균선</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;golden_cross&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;5day_ma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;20day_ma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;5day_ma&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;20day_ma&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 5일선이 20일 이동평균선보다 작았다가 커지는 시점</span>
       
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 5 영업일 종가 수익율 중 최고 값</span>
    <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;5day_ma&#39;</span><span class="p">,</span><span class="s1">&#39;20day_ma&#39;</span><span class="p">,</span><span class="s1">&#39;golden_cross&#39;</span><span class="p">,</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># missing 이 있는 행은 제거  </span>
    
    <span class="n">data_h2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">data_h2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">data_h2</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;data_h2.pkl&#39;</span><span class="p">)</span>  
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_h2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;data_h2.pkl&#39;</span><span class="p">)</span>
<span class="n">data_h2</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;golden_cross&#39;</span><span class="p">)[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_ce34a_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >count</th>
      <th class="col_heading level0 col1" >mean</th>
      <th class="col_heading level0 col2" >std</th>
      <th class="col_heading level0 col3" >min</th>
      <th class="col_heading level0 col4" >25%</th>
      <th class="col_heading level0 col5" >50%</th>
      <th class="col_heading level0 col6" >75%</th>
      <th class="col_heading level0 col7" >max</th>
    </tr>
    <tr>
      <th class="index_name level0" >golden_cross</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
      <th class="blank col7" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_ce34a_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_ce34a_row0_col0" class="data row0 col0" >387430.000</td>
      <td id="T_ce34a_row0_col1" class="data row0 col1" >1.032</td>
      <td id="T_ce34a_row0_col2" class="data row0 col2" >0.071</td>
      <td id="T_ce34a_row0_col3" class="data row0 col3" >0.326</td>
      <td id="T_ce34a_row0_col4" class="data row0 col4" >1.000</td>
      <td id="T_ce34a_row0_col5" class="data row0 col5" >1.016</td>
      <td id="T_ce34a_row0_col6" class="data row0 col6" >1.048</td>
      <td id="T_ce34a_row0_col7" class="data row0 col7" >3.703</td>
    </tr>
    <tr>
      <th id="T_ce34a_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_ce34a_row1_col0" class="data row1 col0" >12164.000</td>
      <td id="T_ce34a_row1_col1" class="data row1 col1" >1.033</td>
      <td id="T_ce34a_row1_col2" class="data row1 col2" >0.079</td>
      <td id="T_ce34a_row1_col3" class="data row1 col3" >0.700</td>
      <td id="T_ce34a_row1_col4" class="data row1 col4" >0.997</td>
      <td id="T_ce34a_row1_col5" class="data row1 col5" >1.015</td>
      <td id="T_ce34a_row1_col6" class="data row1 col6" >1.047</td>
      <td id="T_ce34a_row1_col7" class="data row1 col7" >2.852</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<span id="document-chapter5/5.1.3_Hypothesis_3"></span><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<section id="id1">
<h3>위 꼬리가 긴 양봉이 자주 발생한다.<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>위 꼬리는 종가보다 고가가 더 높이 위치해 있는 양봉입니다. 따라서 고가를 종가로 나눈 값이 1 보다 상당히 크면 위꼬리 양봉이라고 할 수 있습니다. 양봉의 조건은 종가가 시가보다 큰 것입니다. 이 것을 데이터로 표현합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mdl_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;mdl_data.pkl&#39;</span><span class="p">)</span>
<span class="n">mdl_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_44371_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >open</th>
      <th class="col_heading level0 col1" >high</th>
      <th class="col_heading level0 col2" >low</th>
      <th class="col_heading level0 col3" >close</th>
      <th class="col_heading level0 col4" >volume</th>
      <th class="col_heading level0 col5" >change</th>
      <th class="col_heading level0 col6" >code</th>
      <th class="col_heading level0 col7" >name</th>
      <th class="col_heading level0 col8" >kosdaq_return</th>
      <th class="col_heading level0 col9" >return</th>
      <th class="col_heading level0 col10" >win_market</th>
      <th class="col_heading level0 col11" >close_r1</th>
      <th class="col_heading level0 col12" >close_r2</th>
      <th class="col_heading level0 col13" >close_r3</th>
      <th class="col_heading level0 col14" >close_r4</th>
      <th class="col_heading level0 col15" >close_r5</th>
      <th class="col_heading level0 col16" >max_close</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_44371_level0_row0" class="row_heading level0 row0" >2021-01-05</th>
      <td id="T_44371_row0_col0" class="data row0 col0" >2270</td>
      <td id="T_44371_row0_col1" class="data row0 col1" >2285</td>
      <td id="T_44371_row0_col2" class="data row0 col2" >2200</td>
      <td id="T_44371_row0_col3" class="data row0 col3" >2250</td>
      <td id="T_44371_row0_col4" class="data row0 col4" >410263</td>
      <td id="T_44371_row0_col5" class="data row0 col5" >-0.004425</td>
      <td id="T_44371_row0_col6" class="data row0 col6" >060310</td>
      <td id="T_44371_row0_col7" class="data row0 col7" >3S</td>
      <td id="T_44371_row0_col8" class="data row0 col8" >1.008326</td>
      <td id="T_44371_row0_col9" class="data row0 col9" >0.995575</td>
      <td id="T_44371_row0_col10" class="data row0 col10" >0</td>
      <td id="T_44371_row0_col11" class="data row0 col11" >1.017778</td>
      <td id="T_44371_row0_col12" class="data row0 col12" >1.017778</td>
      <td id="T_44371_row0_col13" class="data row0 col13" >0.997778</td>
      <td id="T_44371_row0_col14" class="data row0 col14" >0.966667</td>
      <td id="T_44371_row0_col15" class="data row0 col15" >0.971111</td>
      <td id="T_44371_row0_col16" class="data row0 col16" >1.017778</td>
    </tr>
    <tr>
      <th id="T_44371_level0_row1" class="row_heading level0 row1" >2021-01-06</th>
      <td id="T_44371_row1_col0" class="data row1 col0" >2225</td>
      <td id="T_44371_row1_col1" class="data row1 col1" >2310</td>
      <td id="T_44371_row1_col2" class="data row1 col2" >2215</td>
      <td id="T_44371_row1_col3" class="data row1 col3" >2290</td>
      <td id="T_44371_row1_col4" class="data row1 col4" >570349</td>
      <td id="T_44371_row1_col5" class="data row1 col5" >0.017778</td>
      <td id="T_44371_row1_col6" class="data row1 col6" >060310</td>
      <td id="T_44371_row1_col7" class="data row1 col7" >3S</td>
      <td id="T_44371_row1_col8" class="data row1 col8" >0.995567</td>
      <td id="T_44371_row1_col9" class="data row1 col9" >1.017778</td>
      <td id="T_44371_row1_col10" class="data row1 col10" >1</td>
      <td id="T_44371_row1_col11" class="data row1 col11" >1.000000</td>
      <td id="T_44371_row1_col12" class="data row1 col12" >0.980349</td>
      <td id="T_44371_row1_col13" class="data row1 col13" >0.949782</td>
      <td id="T_44371_row1_col14" class="data row1 col14" >0.954148</td>
      <td id="T_44371_row1_col15" class="data row1 col15" >0.949782</td>
      <td id="T_44371_row1_col16" class="data row1 col16" >1.000000</td>
    </tr>
    <tr>
      <th id="T_44371_level0_row2" class="row_heading level0 row2" >2021-01-07</th>
      <td id="T_44371_row2_col0" class="data row2 col0" >2290</td>
      <td id="T_44371_row2_col1" class="data row2 col1" >2340</td>
      <td id="T_44371_row2_col2" class="data row2 col2" >2240</td>
      <td id="T_44371_row2_col3" class="data row2 col3" >2290</td>
      <td id="T_44371_row2_col4" class="data row2 col4" >519777</td>
      <td id="T_44371_row2_col5" class="data row2 col5" >0.000000</td>
      <td id="T_44371_row2_col6" class="data row2 col6" >060310</td>
      <td id="T_44371_row2_col7" class="data row2 col7" >3S</td>
      <td id="T_44371_row2_col8" class="data row2 col8" >1.007612</td>
      <td id="T_44371_row2_col9" class="data row2 col9" >1.000000</td>
      <td id="T_44371_row2_col10" class="data row2 col10" >0</td>
      <td id="T_44371_row2_col11" class="data row2 col11" >0.980349</td>
      <td id="T_44371_row2_col12" class="data row2 col12" >0.949782</td>
      <td id="T_44371_row2_col13" class="data row2 col13" >0.954148</td>
      <td id="T_44371_row2_col14" class="data row2 col14" >0.949782</td>
      <td id="T_44371_row2_col15" class="data row2 col15" >0.958515</td>
      <td id="T_44371_row2_col16" class="data row2 col16" >0.980349</td>
    </tr>
    <tr>
      <th id="T_44371_level0_row3" class="row_heading level0 row3" >2021-01-08</th>
      <td id="T_44371_row3_col0" class="data row3 col0" >2300</td>
      <td id="T_44371_row3_col1" class="data row3 col1" >2315</td>
      <td id="T_44371_row3_col2" class="data row3 col2" >2225</td>
      <td id="T_44371_row3_col3" class="data row3 col3" >2245</td>
      <td id="T_44371_row3_col4" class="data row3 col4" >462568</td>
      <td id="T_44371_row3_col5" class="data row3 col5" >-0.019651</td>
      <td id="T_44371_row3_col6" class="data row3 col6" >060310</td>
      <td id="T_44371_row3_col7" class="data row3 col7" >3S</td>
      <td id="T_44371_row3_col8" class="data row3 col8" >0.998918</td>
      <td id="T_44371_row3_col9" class="data row3 col9" >0.980349</td>
      <td id="T_44371_row3_col10" class="data row3 col10" >0</td>
      <td id="T_44371_row3_col11" class="data row3 col11" >0.968820</td>
      <td id="T_44371_row3_col12" class="data row3 col12" >0.973274</td>
      <td id="T_44371_row3_col13" class="data row3 col13" >0.968820</td>
      <td id="T_44371_row3_col14" class="data row3 col14" >0.977728</td>
      <td id="T_44371_row3_col15" class="data row3 col15" >0.973274</td>
      <td id="T_44371_row3_col16" class="data row3 col16" >0.977728</td>
    </tr>
    <tr>
      <th id="T_44371_level0_row4" class="row_heading level0 row4" >2021-01-11</th>
      <td id="T_44371_row4_col0" class="data row4 col0" >2230</td>
      <td id="T_44371_row4_col1" class="data row4 col1" >2275</td>
      <td id="T_44371_row4_col2" class="data row4 col2" >2130</td>
      <td id="T_44371_row4_col3" class="data row4 col3" >2175</td>
      <td id="T_44371_row4_col4" class="data row4 col4" >409057</td>
      <td id="T_44371_row4_col5" class="data row4 col5" >-0.031180</td>
      <td id="T_44371_row4_col6" class="data row4 col6" >060310</td>
      <td id="T_44371_row4_col7" class="data row4 col7" >3S</td>
      <td id="T_44371_row4_col8" class="data row4 col8" >0.988702</td>
      <td id="T_44371_row4_col9" class="data row4 col9" >0.968820</td>
      <td id="T_44371_row4_col10" class="data row4 col10" >0</td>
      <td id="T_44371_row4_col11" class="data row4 col11" >1.004598</td>
      <td id="T_44371_row4_col12" class="data row4 col12" >1.000000</td>
      <td id="T_44371_row4_col13" class="data row4 col13" >1.009195</td>
      <td id="T_44371_row4_col14" class="data row4 col14" >1.004598</td>
      <td id="T_44371_row4_col15" class="data row4 col15" >1.002299</td>
      <td id="T_44371_row4_col16" class="data row4 col16" >1.009195</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span>

<span class="n">data_h3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]:</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">mdl_data</span><span class="p">[</span><span class="n">mdl_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;positive_candle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 양봉</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;high/close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;positive_candle&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 양봉이면서 고가가 종가보다 높게 위치 10% 이상 높은 경우</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_high/close&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;high/close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
       
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 5 영업일 종가 수익율 중 최고 값</span>
    <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;num_high/close&#39;</span><span class="p">,</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># missing 이 있는 행은 제거  </span>
    
    <span class="n">data_h3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">data_h3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">data_h3</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;data_h3.pkl&#39;</span><span class="p">)</span>  
</pre></div>
</div>
</div>
</div>
<p><br> 윗 꼬리가 긴 양봉이 많이 발생할 수 록 수익율에 좋은 영향을 주는 것으로 분석이 되었습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_h3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;data_h3.pkl&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_h3</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;num_high/close&#39;</span><span class="p">)[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;count&#39;</span><span class="p">,</span><span class="s1">&#39;mean&#39;</span><span class="p">]))</span>
<span class="n">data_h3</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;num_high/close&#39;</span><span class="p">)[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">1.2</span><span class="p">))</span> <span class="c1"># 막대그래프로 표현</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                 count  mean
num_high/close              
0.000           355754 1.031
1.000            37734 1.043
2.000             5113 1.050
3.000              824 1.072
4.000              159 1.047
5.000               10 1.168
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;num_high/close&#39;&gt;
</pre></div>
</div>
<img alt="_images/5.1.3_Hypothesis_3_5_2.png" src="_images/5.1.3_Hypothesis_3_5_2.png" />
</div>
</div>
<p><br> 윗 꼬리가 긴 양봉도 궁금하지만, 장대양봉은 어떨지도 궁금합니다. 이렇게 가설을 검증하는 과정에서 새로운 가설을 테스트하기도 합니다. 장대양봉이 과거 60일 동안 몇 번 발생했는지 카운트해보고, 장대양봉의 갯 수와 수익율 사이에 상관성이 있는 지 함 보겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span>

<span class="n">data_h3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]:</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">mdl_data</span><span class="p">[</span><span class="n">mdl_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;positive_candle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 양봉</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;long_candle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;positive_candle&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span><span class="o">*</span>\
    <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 장대 양봉을 데이터로 표현</span>
    
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_long&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;long_candle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># 지난 20 일 동안 장대양봉의 갯 수</span>
       
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 5 영업일 종가 수익율 중 최고 값</span>
    <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;num_long&#39;</span><span class="p">,</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># missing 이 있는 행은 제거  </span>
    
    <span class="n">data_h3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">data_h3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">data_h3</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;data_h3.pkl&#39;</span><span class="p">)</span>  
</pre></div>
</div>
</div>
</div>
<p><br> 과거 60일 동안 장대양봉이 2 번 발생한 경우 좋은 수익율을 보여주고 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_h3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;data_h3.pkl&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_h3</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;num_long&#39;</span><span class="p">)[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;count&#39;</span><span class="p">,</span><span class="s1">&#39;mean&#39;</span><span class="p">]))</span>
<span class="n">data_h3</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;num_long&#39;</span><span class="p">)[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">1.1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>           count  mean
num_long              
0.000     337432 1.031
1.000       5394 1.047
2.000         88 1.056
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;num_long&#39;&gt;
</pre></div>
</div>
<img alt="_images/5.1.3_Hypothesis_3_9_2.png" src="_images/5.1.3_Hypothesis_3_9_2.png" />
</div>
</div>
</section>
<span id="document-chapter5/5.1.4_Hypothesis_4"></span><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<section id="id1">
<h3>거래량이 종종 터지며, 매집의 흔적을 보인다.<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>양봉이면서 거래량이 갑자기 증가하는 날을 카운트하고, 수익율과의 상관관계를 보겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mdl_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;mdl_data.pkl&#39;</span><span class="p">)</span>
<span class="n">mdl_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_e7eeb_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >open</th>
      <th class="col_heading level0 col1" >high</th>
      <th class="col_heading level0 col2" >low</th>
      <th class="col_heading level0 col3" >close</th>
      <th class="col_heading level0 col4" >volume</th>
      <th class="col_heading level0 col5" >change</th>
      <th class="col_heading level0 col6" >code</th>
      <th class="col_heading level0 col7" >name</th>
      <th class="col_heading level0 col8" >kosdaq_return</th>
      <th class="col_heading level0 col9" >return</th>
      <th class="col_heading level0 col10" >win_market</th>
      <th class="col_heading level0 col11" >close_r1</th>
      <th class="col_heading level0 col12" >close_r2</th>
      <th class="col_heading level0 col13" >close_r3</th>
      <th class="col_heading level0 col14" >close_r4</th>
      <th class="col_heading level0 col15" >close_r5</th>
      <th class="col_heading level0 col16" >max_close</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_e7eeb_level0_row0" class="row_heading level0 row0" >2021-01-05</th>
      <td id="T_e7eeb_row0_col0" class="data row0 col0" >2270</td>
      <td id="T_e7eeb_row0_col1" class="data row0 col1" >2285</td>
      <td id="T_e7eeb_row0_col2" class="data row0 col2" >2200</td>
      <td id="T_e7eeb_row0_col3" class="data row0 col3" >2250</td>
      <td id="T_e7eeb_row0_col4" class="data row0 col4" >410263</td>
      <td id="T_e7eeb_row0_col5" class="data row0 col5" >-0.004425</td>
      <td id="T_e7eeb_row0_col6" class="data row0 col6" >060310</td>
      <td id="T_e7eeb_row0_col7" class="data row0 col7" >3S</td>
      <td id="T_e7eeb_row0_col8" class="data row0 col8" >1.008326</td>
      <td id="T_e7eeb_row0_col9" class="data row0 col9" >0.995575</td>
      <td id="T_e7eeb_row0_col10" class="data row0 col10" >0</td>
      <td id="T_e7eeb_row0_col11" class="data row0 col11" >1.017778</td>
      <td id="T_e7eeb_row0_col12" class="data row0 col12" >1.017778</td>
      <td id="T_e7eeb_row0_col13" class="data row0 col13" >0.997778</td>
      <td id="T_e7eeb_row0_col14" class="data row0 col14" >0.966667</td>
      <td id="T_e7eeb_row0_col15" class="data row0 col15" >0.971111</td>
      <td id="T_e7eeb_row0_col16" class="data row0 col16" >1.017778</td>
    </tr>
    <tr>
      <th id="T_e7eeb_level0_row1" class="row_heading level0 row1" >2021-01-06</th>
      <td id="T_e7eeb_row1_col0" class="data row1 col0" >2225</td>
      <td id="T_e7eeb_row1_col1" class="data row1 col1" >2310</td>
      <td id="T_e7eeb_row1_col2" class="data row1 col2" >2215</td>
      <td id="T_e7eeb_row1_col3" class="data row1 col3" >2290</td>
      <td id="T_e7eeb_row1_col4" class="data row1 col4" >570349</td>
      <td id="T_e7eeb_row1_col5" class="data row1 col5" >0.017778</td>
      <td id="T_e7eeb_row1_col6" class="data row1 col6" >060310</td>
      <td id="T_e7eeb_row1_col7" class="data row1 col7" >3S</td>
      <td id="T_e7eeb_row1_col8" class="data row1 col8" >0.995567</td>
      <td id="T_e7eeb_row1_col9" class="data row1 col9" >1.017778</td>
      <td id="T_e7eeb_row1_col10" class="data row1 col10" >1</td>
      <td id="T_e7eeb_row1_col11" class="data row1 col11" >1.000000</td>
      <td id="T_e7eeb_row1_col12" class="data row1 col12" >0.980349</td>
      <td id="T_e7eeb_row1_col13" class="data row1 col13" >0.949782</td>
      <td id="T_e7eeb_row1_col14" class="data row1 col14" >0.954148</td>
      <td id="T_e7eeb_row1_col15" class="data row1 col15" >0.949782</td>
      <td id="T_e7eeb_row1_col16" class="data row1 col16" >1.000000</td>
    </tr>
    <tr>
      <th id="T_e7eeb_level0_row2" class="row_heading level0 row2" >2021-01-07</th>
      <td id="T_e7eeb_row2_col0" class="data row2 col0" >2290</td>
      <td id="T_e7eeb_row2_col1" class="data row2 col1" >2340</td>
      <td id="T_e7eeb_row2_col2" class="data row2 col2" >2240</td>
      <td id="T_e7eeb_row2_col3" class="data row2 col3" >2290</td>
      <td id="T_e7eeb_row2_col4" class="data row2 col4" >519777</td>
      <td id="T_e7eeb_row2_col5" class="data row2 col5" >0.000000</td>
      <td id="T_e7eeb_row2_col6" class="data row2 col6" >060310</td>
      <td id="T_e7eeb_row2_col7" class="data row2 col7" >3S</td>
      <td id="T_e7eeb_row2_col8" class="data row2 col8" >1.007612</td>
      <td id="T_e7eeb_row2_col9" class="data row2 col9" >1.000000</td>
      <td id="T_e7eeb_row2_col10" class="data row2 col10" >0</td>
      <td id="T_e7eeb_row2_col11" class="data row2 col11" >0.980349</td>
      <td id="T_e7eeb_row2_col12" class="data row2 col12" >0.949782</td>
      <td id="T_e7eeb_row2_col13" class="data row2 col13" >0.954148</td>
      <td id="T_e7eeb_row2_col14" class="data row2 col14" >0.949782</td>
      <td id="T_e7eeb_row2_col15" class="data row2 col15" >0.958515</td>
      <td id="T_e7eeb_row2_col16" class="data row2 col16" >0.980349</td>
    </tr>
    <tr>
      <th id="T_e7eeb_level0_row3" class="row_heading level0 row3" >2021-01-08</th>
      <td id="T_e7eeb_row3_col0" class="data row3 col0" >2300</td>
      <td id="T_e7eeb_row3_col1" class="data row3 col1" >2315</td>
      <td id="T_e7eeb_row3_col2" class="data row3 col2" >2225</td>
      <td id="T_e7eeb_row3_col3" class="data row3 col3" >2245</td>
      <td id="T_e7eeb_row3_col4" class="data row3 col4" >462568</td>
      <td id="T_e7eeb_row3_col5" class="data row3 col5" >-0.019651</td>
      <td id="T_e7eeb_row3_col6" class="data row3 col6" >060310</td>
      <td id="T_e7eeb_row3_col7" class="data row3 col7" >3S</td>
      <td id="T_e7eeb_row3_col8" class="data row3 col8" >0.998918</td>
      <td id="T_e7eeb_row3_col9" class="data row3 col9" >0.980349</td>
      <td id="T_e7eeb_row3_col10" class="data row3 col10" >0</td>
      <td id="T_e7eeb_row3_col11" class="data row3 col11" >0.968820</td>
      <td id="T_e7eeb_row3_col12" class="data row3 col12" >0.973274</td>
      <td id="T_e7eeb_row3_col13" class="data row3 col13" >0.968820</td>
      <td id="T_e7eeb_row3_col14" class="data row3 col14" >0.977728</td>
      <td id="T_e7eeb_row3_col15" class="data row3 col15" >0.973274</td>
      <td id="T_e7eeb_row3_col16" class="data row3 col16" >0.977728</td>
    </tr>
    <tr>
      <th id="T_e7eeb_level0_row4" class="row_heading level0 row4" >2021-01-11</th>
      <td id="T_e7eeb_row4_col0" class="data row4 col0" >2230</td>
      <td id="T_e7eeb_row4_col1" class="data row4 col1" >2275</td>
      <td id="T_e7eeb_row4_col2" class="data row4 col2" >2130</td>
      <td id="T_e7eeb_row4_col3" class="data row4 col3" >2175</td>
      <td id="T_e7eeb_row4_col4" class="data row4 col4" >409057</td>
      <td id="T_e7eeb_row4_col5" class="data row4 col5" >-0.031180</td>
      <td id="T_e7eeb_row4_col6" class="data row4 col6" >060310</td>
      <td id="T_e7eeb_row4_col7" class="data row4 col7" >3S</td>
      <td id="T_e7eeb_row4_col8" class="data row4 col8" >0.988702</td>
      <td id="T_e7eeb_row4_col9" class="data row4 col9" >0.968820</td>
      <td id="T_e7eeb_row4_col10" class="data row4 col10" >0</td>
      <td id="T_e7eeb_row4_col11" class="data row4 col11" >1.004598</td>
      <td id="T_e7eeb_row4_col12" class="data row4 col12" >1.000000</td>
      <td id="T_e7eeb_row4_col13" class="data row4 col13" >1.009195</td>
      <td id="T_e7eeb_row4_col14" class="data row4 col14" >1.004598</td>
      <td id="T_e7eeb_row4_col15" class="data row4 col15" >1.002299</td>
      <td id="T_e7eeb_row4_col16" class="data row4 col16" >1.009195</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span>

<span class="n">data_h4</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]:</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">mdl_data</span><span class="p">[</span><span class="n">mdl_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 60일 이동평균값</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="c1"># 60일 이동평균값</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span> <span class="c1"># 거래량은 종목과 주가에 따라 다르기 떄문에 표준화한 값이 필요함</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;z&gt;1.96&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_z&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.65</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 양봉이면서 거래량이 90%신뢰구간을 벗어난 날</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_z&gt;1.96&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;z&gt;1.96&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># 양봉이면서 거래량이 90% 신뢰구간을 벗어난 날을 카운트</span>
       
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 5 영업일 종가 수익율 중 최고 값</span>
    <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">,</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># missing 이 있는 행은 제거  </span>
    
    <span class="n">data_h4</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">data_h4</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">data_h4</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;data_h4.pkl&#39;</span><span class="p">)</span>  
</pre></div>
</div>
</div>
</div>
<p><br> 거래량이 갑자기 많아지고 양봉인 날을 카운트하고 그 갯 수에 따라 수익율의 변화를 봤습니다. 전체적으로 거래량이 갑자기 증가하는 날이 많을 수 록 수익율이 증가하는 패턴을 보여줍니다. 결과의 마지막 num_z 가 15일인 경우는 수익율이 급강하했는데요. 실제로 너무 많으면 수익율이 안 좋은 것인지 여부는 해당 레코드 수(47개)가 많지 않아 신뢰하기 어렵습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_h4</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;data_h4.pkl&#39;</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="n">data_h4</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;num_z&gt;1.96&#39;</span><span class="p">)[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;count&#39;</span><span class="p">,</span><span class="s1">&#39;mean&#39;</span><span class="p">]))</span>
<span class="n">data_h4</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;num_z&gt;1.96&#39;</span><span class="p">)[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>             count  mean
num_z&gt;1.96              
0.000       105320 1.027
1.000        78911 1.031
2.000        57860 1.032
3.000        39476 1.035
4.000        25244 1.035
5.000        15428 1.038
6.000         9250 1.040
7.000         4841 1.045
8.000         3210 1.048
9.000         1505 1.044
10.000         904 1.046
11.000         450 1.047
12.000         318 1.035
13.000          56 1.046
14.000          94 1.048
15.000          47 1.002
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;num_z&gt;1.96&#39;&gt;
</pre></div>
</div>
<img alt="_images/5.1.4_Hypothesis_4_5_2.png" src="_images/5.1.4_Hypothesis_4_5_2.png" />
</div>
</div>
</section>
<span id="document-chapter5/5.1.5_Hypothesis_5"></span><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<section id="id1">
<h3>주가지수보다 더 좋은 수익율을 자주 보여준다.<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mdl_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;mdl_data.pkl&#39;</span><span class="p">)</span>
<span class="n">mdl_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_1f881_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >open</th>
      <th class="col_heading level0 col1" >high</th>
      <th class="col_heading level0 col2" >low</th>
      <th class="col_heading level0 col3" >close</th>
      <th class="col_heading level0 col4" >volume</th>
      <th class="col_heading level0 col5" >change</th>
      <th class="col_heading level0 col6" >code</th>
      <th class="col_heading level0 col7" >name</th>
      <th class="col_heading level0 col8" >kosdaq_return</th>
      <th class="col_heading level0 col9" >return</th>
      <th class="col_heading level0 col10" >win_market</th>
      <th class="col_heading level0 col11" >close_r1</th>
      <th class="col_heading level0 col12" >close_r2</th>
      <th class="col_heading level0 col13" >close_r3</th>
      <th class="col_heading level0 col14" >close_r4</th>
      <th class="col_heading level0 col15" >close_r5</th>
      <th class="col_heading level0 col16" >max_close</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_1f881_level0_row0" class="row_heading level0 row0" >2021-01-05</th>
      <td id="T_1f881_row0_col0" class="data row0 col0" >2270</td>
      <td id="T_1f881_row0_col1" class="data row0 col1" >2285</td>
      <td id="T_1f881_row0_col2" class="data row0 col2" >2200</td>
      <td id="T_1f881_row0_col3" class="data row0 col3" >2250</td>
      <td id="T_1f881_row0_col4" class="data row0 col4" >410263</td>
      <td id="T_1f881_row0_col5" class="data row0 col5" >-0.004</td>
      <td id="T_1f881_row0_col6" class="data row0 col6" >060310</td>
      <td id="T_1f881_row0_col7" class="data row0 col7" >3S</td>
      <td id="T_1f881_row0_col8" class="data row0 col8" >1.008</td>
      <td id="T_1f881_row0_col9" class="data row0 col9" >0.996</td>
      <td id="T_1f881_row0_col10" class="data row0 col10" >0</td>
      <td id="T_1f881_row0_col11" class="data row0 col11" >1.018</td>
      <td id="T_1f881_row0_col12" class="data row0 col12" >1.018</td>
      <td id="T_1f881_row0_col13" class="data row0 col13" >0.998</td>
      <td id="T_1f881_row0_col14" class="data row0 col14" >0.967</td>
      <td id="T_1f881_row0_col15" class="data row0 col15" >0.971</td>
      <td id="T_1f881_row0_col16" class="data row0 col16" >1.018</td>
    </tr>
    <tr>
      <th id="T_1f881_level0_row1" class="row_heading level0 row1" >2021-01-06</th>
      <td id="T_1f881_row1_col0" class="data row1 col0" >2225</td>
      <td id="T_1f881_row1_col1" class="data row1 col1" >2310</td>
      <td id="T_1f881_row1_col2" class="data row1 col2" >2215</td>
      <td id="T_1f881_row1_col3" class="data row1 col3" >2290</td>
      <td id="T_1f881_row1_col4" class="data row1 col4" >570349</td>
      <td id="T_1f881_row1_col5" class="data row1 col5" >0.018</td>
      <td id="T_1f881_row1_col6" class="data row1 col6" >060310</td>
      <td id="T_1f881_row1_col7" class="data row1 col7" >3S</td>
      <td id="T_1f881_row1_col8" class="data row1 col8" >0.996</td>
      <td id="T_1f881_row1_col9" class="data row1 col9" >1.018</td>
      <td id="T_1f881_row1_col10" class="data row1 col10" >1</td>
      <td id="T_1f881_row1_col11" class="data row1 col11" >1.000</td>
      <td id="T_1f881_row1_col12" class="data row1 col12" >0.980</td>
      <td id="T_1f881_row1_col13" class="data row1 col13" >0.950</td>
      <td id="T_1f881_row1_col14" class="data row1 col14" >0.954</td>
      <td id="T_1f881_row1_col15" class="data row1 col15" >0.950</td>
      <td id="T_1f881_row1_col16" class="data row1 col16" >1.000</td>
    </tr>
    <tr>
      <th id="T_1f881_level0_row2" class="row_heading level0 row2" >2021-01-07</th>
      <td id="T_1f881_row2_col0" class="data row2 col0" >2290</td>
      <td id="T_1f881_row2_col1" class="data row2 col1" >2340</td>
      <td id="T_1f881_row2_col2" class="data row2 col2" >2240</td>
      <td id="T_1f881_row2_col3" class="data row2 col3" >2290</td>
      <td id="T_1f881_row2_col4" class="data row2 col4" >519777</td>
      <td id="T_1f881_row2_col5" class="data row2 col5" >0.000</td>
      <td id="T_1f881_row2_col6" class="data row2 col6" >060310</td>
      <td id="T_1f881_row2_col7" class="data row2 col7" >3S</td>
      <td id="T_1f881_row2_col8" class="data row2 col8" >1.008</td>
      <td id="T_1f881_row2_col9" class="data row2 col9" >1.000</td>
      <td id="T_1f881_row2_col10" class="data row2 col10" >0</td>
      <td id="T_1f881_row2_col11" class="data row2 col11" >0.980</td>
      <td id="T_1f881_row2_col12" class="data row2 col12" >0.950</td>
      <td id="T_1f881_row2_col13" class="data row2 col13" >0.954</td>
      <td id="T_1f881_row2_col14" class="data row2 col14" >0.950</td>
      <td id="T_1f881_row2_col15" class="data row2 col15" >0.959</td>
      <td id="T_1f881_row2_col16" class="data row2 col16" >0.980</td>
    </tr>
    <tr>
      <th id="T_1f881_level0_row3" class="row_heading level0 row3" >2021-01-08</th>
      <td id="T_1f881_row3_col0" class="data row3 col0" >2300</td>
      <td id="T_1f881_row3_col1" class="data row3 col1" >2315</td>
      <td id="T_1f881_row3_col2" class="data row3 col2" >2225</td>
      <td id="T_1f881_row3_col3" class="data row3 col3" >2245</td>
      <td id="T_1f881_row3_col4" class="data row3 col4" >462568</td>
      <td id="T_1f881_row3_col5" class="data row3 col5" >-0.020</td>
      <td id="T_1f881_row3_col6" class="data row3 col6" >060310</td>
      <td id="T_1f881_row3_col7" class="data row3 col7" >3S</td>
      <td id="T_1f881_row3_col8" class="data row3 col8" >0.999</td>
      <td id="T_1f881_row3_col9" class="data row3 col9" >0.980</td>
      <td id="T_1f881_row3_col10" class="data row3 col10" >0</td>
      <td id="T_1f881_row3_col11" class="data row3 col11" >0.969</td>
      <td id="T_1f881_row3_col12" class="data row3 col12" >0.973</td>
      <td id="T_1f881_row3_col13" class="data row3 col13" >0.969</td>
      <td id="T_1f881_row3_col14" class="data row3 col14" >0.978</td>
      <td id="T_1f881_row3_col15" class="data row3 col15" >0.973</td>
      <td id="T_1f881_row3_col16" class="data row3 col16" >0.978</td>
    </tr>
    <tr>
      <th id="T_1f881_level0_row4" class="row_heading level0 row4" >2021-01-11</th>
      <td id="T_1f881_row4_col0" class="data row4 col0" >2230</td>
      <td id="T_1f881_row4_col1" class="data row4 col1" >2275</td>
      <td id="T_1f881_row4_col2" class="data row4 col2" >2130</td>
      <td id="T_1f881_row4_col3" class="data row4 col3" >2175</td>
      <td id="T_1f881_row4_col4" class="data row4 col4" >409057</td>
      <td id="T_1f881_row4_col5" class="data row4 col5" >-0.031</td>
      <td id="T_1f881_row4_col6" class="data row4 col6" >060310</td>
      <td id="T_1f881_row4_col7" class="data row4 col7" >3S</td>
      <td id="T_1f881_row4_col8" class="data row4 col8" >0.989</td>
      <td id="T_1f881_row4_col9" class="data row4 col9" >0.969</td>
      <td id="T_1f881_row4_col10" class="data row4 col10" >0</td>
      <td id="T_1f881_row4_col11" class="data row4 col11" >1.005</td>
      <td id="T_1f881_row4_col12" class="data row4 col12" >1.000</td>
      <td id="T_1f881_row4_col13" class="data row4 col13" >1.009</td>
      <td id="T_1f881_row4_col14" class="data row4 col14" >1.005</td>
      <td id="T_1f881_row4_col15" class="data row4 col15" >1.002</td>
      <td id="T_1f881_row4_col16" class="data row4 col16" >1.009</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> 이전 장에서 일봉 데이터에 KOSDAQ 주가지수 데이터를 추가한 후, 주가지수 수익율이 1 보다 작은 날, 종목 수익율이 1 보다 크면 win_market 이라는 변수에 1 을 담아 두도록 했습니다. win_market 의 과거 60일 동안 합계와 미래 수익율과의 관계를 보겠습니다. 별도로 주가지수 수익률 대비 종목 수익율의 비율을 새로운 변수로 만들어, 미래 수익율과의 상관관계도 볼 수 있도록 하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span>

<span class="n">data_h5</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]:</span>
    
    <span class="c1"># 종목별 처리</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">mdl_data</span><span class="p">[</span><span class="n">mdl_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># 과거 60일 win_market 누적 합</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_win_market&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;win_market&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># 주가지수 수익율이 1 보다 작을 때, 종목 수익율이 1 보다 큰 날 수</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pct_win_market&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 주가지수 수익율 대비 종목 수익율</span>
        
    
    <span class="c1"># 고가, 저가, 종가 수익율</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]:</span>

        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;high_r&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>      
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;low_r&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>   
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close_r&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span>    
        
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 5 영업일 종가 수익율 중 최고 값</span>
    <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;num_win_market&#39;</span><span class="p">,</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># missing 이 있는 행은 제거   </span>
 
    <span class="n">data_h5</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">data_h5</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">data_h5</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;data_h5.pkl&#39;</span><span class="p">)</span>    
<span class="n">data_h5</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>   
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_8ac11_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >open</th>
      <th class="col_heading level0 col1" >high</th>
      <th class="col_heading level0 col2" >low</th>
      <th class="col_heading level0 col3" >close</th>
      <th class="col_heading level0 col4" >volume</th>
      <th class="col_heading level0 col5" >change</th>
      <th class="col_heading level0 col6" >code</th>
      <th class="col_heading level0 col7" >name</th>
      <th class="col_heading level0 col8" >kosdaq_return</th>
      <th class="col_heading level0 col9" >return</th>
      <th class="col_heading level0 col10" >win_market</th>
      <th class="col_heading level0 col11" >close_r1</th>
      <th class="col_heading level0 col12" >close_r2</th>
      <th class="col_heading level0 col13" >close_r3</th>
      <th class="col_heading level0 col14" >close_r4</th>
      <th class="col_heading level0 col15" >close_r5</th>
      <th class="col_heading level0 col16" >max_close</th>
      <th class="col_heading level0 col17" >num_win_market</th>
      <th class="col_heading level0 col18" >pct_win_market</th>
      <th class="col_heading level0 col19" >high_r1</th>
      <th class="col_heading level0 col20" >low_r1</th>
      <th class="col_heading level0 col21" >high_r2</th>
      <th class="col_heading level0 col22" >low_r2</th>
      <th class="col_heading level0 col23" >high_r3</th>
      <th class="col_heading level0 col24" >low_r3</th>
      <th class="col_heading level0 col25" >high_r4</th>
      <th class="col_heading level0 col26" >low_r4</th>
      <th class="col_heading level0 col27" >high_r5</th>
      <th class="col_heading level0 col28" >low_r5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_8ac11_level0_row0" class="row_heading level0 row0" >2021-04-01</th>
      <td id="T_8ac11_row0_col0" class="data row0 col0" >13100</td>
      <td id="T_8ac11_row0_col1" class="data row0 col1" >13650</td>
      <td id="T_8ac11_row0_col2" class="data row0 col2" >13100</td>
      <td id="T_8ac11_row0_col3" class="data row0 col3" >13400</td>
      <td id="T_8ac11_row0_col4" class="data row0 col4" >194185</td>
      <td id="T_8ac11_row0_col5" class="data row0 col5" >0.023</td>
      <td id="T_8ac11_row0_col6" class="data row0 col6" >238490</td>
      <td id="T_8ac11_row0_col7" class="data row0 col7" >힘스</td>
      <td id="T_8ac11_row0_col8" class="data row0 col8" >1.010</td>
      <td id="T_8ac11_row0_col9" class="data row0 col9" >1.023</td>
      <td id="T_8ac11_row0_col10" class="data row0 col10" >0</td>
      <td id="T_8ac11_row0_col11" class="data row0 col11" >1.007</td>
      <td id="T_8ac11_row0_col12" class="data row0 col12" >1.022</td>
      <td id="T_8ac11_row0_col13" class="data row0 col13" >1.019</td>
      <td id="T_8ac11_row0_col14" class="data row0 col14" >1.041</td>
      <td id="T_8ac11_row0_col15" class="data row0 col15" >1.026</td>
      <td id="T_8ac11_row0_col16" class="data row0 col16" >1.041</td>
      <td id="T_8ac11_row0_col17" class="data row0 col17" >9.000</td>
      <td id="T_8ac11_row0_col18" class="data row0 col18" >1.001</td>
      <td id="T_8ac11_row0_col19" class="data row0 col19" >1.019</td>
      <td id="T_8ac11_row0_col20" class="data row0 col20" >0.993</td>
      <td id="T_8ac11_row0_col21" class="data row0 col21" >1.030</td>
      <td id="T_8ac11_row0_col22" class="data row0 col22" >1.000</td>
      <td id="T_8ac11_row0_col23" class="data row0 col23" >1.037</td>
      <td id="T_8ac11_row0_col24" class="data row0 col24" >1.007</td>
      <td id="T_8ac11_row0_col25" class="data row0 col25" >1.041</td>
      <td id="T_8ac11_row0_col26" class="data row0 col26" >1.007</td>
      <td id="T_8ac11_row0_col27" class="data row0 col27" >1.049</td>
      <td id="T_8ac11_row0_col28" class="data row0 col28" >1.026</td>
    </tr>
    <tr>
      <th id="T_8ac11_level0_row1" class="row_heading level0 row1" >2021-04-02</th>
      <td id="T_8ac11_row1_col0" class="data row1 col0" >13500</td>
      <td id="T_8ac11_row1_col1" class="data row1 col1" >13650</td>
      <td id="T_8ac11_row1_col2" class="data row1 col2" >13300</td>
      <td id="T_8ac11_row1_col3" class="data row1 col3" >13500</td>
      <td id="T_8ac11_row1_col4" class="data row1 col4" >136673</td>
      <td id="T_8ac11_row1_col5" class="data row1 col5" >0.007</td>
      <td id="T_8ac11_row1_col6" class="data row1 col6" >238490</td>
      <td id="T_8ac11_row1_col7" class="data row1 col7" >힘스</td>
      <td id="T_8ac11_row1_col8" class="data row1 col8" >1.004</td>
      <td id="T_8ac11_row1_col9" class="data row1 col9" >1.007</td>
      <td id="T_8ac11_row1_col10" class="data row1 col10" >0</td>
      <td id="T_8ac11_row1_col11" class="data row1 col11" >1.015</td>
      <td id="T_8ac11_row1_col12" class="data row1 col12" >1.011</td>
      <td id="T_8ac11_row1_col13" class="data row1 col13" >1.033</td>
      <td id="T_8ac11_row1_col14" class="data row1 col14" >1.019</td>
      <td id="T_8ac11_row1_col15" class="data row1 col15" >1.022</td>
      <td id="T_8ac11_row1_col16" class="data row1 col16" >1.033</td>
      <td id="T_8ac11_row1_col17" class="data row1 col17" >9.000</td>
      <td id="T_8ac11_row1_col18" class="data row1 col18" >1.001</td>
      <td id="T_8ac11_row1_col19" class="data row1 col19" >1.022</td>
      <td id="T_8ac11_row1_col20" class="data row1 col20" >0.993</td>
      <td id="T_8ac11_row1_col21" class="data row1 col21" >1.030</td>
      <td id="T_8ac11_row1_col22" class="data row1 col22" >1.000</td>
      <td id="T_8ac11_row1_col23" class="data row1 col23" >1.033</td>
      <td id="T_8ac11_row1_col24" class="data row1 col24" >1.000</td>
      <td id="T_8ac11_row1_col25" class="data row1 col25" >1.041</td>
      <td id="T_8ac11_row1_col26" class="data row1 col26" >1.019</td>
      <td id="T_8ac11_row1_col27" class="data row1 col27" >1.030</td>
      <td id="T_8ac11_row1_col28" class="data row1 col28" >1.015</td>
    </tr>
    <tr>
      <th id="T_8ac11_level0_row2" class="row_heading level0 row2" >2021-04-05</th>
      <td id="T_8ac11_row2_col0" class="data row2 col0" >13600</td>
      <td id="T_8ac11_row2_col1" class="data row2 col1" >13800</td>
      <td id="T_8ac11_row2_col2" class="data row2 col2" >13400</td>
      <td id="T_8ac11_row2_col3" class="data row2 col3" >13700</td>
      <td id="T_8ac11_row2_col4" class="data row2 col4" >219062</td>
      <td id="T_8ac11_row2_col5" class="data row2 col5" >0.015</td>
      <td id="T_8ac11_row2_col6" class="data row2 col6" >238490</td>
      <td id="T_8ac11_row2_col7" class="data row2 col7" >힘스</td>
      <td id="T_8ac11_row2_col8" class="data row2 col8" >1.000</td>
      <td id="T_8ac11_row2_col9" class="data row2 col9" >1.015</td>
      <td id="T_8ac11_row2_col10" class="data row2 col10" >1</td>
      <td id="T_8ac11_row2_col11" class="data row2 col11" >0.996</td>
      <td id="T_8ac11_row2_col12" class="data row2 col12" >1.018</td>
      <td id="T_8ac11_row2_col13" class="data row2 col13" >1.004</td>
      <td id="T_8ac11_row2_col14" class="data row2 col14" >1.007</td>
      <td id="T_8ac11_row2_col15" class="data row2 col15" >0.993</td>
      <td id="T_8ac11_row2_col16" class="data row2 col16" >1.018</td>
      <td id="T_8ac11_row2_col17" class="data row2 col17" >9.000</td>
      <td id="T_8ac11_row2_col18" class="data row2 col18" >1.001</td>
      <td id="T_8ac11_row2_col19" class="data row2 col19" >1.015</td>
      <td id="T_8ac11_row2_col20" class="data row2 col20" >0.985</td>
      <td id="T_8ac11_row2_col21" class="data row2 col21" >1.018</td>
      <td id="T_8ac11_row2_col22" class="data row2 col22" >0.985</td>
      <td id="T_8ac11_row2_col23" class="data row2 col23" >1.026</td>
      <td id="T_8ac11_row2_col24" class="data row2 col24" >1.004</td>
      <td id="T_8ac11_row2_col25" class="data row2 col25" >1.015</td>
      <td id="T_8ac11_row2_col26" class="data row2 col26" >1.000</td>
      <td id="T_8ac11_row2_col27" class="data row2 col27" >1.011</td>
      <td id="T_8ac11_row2_col28" class="data row2 col28" >0.989</td>
    </tr>
    <tr>
      <th id="T_8ac11_level0_row3" class="row_heading level0 row3" >2021-04-06</th>
      <td id="T_8ac11_row3_col0" class="data row3 col0" >13800</td>
      <td id="T_8ac11_row3_col1" class="data row3 col1" >13900</td>
      <td id="T_8ac11_row3_col2" class="data row3 col2" >13500</td>
      <td id="T_8ac11_row3_col3" class="data row3 col3" >13650</td>
      <td id="T_8ac11_row3_col4" class="data row3 col4" >135914</td>
      <td id="T_8ac11_row3_col5" class="data row3 col5" >-0.004</td>
      <td id="T_8ac11_row3_col6" class="data row3 col6" >238490</td>
      <td id="T_8ac11_row3_col7" class="data row3 col7" >힘스</td>
      <td id="T_8ac11_row3_col8" class="data row3 col8" >0.999</td>
      <td id="T_8ac11_row3_col9" class="data row3 col9" >0.996</td>
      <td id="T_8ac11_row3_col10" class="data row3 col10" >0</td>
      <td id="T_8ac11_row3_col11" class="data row3 col11" >1.022</td>
      <td id="T_8ac11_row3_col12" class="data row3 col12" >1.007</td>
      <td id="T_8ac11_row3_col13" class="data row3 col13" >1.011</td>
      <td id="T_8ac11_row3_col14" class="data row3 col14" >0.996</td>
      <td id="T_8ac11_row3_col15" class="data row3 col15" >1.004</td>
      <td id="T_8ac11_row3_col16" class="data row3 col16" >1.022</td>
      <td id="T_8ac11_row3_col17" class="data row3 col17" >9.000</td>
      <td id="T_8ac11_row3_col18" class="data row3 col18" >1.001</td>
      <td id="T_8ac11_row3_col19" class="data row3 col19" >1.022</td>
      <td id="T_8ac11_row3_col20" class="data row3 col20" >0.989</td>
      <td id="T_8ac11_row3_col21" class="data row3 col21" >1.029</td>
      <td id="T_8ac11_row3_col22" class="data row3 col22" >1.007</td>
      <td id="T_8ac11_row3_col23" class="data row3 col23" >1.018</td>
      <td id="T_8ac11_row3_col24" class="data row3 col24" >1.004</td>
      <td id="T_8ac11_row3_col25" class="data row3 col25" >1.015</td>
      <td id="T_8ac11_row3_col26" class="data row3 col26" >0.993</td>
      <td id="T_8ac11_row3_col27" class="data row3 col27" >1.007</td>
      <td id="T_8ac11_row3_col28" class="data row3 col28" >0.996</td>
    </tr>
    <tr>
      <th id="T_8ac11_level0_row4" class="row_heading level0 row4" >2021-04-07</th>
      <td id="T_8ac11_row4_col0" class="data row4 col0" >13700</td>
      <td id="T_8ac11_row4_col1" class="data row4 col1" >13950</td>
      <td id="T_8ac11_row4_col2" class="data row4 col2" >13500</td>
      <td id="T_8ac11_row4_col3" class="data row4 col3" >13950</td>
      <td id="T_8ac11_row4_col4" class="data row4 col4" >195408</td>
      <td id="T_8ac11_row4_col5" class="data row4 col5" >0.022</td>
      <td id="T_8ac11_row4_col6" class="data row4 col6" >238490</td>
      <td id="T_8ac11_row4_col7" class="data row4 col7" >힘스</td>
      <td id="T_8ac11_row4_col8" class="data row4 col8" >1.005</td>
      <td id="T_8ac11_row4_col9" class="data row4 col9" >1.022</td>
      <td id="T_8ac11_row4_col10" class="data row4 col10" >0</td>
      <td id="T_8ac11_row4_col11" class="data row4 col11" >0.986</td>
      <td id="T_8ac11_row4_col12" class="data row4 col12" >0.989</td>
      <td id="T_8ac11_row4_col13" class="data row4 col13" >0.975</td>
      <td id="T_8ac11_row4_col14" class="data row4 col14" >0.982</td>
      <td id="T_8ac11_row4_col15" class="data row4 col15" >1.018</td>
      <td id="T_8ac11_row4_col16" class="data row4 col16" >1.018</td>
      <td id="T_8ac11_row4_col17" class="data row4 col17" >9.000</td>
      <td id="T_8ac11_row4_col18" class="data row4 col18" >1.002</td>
      <td id="T_8ac11_row4_col19" class="data row4 col19" >1.007</td>
      <td id="T_8ac11_row4_col20" class="data row4 col20" >0.986</td>
      <td id="T_8ac11_row4_col21" class="data row4 col21" >0.996</td>
      <td id="T_8ac11_row4_col22" class="data row4 col22" >0.982</td>
      <td id="T_8ac11_row4_col23" class="data row4 col23" >0.993</td>
      <td id="T_8ac11_row4_col24" class="data row4 col24" >0.971</td>
      <td id="T_8ac11_row4_col25" class="data row4 col25" >0.986</td>
      <td id="T_8ac11_row4_col26" class="data row4 col26" >0.975</td>
      <td id="T_8ac11_row4_col27" class="data row4 col27" >1.022</td>
      <td id="T_8ac11_row4_col28" class="data row4 col28" >0.971</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> 예상한 바와 같이 주가지수가 빠질 때, 수익율이 좋았던 종목들은 미래 수익율이 좋게 나타났습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_h5</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;data_h5.pkl&#39;</span><span class="p">)</span>    
<span class="n">ranks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">data_h5</span><span class="p">[</span><span class="s1">&#39;num_win_market&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_h5</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ranks</span><span class="p">)[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">data_h5</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ranks</span><span class="p">)[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>num_win_market
(-0.001, 4.0]   1.022
(4.0, 5.0]      1.031
(5.0, 6.0]      1.031
(6.0, 7.0]      1.032
(7.0, 8.0]      1.032
(8.0, 9.0]      1.034
(9.0, 11.0]     1.036
(11.0, 22.0]    1.040
Name: max_close, dtype: float64
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;num_win_market&#39;&gt;
</pre></div>
</div>
<img alt="_images/5.1.5_Hypothesis_5_6_2.png" src="_images/5.1.5_Hypothesis_5_6_2.png" />
</div>
</div>
<p><br> 주가지수 수익율 대비 종목수익율의 경우는 아주 크거나 작을 때 수익율이 좋게 나타났습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ranks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">data_h5</span><span class="p">[</span><span class="s1">&#39;pct_win_market&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_h5</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ranks</span><span class="p">)[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">data_h5</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ranks</span><span class="p">)[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>pct_win_market
(0.9747, 0.9964]   1.039
(0.9964, 0.9976]   1.029
(0.9976, 0.9985]   1.026
(0.9985, 0.9992]   1.024
(0.9992, 1.0]      1.025
(1.0, 1.0007]      1.026
(1.0007, 1.0016]   1.028
(1.0016, 1.0029]   1.031
(1.0029, 1.0052]   1.038
(1.0052, 1.0432]   1.049
Name: max_close, dtype: float64
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;pct_win_market&#39;&gt;
</pre></div>
</div>
<img alt="_images/5.1.5_Hypothesis_5_8_2.png" src="_images/5.1.5_Hypothesis_5_8_2.png" />
</div>
</div>
</section>
<span id="document-chapter5/5.1.6_Hypothesis_6"></span><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<section id="id1">
<h3>동종업계 평균 수익률보다 더 좋은 수익률을 보여준다.<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mdl_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;mdl_data.pkl&#39;</span><span class="p">)</span>
<span class="n">mdl_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_39db5_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >open</th>
      <th class="col_heading level0 col1" >high</th>
      <th class="col_heading level0 col2" >low</th>
      <th class="col_heading level0 col3" >close</th>
      <th class="col_heading level0 col4" >volume</th>
      <th class="col_heading level0 col5" >change</th>
      <th class="col_heading level0 col6" >code</th>
      <th class="col_heading level0 col7" >name</th>
      <th class="col_heading level0 col8" >kosdaq_return</th>
      <th class="col_heading level0 col9" >return</th>
      <th class="col_heading level0 col10" >win_market</th>
      <th class="col_heading level0 col11" >close_r1</th>
      <th class="col_heading level0 col12" >close_r2</th>
      <th class="col_heading level0 col13" >close_r3</th>
      <th class="col_heading level0 col14" >close_r4</th>
      <th class="col_heading level0 col15" >close_r5</th>
      <th class="col_heading level0 col16" >max_close</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_39db5_level0_row0" class="row_heading level0 row0" >2021-01-05</th>
      <td id="T_39db5_row0_col0" class="data row0 col0" >2270</td>
      <td id="T_39db5_row0_col1" class="data row0 col1" >2285</td>
      <td id="T_39db5_row0_col2" class="data row0 col2" >2200</td>
      <td id="T_39db5_row0_col3" class="data row0 col3" >2250</td>
      <td id="T_39db5_row0_col4" class="data row0 col4" >410263</td>
      <td id="T_39db5_row0_col5" class="data row0 col5" >-0.004</td>
      <td id="T_39db5_row0_col6" class="data row0 col6" >060310</td>
      <td id="T_39db5_row0_col7" class="data row0 col7" >3S</td>
      <td id="T_39db5_row0_col8" class="data row0 col8" >1.008</td>
      <td id="T_39db5_row0_col9" class="data row0 col9" >0.996</td>
      <td id="T_39db5_row0_col10" class="data row0 col10" >0</td>
      <td id="T_39db5_row0_col11" class="data row0 col11" >1.018</td>
      <td id="T_39db5_row0_col12" class="data row0 col12" >1.018</td>
      <td id="T_39db5_row0_col13" class="data row0 col13" >0.998</td>
      <td id="T_39db5_row0_col14" class="data row0 col14" >0.967</td>
      <td id="T_39db5_row0_col15" class="data row0 col15" >0.971</td>
      <td id="T_39db5_row0_col16" class="data row0 col16" >1.018</td>
    </tr>
    <tr>
      <th id="T_39db5_level0_row1" class="row_heading level0 row1" >2021-01-06</th>
      <td id="T_39db5_row1_col0" class="data row1 col0" >2225</td>
      <td id="T_39db5_row1_col1" class="data row1 col1" >2310</td>
      <td id="T_39db5_row1_col2" class="data row1 col2" >2215</td>
      <td id="T_39db5_row1_col3" class="data row1 col3" >2290</td>
      <td id="T_39db5_row1_col4" class="data row1 col4" >570349</td>
      <td id="T_39db5_row1_col5" class="data row1 col5" >0.018</td>
      <td id="T_39db5_row1_col6" class="data row1 col6" >060310</td>
      <td id="T_39db5_row1_col7" class="data row1 col7" >3S</td>
      <td id="T_39db5_row1_col8" class="data row1 col8" >0.996</td>
      <td id="T_39db5_row1_col9" class="data row1 col9" >1.018</td>
      <td id="T_39db5_row1_col10" class="data row1 col10" >1</td>
      <td id="T_39db5_row1_col11" class="data row1 col11" >1.000</td>
      <td id="T_39db5_row1_col12" class="data row1 col12" >0.980</td>
      <td id="T_39db5_row1_col13" class="data row1 col13" >0.950</td>
      <td id="T_39db5_row1_col14" class="data row1 col14" >0.954</td>
      <td id="T_39db5_row1_col15" class="data row1 col15" >0.950</td>
      <td id="T_39db5_row1_col16" class="data row1 col16" >1.000</td>
    </tr>
    <tr>
      <th id="T_39db5_level0_row2" class="row_heading level0 row2" >2021-01-07</th>
      <td id="T_39db5_row2_col0" class="data row2 col0" >2290</td>
      <td id="T_39db5_row2_col1" class="data row2 col1" >2340</td>
      <td id="T_39db5_row2_col2" class="data row2 col2" >2240</td>
      <td id="T_39db5_row2_col3" class="data row2 col3" >2290</td>
      <td id="T_39db5_row2_col4" class="data row2 col4" >519777</td>
      <td id="T_39db5_row2_col5" class="data row2 col5" >0.000</td>
      <td id="T_39db5_row2_col6" class="data row2 col6" >060310</td>
      <td id="T_39db5_row2_col7" class="data row2 col7" >3S</td>
      <td id="T_39db5_row2_col8" class="data row2 col8" >1.008</td>
      <td id="T_39db5_row2_col9" class="data row2 col9" >1.000</td>
      <td id="T_39db5_row2_col10" class="data row2 col10" >0</td>
      <td id="T_39db5_row2_col11" class="data row2 col11" >0.980</td>
      <td id="T_39db5_row2_col12" class="data row2 col12" >0.950</td>
      <td id="T_39db5_row2_col13" class="data row2 col13" >0.954</td>
      <td id="T_39db5_row2_col14" class="data row2 col14" >0.950</td>
      <td id="T_39db5_row2_col15" class="data row2 col15" >0.959</td>
      <td id="T_39db5_row2_col16" class="data row2 col16" >0.980</td>
    </tr>
    <tr>
      <th id="T_39db5_level0_row3" class="row_heading level0 row3" >2021-01-08</th>
      <td id="T_39db5_row3_col0" class="data row3 col0" >2300</td>
      <td id="T_39db5_row3_col1" class="data row3 col1" >2315</td>
      <td id="T_39db5_row3_col2" class="data row3 col2" >2225</td>
      <td id="T_39db5_row3_col3" class="data row3 col3" >2245</td>
      <td id="T_39db5_row3_col4" class="data row3 col4" >462568</td>
      <td id="T_39db5_row3_col5" class="data row3 col5" >-0.020</td>
      <td id="T_39db5_row3_col6" class="data row3 col6" >060310</td>
      <td id="T_39db5_row3_col7" class="data row3 col7" >3S</td>
      <td id="T_39db5_row3_col8" class="data row3 col8" >0.999</td>
      <td id="T_39db5_row3_col9" class="data row3 col9" >0.980</td>
      <td id="T_39db5_row3_col10" class="data row3 col10" >0</td>
      <td id="T_39db5_row3_col11" class="data row3 col11" >0.969</td>
      <td id="T_39db5_row3_col12" class="data row3 col12" >0.973</td>
      <td id="T_39db5_row3_col13" class="data row3 col13" >0.969</td>
      <td id="T_39db5_row3_col14" class="data row3 col14" >0.978</td>
      <td id="T_39db5_row3_col15" class="data row3 col15" >0.973</td>
      <td id="T_39db5_row3_col16" class="data row3 col16" >0.978</td>
    </tr>
    <tr>
      <th id="T_39db5_level0_row4" class="row_heading level0 row4" >2021-01-11</th>
      <td id="T_39db5_row4_col0" class="data row4 col0" >2230</td>
      <td id="T_39db5_row4_col1" class="data row4 col1" >2275</td>
      <td id="T_39db5_row4_col2" class="data row4 col2" >2130</td>
      <td id="T_39db5_row4_col3" class="data row4 col3" >2175</td>
      <td id="T_39db5_row4_col4" class="data row4 col4" >409057</td>
      <td id="T_39db5_row4_col5" class="data row4 col5" >-0.031</td>
      <td id="T_39db5_row4_col6" class="data row4 col6" >060310</td>
      <td id="T_39db5_row4_col7" class="data row4 col7" >3S</td>
      <td id="T_39db5_row4_col8" class="data row4 col8" >0.989</td>
      <td id="T_39db5_row4_col9" class="data row4 col9" >0.969</td>
      <td id="T_39db5_row4_col10" class="data row4 col10" >0</td>
      <td id="T_39db5_row4_col11" class="data row4 col11" >1.005</td>
      <td id="T_39db5_row4_col12" class="data row4 col12" >1.000</td>
      <td id="T_39db5_row4_col13" class="data row4 col13" >1.009</td>
      <td id="T_39db5_row4_col14" class="data row4 col14" >1.005</td>
      <td id="T_39db5_row4_col15" class="data row4 col15" >1.002</td>
      <td id="T_39db5_row4_col16" class="data row4 col16" >1.009</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> 우선 과거 60일 평균 수익율 값을 return_mean 에 저장합니다. 그리고 종목에 sector 정보를 추가합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span>

<span class="n">data_h6</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">sector</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]):</span>
    
    <span class="c1"># 종목별 처리</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">mdl_data</span><span class="p">[</span><span class="n">mdl_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># 최근 60일 평균 수익율            </span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 종목별 최근 60 일 수익율의 평균</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sector</span>  <span class="c1"># 섹터 정보   </span>
  
    <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;return_mean&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
    <span class="n">data_h6</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">data_h6</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    
<span class="n">data_h6</span><span class="p">[</span><span class="s1">&#39;sector_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_h6</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="n">data_h6</span><span class="o">.</span><span class="n">index</span><span class="p">])[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="c1"># 섹터와 날짜별 평균 값</span>
<span class="n">data_h6</span><span class="p">[</span><span class="s1">&#39;return over sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_h6</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data_h6</span><span class="p">[</span><span class="s1">&#39;sector_return&#39;</span><span class="p">])</span>

<span class="n">data_h6</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;data_h6.pkl&#39;</span><span class="p">)</span>  
</pre></div>
</div>
</div>
</div>
<p><br> 종목이 몇 개 없는 섹터는 평균의 의미가 없으므로 섹터에 종목이 최소한 10 개 이상이 있는 섹터만 보겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_h6</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;data_h6.pkl&#39;</span><span class="p">)</span>  
<span class="n">sector_count</span> <span class="o">=</span> <span class="n">data_h6</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;sector&#39;</span><span class="p">)[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span> <span class="c1"># 섹터 별로 종목 수 계산</span>
<span class="n">data_h6x</span> <span class="o">=</span> <span class="n">data_h6</span><span class="p">[</span><span class="n">data_h6</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">sector_count</span><span class="p">[</span><span class="n">sector_count</span><span class="o">&gt;=</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># 섹터 별로 10개 이상이 있는 종목이 있는 섹터만 추출</span>
</pre></div>
</div>
</div>
</div>
<p><br> 섹터 평균 수익율 대비 종목 수익율이 아주 낮거나, 높은 경우에 미래 수익률이 높게 나왔습니다. 종목 수익률이 섹터 평균 수익률과 비슷한 경우(‘return over sector’ 값이 1 근처인 경우)는 예상 수익율이 낮게 나타나고 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_h6x</span><span class="p">[</span><span class="s1">&#39;sector_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_h6x</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="n">data_h6x</span><span class="o">.</span><span class="n">index</span><span class="p">])[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">data_h6x</span><span class="p">[</span><span class="s1">&#39;return over sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_h6x</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data_h6x</span><span class="p">[</span><span class="s1">&#39;sector_return&#39;</span><span class="p">])</span>
<span class="n">ranks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">data_h6x</span><span class="p">[</span><span class="s1">&#39;return over sector&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_h6x</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ranks</span><span class="p">)[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]))</span>
<span class="n">data_h6x</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ranks</span><span class="p">)[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                        count  mean   std   min   10%   50%   90%   max
return over sector                                                     
(0.688, 0.973]     26,887.000 1.042 0.087 0.700 0.974 1.022 1.126 2.968
(0.973, 0.983]     26,886.000 1.034 0.067 0.702 0.982 1.019 1.099 2.171
(0.983, 0.989]     26,886.000 1.030 0.060 0.704 0.984 1.016 1.087 2.286
(0.989, 0.994]     26,886.000 1.028 0.060 0.700 0.985 1.014 1.083 2.194
(0.994, 0.998]     26,889.000 1.027 0.058 0.819 0.985 1.013 1.080 2.729
(0.998, 1.002]     26,883.000 1.026 0.059 0.700 0.985 1.012 1.078 2.652
(1.002, 1.007]     26,886.000 1.027 0.062 0.700 0.984 1.012 1.080 3.027
(1.007, 1.014]     26,886.000 1.028 0.062 0.700 0.983 1.013 1.084 3.380
(1.014, 1.027]     26,886.000 1.031 0.068 0.700 0.980 1.014 1.093 2.412
(1.027, 1.399]     26,887.000 1.043 0.105 0.700 0.970 1.019 1.136 3.703
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;return over sector&#39;&gt;
</pre></div>
</div>
<img alt="_images/5.1.6_Hypothesis_6_8_2.png" src="_images/5.1.6_Hypothesis_6_8_2.png" />
</div>
</div>
</section>
</div>
</section>
<span id="document-chapter5/5.2.0_Solution_Details"></span><section id="id1">
<h2><strong>해결책 개발</strong><a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<p>가설 검증을 통하여 각 가설이 유의미한지 알아보았습니다. 가설 검정과정에서 얻은 지식을 이용하여  종목을 찾고, 매매 수익을 실현하고 싶습니다. 하지만 유미의한 가설들을 동시에 활용하여 종목을 뽑아내기는 쉬운 일이 아닙니다.  단지 2 개의 가설을 동시에 고려하는 것도 어렵습니다.  이것을 가능하게 해 주는 것이 예측 모델인데요. 가설들이 입력변수가 되는 예측 모델을 만들어 보겠습니다.</p>
<p>매수 후 5 영업일 이내 주가 상승 여부를 알 수 있는 예측력이 좋은 모델이 개발되면, 매일 모델을 실행시켜 종목 추천을 모델로 부터 받을 것입니다. 정규장이 3시 30에 종료되므로 3시 30분에 모델을 돌리고 종목 추천을 받겠습니다. 그리고 익일 정해진 지정가에 매수를 하겠습니다. 매수와 매도는 자동매매로 구현해볼 계획입니다.</p>
<div class="toctree-wrapper compound">
<span id="document-chapter5/5.2.1_Feature_Engineering"></span><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<section id="id1">
<h3>피처 엔지니어링<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>가설 검정에서 만들었던 모든 피쳐(변수)를 정리해 보겠습니다. 이제 예측 모델링을 위한 데이터가 준비되었습니다. 예측모델링에 활용한 데이터의 기간은 2021년 1월 5일부터 2022년 3월 24일까지입니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mdl_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;mdl_data.pkl&#39;</span><span class="p">)</span> <span class="c1"># 수익률 결과값이 있는 데이터</span>
<span class="n">mdl_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mdl_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">mdl_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-01-05 2022-03-24
</pre></div>
</div>
</div>
</div>
<p><br> 가설검정에서 만들었던 모든 피쳐를 정리합니다. 단, <em>“5일 이동평균선이 종가보다 위에 있다”</em> 는 유의미하지 않았으므로 제외입니다. 결과를 feature_all 이라는 데이터프레임에 저장합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span>

<span class="n">feature_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">sector</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]):</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">mdl_data</span><span class="p">[</span><span class="n">mdl_data</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    
    <span class="c1"># 가격변동성이 크고, 거래량이 몰린 종목이 주가가 상승한다</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_mean&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_std&#39;</span><span class="p">]</span>    
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span>      
    
    
    <span class="c1"># 위꼬리가 긴 양봉이 자주 발생한다.</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;positive_candle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 양봉</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;high/close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;positive_candle&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 양봉이면서 고가가 종가보다 높게 위치</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_high/close&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;high/close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;long_candle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;positive_candle&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span><span class="o">*</span>\
    <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 장대 양봉을 데이터로 표현</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_long&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;long_candle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># 지난 20 일 동안 장대양봉의 갯 수</span>
    
    
     <span class="c1"># 거래량이 종좀 터지며 매집의 흔적을 보인다   </span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span> <span class="c1"># 거래량은 종목과 주가에 따라 다르기 떄문에 표준화한 값이 필요함</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;z&gt;1.96&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_z&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.65</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 양봉이면서 거래량이 90%신뢰구간을 벗어난 날</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_z&gt;1.96&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;z&gt;1.96&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># 양봉이면서 거래량이 90%신뢰구간을 벗어난 날을 카운트</span>
    
    <span class="c1"># 주가지수보다 더 좋은 수익율을 보여준다</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_win_market&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;win_market&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># 주가지수 수익율이 1 보다 작을 때, 종목 수익율이 1 보다 큰 날 수</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pct_win_market&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 주가지수 수익율 대비 종목 수익율</span>
    
    
    <span class="c1"># 동종업체 수익률보다 더 좋은 수익율을 보여준다.           </span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 종목별 최근 60 일 수익율의 평균</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sector</span> 
       
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 5 영업일 종가 수익율 중 최고 값   </span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;mean_close&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 5 영업일 종가 수익율 중 최고 값   </span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;min_close&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 5 영업일 종가 수익율 중 최저 값   </span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_std&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)]</span> 
    
    <span class="n">feature_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">feature_all</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    

<span class="n">feature_all</span><span class="p">[</span><span class="s1">&#39;sector_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_all</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="n">feature_all</span><span class="o">.</span><span class="n">index</span><span class="p">])[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="c1"># 섹터의 평균 수익율 계산</span>
<span class="n">feature_all</span><span class="p">[</span><span class="s1">&#39;return over sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">feature_all</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">feature_all</span><span class="p">[</span><span class="s1">&#39;sector_return&#39;</span><span class="p">])</span> <span class="c1"># 섹터 평균 수익률 대비 종목 수익률 계산</span>
<span class="n">feature_all</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Missing 값 있는 행 모두 제거</span>


<span class="c1"># 최종 피처 및 수익률 데이터만으로 구성</span>
<span class="n">feature_all</span> <span class="o">=</span> <span class="n">feature_all</span><span class="p">[[</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;sector&#39;</span><span class="p">,</span><span class="s1">&#39;return&#39;</span><span class="p">,</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">,</span><span class="s1">&#39;price_z&#39;</span><span class="p">,</span><span class="s1">&#39;volume_z&#39;</span><span class="p">,</span><span class="s1">&#39;num_high/close&#39;</span><span class="p">,</span><span class="s1">&#39;num_long&#39;</span><span class="p">,</span><span class="s1">&#39;num_z&gt;1.96&#39;</span><span class="p">,</span><span class="s1">&#39;num_win_market&#39;</span><span class="p">,</span><span class="s1">&#39;pct_win_market&#39;</span><span class="p">,</span><span class="s1">&#39;return over sector&#39;</span><span class="p">,</span><span class="s1">&#39;max_close&#39;</span><span class="p">,</span><span class="s1">&#39;mean_close&#39;</span><span class="p">,</span><span class="s1">&#39;min_close&#39;</span><span class="p">]]</span>
<span class="n">feature_all</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;feature_all.pkl&#39;</span><span class="p">)</span>  
</pre></div>
</div>
</div>
</div>
<p><br> 이제 모델링을 위한 데이터 준비가 끝났습니다. 간단한 프로파일을 뽑아봅니다. 평균과 표준편차 값을 보고, 피처들이 제대로 생성되었는 지 확인합니다. 그리고 price_z 와 volum_z 는 같이 분석했을 때 유의미했다는 사실을 기억하면 좋겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feature_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;feature_all.pkl&#39;</span><span class="p">)</span> 
<span class="n">feature_all</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_5772f_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >return</th>
      <th class="col_heading level0 col1" >kosdaq_return</th>
      <th class="col_heading level0 col2" >price_z</th>
      <th class="col_heading level0 col3" >volume_z</th>
      <th class="col_heading level0 col4" >num_high/close</th>
      <th class="col_heading level0 col5" >num_long</th>
      <th class="col_heading level0 col6" >num_z>1.96</th>
      <th class="col_heading level0 col7" >num_win_market</th>
      <th class="col_heading level0 col8" >pct_win_market</th>
      <th class="col_heading level0 col9" >return over sector</th>
      <th class="col_heading level0 col10" >max_close</th>
      <th class="col_heading level0 col11" >mean_close</th>
      <th class="col_heading level0 col12" >min_close</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_5772f_level0_row0" class="row_heading level0 row0" >count</th>
      <td id="T_5772f_row0_col0" class="data row0 col0" >329307.000</td>
      <td id="T_5772f_row0_col1" class="data row0 col1" >329307.000</td>
      <td id="T_5772f_row0_col2" class="data row0 col2" >329307.000</td>
      <td id="T_5772f_row0_col3" class="data row0 col3" >329307.000</td>
      <td id="T_5772f_row0_col4" class="data row0 col4" >329307.000</td>
      <td id="T_5772f_row0_col5" class="data row0 col5" >329307.000</td>
      <td id="T_5772f_row0_col6" class="data row0 col6" >329307.000</td>
      <td id="T_5772f_row0_col7" class="data row0 col7" >329307.000</td>
      <td id="T_5772f_row0_col8" class="data row0 col8" >329307.000</td>
      <td id="T_5772f_row0_col9" class="data row0 col9" >329307.000</td>
      <td id="T_5772f_row0_col10" class="data row0 col10" >329307.000</td>
      <td id="T_5772f_row0_col11" class="data row0 col11" >329307.000</td>
      <td id="T_5772f_row0_col12" class="data row0 col12" >329307.000</td>
    </tr>
    <tr>
      <th id="T_5772f_level0_row1" class="row_heading level0 row1" >mean</th>
      <td id="T_5772f_row1_col0" class="data row1 col0" >1.000</td>
      <td id="T_5772f_row1_col1" class="data row1 col1" >1.000</td>
      <td id="T_5772f_row1_col2" class="data row1 col2" >-0.106</td>
      <td id="T_5772f_row1_col3" class="data row1 col3" >-0.058</td>
      <td id="T_5772f_row1_col4" class="data row1 col4" >0.126</td>
      <td id="T_5772f_row1_col5" class="data row1 col5" >0.017</td>
      <td id="T_5772f_row1_col6" class="data row1 col6" >1.942</td>
      <td id="T_5772f_row1_col7" class="data row1 col7" >7.559</td>
      <td id="T_5772f_row1_col8" class="data row1 col8" >1.001</td>
      <td id="T_5772f_row1_col9" class="data row1 col9" >1.000</td>
      <td id="T_5772f_row1_col10" class="data row1 col10" >1.033</td>
      <td id="T_5772f_row1_col11" class="data row1 col11" >1.001</td>
      <td id="T_5772f_row1_col12" class="data row1 col12" >0.970</td>
    </tr>
    <tr>
      <th id="T_5772f_level0_row2" class="row_heading level0 row2" >std</th>
      <td id="T_5772f_row2_col0" class="data row2 col0" >0.035</td>
      <td id="T_5772f_row2_col1" class="data row2 col1" >0.013</td>
      <td id="T_5772f_row2_col2" class="data row2 col2" >1.316</td>
      <td id="T_5772f_row2_col3" class="data row2 col3" >1.063</td>
      <td id="T_5772f_row2_col4" class="data row2 col4" >0.387</td>
      <td id="T_5772f_row2_col5" class="data row2 col5" >0.131</td>
      <td id="T_5772f_row2_col6" class="data row2 col6" >2.015</td>
      <td id="T_5772f_row2_col7" class="data row2 col7" >2.840</td>
      <td id="T_5772f_row2_col8" class="data row2 col8" >0.004</td>
      <td id="T_5772f_row2_col9" class="data row2 col9" >0.030</td>
      <td id="T_5772f_row2_col10" class="data row2 col10" >0.071</td>
      <td id="T_5772f_row2_col11" class="data row2 col11" >0.053</td>
      <td id="T_5772f_row2_col12" class="data row2 col12" >0.050</td>
    </tr>
    <tr>
      <th id="T_5772f_level0_row3" class="row_heading level0 row3" >min</th>
      <td id="T_5772f_row3_col0" class="data row3 col0" >0.326</td>
      <td id="T_5772f_row3_col1" class="data row3 col1" >0.963</td>
      <td id="T_5772f_row3_col2" class="data row3 col2" >-4.359</td>
      <td id="T_5772f_row3_col3" class="data row3 col3" >-2.032</td>
      <td id="T_5772f_row3_col4" class="data row3 col4" >0.000</td>
      <td id="T_5772f_row3_col5" class="data row3 col5" >0.000</td>
      <td id="T_5772f_row3_col6" class="data row3 col6" >0.000</td>
      <td id="T_5772f_row3_col7" class="data row3 col7" >0.000</td>
      <td id="T_5772f_row3_col8" class="data row3 col8" >0.976</td>
      <td id="T_5772f_row3_col9" class="data row3 col9" >0.379</td>
      <td id="T_5772f_row3_col10" class="data row3 col10" >0.700</td>
      <td id="T_5772f_row3_col11" class="data row3 col11" >0.509</td>
      <td id="T_5772f_row3_col12" class="data row3 col12" >0.416</td>
    </tr>
    <tr>
      <th id="T_5772f_level0_row4" class="row_heading level0 row4" >5%</th>
      <td id="T_5772f_row4_col0" class="data row4 col0" >0.955</td>
      <td id="T_5772f_row4_col1" class="data row4 col1" >0.978</td>
      <td id="T_5772f_row4_col2" class="data row4 col2" >-2.083</td>
      <td id="T_5772f_row4_col3" class="data row4 col3" >-0.868</td>
      <td id="T_5772f_row4_col4" class="data row4 col4" >0.000</td>
      <td id="T_5772f_row4_col5" class="data row4 col5" >0.000</td>
      <td id="T_5772f_row4_col6" class="data row4 col6" >0.000</td>
      <td id="T_5772f_row4_col7" class="data row4 col7" >3.000</td>
      <td id="T_5772f_row4_col8" class="data row4 col8" >0.995</td>
      <td id="T_5772f_row4_col9" class="data row4 col9" >0.963</td>
      <td id="T_5772f_row4_col10" class="data row4 col10" >0.969</td>
      <td id="T_5772f_row4_col11" class="data row4 col11" >0.931</td>
      <td id="T_5772f_row4_col12" class="data row4 col12" >0.884</td>
    </tr>
    <tr>
      <th id="T_5772f_level0_row5" class="row_heading level0 row5" >10%</th>
      <td id="T_5772f_row5_col0" class="data row5 col0" >0.967</td>
      <td id="T_5772f_row5_col1" class="data row5 col1" >0.983</td>
      <td id="T_5772f_row5_col2" class="data row5 col2" >-1.729</td>
      <td id="T_5772f_row5_col3" class="data row5 col3" >-0.722</td>
      <td id="T_5772f_row5_col4" class="data row5 col4" >0.000</td>
      <td id="T_5772f_row5_col5" class="data row5 col5" >0.000</td>
      <td id="T_5772f_row5_col6" class="data row5 col6" >0.000</td>
      <td id="T_5772f_row5_col7" class="data row5 col7" >4.000</td>
      <td id="T_5772f_row5_col8" class="data row5 col8" >0.996</td>
      <td id="T_5772f_row5_col9" class="data row5 col9" >0.974</td>
      <td id="T_5772f_row5_col10" class="data row5 col10" >0.981</td>
      <td id="T_5772f_row5_col11" class="data row5 col11" >0.949</td>
      <td id="T_5772f_row5_col12" class="data row5 col12" >0.911</td>
    </tr>
    <tr>
      <th id="T_5772f_level0_row6" class="row_heading level0 row6" >50%</th>
      <td id="T_5772f_row6_col0" class="data row6 col0" >1.000</td>
      <td id="T_5772f_row6_col1" class="data row6 col1" >1.001</td>
      <td id="T_5772f_row6_col2" class="data row6 col2" >-0.226</td>
      <td id="T_5772f_row6_col3" class="data row6 col3" >-0.311</td>
      <td id="T_5772f_row6_col4" class="data row6 col4" >0.000</td>
      <td id="T_5772f_row6_col5" class="data row6 col5" >0.000</td>
      <td id="T_5772f_row6_col6" class="data row6 col6" >1.000</td>
      <td id="T_5772f_row6_col7" class="data row6 col7" >7.000</td>
      <td id="T_5772f_row6_col8" class="data row6 col8" >1.000</td>
      <td id="T_5772f_row6_col9" class="data row6 col9" >0.998</td>
      <td id="T_5772f_row6_col10" class="data row6 col10" >1.017</td>
      <td id="T_5772f_row6_col11" class="data row6 col11" >0.998</td>
      <td id="T_5772f_row6_col12" class="data row6 col12" >0.977</td>
    </tr>
    <tr>
      <th id="T_5772f_level0_row7" class="row_heading level0 row7" >90%</th>
      <td id="T_5772f_row7_col0" class="data row7 col0" >1.033</td>
      <td id="T_5772f_row7_col1" class="data row7 col1" >1.015</td>
      <td id="T_5772f_row7_col2" class="data row7 col2" >1.672</td>
      <td id="T_5772f_row7_col3" class="data row7 col3" >0.687</td>
      <td id="T_5772f_row7_col4" class="data row7 col4" >1.000</td>
      <td id="T_5772f_row7_col5" class="data row7 col5" >0.000</td>
      <td id="T_5772f_row7_col6" class="data row7 col6" >5.000</td>
      <td id="T_5772f_row7_col7" class="data row7 col7" >11.000</td>
      <td id="T_5772f_row7_col8" class="data row7 col8" >1.005</td>
      <td id="T_5772f_row7_col9" class="data row7 col9" >1.026</td>
      <td id="T_5772f_row7_col10" class="data row7 col10" >1.096</td>
      <td id="T_5772f_row7_col11" class="data row7 col11" >1.053</td>
      <td id="T_5772f_row7_col12" class="data row7 col12" >1.016</td>
    </tr>
    <tr>
      <th id="T_5772f_level0_row8" class="row_heading level0 row8" >95%</th>
      <td id="T_5772f_row8_col0" class="data row8 col0" >1.051</td>
      <td id="T_5772f_row8_col1" class="data row8 col1" >1.021</td>
      <td id="T_5772f_row8_col2" class="data row8 col2" >2.127</td>
      <td id="T_5772f_row8_col3" class="data row8 col3" >1.681</td>
      <td id="T_5772f_row8_col4" class="data row8 col4" >1.000</td>
      <td id="T_5772f_row8_col5" class="data row8 col5" >0.000</td>
      <td id="T_5772f_row8_col6" class="data row8 col6" >6.000</td>
      <td id="T_5772f_row8_col7" class="data row8 col7" >12.000</td>
      <td id="T_5772f_row8_col8" class="data row8 col8" >1.008</td>
      <td id="T_5772f_row8_col9" class="data row8 col9" >1.042</td>
      <td id="T_5772f_row8_col10" class="data row8 col10" >1.143</td>
      <td id="T_5772f_row8_col11" class="data row8 col11" >1.080</td>
      <td id="T_5772f_row8_col12" class="data row8 col12" >1.032</td>
    </tr>
    <tr>
      <th id="T_5772f_level0_row9" class="row_heading level0 row9" >max</th>
      <td id="T_5772f_row9_col0" class="data row9 col0" >1.300</td>
      <td id="T_5772f_row9_col1" class="data row9 col1" >1.046</td>
      <td id="T_5772f_row9_col2" class="data row9 col2" >4.359</td>
      <td id="T_5772f_row9_col3" class="data row9 col3" >7.617</td>
      <td id="T_5772f_row9_col4" class="data row9 col4" >5.000</td>
      <td id="T_5772f_row9_col5" class="data row9 col5" >2.000</td>
      <td id="T_5772f_row9_col6" class="data row9 col6" >15.000</td>
      <td id="T_5772f_row9_col7" class="data row9 col7" >22.000</td>
      <td id="T_5772f_row9_col8" class="data row9 col8" >1.043</td>
      <td id="T_5772f_row9_col9" class="data row9 col9" >1.399</td>
      <td id="T_5772f_row9_col10" class="data row9 col10" >3.703</td>
      <td id="T_5772f_row9_col11" class="data row9 col11" >2.346</td>
      <td id="T_5772f_row9_col12" class="data row9 col12" >1.300</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<span id="document-chapter5/5.2.2_Modeling_Library"></span><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<section id="id1">
<h3>모델링 라이브러리 소개<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>모델은 가설을 활용하여 타겟변수를 예측하는 알고리즘을 만드는 것이라고 생각하시면 될 것 같습니다. 파이썬에서는 모델링을 위하여 여러개의 라이브러리(패키지)를 제공하고 있습니다. 대표적인 모델개발 라이브러리는 Statsmodels, Scikit-Learn, Keras 등이 있습니다. 책에서 종목 추천으로 사용할 모델은 일반화 가법 모형(Generalized Additive Model) 입니다. 일반화가법모형은 Statsmodels 에서도 구현할 수 있으나, pyGAM 패키지를 사용하면 더 편리합니다.</p>
<p>Statsmodels 는 전통적인 통계모델에 특화되어 있고, Scikit-Learn 는 머신러닝모델, Keras 는 딥러닝 모델을 개발할 때 활용할 수 있습니다. 라이브러리는 모델을 만드는 패키지가 들어가 있으므로 호출해서 사용하면 됩니다. Statsmodels 은 주로 일반화 선형모형을 구현할 때 주로 사용합니다. 통계 선형모형의 장점은 해석이 가능한 모델을 만들 수 있다는 것입니다. 예를 들면 변수 X 가 1 단위 증가하면 타겟변수는 얼마나 증가하느냐? 등의 해석을 할 수 있습니다..</p>
<p>Scikit-Learn 은 주로 머신러닝 모델을 만들 때 활용하는 라이브러리입니다. 머신러닝 모델은 각 피쳐의 해석보다는 예측력을 최우선으로 합니다. 특히 트리(Tree) 기반 모델은 변수간의 상호작용을 고려하므로 입력 변수사이에 상호작용이 많을 때 효과가 좋습니다. 머신러닝 모델 중에는 앙상블 모델이 인기인데요. 앙상블도 Bias 를 줄이는데 집중하는 Boosting  모델(예 Ada Boost) 계열과 Variance 를 줄이는데 집중하는 Bagging 모델(예 Random Forest) 계열로 나눌 수 있습니다. Bias 랑 Variance 는 하나를 내리면 하나는 올라가는 특징이 있습니다. 두 명의 양궁선수가 있습니다. 한 명은 과녁 중앙에 골고루 퍼지게 활을 쏘는 능력이 있고, 한 명은 일단 처음 쏜 화살에 근처에 집중에서 쏘는 능력이 있다고 하면 누구를 선택하시겠습니까? 첫 번째 양궁선수는 과녁근방에 골고루 쏘는 분이므로 큰 점수는 못 얻어도 항상 기본점수 이상은 획득하는 안전함이 있습니다. 즉 Variance 가 낮음에 해당합니다. 두 번째 양궁선수는  일단 첫 화살에 중앙에 명중하면, 나머지도 10점을 얻을 수 있습니다. 하지만, 처음 화살이 빗나가면 나머지도 다 빗나갑니다. 따라서 첫 화살이 중요합니다. Bias 가 낮기 때문에 overfitting (과대적합) 을 주의해야 합니다. 운이 안 좋아 중앙에서 먼거리에 첫 화살이 명중했다면, 나머지 화살도 그  근방으로 가므로, 우리가 원하는 해답이 아닌 곳으로 모델학습이 이루어지게 되는 것입니다.</p>
<p>Keras 는 딥러닝을 위한 라이브러리입니다. 데이터 수가 많지 않고,  피쳐의 디멘젼이 5 개(시종고저, 거래량) 라면 데이터 복잡성도 높지 않습니다. 구현하고자 하는 예측모델은 딥러닝이 적절하지는 않아보입니다. 굳이 일봉 데이터가 요약된 피쳐로 뉴럴네트워크 모델을 구현한다면  Multi-Layer Perceptron (다층 퍼셉트론) 모델을 생각해 볼 수 있습니다. MLP 는 비선형관계를 표현하기 위해서 Activation Function (활성화함수) 를 이용하고,  Activation 함수에서 나온 값을 다시 다음 층의 입력변수로 넣는 형태입니다. 이렇게 함으로써 변수간의 상호작용과 비선형관계를 동시에 표현할 수 있습니다. 사실, 활성화 함수가 Sigmoid  함수인 뉴럴네트워크 모델은 Logistic Regression.모델을 가로 세로층으로 중첩한 것과 동일한 구조가 됩니다. 즉, Logistic Regression 의 확장형으로도 생각할 수 있습니다.  뉴럴네트워크 계통의 모델은 Loss Function (손실함수) 를 만들고 Loss Function 를 최소화하는 네트워크의 가중치를 찾도록 훈련합니다. 많이 쓰는 훈련방식은 오류 역전파(BackPropagation) 입니다. 이런 식의 접근 법은 과대적합이 항상 문제가 됩니다. 따라서 과대적합을 피하기 위해 다양한 기법이 개발 되고 있습니다.</p>
<p>이번절에서는 Statsmodel 과 Scikit-Learn 라이브러리가 모델 개발에 어떻게 활용되는지 경험해 보는 시간입니다.</p>
<p>모델링을 위해 준비한 데이터를 읽습니다. 그리고 모델의 오버피팅을 최소화하기 위하여 타겟변수를 0 과 1 로 치환합니다. 예를 들어, 5% 익절의 데이터 표현은 - ‘max_close’ 가 5% 이상일 때 1, 아니면 0 이 됩니다. ‘max_close’ 가 1 인 비율을 보니, 약 24% 입니다. 10000 개 샘플을 뽑아 예측모델을 만들고 나머지로 데이터로 테스트(혹은 백테스팅)를 하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feature_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;feature_all.pkl&#39;</span><span class="p">)</span> 
<span class="n">feature_all</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">feature_all</span><span class="p">[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">&gt;=</span> <span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">feature_all</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;% of target:</span><span class="si">{</span><span class="n">target</span><span class="si">:</span><span class="s1"> 5.1%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">mdl_all</span> <span class="o">=</span> <span class="n">feature_all</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="n">feature_all</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;code&#39;</span><span class="p">])</span>

<span class="n">train</span> <span class="o">=</span> <span class="n">mdl_all</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">124</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">mdl_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">mdl_all</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>% of target: 24.3%
</pre></div>
</div>
</div>
</div>
</section>
<section id="statsmodels-logistic-regression">
<h3>Statsmodels - Logistic Regression<a class="headerlink" href="#statsmodels-logistic-regression" title="Permalink to this headline">#</a></h3>
<p>아래 코드는 Statsmodels 라이브러리에 대한 이해가 목적입니다. Statsmodels 는 전통적인 통계모델을 구현하는데 주로 활용하는데요. 통계모델의 장점은 변수의 해석이 가능하다는 것입니다. 아래 코드는 랜덤해게 뽑은 5천개의 샘플로 모델을 만들고, 나머지 데이터로 모델 성능을 테스트하는 과정입니다. 모델 개발은 여기서부터 시작입니다.  결과를 보면 P Value(P&gt;|z|) 가 0.01(유의수준) 보다 큰 변수가 많은데요. P Value(P&gt;|z|) 가 유의수준보다 크다는 이야기는 coefficient 가 0 일 가능성이 높다는 말이고, Coefficient 가 0 이라는 말은 예측에 도움을 안 준다는 말입니다. 이런 변수들은 적절한 변형을 통하여 유의미하게 만들거나 제거해야 합니다. 가장 대표적인 방법이 Binning 입니다. 이 절은 라이브러리를 소개하는 것이 목적이라, 모델 완성을 위한 나머지 과정은 생략하도록 하겠습니다. 제가 통계모델의 장점으로 해석을 언급했는데요. 아직 모델이 완성되지 않았지만, 변수 ‘volume_z’ 를 해석해 보도록 하겠습니다. ‘volume_z’ 는 과거 20일대비 당일 거래량이 얼마나 많은 지를 의미하는 변수입니다. ‘volume_z’ 가 1 증가하면 log(odds) 는 그 변수의 계수 0.1765 만큼 증가하게 됩니다. 즉, odds 는 exp(0.1765) 증가하게 됩니다. 풀어서 이야기하면, 전일 20일 대비 당일 거래량 표준화 값 z 가  1 증가할 때마다, 5% 로 익절할 odds(=p/1-p)는 exp(0.1765) 증가한다고 말할 수 있습니다.</p>
<p>모델을 완성하기까지 필요한 나머지 절차는 아래와 같습니다.</p>
<ol class="simple">
<li><p>각 설명변수와 타겟변수와 관계를 분석합니다 (변수간에 상호작용 강한 지 체크)</p></li>
<li><p>선형적인 관계가 없는 변수는 binning 등을 통해 문제를 해결합니다. 혹은 제곱근, 제곱, 로그 등의 변형으로 선형적으로 만들 수 도 있습니다.</p></li>
<li><p>다중 공선성이 의심되는 변수는 제거하거나 새로운 변수로 대체합니다. (다중 공선성이 높은 모델은 변수의 해석이 부정확함)</p></li>
<li><p>테스트 데이터셋과 예측성능을 비교합니다 (오버피팅 여부 확인).</p></li>
<li><p>변수를 해석하고 예측값을 만듭니다.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>

<span class="n">feature_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">,</span> <span class="s1">&#39;volume_z&#39;</span><span class="p">,</span> <span class="s1">&#39;num_high/close&#39;</span><span class="p">,</span> <span class="s1">&#39;num_long&#39;</span><span class="p">,</span> <span class="s1">&#39;num_z&gt;1.96&#39;</span><span class="p">,</span> <span class="s1">&#39;num_win_market&#39;</span><span class="p">,</span> <span class="s1">&#39;pct_win_market&#39;</span><span class="p">,</span> <span class="s1">&#39;return over sector&#39;</span><span class="p">]</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">feature_list</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">Logit</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
<span class="n">yhat</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">yhat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">yhat</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;yhat&#39;</span><span class="p">)</span>

<span class="n">X_test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">feature_list</span><span class="p">]</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">yhat_test</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">yhat_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">yhat_test</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;yhat&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Optimization terminated successfully.
         Current function value: 0.549822
         Iterations 6
                           Logit Regression Results                           
==============================================================================
Dep. Variable:                 target   No. Observations:                10000
Model:                          Logit   Df Residuals:                     9991
Method:                           MLE   Df Model:                            8
Date:                Sun, 26 Jun 2022   Pseudo R-squ.:                 0.01089
Time:                        05:30:08   Log-Likelihood:                -5498.2
converged:                       True   LL-Null:                       -5558.7
Covariance Type:            nonrobust   LLR p-value:                 2.047e-22
======================================================================================
                         coef    std err          z      P&gt;|z|      [0.025      0.975]
--------------------------------------------------------------------------------------
const                -24.3868      6.812     -3.580      0.000     -37.739     -11.035
price_z               -0.1266      0.021     -6.156      0.000      -0.167      -0.086
volume_z               0.1491      0.024      6.255      0.000       0.102       0.196
num_high/close         0.1396      0.058      2.411      0.016       0.026       0.253
num_long              -0.1293      0.172     -0.752      0.452      -0.466       0.208
num_z&gt;1.96             0.0257      0.013      1.982      0.047       0.000       0.051
num_win_market         0.0251      0.009      2.722      0.006       0.007       0.043
pct_win_market        23.8495      6.797      3.509      0.000      10.527      37.172
return over sector    -0.8839      0.835     -1.058      0.290      -2.521       0.753
======================================================================================
</pre></div>
</div>
</div>
</div>
<p><br> 개발 데이터가 아니라, 테스트데이터에서도 좋은 성능을 보이는지 확인해봅니다. 쉽게 확인하는 방법은 Decile 분석입니다. 예측값의 변별력을 알기 위해서 정렬된 예측값을 10 개 구간으로 나누고, 각 구간에서 ‘target’의 평균값을 찍어봅니다. 파란색이 개발데이터, 주황색이 테스트 데이터입니다. 모델이 예측력이 좋다면, 예측값의 십분위 수가 증가하면 5%로 익절할 확률도 같이 증가하는 형태를 보이게 됩니다. 아래 결과에서 완성되지 않은 모델이지만 단조증가하는 좋은 흐름을 보여주고 있습니다. 테스트 결과에서 제 1 십분위수(첫 번째 구간) 에서 종목을 선택한다면 19.7% 로 익절할 확률이 있지만, 제 10 분위수(마지막 구간)에서 종목을 선택한다면 34.9% 로 익절할 확률이 생깁니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">perf</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">yhat</span><span class="p">):</span> <span class="c1"># Decile 분석 함수</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="n">yhat</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ranks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">combined</span><span class="p">[</span><span class="s1">&#39;yhat&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">combined</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ranks</span><span class="p">)[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;count&#39;</span><span class="p">,</span><span class="s1">&#39;mean&#39;</span><span class="p">]))</span>
    <span class="n">combined</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ranks</span><span class="p">)[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="n">perf</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">yhat</span><span class="p">)</span>
<span class="n">perf</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">yhat_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                count  mean
yhat                       
(0.138, 0.192]   1000 0.204
(0.192, 0.206]   1000 0.173
(0.206, 0.218]   1000 0.236
(0.218, 0.227]   1000 0.225
(0.227, 0.237]   1000 0.208
(0.237, 0.248]   1000 0.228
(0.248, 0.259]   1000 0.240
(0.259, 0.275]   1000 0.266
(0.275, 0.302]   1000 0.303
(0.302, 0.637]   1000 0.359
                              count  mean
yhat                                     
(0.11699999999999999, 0.192]  31931 0.195
(0.192, 0.205]                31931 0.198
(0.205, 0.216]                31930 0.212
(0.216, 0.226]                31931 0.221
(0.226, 0.236]                31931 0.225
(0.236, 0.247]                31930 0.230
(0.247, 0.259]                31931 0.248
(0.259, 0.275]                31930 0.260
(0.275, 0.302]                31931 0.292
(0.302, 0.728]                31931 0.349
</pre></div>
</div>
<img alt="_images/5.2.2_Modeling_Library_7_1.png" src="_images/5.2.2_Modeling_Library_7_1.png" />
</div>
</div>
</section>
<section id="sk-learn-logistic-regression">
<h3>SK-Learn - Logistic Regression<a class="headerlink" href="#sk-learn-logistic-regression" title="Permalink to this headline">#</a></h3>
<p>Scikit-Learn 에서도 Logistic Regression 을 지원합니다. 하지만 계수를 추정하는 방식이 Statsmodels 과는 다른데요. Scikit-Learn Logistic Regression 은 loss 함수를 만들고, 과대적합을 해결하기 위해 penalty term (L1/L2) 도 추가합니다. 이런 방식으로 Penalty Term 이 있는 Loss 함수를 최소화하는 방식을 계수를 찾을 때는 입력 피처의 스케일이 동일해야 의미가 있습니다. 아래 코드에서 입력 피쳐를 Scaling 하는 부분이 반드시 들어가야 합니다. 아래 Test 데이터의 결과가 Train 데이터보다 모델성능의 차이가 크지는 않습니다. 즉 overfitting(과대적합)이 심하지는 않아 보입니다.</p>
<p>SK-Learn 으로 만드는 모델은 절차가 아래와 같습니다.</p>
<ol class="simple">
<li><p>입력 피처 스케일링 (Loss 함수 + Penalty Term 로 훈련하는 모델만 해당)</p></li>
<li><p>하이퍼파라미터 튜닝 (성능을 최고로 만드는 하이퍼파라미터을 찾기)</p></li>
<li><p>테스트 데이터셋과 예측성능을 비교합니다 (오버피팅 여부 확인)</p></li>
<li><p>변수의 중요도 파악과 이해</p></li>
<li><p>예측값 만들기</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="n">feature_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">,</span> <span class="s1">&#39;volume_z&#39;</span><span class="p">,</span> <span class="s1">&#39;num_high/close&#39;</span><span class="p">,</span> <span class="s1">&#39;num_long&#39;</span><span class="p">,</span> <span class="s1">&#39;num_z&gt;1.96&#39;</span><span class="p">,</span> <span class="s1">&#39;num_win_market&#39;</span><span class="p">,</span> <span class="s1">&#39;pct_win_market&#39;</span><span class="p">,</span> <span class="s1">&#39;return over sector&#39;</span><span class="p">]</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">feature_list</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>

<span class="n">X_test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">feature_list</span><span class="p">]</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>

<span class="c1"># 입력 피처 표준화</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span> <span class="c1"># 평균이 0 이고 편차가 1 가 되도록 피처 표준화</span>
<span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="n">lr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 정해진 하이퍼파라미터를 가진 객체를 생성, C 값은 다중 공선성을 제거하기 위한 페널티의 가중치이며 디폴트는 L2(Ridge) 페널티</span>
<span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">lr</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span>
<span class="n">yhat</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">yhat_test</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>

<span class="n">yhat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">yhat</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;yhat&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> 
<span class="n">yhat_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">yhat_test</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;yhat&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[-0.10997133  0.14023527  0.15290205 -0.03634754  0.04334864  0.03748485
   0.51234537 -0.51150234]]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">perf</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">yhat</span><span class="p">)</span>
<span class="n">perf</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">yhat_test</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                count  mean
yhat                       
(0.142, 0.194]   1000 0.175
(0.194, 0.208]   1000 0.201
(0.208, 0.219]   1000 0.224
(0.219, 0.228]   1000 0.236
(0.228, 0.238]   1000 0.217
(0.238, 0.248]   1000 0.234
(0.248, 0.26]    1000 0.270
(0.26, 0.275]    1000 0.249
(0.275, 0.3]     1000 0.294
(0.3, 0.632]     1000 0.342
                count  mean
yhat                       
(0.126, 0.194]  31931 0.187
(0.194, 0.207]  31931 0.207
(0.207, 0.218]  31930 0.217
(0.218, 0.228]  31931 0.218
(0.228, 0.237]  31931 0.226
(0.237, 0.247]  31930 0.235
(0.247, 0.259]  31931 0.254
(0.259, 0.274]  31930 0.258
(0.274, 0.299]  31931 0.289
(0.299, 0.652]  31931 0.338
</pre></div>
</div>
<img alt="_images/5.2.2_Modeling_Library_10_1.png" src="_images/5.2.2_Modeling_Library_10_1.png" />
</div>
</div>
</section>
<section id="sk-learn-random-forerst">
<h3>SK-learn - Random Forerst<a class="headerlink" href="#sk-learn-random-forerst" title="Permalink to this headline">#</a></h3>
<p>Random Forest 는 Scikit-Learn 에서 인기있는 모델인데요. Decision-Tree(의사결정나무)의 문제점을 보완하고자 나온 개념입니다. 모델을 훈련시키기 위한 loss 함수와 Penalty term 이 없기 때문에 피쳐 스케일링이 불필요해서 쉽게 모델을 만들어 볼 수 있습니다. 보통 모델의 최소성능을 파악하기 위해 먼저 만들어보는 모델입니다.
sklearn 의 ensemble(앙상블) 모델군에서 RandomForestClassifier 을 불러옵니다. 그 다음 정해진 하이퍼파라미터(hyperparameter)를 가진 객체를 하나 생성합니다. 여기서 어떤 하이퍼파라미터로 객체를 생성하는가에 따라 모델의 성능이 결정되므로, 하이퍼파라미터 튜닝이라 절차가 필요합니다. 보통 최적의 하이퍼파라미터는 Grid Search 로 찾습니다. 그리고 fit 를 이용해서 데이터를 적용하면 됩니다. 예측값 생성은 predict 함수나 predict_proba 함수로 할 수 있는데요. predict 함수는 0/1 값을 리턴하고, predict_proba 함수는 ‘0 일 확률’/’1 일 확률’을 리턴합니다. 각 피처의 중요도를 그래프로 파악해보겠습니다. 이전 모델들에 비해 예측성능이 좋습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="c1"># 정해진 하이퍼파라미터를 가진 객체를 생성</span>

<span class="n">feature_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">,</span> <span class="s1">&#39;volume_z&#39;</span><span class="p">,</span> <span class="s1">&#39;num_high/close&#39;</span><span class="p">,</span> <span class="s1">&#39;num_long&#39;</span><span class="p">,</span> <span class="s1">&#39;num_z&gt;1.96&#39;</span><span class="p">,</span> <span class="s1">&#39;num_win_market&#39;</span><span class="p">,</span> <span class="s1">&#39;pct_win_market&#39;</span><span class="p">,</span> <span class="s1">&#39;return over sector&#39;</span><span class="p">]</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">feature_list</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>
<span class="n">rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">yhat</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># 첫번째 열은 0일 확률, 두번째 열은 1 일 확률 -&gt; 1 일 확률을 저장</span>
<span class="n">yhat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">yhat</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;yhat&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> 

<span class="n">X_test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">feature_list</span><span class="p">]</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>
<span class="n">yhat_test</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># 첫번째 열은 0일 확률, 두번째 열은 1 일 확률 -&gt; 1 일 확률을 저장</span>
<span class="n">yhat_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">yhat_test</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;yhat&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> 

<span class="n">importances</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">feature_importances_</span>
<span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">importances</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
 
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Feature Importance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">importances</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">],</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5.2.2_Modeling_Library_12_0.png" src="_images/5.2.2_Modeling_Library_12_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">perf</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">yhat</span><span class="p">)</span>
<span class="n">perf</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">yhat_test</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                count  mean
yhat                       
(0.167, 0.203]   1000 0.131
(0.203, 0.212]   1000 0.152
(0.212, 0.218]   1000 0.182
(0.218, 0.226]   1000 0.209
(0.226, 0.233]   1000 0.221
(0.233, 0.242]   1000 0.241
(0.242, 0.255]   1000 0.263
(0.255, 0.274]   1000 0.295
(0.274, 0.304]   1000 0.313
(0.304, 0.469]   1000 0.435
                count  mean
yhat                       
(0.164, 0.203]  31932 0.155
(0.203, 0.212]  31930 0.180
(0.212, 0.218]  31930 0.187
(0.218, 0.225]  31931 0.204
(0.225, 0.233]  31931 0.225
(0.233, 0.241]  31931 0.238
(0.241, 0.254]  31930 0.268
(0.254, 0.274]  31930 0.287
(0.274, 0.304]  31931 0.308
(0.304, 0.487]  31931 0.378
</pre></div>
</div>
<img alt="_images/5.2.2_Modeling_Library_13_1.png" src="_images/5.2.2_Modeling_Library_13_1.png" />
</div>
</div>
</section>
<span id="document-chapter5/5.2.3_GAM"></span><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<section id="id1">
<h3>종목 선정 모델 개발<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>선형모델에 대한 중요한 가정과 설명은 다음 절에서 추가로 설명드리겠으나,  수익률에 따라 단조 증가나 감소의 형태를 보이지 않는 피쳐(설명변수)는 변형을 해야 선형모형에서 더 유의미하게 사용될 수 있습니다.  주로 Binning (오름차순으로 정렬 후, 여러개 구간으로 분리) 을 통하여 이런 비선형적인 관계를 선형적으로 변경합니다. 2차 함수나 로그함수 등을 이용해 선형적으로 변경할 수 도 있습니다. 우리는 앞서 수익율과 피쳐사이에 선형적인 관계를 가지지 않는 가설(예: 섹터의 평균 수익률 대비 종목 수익률)들 이 있었습니다. 이런 피처들에 대하여 Binning 없이 적합할 수 있는 모델이 일반화가법모형(Generalized Additive Model) 입니다. 또한 가설 검정에서는 5 영업일 동안의 최대 수익률을 예측변수로 이용했으나, 모델의 overfitting (과대적합) 문제를 최소화하기 위하여, 예측값을 이진값(0/1)으로 치환한 후, 로지스틱 일반화가법모형(Logistic Generalized Additive Model) 을 구현합니다. 로지스틱 회귀모형은 <span class="math notranslate nohighlight">\(log(odds) = a0 + a1*x1 + a2*x2 …\)</span>  으로 표현할 수 있는데요. 여기서 X 를 여러개의 spline 로 함수로 만든 후, 다시 합하여 X 와 <span class="math notranslate nohighlight">\(log(odds)\)</span> 의  비선형적관계를 표현할 수 있도록 한 것이  Logistic GAM 입니다.  이 모델의 구현은 Statsmodels 에서 가능합니다만, pyGAM 패키지는 자동으로 하이퍼파라미터를 찾는 기능이 있어 편리합니다. GAM 을 선택한 다른 이유는 피처사이에 상호작용이 크지 않을 것이라는 가정이 있습니다. 무엇보다도 좋은 점은 모델이 왜 이 종목을 선택했는지에 대한 해석이 가능합니다. 향후, 모델의 예측력이 저하되는 경우 어떤 피처가 원인인지도 파악이 가능합니다.</p>
<p>단순히, 스코어가 높은 모든 종목을 매수하는 것이 아니라,  오늘의 종가 수익률과 주가를 고려하여 기본적인 필터링을 합니다. 분석결과 종가 수익률은 높고, 최근 20일 대비 가격이 낮은 종목을 매수하면 리스크가 적은 것으로 판단됩니다.</p>
<p>이번절에서는 책에서 종목선정을 위해 사용할 GAM 모델을 개발하겠습니다. 아나콘다 프롬프트에서 conda install -c conda-forge pygam 로 설치를 해 줍니다. 관련 링크 <a class="reference external" href="https://anaconda.org/conda-forge/pygam">https://anaconda.org/conda-forge/pygam</a></p>
<p>모델링을 위해 준비한 데이터를 읽습니다. 그리고 모델의 오버피팅을 최소화하기 위하여 타겟변수를 0 과 1 로 치환합니다. 5% 익절은 다음과 같이 데이터로 표현할 수 있습니다. - ‘max_close’ 가 5% 이상일 때 1, 아니면 0. 파이썬 코드는 아래와 같습니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">feature_all</span><span class="p">[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">&gt;=</span> <span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>타겟 변수 - ‘target’ 값이 1 인 비율을 보니, 약 24% 입니다. 타겟변수의 비율이 너무 적으면 모델 트레이닝이 어렵습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feature_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;feature_all.pkl&#39;</span><span class="p">)</span> 
<span class="n">feature_all</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">feature_all</span><span class="p">[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">&gt;=</span> <span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">feature_all</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;% of target:</span><span class="si">{</span><span class="n">target</span><span class="si">:</span><span class="s1"> 5.1%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>% of target: 24.3%
</pre></div>
</div>
</div>
</div>
<p><br> 날짜와 종목은 모델의 입력피처가 아닙니다. 편의를 위해 제거하거나 인덱스로 처리합니다. 모델 트레이닝 용도로 10,000 개 샘플을 뽑아 예측모델을 만들고, 나머지 데이터는 테스트(혹은 백테스팅)를 하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mdl_all</span> <span class="o">=</span> <span class="n">feature_all</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="n">feature_all</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;code&#39;</span><span class="p">])</span>

<span class="n">train</span> <span class="o">=</span> <span class="n">mdl_all</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">124</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">mdl_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">mdl_all</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10000 319307
</pre></div>
</div>
</div>
</div>
<p>입력 피처의 갯수와 데이터타입을 확인합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
MultiIndex: 10000 entries, (&#39;2021-10-22&#39;, &#39;312610&#39;) to (&#39;2021-04-28&#39;, &#39;011320&#39;)
Data columns (total 15 columns):
 #   Column              Non-Null Count  Dtype  
---  ------              --------------  -----  
 0   sector              10000 non-null  object 
 1   return              10000 non-null  float64
 2   kosdaq_return       10000 non-null  float64
 3   price_z             10000 non-null  float64
 4   volume_z            10000 non-null  float64
 5   num_high/close      10000 non-null  float64
 6   num_long            10000 non-null  float64
 7   num_z&gt;1.96          10000 non-null  float64
 8   num_win_market      10000 non-null  float64
 9   pct_win_market      10000 non-null  float64
 10  return over sector  10000 non-null  float64
 11  max_close           10000 non-null  float64
 12  mean_close          10000 non-null  float64
 13  min_close           10000 non-null  float64
 14  target              10000 non-null  int32  
dtypes: float64(13), int32(1), object(1)
memory usage: 1.2+ MB
</pre></div>
</div>
</div>
</div>
<p><br> 각 변수별로 다른 ‘lambda’ (Wiggliness Penalty Weight) 을 적용해서 grid Search 를 합니다. spline 수는 20 이 default 값입니다. spline 수는 고정하고 lambda의 최적 조합을 찾거나, lambda 를 고정하고, spline 수의 최적 조합을 찾는 것이 현실적이고, 두 하이퍼파라미터를 동시에 조합하여 grid Search 하는 것은 시간이 많이 걸립니다. 다양한 시도를 통하여 더 좋은 모델을 구현할 수 있겠으나, 이 책에서는 grid search 로 변수별 최적의 lambda 를 찾는 것으로 모델을 완성합니다. P value 가 크게 나타나는 입력변수는 제거하는 것이 좋겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pygam</span> <span class="kn">import</span> <span class="n">LogisticGAM</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">te</span><span class="p">,</span> <span class="n">l</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">log_loss</span>

<span class="n">feature_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">,</span><span class="s1">&#39;volume_z&#39;</span><span class="p">,</span><span class="s1">&#39;num_high/close&#39;</span><span class="p">,</span><span class="s1">&#39;num_win_market&#39;</span><span class="p">,</span><span class="s1">&#39;pct_win_market&#39;</span><span class="p">,</span><span class="s1">&#39;return over sector&#39;</span><span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">feature_list</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">feature_list</span><span class="p">]</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>

<span class="c1"># 하이퍼파라미터 설정 N 개의 변수면 (M x N) 개의 리스트로 생성함으로써 변수별로 다른 하이퍼파라미터 테스트 가능. </span>
<span class="c1"># M 개만 1D 리스트를 만들면 동일한 lambda 른 모든 변수에 적용함.</span>
<span class="n">lam_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span><span class="o">*</span><span class="mi">8</span>
   
<span class="n">gam</span> <span class="o">=</span> <span class="n">LogisticGAM</span><span class="p">(</span><span class="n">te</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_splines</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">s</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">s</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">te</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">n_splines</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">gridsearch</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">lam</span><span class="o">=</span><span class="n">lam_list</span><span class="p">)</span> 

<span class="nb">print</span><span class="p">(</span><span class="n">gam</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gam</span><span class="o">.</span><span class="n">accuracy</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100% (256 of 256) |######################| Elapsed Time: 0:03:32 Time:  0:03:32
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LogisticGAM                                                                                               
=============================================== ==========================================================
Distribution:                      BinomialDist Effective DoF:                                     21.7127
Link Function:                        LogitLink Log Likelihood:                                 -5473.5193
Number of Samples:                        10000 AIC:                                            10990.4639
                                                AICc:                                           10990.5719
                                                UBRE:                                               3.1008
                                                Scale:                                                 1.0
                                                Pseudo R-Squared:                                   0.0197
==========================================================================================================
Feature Function                  Lambda               Rank         EDoF         P &gt; x        Sig. Code   
================================= ==================== ============ ============ ============ ============
te(0, 1)                          [1. 1.]              25           6.2          1.11e-15     ***         
s(1)                              [1000.]              20           0.1          1.39e-04     ***         
s(2)                              [1000.]              20           1.8          1.65e-01                 
s(3)                              [1000.]              20           2.7          4.35e-02     *           
s(4)                              [1.]                 20           8.9          1.11e-11     ***         
te(4, 5)                          [1. 1.]              25           2.0          1.80e-01                 
intercept                                              1            0.0          2.07e-01                 
==========================================================================================================
Significance codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

WARNING: Fitting splines and a linear function to a feature introduces a model identifiability problem
         which can cause p-values to appear significant when they are not.

WARNING: p-values calculated in this manner behave correctly for un-penalized models or models with
         known smoothing parameters, but when smoothing parameters have been estimated, the p-values
         are typically lower than they should be, meaning that the tests reject the null too readily.
None
0.7571130530379218
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gam</span><span class="o">.</span><span class="n">terms</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0 tensor_term
1 spline_term
2 spline_term
3 spline_term
4 spline_term
5 tensor_term
6 intercept_term
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feature_list</span> <span class="o">=</span>  <span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">,</span><span class="s1">&#39;volume_z&#39;</span><span class="p">,</span><span class="s1">&#39;num_high/close&#39;</span><span class="p">,</span><span class="s1">&#39;num_win_market&#39;</span><span class="p">,</span><span class="s1">&#39;pct_win_market&#39;</span><span class="p">,</span><span class="s1">&#39;return over sector&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gam</span><span class="o">.</span><span class="n">terms</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">i</span><span class="o">&gt;=</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">i</span><span class="o">&lt;=</span><span class="mi">4</span><span class="p">:</span>

        <span class="n">XX</span> <span class="o">=</span> <span class="n">gam</span><span class="o">.</span><span class="n">generate_X_grid</span><span class="p">(</span><span class="n">term</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
        <span class="n">pdep</span><span class="p">,</span> <span class="n">confi</span> <span class="o">=</span> <span class="n">gam</span><span class="o">.</span><span class="n">partial_dependence</span><span class="p">(</span><span class="n">term</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">XX</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">XX</span><span class="p">[:,</span> <span class="n">term</span><span class="o">.</span><span class="n">feature</span><span class="p">],</span> <span class="n">pdep</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">XX</span><span class="p">[:,</span> <span class="n">term</span><span class="o">.</span><span class="n">feature</span><span class="p">],</span> <span class="n">confi</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">feature_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5.2.3_GAM_11_0.png" src="_images/5.2.3_GAM_11_0.png" />
<img alt="_images/5.2.3_GAM_11_1.png" src="_images/5.2.3_GAM_11_1.png" />
<img alt="_images/5.2.3_GAM_11_2.png" src="_images/5.2.3_GAM_11_2.png" />
<img alt="_images/5.2.3_GAM_11_3.png" src="_images/5.2.3_GAM_11_3.png" />
</div>
</div>
<p><br> 완성된 모델을 pickle 로 binary 파일로 저장합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;gam.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">gam</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;gam.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">gam</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">gam</span><span class="o">.</span><span class="n">get_params</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gam</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;max_iter&#39;: 100, &#39;tol&#39;: 0.0001, &#39;callbacks&#39;: [Deviance(), Diffs(), Accuracy()], &#39;verbose&#39;: False, &#39;terms&#39;: te(0, 1) + s(1) + s(2) + s(3) + s(4) + te(4, 5) + intercept, &#39;fit_intercept&#39;: True}
(131,)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">gam</span><span class="o">.</span><span class="n">_compute_p_value</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">:</span><span class="s1"> 5.3f</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">gam</span><span class="o">.</span><span class="n">generate_X_grid</span><span class="p">(</span><span class="n">term</span><span class="o">=</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0:  0.000 (10000, 6)
1:  0.000 (100, 6)
2:  0.165 (100, 6)
3:  0.043 (100, 6)
4:  0.000 (100, 6)
5:  0.180 (10000, 6)
</pre></div>
</div>
</div>
</div>
<p><br> 간단하게 십분위수 분석을 하고, 성능을 평가합니다. 안정적인 모델을 만들었습니다. 이론적으로는 마지막 Decile(제 10 십분위 수)에서 랜덤하게 종목을 골라 동일한 금액으로 매수를 한다면, 5 영업일이내 5% 익절할 확률이 37% 가 됩니다.  100% 만족스럽지는 않지만, 생성된 GAM 모델을 이용하여 종목 추천을 받도록 하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feature_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">,</span><span class="s1">&#39;volume_z&#39;</span><span class="p">,</span><span class="s1">&#39;num_high/close&#39;</span><span class="p">,</span><span class="s1">&#39;num_win_market&#39;</span><span class="p">,</span><span class="s1">&#39;pct_win_market&#39;</span><span class="p">,</span><span class="s1">&#39;return over sector&#39;</span><span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="n">feature_list</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">train</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">feature_list</span><span class="p">]</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>

<span class="n">yhat</span> <span class="o">=</span> <span class="n">gam</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
<span class="n">yhat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">yhat</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;yhat&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="n">yhat_test</span> <span class="o">=</span> <span class="n">gam</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
<span class="n">yhat_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">yhat_test</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;yhat&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">y_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">perf</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">yhat</span><span class="p">):</span> <span class="c1"># Decile 분석 함수</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="n">yhat</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ranks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">combined</span><span class="p">[</span><span class="s1">&#39;yhat&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">combined</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ranks</span><span class="p">)[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;count&#39;</span><span class="p">,</span><span class="s1">&#39;mean&#39;</span><span class="p">]))</span>
    <span class="n">combined</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ranks</span><span class="p">)[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">perf</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">yhat</span><span class="p">)</span>
<span class="n">perf</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">yhat_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                count  mean
yhat                       
(0.121, 0.184]   1000 0.144
(0.184, 0.198]   1000 0.183
(0.198, 0.21]    1000 0.195
(0.21, 0.222]    1000 0.193
(0.222, 0.235]   1000 0.229
(0.235, 0.251]   1000 0.231
(0.251, 0.268]   1000 0.294
(0.268, 0.291]   1000 0.281
(0.291, 0.326]   1000 0.310
(0.326, 0.688]   1000 0.382
                 count  mean
yhat                        
(0.0342, 0.184]  31931 0.156
(0.184, 0.198]   31931 0.182
(0.198, 0.209]   31930 0.192
(0.209, 0.221]   31931 0.203
(0.221, 0.234]   31931 0.224
(0.234, 0.249]   31930 0.238
(0.249, 0.267]   31931 0.259
(0.267, 0.292]   31930 0.283
(0.292, 0.327]   31931 0.320
(0.327, 0.783]   31931 0.373
</pre></div>
</div>
<img alt="_images/5.2.3_GAM_19_1.png" src="_images/5.2.3_GAM_19_1.png" />
</div>
</div>
</section>
<section id="basic-filtering">
<h3>Basic Filtering<a class="headerlink" href="#basic-filtering" title="Permalink to this headline">#</a></h3>
<p>단순히 스코어가 높다고 무조건 매수했다가 큰 낙폭으로 손해를 볼 수도 있기 때문에 기본적인 필터링이 필요합니다. 오늘 종가 수익률과 가격 변동성으로 기본적인 필터를 만들어 보겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;yhat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat_test</span>
<span class="n">test</span><span class="p">[</span><span class="s1">&#39;yhat_rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;yhat&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">test</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;yhat_rank&#39;</span><span class="p">)[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>yhat_rank
(0.0342, 0.184]   0.156
(0.184, 0.198]    0.182
(0.198, 0.209]    0.192
(0.209, 0.221]    0.203
(0.221, 0.234]    0.224
(0.234, 0.249]    0.238
(0.249, 0.267]    0.259
(0.267, 0.292]    0.283
(0.292, 0.327]    0.320
(0.327, 0.783]    0.373
Name: target, dtype: float64
</pre></div>
</div>
</div>
</div>
<p><br> 종목선정은 상위 스코어 구간에서 할 것이므로 상위 구간에서 대하여 수익률 및 표준화 가격 구간으로 분리해서 미래 수익률을 보겠습니다. 표준화된 가격이 낮고 당일 수익율이 높은 경우 미래 수익률이 높을 것으로 예상됩니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tops</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="n">test</span><span class="p">[</span><span class="s1">&#39;yhat&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">tops</span><span class="p">[</span><span class="s1">&#39;return_rank&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">tops</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># 종가 수익률</span>
<span class="n">tops</span><span class="p">[</span><span class="s1">&#39;price_rank&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">tops</span><span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">],</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># 가격 변동성</span>
<span class="n">tops</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;return_rank&#39;</span><span class="p">,</span><span class="s1">&#39;price_rank&#39;</span><span class="p">])[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_904a2_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="index_name level0" >price_rank</th>
      <th class="col_heading level0 col0" >(-4.36, -1.836]</th>
      <th class="col_heading level0 col1" >(-1.836, -0.962]</th>
      <th class="col_heading level0 col2" >(-0.962, 0.529]</th>
      <th class="col_heading level0 col3" >(0.529, 1.659]</th>
      <th class="col_heading level0 col4" >(1.659, 4.359]</th>
    </tr>
    <tr>
      <th class="index_name level0" >return_rank</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_904a2_level0_row0" class="row_heading level0 row0" >(0.325, 0.958]</th>
      <td id="T_904a2_row0_col0" class="data row0 col0" >0.467728</td>
      <td id="T_904a2_row0_col1" class="data row0 col1" >0.401386</td>
      <td id="T_904a2_row0_col2" class="data row0 col2" >0.365480</td>
      <td id="T_904a2_row0_col3" class="data row0 col3" >0.402558</td>
      <td id="T_904a2_row0_col4" class="data row0 col4" >0.352185</td>
    </tr>
    <tr>
      <th id="T_904a2_level0_row1" class="row_heading level0 row1" >(0.958, 0.98]</th>
      <td id="T_904a2_row1_col0" class="data row1 col0" >0.323312</td>
      <td id="T_904a2_row1_col1" class="data row1 col1" >0.322218</td>
      <td id="T_904a2_row1_col2" class="data row1 col2" >0.312813</td>
      <td id="T_904a2_row1_col3" class="data row1 col3" >0.371080</td>
      <td id="T_904a2_row1_col4" class="data row1 col4" >0.380762</td>
    </tr>
    <tr>
      <th id="T_904a2_level0_row2" class="row_heading level0 row2" >(0.98, 1.0]</th>
      <td id="T_904a2_row2_col0" class="data row2 col0" >0.247881</td>
      <td id="T_904a2_row2_col1" class="data row2 col1" >0.301568</td>
      <td id="T_904a2_row2_col2" class="data row2 col2" >0.303585</td>
      <td id="T_904a2_row2_col3" class="data row2 col3" >0.335506</td>
      <td id="T_904a2_row2_col4" class="data row2 col4" >0.329555</td>
    </tr>
    <tr>
      <th id="T_904a2_level0_row3" class="row_heading level0 row3" >(1.0, 1.031]</th>
      <td id="T_904a2_row3_col0" class="data row3 col0" >0.385084</td>
      <td id="T_904a2_row3_col1" class="data row3 col1" >0.341678</td>
      <td id="T_904a2_row3_col2" class="data row3 col2" >0.318606</td>
      <td id="T_904a2_row3_col3" class="data row3 col3" >0.339809</td>
      <td id="T_904a2_row3_col4" class="data row3 col4" >0.330736</td>
    </tr>
    <tr>
      <th id="T_904a2_level0_row4" class="row_heading level0 row4" >(1.031, 1.3]</th>
      <td id="T_904a2_row4_col0" class="data row4 col0" >0.670000</td>
      <td id="T_904a2_row4_col1" class="data row4 col1" >0.471311</td>
      <td id="T_904a2_row4_col2" class="data row4 col2" >0.335314</td>
      <td id="T_904a2_row4_col3" class="data row4 col3" >0.379326</td>
      <td id="T_904a2_row4_col4" class="data row4 col4" >0.368984</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> 참고로 groupby 로 데이터를 요약하는 방법은 직관적이나, 각 행과 열의 총계는 보여주지 않는다는 단점이 있습니다. 총계가 보고 싶을 때는 pivot_table 에서 ‘margins=True’ 를 인수로 넣어주면 총계를 볼 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">tops</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="s1">&#39;return_rank&#39;</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="s1">&#39;price_rank&#39;</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">margins</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_843af_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="index_name level0" >price_rank</th>
      <th class="col_heading level0 col0" >(-4.36, -1.836]</th>
      <th class="col_heading level0 col1" >(-1.836, -0.962]</th>
      <th class="col_heading level0 col2" >(-0.962, 0.529]</th>
      <th class="col_heading level0 col3" >(0.529, 1.659]</th>
      <th class="col_heading level0 col4" >(1.659, 4.359]</th>
      <th class="col_heading level0 col5" >All</th>
    </tr>
    <tr>
      <th class="index_name level0" >return_rank</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_843af_level0_row0" class="row_heading level0 row0" >(0.325, 0.958]</th>
      <td id="T_843af_row0_col0" class="data row0 col0" >0.467728</td>
      <td id="T_843af_row0_col1" class="data row0 col1" >0.401386</td>
      <td id="T_843af_row0_col2" class="data row0 col2" >0.365480</td>
      <td id="T_843af_row0_col3" class="data row0 col3" >0.402558</td>
      <td id="T_843af_row0_col4" class="data row0 col4" >0.352185</td>
      <td id="T_843af_row0_col5" class="data row0 col5" >0.419958</td>
    </tr>
    <tr>
      <th id="T_843af_level0_row1" class="row_heading level0 row1" >(0.958, 0.98]</th>
      <td id="T_843af_row1_col0" class="data row1 col0" >0.323312</td>
      <td id="T_843af_row1_col1" class="data row1 col1" >0.322218</td>
      <td id="T_843af_row1_col2" class="data row1 col2" >0.312813</td>
      <td id="T_843af_row1_col3" class="data row1 col3" >0.371080</td>
      <td id="T_843af_row1_col4" class="data row1 col4" >0.380762</td>
      <td id="T_843af_row1_col5" class="data row1 col5" >0.331053</td>
    </tr>
    <tr>
      <th id="T_843af_level0_row2" class="row_heading level0 row2" >(0.98, 1.0]</th>
      <td id="T_843af_row2_col0" class="data row2 col0" >0.247881</td>
      <td id="T_843af_row2_col1" class="data row2 col1" >0.301568</td>
      <td id="T_843af_row2_col2" class="data row2 col2" >0.303585</td>
      <td id="T_843af_row2_col3" class="data row2 col3" >0.335506</td>
      <td id="T_843af_row2_col4" class="data row2 col4" >0.329555</td>
      <td id="T_843af_row2_col5" class="data row2 col5" >0.302817</td>
    </tr>
    <tr>
      <th id="T_843af_level0_row3" class="row_heading level0 row3" >(1.0, 1.031]</th>
      <td id="T_843af_row3_col0" class="data row3 col0" >0.385084</td>
      <td id="T_843af_row3_col1" class="data row3 col1" >0.341678</td>
      <td id="T_843af_row3_col2" class="data row3 col2" >0.318606</td>
      <td id="T_843af_row3_col3" class="data row3 col3" >0.339809</td>
      <td id="T_843af_row3_col4" class="data row3 col4" >0.330736</td>
      <td id="T_843af_row3_col5" class="data row3 col5" >0.335920</td>
    </tr>
    <tr>
      <th id="T_843af_level0_row4" class="row_heading level0 row4" >(1.031, 1.3]</th>
      <td id="T_843af_row4_col0" class="data row4 col0" >0.670000</td>
      <td id="T_843af_row4_col1" class="data row4 col1" >0.471311</td>
      <td id="T_843af_row4_col2" class="data row4 col2" >0.335314</td>
      <td id="T_843af_row4_col3" class="data row4 col3" >0.379326</td>
      <td id="T_843af_row4_col4" class="data row4 col4" >0.368984</td>
      <td id="T_843af_row4_col5" class="data row4 col5" >0.376038</td>
    </tr>
    <tr>
      <th id="T_843af_level0_row5" class="row_heading level0 row5" >All</th>
      <td id="T_843af_row5_col0" class="data row5 col0" >0.376790</td>
      <td id="T_843af_row5_col1" class="data row5 col1" >0.343522</td>
      <td id="T_843af_row5_col2" class="data row5 col2" >0.325730</td>
      <td id="T_843af_row5_col3" class="data row5 col3" >0.363139</td>
      <td id="T_843af_row5_col4" class="data row5 col4" >0.355839</td>
      <td id="T_843af_row5_col5" class="data row5 col5" >0.353005</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> 최저 수익률(리스크)도 조사합니다. 당일 수익률 높고, 표준화 된 주가가 낮은 좌하단 부분의 리스크가 낮습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">tops</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="s1">&#39;return_rank&#39;</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="s1">&#39;price_rank&#39;</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="s1">&#39;min_close&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">margins</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_24612_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="index_name level0" >price_rank</th>
      <th class="col_heading level0 col0" >(-4.36, -1.836]</th>
      <th class="col_heading level0 col1" >(-1.836, -0.962]</th>
      <th class="col_heading level0 col2" >(-0.962, 0.529]</th>
      <th class="col_heading level0 col3" >(0.529, 1.659]</th>
      <th class="col_heading level0 col4" >(1.659, 4.359]</th>
      <th class="col_heading level0 col5" >All</th>
    </tr>
    <tr>
      <th class="index_name level0" >return_rank</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_24612_level0_row0" class="row_heading level0 row0" >(0.325, 0.958]</th>
      <td id="T_24612_row0_col0" class="data row0 col0" >0.971249</td>
      <td id="T_24612_row0_col1" class="data row0 col1" >0.955960</td>
      <td id="T_24612_row0_col2" class="data row0 col2" >0.950540</td>
      <td id="T_24612_row0_col3" class="data row0 col3" >0.949295</td>
      <td id="T_24612_row0_col4" class="data row0 col4" >0.936891</td>
      <td id="T_24612_row0_col5" class="data row0 col5" >0.959307</td>
    </tr>
    <tr>
      <th id="T_24612_level0_row1" class="row_heading level0 row1" >(0.958, 0.98]</th>
      <td id="T_24612_row1_col0" class="data row1 col0" >0.968130</td>
      <td id="T_24612_row1_col1" class="data row1 col1" >0.961449</td>
      <td id="T_24612_row1_col2" class="data row1 col2" >0.955620</td>
      <td id="T_24612_row1_col3" class="data row1 col3" >0.955920</td>
      <td id="T_24612_row1_col4" class="data row1 col4" >0.948468</td>
      <td id="T_24612_row1_col5" class="data row1 col5" >0.961134</td>
    </tr>
    <tr>
      <th id="T_24612_level0_row2" class="row_heading level0 row2" >(0.98, 1.0]</th>
      <td id="T_24612_row2_col0" class="data row2 col0" >0.963653</td>
      <td id="T_24612_row2_col1" class="data row2 col1" >0.965476</td>
      <td id="T_24612_row2_col2" class="data row2 col2" >0.958850</td>
      <td id="T_24612_row2_col3" class="data row2 col3" >0.955340</td>
      <td id="T_24612_row2_col4" class="data row2 col4" >0.945676</td>
      <td id="T_24612_row2_col5" class="data row2 col5" >0.959550</td>
    </tr>
    <tr>
      <th id="T_24612_level0_row3" class="row_heading level0 row3" >(1.0, 1.031]</th>
      <td id="T_24612_row3_col0" class="data row3 col0" >0.971163</td>
      <td id="T_24612_row3_col1" class="data row3 col1" >0.965972</td>
      <td id="T_24612_row3_col2" class="data row3 col2" >0.958342</td>
      <td id="T_24612_row3_col3" class="data row3 col3" >0.953141</td>
      <td id="T_24612_row3_col4" class="data row3 col4" >0.952475</td>
      <td id="T_24612_row3_col5" class="data row3 col5" >0.958020</td>
    </tr>
    <tr>
      <th id="T_24612_level0_row4" class="row_heading level0 row4" >(1.031, 1.3]</th>
      <td id="T_24612_row4_col0" class="data row4 col0" >0.992942</td>
      <td id="T_24612_row4_col1" class="data row4 col1" >0.970208</td>
      <td id="T_24612_row4_col2" class="data row4 col2" >0.950858</td>
      <td id="T_24612_row4_col3" class="data row4 col3" >0.947691</td>
      <td id="T_24612_row4_col4" class="data row4 col4" >0.948263</td>
      <td id="T_24612_row4_col5" class="data row4 col5" >0.950377</td>
    </tr>
    <tr>
      <th id="T_24612_level0_row5" class="row_heading level0 row5" >All</th>
      <td id="T_24612_row5_col0" class="data row5 col0" >0.969054</td>
      <td id="T_24612_row5_col1" class="data row5 col1" >0.963253</td>
      <td id="T_24612_row5_col2" class="data row5 col2" >0.955302</td>
      <td id="T_24612_row5_col3" class="data row5 col3" >0.952232</td>
      <td id="T_24612_row5_col4" class="data row5 col4" >0.948584</td>
      <td id="T_24612_row5_col5" class="data row5 col5" >0.957685</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> 위 결과를 종합하면 당일 종가 수익률은 높고, 최근 20일 대비 가격이 낮은 종목을 매수하면 리스크가 적을 것으로 판단됩니다. ‘return’ 은 1.03 보다 크고, ‘price_z’ 는 0 보다 작은 종목만을 고르겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tops</span><span class="p">[</span> <span class="p">(</span><span class="n">tops</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.03</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tops</span><span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)][[</span><span class="s1">&#39;return&#39;</span><span class="p">,</span><span class="s1">&#39;price_z&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_2d825_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank" >&nbsp;</th>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >return</th>
      <th class="col_heading level0 col1" >price_z</th>
    </tr>
    <tr>
      <th class="index_name level0" >&nbsp;</th>
      <th class="index_name level1" >code</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_2d825_level0_row0" class="row_heading level0 row0" >2021-05-26</th>
      <th id="T_2d825_level1_row0" class="row_heading level1 row0" >037440</th>
      <td id="T_2d825_row0_col0" class="data row0 col0" >1.038084</td>
      <td id="T_2d825_row0_col1" class="data row0 col1" >-0.747394</td>
    </tr>
    <tr>
      <th id="T_2d825_level0_row1" class="row_heading level0 row1" >2021-06-24</th>
      <th id="T_2d825_level1_row1" class="row_heading level1 row1" >037440</th>
      <td id="T_2d825_row1_col0" class="data row1 col0" >1.050481</td>
      <td id="T_2d825_row1_col1" class="data row1 col1" >-0.605273</td>
    </tr>
    <tr>
      <th id="T_2d825_level0_row2" class="row_heading level0 row2" >2022-03-10</th>
      <th id="T_2d825_level1_row2" class="row_heading level1 row2" >037440</th>
      <td id="T_2d825_row2_col0" class="data row2 col0" >1.147170</td>
      <td id="T_2d825_row2_col1" class="data row2 col1" >-0.495290</td>
    </tr>
    <tr>
      <th id="T_2d825_level0_row3" class="row_heading level0 row3" >2021-04-19</th>
      <th id="T_2d825_level1_row3" class="row_heading level1 row3" >189980</th>
      <td id="T_2d825_row3_col0" class="data row3 col0" >1.031782</td>
      <td id="T_2d825_row3_col1" class="data row3 col1" >-1.108919</td>
    </tr>
    <tr>
      <th id="T_2d825_level0_row4" class="row_heading level0 row4" >2021-10-07</th>
      <th id="T_2d825_level1_row4" class="row_heading level1 row4" >189980</th>
      <td id="T_2d825_row4_col0" class="data row4 col0" >1.073741</td>
      <td id="T_2d825_row4_col1" class="data row4 col1" >-1.231395</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<span id="document-chapter5/5.2.4_LM_Assumptions"></span><section id="id1">
<h3>선형모델 가정에 대한 이해<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>왜 매수결정을 했는지에 대한 이유를 구체적으로 설명하기 유리한 모델은 Linear Model 입니다. 그 중 다변량 회귀모델 (Multivariate Linear Regression) 은 데이터분석을 배울 때, 가장 기초적으로 다루는 예측모델입니다. 예측하고자 하는 종속변수 Y (레이블 혹은 타겟 변수) 가 연속형이고, 이것을 설명 혹은 예측하는 독립변수 X (입력피쳐 혹은 입력변수) 들의 선형조합 Z 로 Fitting 을 하는 것인데, 충분한 이해없이 사용하면, 잘못된 결론을 내기 쉽습니다. 다변량 회귀분석 모델이 의미가 있을려면, 데이터가 상당히 강한 Assumptions 를 만족해야 합니다. 중요한 4 가지는 다음과 같습니다.</p>
<ol class="simple">
<li><p>Normality - 에러(실제값 - 예측값)가 정규분포를 따라야한다. 사실 이건 Y 가 정규분포를 따라야 한다는 것과 크게 다르지 않습니다.</p></li>
<li><p>Weak Heteroscedasticity - 에러가 등분산성을 만족해야 한다. 즉 에러의 분산이 예측 값의 크기에 따라서 크게 변화하지 않아야 한다.</p></li>
<li><p>Linearity - 선형성. 이것은 추정된 베타값이 X 값의 크기에 따라서 변화하지 않아야 한다. 예를 들어, 소득을 추정하는데, 카드 사용량이 변수라면 카드 월 사용량이 백만원일 때 추정된 계수(coefficient) 가 50 이라면, 카드 사용량이 천 만원일때도 베타 계수가 50이여야 한다는 말입니다.</p></li>
<li><p>Weak Multicollinearity - (다중 공선성)이 크지 않아야 한다. 쉽게 이야기 하면 어떤 여러개의 X 가 Y 를 설명하는데 있어서 X 들이 같은 방향으로 움직이면 안 된다고 이해하면 될 것 같습니다. 다중 공선성이 큰 경우는 계수 값이 정확하지 않아서, 계수에 대한 해석이 불가능하게 됩니다. 아주 심한 경우는 다른 변수의 영향으로 양의 계수가 음의 계수로 바뀌게 됩니다.</p></li>
</ol>
<p>위 가정 1 번과 2 번을 만족하지 않아도 Regression 을 할 수 있게 일반화 한 것이 일반화 회귀모형(Generalized Linear Model) 입니다. GLM 에서는 Y 가 갯수(count), 비율(proportion), 이진(0과 1) 등 같이 연속형 변수가 아니고 정규 분포를 따르지 않아도 선형모델을 구현할 수 있습니다. 물론 등분산성을 만족하지 않아도 됩니다. 대신에 Y 에 대한 명확한 분포 설정과 Y 에 대한 Link Function 필요합니다. 가장 많이 쓰이는 것이 Log Link 입니다. 이 부분을 쉽게 이해하기 위해서는 이렇게 생각하면 됩니다. X 의 선형조합 Z 는 음수의 값도 갖게 되는데, 비율이나, 갯수는 항상 양수입니다. 따라서 Y 에 Log 를 씌워서 음수를 갖게 할 수 있습니다. 반대로 EXP( a0 + a1<em>x1 + a2</em>x2 …) 로 항상 양수인 Y 를 Fitting 한다고 보시면 될 것 같습니다. 많이 다루는 로지스틱 회귀 모델은 Log(odds) 를 X 의 선형조합으로 Fitting 을 하는 일반화 선형모형의 한 예로 볼 수 있습니다. 데이터상으로는 Y 가 이항분포(Bernoulli 분포 혹은 0 과 1) 이므로 Link Function 가 Logit Link 즉, log(p/1-p) 로 하는 일반화 선형모형과 동일한 의미가 됩니다.  Y 가 0 과 1 이므로 이것을 가장 잘 근사하게 따라갈 수 있는 변형은 Logit Link 인 것입니다. logit Link 를 풀면 Y = exp(z) / 1 + exp(z) 가 됩니다. 즉 Y 를 설명하기에 좋은 형태로 변경이 되는 것입니다. Y 가  개 수(count) 인 경우는 포아송 회귀분석 (Poisson regression) 입니다. 주어진 시간 혹은 범위에서 뽑은 count 샘플은 포아송 분포를 따라간다는 것이 알려져 있습니다. 예를 들면 인구 만명당 암 발생 환자 수 등이 예가 될 것 같습니다. 포아송 분포의 평균과 분산은 같습니다. 즉 평균이 증가하면 분산이 증가하는 분포입니다. 따라서 등분산성을 만족하지 않아도 Y 를 fitting 할 수 있습니다. 이 경우, Link 는 log 입니다. 즉, X 의 선형조합인 Z 에 Exponential 를 씌워서 양수가 되도록 합니다. Y 가 비율(Proportion) 인 경우도 있습니다. 그럼 비율은 어떤 분포일지 궁금합니다. 비율은 항상 0 과 1 사이 양수이므로 Link 함수는 log link 를 쓰면 될 것 같습니다. 일반적으로 비율은 분자의 특성에 따라 분포가 바뀔 수 있습니다. 위에 예시한 인구 만명 당 암환자의 비율은 GLM 으로 Fitting (Y ~ Normal 분포, Log link) 할 수 있습니다. 하지만 더 Fitting 을 잘 하려면 분자를 Y 로 하고 분모인 인구 수를 exposure 요인으로 처리하는 것입니다. 이 경우 당연히 Y 는 포아송분포가 됩니다.  log(암 환수/인구 수) = Z(X 선형조합)  형태의 모델을 (암 환자수) = exp(Z)*(인구수) 이렇게 변경하는 것과 동일합니다. 그럼 여기서 인구수가 exposure 가 되고, 인구수를 고려하여 Z 에 계수값을 추정하게 됩니다. Proportion 을 Y 로  fitting 하는 것보다 훨씬 좋은 결과가 나옵니다.</p>
<p>마지막으로 3 번째 가정이 선형성을 만족하지 않아도 쓸 수 있는 Linear Model 이 있습니다.  Generalized Additive Model (GAM) 인데, 이경우는 spline 함수를 이용하여 각 X 를 곡선으로 만들어 Y 와 fitting 합니다. 예를 들어 Y 가 그랜저를 살 확률이고, X 가 소득이라고 할 때, 소득이 증가함에 따라 그랜저를 살 확률은 증가하다가 어느 순간 다시 감소할 것 입니다. 그럼 2 차원 곡선이 되는데요. 이런 경우도 소득을 spline 함수(곡선형태)로 만들면 Y 를 잘 Fitting 할 수 있습니다.</p>
<p>마지막 4 번째 가정은 선형모형의 구조상 피할 수 가 없습니다. 공선성을 일으키는 입력 변수를 빼거나, 주성분등으로 공선성을 완전히 제거해야 합니다. 기본적으로 Linear 모델이라는 것은 X 의 합으로 연결이 되어 있습니다. 따라서 Fitting 된 모델에서 X1 이 1 증가할 때,  X2 도 1 증가하는 구조라면, X1 와 X2 의 계수의 추정은 해석하기 어렵게 됩니다. 하지만, 이런 구조이기 때문에 잘 fitting 된 선형모델에서는 X 변화에 따른 Y 의 변화를 이해할 수 있는 장점으로 작용합니다. 요즘 관심을 받고 있는 해석가능한 모델이 되는 것입니다.</p>
</section>
</div>
</section>
</div>
<div class="toctree-wrapper compound">
<span id="document-chapter6/6.0.0_Effectiveness_Testing"></span><section id="id1">
<h2><strong>해결책의 효과 측정</strong><a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<p>앞서 입증된 가설을 활용하며 예측모델을 구현했습니다. 이제 완성된 모델을 이용하여 종목 추천을 받는 전체 프로세스를 만들어보겠습니다.
오늘이 2022년 4월 1일라고 가정하고 어떤 종목들이 추천되는 지 보겠습니다. 4월1일 장 마감 후 프로그램을 돌려 추천 종목을 받고, 익일(4월 2일) 날 4월 1일의 종가에 매수를 하는 전략입니다.</p>
<div class="toctree-wrapper compound">
<span id="document-chapter6/6.1.1_Stock_Selection"></span><section id="id1">
<h3>종목 추천 프로세스<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>완성된 모델을 이용하여 종목 추천을 받는 프로세스를 순서대로 만들어보겠습니다.
오늘이 2022년 4월 1일라고 가정하고 어떤 종목들이 추천되는 지 보겠습니다. 4월1일 장 마감 후 프로그램을 돌려 추천 종목을 받고, 익일(4월 2일) 날 4월 1일의 종가에 매수를 하는 전략입니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">bs4</span>

<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</pre></div>
</div>
</div>
</div>
<p><br> 오늘이 2022년 4월 1일라고 가정하고 어떤 종목들이 추천되는 지 보겠습니다. 먼저 오늘 기준으로 100 일전 날짜를 timedelta 를 이용해 찾습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="n">today_dt</span> <span class="o">=</span> <span class="s1">&#39;2022-04-01&#39;</span>
<span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">today_dt</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">start_dt</span> <span class="o">=</span> <span class="n">today</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># 100 일전 데이터 부터 시작 - 피쳐 엔지니어링은 최소 60 개의 일봉이 필요함</span>
<span class="nb">print</span><span class="p">(</span><span class="n">start_dt</span><span class="p">,</span> <span class="n">today_dt</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-12-22 00:00:00 2022-04-01
</pre></div>
</div>
</div>
</div>
<p><br> 위 코드에서 찾은 시작일부터 오늘까지 종목별로 일봉을 가져와서 데이터셋을 구성합니다. 총 67 개의 일봉이 있습니다. 입력 피처를 생성하기 위해서는 최소한 60일의 데이터가 필요합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span>

<span class="n">price_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]):</span>  <span class="c1"># 코스닥 모든 종목에서 대하여 반복</span>
    <span class="n">daily_price</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">code</span><span class="p">,</span>  <span class="n">start</span> <span class="o">=</span> <span class="n">start_dt</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">today_dt</span><span class="p">)</span> <span class="c1"># 종목, 일봉, 데이터 갯수</span>
    <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
    <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">price_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">price_data</span><span class="p">,</span> <span class="n">daily_price</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>   

<span class="n">price_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>
<span class="n">price_data</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span> <span class="n">price_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="c1"># 컬럼 이름 소문자로 변경</span>

<span class="nb">print</span><span class="p">(</span><span class="n">price_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>67
</pre></div>
</div>
</div>
</div>
<p><br> 주가지수 데이터를 가져오고, 일봉데이터에 추가합니다. 그리고 결과물을 merge 라는 이름으로 저장합니다. FinanceDataReader 에서 지수데이터가 수집이 안 될 경우, 야후 파이낸스를 이용할 수 도 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kosdaq_index</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s1">&#39;KQ11&#39;</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="n">start_dt</span><span class="p">)</span> <span class="c1"># 데이터 호출</span>
<span class="n">kosdaq_index</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="s1">&#39;high&#39;</span><span class="p">,</span><span class="s1">&#39;low&#39;</span><span class="p">,</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span><span class="s1">&#39;change&#39;</span><span class="p">]</span> <span class="c1"># 컬럼명 변경</span>
<span class="n">kosdaq_index</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;date&#39;</span> <span class="c1"># 인덱스 이름 생성</span>
<span class="n">kosdaq_index</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># 인덱스(날짜) 로 정렬 </span>
<span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 수익율 : 전 날 종가대비 당일 종가</span>

<span class="n">merged</span> <span class="o">=</span> <span class="n">price_data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">],</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">merged</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;merged.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>야후 파이낸스에서 지수 데이터 수집은 아래와 같이 할 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>

<span class="n">kosdaq_index</span> <span class="o">=</span>  <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;^KQ11&#39;</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="n">start_dt</span><span class="p">)</span> <span class="c1"># 데이터 호출</span>
<span class="n">kosdaq_index</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="s1">&#39;high&#39;</span><span class="p">,</span><span class="s1">&#39;low&#39;</span><span class="p">,</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="s1">&#39;adj_close&#39;</span><span class="p">,</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="c1"># 컬럼명 변경</span>
<span class="n">kosdaq_index</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;date&#39;</span> <span class="c1"># 인덱스 이름 생성</span>
<span class="n">kosdaq_index</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># 인덱스(날짜) 로 정렬 </span>
<span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 수익율 : 전 날 종가대비 당일 종가</span>

<span class="n">merged</span> <span class="o">=</span> <span class="n">price_data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">],</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">merged</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;merged.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[*********************100%***********************]  1 of 1 completed
</pre></div>
</div>
</div>
</div>
<p><br> 주가 지수 수익률과 종목별 수익율을 비교한 결과를 win_market 이라는 변수에 담습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;merged.pkl&#39;</span><span class="p">)</span>

<span class="n">return_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]:</span>  
    
    <span class="n">stock_return</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">merged</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    <span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 종목별 전일 종가 대비 당일 종가 수익율</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># 수익율 1 보다 작음. 당일 종가가 전일 종가보다 낮음 (코스닥 지표)</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># 수익율 1 보다 큼. 당일 종가가 전일 종가보다 큼 (개별 종목)</span>
    <span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;win_market&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">c1</span><span class="o">&amp;</span><span class="n">c2</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># C1 과 C2 조건을 동시에 만족하면 1, 아니면 0</span>
    <span class="n">return_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">return_all</span><span class="p">,</span> <span class="n">stock_return</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> 
    
<span class="n">return_all</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    
</pre></div>
</div>
</div>
</div>
<p><br> 데이터가 잘 생성되었는 지 확인해 봅니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">return_all</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_94fa7_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >open</th>
      <th class="col_heading level0 col1" >high</th>
      <th class="col_heading level0 col2" >low</th>
      <th class="col_heading level0 col3" >close</th>
      <th class="col_heading level0 col4" >volume</th>
      <th class="col_heading level0 col5" >change</th>
      <th class="col_heading level0 col6" >code</th>
      <th class="col_heading level0 col7" >name</th>
      <th class="col_heading level0 col8" >kosdaq_return</th>
      <th class="col_heading level0 col9" >return</th>
      <th class="col_heading level0 col10" >win_market</th>
    </tr>
    <tr>
      <th class="index_name level0" >date</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
      <th class="blank col7" >&nbsp;</th>
      <th class="blank col8" >&nbsp;</th>
      <th class="blank col9" >&nbsp;</th>
      <th class="blank col10" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_94fa7_level0_row0" class="row_heading level0 row0" >2021-12-23 00:00:00</th>
      <td id="T_94fa7_row0_col0" class="data row0 col0" >3195</td>
      <td id="T_94fa7_row0_col1" class="data row0 col1" >3260</td>
      <td id="T_94fa7_row0_col2" class="data row0 col2" >3195</td>
      <td id="T_94fa7_row0_col3" class="data row0 col3" >3220</td>
      <td id="T_94fa7_row0_col4" class="data row0 col4" >104180</td>
      <td id="T_94fa7_row0_col5" class="data row0 col5" >-0.002</td>
      <td id="T_94fa7_row0_col6" class="data row0 col6" >060310</td>
      <td id="T_94fa7_row0_col7" class="data row0 col7" >3S</td>
      <td id="T_94fa7_row0_col8" class="data row0 col8" >1.003</td>
      <td id="T_94fa7_row0_col9" class="data row0 col9" >0.998</td>
      <td id="T_94fa7_row0_col10" class="data row0 col10" >0</td>
    </tr>
    <tr>
      <th id="T_94fa7_level0_row1" class="row_heading level0 row1" >2021-12-24 00:00:00</th>
      <td id="T_94fa7_row1_col0" class="data row1 col0" >3230</td>
      <td id="T_94fa7_row1_col1" class="data row1 col1" >3355</td>
      <td id="T_94fa7_row1_col2" class="data row1 col2" >3220</td>
      <td id="T_94fa7_row1_col3" class="data row1 col3" >3290</td>
      <td id="T_94fa7_row1_col4" class="data row1 col4" >238933</td>
      <td id="T_94fa7_row1_col5" class="data row1 col5" >0.022</td>
      <td id="T_94fa7_row1_col6" class="data row1 col6" >060310</td>
      <td id="T_94fa7_row1_col7" class="data row1 col7" >3S</td>
      <td id="T_94fa7_row1_col8" class="data row1 col8" >1.004</td>
      <td id="T_94fa7_row1_col9" class="data row1 col9" >1.022</td>
      <td id="T_94fa7_row1_col10" class="data row1 col10" >0</td>
    </tr>
    <tr>
      <th id="T_94fa7_level0_row2" class="row_heading level0 row2" >2021-12-27 00:00:00</th>
      <td id="T_94fa7_row2_col0" class="data row2 col0" >3290</td>
      <td id="T_94fa7_row2_col1" class="data row2 col1" >3380</td>
      <td id="T_94fa7_row2_col2" class="data row2 col2" >3275</td>
      <td id="T_94fa7_row2_col3" class="data row2 col3" >3305</td>
      <td id="T_94fa7_row2_col4" class="data row2 col4" >130826</td>
      <td id="T_94fa7_row2_col5" class="data row2 col5" >0.005</td>
      <td id="T_94fa7_row2_col6" class="data row2 col6" >060310</td>
      <td id="T_94fa7_row2_col7" class="data row2 col7" >3S</td>
      <td id="T_94fa7_row2_col8" class="data row2 col8" >1.004</td>
      <td id="T_94fa7_row2_col9" class="data row2 col9" >1.005</td>
      <td id="T_94fa7_row2_col10" class="data row2 col10" >0</td>
    </tr>
    <tr>
      <th id="T_94fa7_level0_row3" class="row_heading level0 row3" >2021-12-28 00:00:00</th>
      <td id="T_94fa7_row3_col0" class="data row3 col0" >3355</td>
      <td id="T_94fa7_row3_col1" class="data row3 col1" >3355</td>
      <td id="T_94fa7_row3_col2" class="data row3 col2" >3180</td>
      <td id="T_94fa7_row3_col3" class="data row3 col3" >3190</td>
      <td id="T_94fa7_row3_col4" class="data row3 col4" >267316</td>
      <td id="T_94fa7_row3_col5" class="data row3 col5" >-0.035</td>
      <td id="T_94fa7_row3_col6" class="data row3 col6" >060310</td>
      <td id="T_94fa7_row3_col7" class="data row3 col7" >3S</td>
      <td id="T_94fa7_row3_col8" class="data row3 col8" >1.016</td>
      <td id="T_94fa7_row3_col9" class="data row3 col9" >0.965</td>
      <td id="T_94fa7_row3_col10" class="data row3 col10" >0</td>
    </tr>
    <tr>
      <th id="T_94fa7_level0_row4" class="row_heading level0 row4" >2021-12-29 00:00:00</th>
      <td id="T_94fa7_row4_col0" class="data row4 col0" >3200</td>
      <td id="T_94fa7_row4_col1" class="data row4 col1" >3350</td>
      <td id="T_94fa7_row4_col2" class="data row4 col2" >3200</td>
      <td id="T_94fa7_row4_col3" class="data row4 col3" >3330</td>
      <td id="T_94fa7_row4_col4" class="data row4 col4" >115094</td>
      <td id="T_94fa7_row4_col5" class="data row4 col5" >0.044</td>
      <td id="T_94fa7_row4_col6" class="data row4 col6" >060310</td>
      <td id="T_94fa7_row4_col7" class="data row4 col7" >3S</td>
      <td id="T_94fa7_row4_col8" class="data row4 col8" >1.001</td>
      <td id="T_94fa7_row4_col9" class="data row4 col9" >1.044</td>
      <td id="T_94fa7_row4_col10" class="data row4 col10" >0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br>  모델에 입력할 변수를 생성합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_inputs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sector</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]):</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">return_all</span><span class="p">[</span><span class="n">return_all</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>    
    
    <span class="c1"># 가격변동성이 크고, 거래량이 몰린 종목이 주가가 상승한다</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_mean&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_std&#39;</span><span class="p">]</span>    
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span>
    
    <span class="c1"># 위꼬리가 긴 양봉이 자주발생한다.</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;positive_candle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 양봉</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;high/close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;positive_candle&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 양봉이면서 고가가 종가보다 높게 위치</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_high/close&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;high/close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;long_candle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;positive_candle&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span><span class="o">*</span>\
    <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 장대 양봉을 데이터로 표현</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_long&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;long_candle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># 지난 60 일 동안 장대양봉의 갯 수</span>
    
    
     <span class="c1"># 거래량이 종좀 터지며 매집의 흔적을 보인다   </span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span> <span class="c1"># 거래량은 종목과 주가에 따라 다르기 떄문에 표준화한 값이 필요함</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;z&gt;1.96&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_z&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.65</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 양봉이면서 거래량이 90%신뢰구간을 벗어난 날</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_z&gt;1.96&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;z&gt;1.96&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># 양봉이면서 거래량이 90% 신뢰구간을 벗어난 날을 카운트</span>
    
    <span class="c1"># 주가지수보다 더 좋은 수익율을 보여준다</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_win_market&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;win_market&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># 주가지수 수익율이 1 보다 작을 때, 종목 수익율이 1 보다 큰 날 수</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pct_win_market&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 주가지수 수익율 대비 종목 수익율</span>
    
    
    <span class="c1"># 동종업체 수익률보다 더 좋은 수익율을 보여준다.           </span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 종목별 최근 60 일 수익율의 평균</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sector</span>    
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
     
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_std&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)]</span>    

    <span class="n">model_inputs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">model_inputs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">model_inputs</span><span class="p">[</span><span class="s1">&#39;sector_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_inputs</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="n">model_inputs</span><span class="o">.</span><span class="n">index</span><span class="p">])[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="c1"># 섹터의 평균 수익율 계산</span>
<span class="n">model_inputs</span><span class="p">[</span><span class="s1">&#39;return over sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_inputs</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">model_inputs</span><span class="p">[</span><span class="s1">&#39;sector_return&#39;</span><span class="p">])</span> <span class="c1"># 섹터 평균 수익률 대비 종목 수익률 계산</span>
<span class="n">model_inputs</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Missing 값 있는 행 모두 제거</span>

<span class="n">model_inputs</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="s1">&#39;model_inputs.pkl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><br> 모델에 입력할 변수를 생성하고 X 에 담습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 최종 피처만으로 구성</span>
<span class="n">model_inputs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;model_inputs.pkl&#39;</span><span class="p">)</span>
<span class="n">feature_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">,</span><span class="s1">&#39;volume_z&#39;</span><span class="p">,</span><span class="s1">&#39;num_high/close&#39;</span><span class="p">,</span><span class="s1">&#39;num_win_market&#39;</span><span class="p">,</span><span class="s1">&#39;pct_win_market&#39;</span><span class="p">,</span><span class="s1">&#39;return over sector&#39;</span><span class="p">]</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">model_inputs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">today_dt</span><span class="p">][[</span><span class="s1">&#39;code&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">feature_list</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span> <span class="c1"># 오늘 날짜 2022년 4월 1일 데이터만</span>
<span class="n">X</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_dc906_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >name</th>
      <th class="col_heading level0 col1" >return</th>
      <th class="col_heading level0 col2" >price_z</th>
      <th class="col_heading level0 col3" >volume_z</th>
      <th class="col_heading level0 col4" >num_high/close</th>
      <th class="col_heading level0 col5" >num_win_market</th>
      <th class="col_heading level0 col6" >pct_win_market</th>
      <th class="col_heading level0 col7" >return over sector</th>
    </tr>
    <tr>
      <th class="index_name level0" >code</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
      <th class="blank col7" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_dc906_level0_row0" class="row_heading level0 row0" >238490</th>
      <td id="T_dc906_row0_col0" class="data row0 col0" >힘스</td>
      <td id="T_dc906_row0_col1" class="data row0 col1" >0.997</td>
      <td id="T_dc906_row0_col2" class="data row0 col2" >-1.290</td>
      <td id="T_dc906_row0_col3" class="data row0 col3" >-0.510</td>
      <td id="T_dc906_row0_col4" class="data row0 col4" >0.000</td>
      <td id="T_dc906_row0_col5" class="data row0 col5" >6.000</td>
      <td id="T_dc906_row0_col6" class="data row0 col6" >1.000</td>
      <td id="T_dc906_row0_col7" class="data row0 col7" >1.002</td>
    </tr>
    <tr>
      <th id="T_dc906_level0_row1" class="row_heading level0 row1" >037440</th>
      <td id="T_dc906_row1_col0" class="data row1 col0" >희림</td>
      <td id="T_dc906_row1_col1" class="data row1 col1" >0.981</td>
      <td id="T_dc906_row1_col2" class="data row1 col2" >0.144</td>
      <td id="T_dc906_row1_col3" class="data row1 col3" >-0.839</td>
      <td id="T_dc906_row1_col4" class="data row1 col4" >0.000</td>
      <td id="T_dc906_row1_col5" class="data row1 col5" >12.000</td>
      <td id="T_dc906_row1_col6" class="data row1 col6" >1.009</td>
      <td id="T_dc906_row1_col7" class="data row1 col7" >0.970</td>
    </tr>
    <tr>
      <th id="T_dc906_level0_row2" class="row_heading level0 row2" >189980</th>
      <td id="T_dc906_row2_col0" class="data row2 col0" >흥국에프엔비</td>
      <td id="T_dc906_row2_col1" class="data row2 col1" >1.004</td>
      <td id="T_dc906_row2_col2" class="data row2 col2" >0.304</td>
      <td id="T_dc906_row2_col3" class="data row2 col3" >-0.555</td>
      <td id="T_dc906_row2_col4" class="data row2 col4" >0.000</td>
      <td id="T_dc906_row2_col5" class="data row2 col5" >14.000</td>
      <td id="T_dc906_row2_col6" class="data row2 col6" >1.002</td>
      <td id="T_dc906_row2_col7" class="data row2 col7" >1.000</td>
    </tr>
    <tr>
      <th id="T_dc906_level0_row3" class="row_heading level0 row3" >010240</th>
      <td id="T_dc906_row3_col0" class="data row3 col0" >흥국</td>
      <td id="T_dc906_row3_col1" class="data row3 col1" >0.996</td>
      <td id="T_dc906_row3_col2" class="data row3 col2" >0.962</td>
      <td id="T_dc906_row3_col3" class="data row3 col3" >1.153</td>
      <td id="T_dc906_row3_col4" class="data row3 col4" >0.000</td>
      <td id="T_dc906_row3_col5" class="data row3 col5" >8.000</td>
      <td id="T_dc906_row3_col6" class="data row3 col6" >1.000</td>
      <td id="T_dc906_row3_col7" class="data row3 col7" >1.001</td>
    </tr>
    <tr>
      <th id="T_dc906_level0_row4" class="row_heading level0 row4" >024060</th>
      <td id="T_dc906_row4_col0" class="data row4 col0" >흥구석유</td>
      <td id="T_dc906_row4_col1" class="data row4 col1" >1.011</td>
      <td id="T_dc906_row4_col2" class="data row4 col2" >-0.838</td>
      <td id="T_dc906_row4_col3" class="data row4 col3" >-0.591</td>
      <td id="T_dc906_row4_col4" class="data row4 col4" >0.000</td>
      <td id="T_dc906_row4_col5" class="data row4 col5" >15.000</td>
      <td id="T_dc906_row4_col6" class="data row4 col6" >1.006</td>
      <td id="T_dc906_row4_col7" class="data row4 col7" >1.012</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> 저장한 GAM 모델을 불러 읽고, 입력변수를 넣어 예측값을 생성합니다. 입력변수의 순서는 모델에 사용한 입력변수와 동일해야 합니다. X 라는 데이터 프레임에 예측값 yhat 이 추가되었습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;gam.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">gam</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>     
    
<span class="n">yhat</span> <span class="o">=</span> <span class="n">gam</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">feature_list</span><span class="p">])</span>
<span class="n">X</span><span class="p">[</span><span class="s1">&#39;yhat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat</span>
<span class="n">X</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_5b07f_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >name</th>
      <th class="col_heading level0 col1" >return</th>
      <th class="col_heading level0 col2" >price_z</th>
      <th class="col_heading level0 col3" >volume_z</th>
      <th class="col_heading level0 col4" >num_high/close</th>
      <th class="col_heading level0 col5" >num_win_market</th>
      <th class="col_heading level0 col6" >pct_win_market</th>
      <th class="col_heading level0 col7" >return over sector</th>
      <th class="col_heading level0 col8" >yhat</th>
    </tr>
    <tr>
      <th class="index_name level0" >code</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
      <th class="blank col7" >&nbsp;</th>
      <th class="blank col8" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_5b07f_level0_row0" class="row_heading level0 row0" >238490</th>
      <td id="T_5b07f_row0_col0" class="data row0 col0" >힘스</td>
      <td id="T_5b07f_row0_col1" class="data row0 col1" >0.997</td>
      <td id="T_5b07f_row0_col2" class="data row0 col2" >-1.290</td>
      <td id="T_5b07f_row0_col3" class="data row0 col3" >-0.510</td>
      <td id="T_5b07f_row0_col4" class="data row0 col4" >0.000</td>
      <td id="T_5b07f_row0_col5" class="data row0 col5" >6.000</td>
      <td id="T_5b07f_row0_col6" class="data row0 col6" >1.000</td>
      <td id="T_5b07f_row0_col7" class="data row0 col7" >1.002</td>
      <td id="T_5b07f_row0_col8" class="data row0 col8" >0.205</td>
    </tr>
    <tr>
      <th id="T_5b07f_level0_row1" class="row_heading level0 row1" >037440</th>
      <td id="T_5b07f_row1_col0" class="data row1 col0" >희림</td>
      <td id="T_5b07f_row1_col1" class="data row1 col1" >0.981</td>
      <td id="T_5b07f_row1_col2" class="data row1 col2" >0.144</td>
      <td id="T_5b07f_row1_col3" class="data row1 col3" >-0.839</td>
      <td id="T_5b07f_row1_col4" class="data row1 col4" >0.000</td>
      <td id="T_5b07f_row1_col5" class="data row1 col5" >12.000</td>
      <td id="T_5b07f_row1_col6" class="data row1 col6" >1.009</td>
      <td id="T_5b07f_row1_col7" class="data row1 col7" >0.970</td>
      <td id="T_5b07f_row1_col8" class="data row1 col8" >0.297</td>
    </tr>
    <tr>
      <th id="T_5b07f_level0_row2" class="row_heading level0 row2" >189980</th>
      <td id="T_5b07f_row2_col0" class="data row2 col0" >흥국에프엔비</td>
      <td id="T_5b07f_row2_col1" class="data row2 col1" >1.004</td>
      <td id="T_5b07f_row2_col2" class="data row2 col2" >0.304</td>
      <td id="T_5b07f_row2_col3" class="data row2 col3" >-0.555</td>
      <td id="T_5b07f_row2_col4" class="data row2 col4" >0.000</td>
      <td id="T_5b07f_row2_col5" class="data row2 col5" >14.000</td>
      <td id="T_5b07f_row2_col6" class="data row2 col6" >1.002</td>
      <td id="T_5b07f_row2_col7" class="data row2 col7" >1.000</td>
      <td id="T_5b07f_row2_col8" class="data row2 col8" >0.218</td>
    </tr>
    <tr>
      <th id="T_5b07f_level0_row3" class="row_heading level0 row3" >010240</th>
      <td id="T_5b07f_row3_col0" class="data row3 col0" >흥국</td>
      <td id="T_5b07f_row3_col1" class="data row3 col1" >0.996</td>
      <td id="T_5b07f_row3_col2" class="data row3 col2" >0.962</td>
      <td id="T_5b07f_row3_col3" class="data row3 col3" >1.153</td>
      <td id="T_5b07f_row3_col4" class="data row3 col4" >0.000</td>
      <td id="T_5b07f_row3_col5" class="data row3 col5" >8.000</td>
      <td id="T_5b07f_row3_col6" class="data row3 col6" >1.000</td>
      <td id="T_5b07f_row3_col7" class="data row3 col7" >1.001</td>
      <td id="T_5b07f_row3_col8" class="data row3 col8" >0.237</td>
    </tr>
    <tr>
      <th id="T_5b07f_level0_row4" class="row_heading level0 row4" >024060</th>
      <td id="T_5b07f_row4_col0" class="data row4 col0" >흥구석유</td>
      <td id="T_5b07f_row4_col1" class="data row4 col1" >1.011</td>
      <td id="T_5b07f_row4_col2" class="data row4 col2" >-0.838</td>
      <td id="T_5b07f_row4_col3" class="data row4 col3" >-0.591</td>
      <td id="T_5b07f_row4_col4" class="data row4 col4" >0.000</td>
      <td id="T_5b07f_row4_col5" class="data row4 col5" >15.000</td>
      <td id="T_5b07f_row4_col6" class="data row4 col6" >1.006</td>
      <td id="T_5b07f_row4_col7" class="data row4 col7" >1.012</td>
      <td id="T_5b07f_row4_col8" class="data row4 col8" >0.290</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> 어떤 종목이 높은 스코어를 받았는지 궁금합니다. 스코어의 내림차순 정렬한 후 종목을 확인해 봅니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;yhat&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_b5623_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >name</th>
      <th class="col_heading level0 col1" >return</th>
      <th class="col_heading level0 col2" >price_z</th>
      <th class="col_heading level0 col3" >volume_z</th>
      <th class="col_heading level0 col4" >num_high/close</th>
      <th class="col_heading level0 col5" >num_win_market</th>
      <th class="col_heading level0 col6" >pct_win_market</th>
      <th class="col_heading level0 col7" >return over sector</th>
      <th class="col_heading level0 col8" >yhat</th>
    </tr>
    <tr>
      <th class="index_name level0" >code</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
      <th class="blank col7" >&nbsp;</th>
      <th class="blank col8" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_b5623_level0_row0" class="row_heading level0 row0" >056090</th>
      <td id="T_b5623_row0_col0" class="data row0 col0" >에디슨INNO</td>
      <td id="T_b5623_row0_col1" class="data row0 col1" >1.080</td>
      <td id="T_b5623_row0_col2" class="data row0 col2" >-1.621</td>
      <td id="T_b5623_row0_col3" class="data row0 col3" >1.764</td>
      <td id="T_b5623_row0_col4" class="data row0 col4" >3.000</td>
      <td id="T_b5623_row0_col5" class="data row0 col5" >16.000</td>
      <td id="T_b5623_row0_col6" class="data row0 col6" >1.026</td>
      <td id="T_b5623_row0_col7" class="data row0 col7" >1.064</td>
      <td id="T_b5623_row0_col8" class="data row0 col8" >0.540</td>
    </tr>
    <tr>
      <th id="T_b5623_level0_row1" class="row_heading level0 row1" >145020</th>
      <td id="T_b5623_row1_col0" class="data row1 col0" >휴젤</td>
      <td id="T_b5623_row1_col1" class="data row1 col1" >0.868</td>
      <td id="T_b5623_row1_col2" class="data row1 col2" >-3.379</td>
      <td id="T_b5623_row1_col3" class="data row1 col3" >7.109</td>
      <td id="T_b5623_row1_col4" class="data row1 col4" >0.000</td>
      <td id="T_b5623_row1_col5" class="data row1 col5" >6.000</td>
      <td id="T_b5623_row1_col6" class="data row1 col6" >0.997</td>
      <td id="T_b5623_row1_col7" class="data row1 col7" >0.868</td>
      <td id="T_b5623_row1_col8" class="data row1 col8" >0.497</td>
    </tr>
    <tr>
      <th id="T_b5623_level0_row2" class="row_heading level0 row2" >185490</th>
      <td id="T_b5623_row2_col0" class="data row2 col0" >아이진</td>
      <td id="T_b5623_row2_col1" class="data row2 col1" >0.908</td>
      <td id="T_b5623_row2_col2" class="data row2 col2" >-2.249</td>
      <td id="T_b5623_row2_col3" class="data row2 col3" >2.269</td>
      <td id="T_b5623_row2_col4" class="data row2 col4" >0.000</td>
      <td id="T_b5623_row2_col5" class="data row2 col5" >6.000</td>
      <td id="T_b5623_row2_col6" class="data row2 col6" >0.991</td>
      <td id="T_b5623_row2_col7" class="data row2 col7" >0.920</td>
      <td id="T_b5623_row2_col8" class="data row2 col8" >0.490</td>
    </tr>
    <tr>
      <th id="T_b5623_level0_row3" class="row_heading level0 row3" >069920</th>
      <td id="T_b5623_row3_col0" class="data row3 col0" >아이에스이커머스</td>
      <td id="T_b5623_row3_col1" class="data row3 col1" >1.300</td>
      <td id="T_b5623_row3_col2" class="data row3 col2" >2.396</td>
      <td id="T_b5623_row3_col3" class="data row3 col3" >3.518</td>
      <td id="T_b5623_row3_col4" class="data row3 col4" >2.000</td>
      <td id="T_b5623_row3_col5" class="data row3 col5" >15.000</td>
      <td id="T_b5623_row3_col6" class="data row3 col6" >1.019</td>
      <td id="T_b5623_row3_col7" class="data row3 col7" >1.224</td>
      <td id="T_b5623_row3_col8" class="data row3 col8" >0.469</td>
    </tr>
    <tr>
      <th id="T_b5623_level0_row4" class="row_heading level0 row4" >010280</th>
      <td id="T_b5623_row4_col0" class="data row4 col0" >쌍용정보통신</td>
      <td id="T_b5623_row4_col1" class="data row4 col1" >1.062</td>
      <td id="T_b5623_row4_col2" class="data row4 col2" >2.993</td>
      <td id="T_b5623_row4_col3" class="data row4 col3" >7.584</td>
      <td id="T_b5623_row4_col4" class="data row4 col4" >1.000</td>
      <td id="T_b5623_row4_col5" class="data row4 col5" >11.000</td>
      <td id="T_b5623_row4_col6" class="data row4 col6" >1.004</td>
      <td id="T_b5623_row4_col7" class="data row4 col7" >1.066</td>
      <td id="T_b5623_row4_col8" class="data row4 col8" >0.455</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> 그리고 필터링을 적용해서 최종 종목을 선정합니다. 최종적으로 5 개의 종목이 선정되었습니다. 우리는 4월 1일 이후에 주가 흐름을 알고 있습니다. 4월 2일이후 데이터를 추가하여 선택된 종목들이 유의미한지 점검해 보겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tops</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;yhat&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.3</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># 스코어 0.3 이상 종목만 </span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tops</span><span class="p">))</span>
<span class="n">select_tops</span> <span class="o">=</span> <span class="n">tops</span><span class="p">[(</span><span class="n">tops</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.03</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tops</span><span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)][[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;return&#39;</span><span class="p">,</span><span class="s1">&#39;price_z&#39;</span><span class="p">,</span><span class="s1">&#39;yhat&#39;</span><span class="p">,</span><span class="s1">&#39;return&#39;</span><span class="p">]]</span>          
<span class="n">select_tops</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>203
</pre></div>
</div>
<div class="output text_html"><style type="text/css">
</style>
<table id="T_ebb98_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >name</th>
      <th class="col_heading level0 col1" >return</th>
      <th class="col_heading level0 col2" >price_z</th>
      <th class="col_heading level0 col3" >yhat</th>
      <th class="col_heading level0 col4" >return</th>
    </tr>
    <tr>
      <th class="index_name level0" >code</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_ebb98_level0_row0" class="row_heading level0 row0" >024740</th>
      <td id="T_ebb98_row0_col0" class="data row0 col0" >한일단조</td>
      <td id="T_ebb98_row0_col1" class="data row0 col1" >1.062</td>
      <td id="T_ebb98_row0_col2" class="data row0 col2" >-0.823</td>
      <td id="T_ebb98_row0_col3" class="data row0 col3" >0.355</td>
      <td id="T_ebb98_row0_col4" class="data row0 col4" >1.062</td>
    </tr>
    <tr>
      <th id="T_ebb98_level0_row1" class="row_heading level0 row1" >174880</th>
      <td id="T_ebb98_row1_col0" class="data row1 col0" >장원테크</td>
      <td id="T_ebb98_row1_col1" class="data row1 col1" >1.090</td>
      <td id="T_ebb98_row1_col2" class="data row1 col2" >-0.366</td>
      <td id="T_ebb98_row1_col3" class="data row1 col3" >0.305</td>
      <td id="T_ebb98_row1_col4" class="data row1 col4" >1.090</td>
    </tr>
    <tr>
      <th id="T_ebb98_level0_row2" class="row_heading level0 row2" >056090</th>
      <td id="T_ebb98_row2_col0" class="data row2 col0" >에디슨INNO</td>
      <td id="T_ebb98_row2_col1" class="data row2 col1" >1.080</td>
      <td id="T_ebb98_row2_col2" class="data row2 col2" >-1.621</td>
      <td id="T_ebb98_row2_col3" class="data row2 col3" >0.540</td>
      <td id="T_ebb98_row2_col4" class="data row2 col4" >1.080</td>
    </tr>
    <tr>
      <th id="T_ebb98_level0_row3" class="row_heading level0 row3" >122690</th>
      <td id="T_ebb98_row3_col0" class="data row3 col0" >서진오토모티브</td>
      <td id="T_ebb98_row3_col1" class="data row3 col1" >1.058</td>
      <td id="T_ebb98_row3_col2" class="data row3 col2" >-0.114</td>
      <td id="T_ebb98_row3_col3" class="data row3 col3" >0.314</td>
      <td id="T_ebb98_row3_col4" class="data row3 col4" >1.058</td>
    </tr>
    <tr>
      <th id="T_ebb98_level0_row4" class="row_heading level0 row4" >083660</th>
      <td id="T_ebb98_row4_col0" class="data row4 col0" >CSA 코스믹</td>
      <td id="T_ebb98_row4_col1" class="data row4 col1" >1.035</td>
      <td id="T_ebb98_row4_col2" class="data row4 col2" >-0.094</td>
      <td id="T_ebb98_row4_col3" class="data row4 col3" >0.351</td>
      <td id="T_ebb98_row4_col4" class="data row4 col4" >1.035</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">outcome_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="n">today_dt</span> <span class="o">=</span> <span class="s1">&#39;2022-04-01&#39;</span>
<span class="n">end_dt</span> <span class="o">=</span> <span class="s1">&#39;2022-04-08&#39;</span>

<span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">select_tops</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>  <span class="c1"># 스코어가 생성된 모든 종목에서 대하여 반복</span>
    <span class="n">daily_price</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">code</span><span class="p">,</span>  <span class="n">start</span> <span class="o">=</span> <span class="n">today_dt</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">end_dt</span><span class="p">)</span> <span class="c1"># 종목, 일봉, 데이터 갯수</span>
    <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
  
    
    <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>   <span class="c1"># 4월 1일 종가 매수한 후, 4월 4일 수익율</span>
    <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;close_r2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>   <span class="c1"># 4월 1일 종가 매수한 후, 4월 5일 수익율</span>
    <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;close_r3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>   <span class="c1"># 4월 1일 종가 매수한 후, 4월 6일 수익율</span>
    <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;close_r4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>   <span class="c1"># 4월 1일 종가 매수한 후, 4월 7일 수익율</span>
    <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>   <span class="c1"># 4월 1일 종가 매수한 후, 4월 8일 수익율</span>

    <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_price</span><span class="p">[[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;mean_close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_price</span><span class="p">[[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;min_close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_price</span><span class="p">[[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
    <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;buy_low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
    <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;buy_high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;buy_low&#39;</span><span class="p">],</span> <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;buy_high&#39;</span><span class="p">])),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># 4월 2일 매수일, 4월 1일 종가에 살 수 있는 지 여부</span>
    <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>    
    
    <span class="n">outcome_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">outcome_data</span><span class="p">,</span> <span class="n">daily_price</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  
</pre></div>
</div>
</div>
</div>
<p><br> 최종 선정된 종목들의 결과가 궁금합니다. 선정된 종목 데이터에 결과 데이터를 병합합니다. 두 데이터셋의 인덱스는 종목이어야 병합이 가능합니다. 5% 익절할 확률은 83.3% 로 높게 나왔습니다. 최저 수익률의 평균은 .98 로 리스크도 비교적 낮은 것으로 보입니다. 2022년 4월 1일 매수한 종목은 수익권으로 예상이 됩니다. 물론 모든 날짜에 대하여 동일한 결과가 나오지는 않습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">outcome</span> <span class="o">=</span> <span class="n">outcome_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">today_dt</span><span class="p">][[</span><span class="s1">&#39;code&#39;</span><span class="p">,</span><span class="s1">&#39;buy&#39;</span><span class="p">,</span><span class="s1">&#39;buy_price&#39;</span><span class="p">,</span><span class="s1">&#39;buy_low&#39;</span><span class="p">,</span><span class="s1">&#39;buy_high&#39;</span><span class="p">,</span><span class="s1">&#39;max_close&#39;</span><span class="p">,</span><span class="s1">&#39;mean_close&#39;</span><span class="p">,</span><span class="s1">&#39;min_close&#39;</span><span class="p">,</span><span class="s1">&#39;target&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span>
<span class="n">select_outcome</span> <span class="o">=</span> <span class="n">tops</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">outcome</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
<span class="n">select_outcome</span><span class="p">[[</span><span class="s1">&#39;yhat&#39;</span><span class="p">,</span><span class="s1">&#39;buy&#39;</span><span class="p">,</span><span class="s1">&#39;max_close&#39;</span><span class="p">,</span><span class="s1">&#39;mean_close&#39;</span><span class="p">,</span><span class="s1">&#39;min_close&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>yhat         0.375
buy          0.800
max_close    1.127
mean_close   1.055
min_close    0.983
dtype: float64
</pre></div>
</div>
</div>
</div>
<p><br> buy 는 4월 1일 종가에 4월 2일 매수할 수 있는 기회가 있는 지를 알려주는 Flag 입니다. CSA 코스믹은 4월 2일 갭상승으로 시작했습니다. 4월 1일 종가에 살 수 있는 기회가 없습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_outcome</span><span class="p">[[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;buy&#39;</span><span class="p">,</span><span class="s1">&#39;buy_price&#39;</span><span class="p">,</span> <span class="s1">&#39;buy_low&#39;</span><span class="p">,</span><span class="s1">&#39;buy_high&#39;</span><span class="p">,</span><span class="s1">&#39;yhat&#39;</span><span class="p">,</span><span class="s1">&#39;max_close&#39;</span><span class="p">,</span><span class="s1">&#39;mean_close&#39;</span><span class="p">,</span><span class="s1">&#39;min_close&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_70a7d_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >name</th>
      <th class="col_heading level0 col1" >buy</th>
      <th class="col_heading level0 col2" >buy_price</th>
      <th class="col_heading level0 col3" >buy_low</th>
      <th class="col_heading level0 col4" >buy_high</th>
      <th class="col_heading level0 col5" >yhat</th>
      <th class="col_heading level0 col6" >max_close</th>
      <th class="col_heading level0 col7" >mean_close</th>
      <th class="col_heading level0 col8" >min_close</th>
    </tr>
    <tr>
      <th class="index_name level0" >code</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
      <th class="blank col7" >&nbsp;</th>
      <th class="blank col8" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_70a7d_level0_row0" class="row_heading level0 row0" >024740</th>
      <td id="T_70a7d_row0_col0" class="data row0 col0" >한일단조</td>
      <td id="T_70a7d_row0_col1" class="data row0 col1" >1</td>
      <td id="T_70a7d_row0_col2" class="data row0 col2" >3185</td>
      <td id="T_70a7d_row0_col3" class="data row0 col3" >3185.000</td>
      <td id="T_70a7d_row0_col4" class="data row0 col4" >3300.000</td>
      <td id="T_70a7d_row0_col5" class="data row0 col5" >0.357</td>
      <td id="T_70a7d_row0_col6" class="data row0 col6" >1.057</td>
      <td id="T_70a7d_row0_col7" class="data row0 col7" >1.025</td>
      <td id="T_70a7d_row0_col8" class="data row0 col8" >0.983</td>
    </tr>
    <tr>
      <th id="T_70a7d_level0_row1" class="row_heading level0 row1" >174880</th>
      <td id="T_70a7d_row1_col0" class="data row1 col0" >장원테크</td>
      <td id="T_70a7d_row1_col1" class="data row1 col1" >1</td>
      <td id="T_70a7d_row1_col2" class="data row1 col2" >1990</td>
      <td id="T_70a7d_row1_col3" class="data row1 col3" >1985.000</td>
      <td id="T_70a7d_row1_col4" class="data row1 col4" >2225.000</td>
      <td id="T_70a7d_row1_col5" class="data row1 col5" >0.302</td>
      <td id="T_70a7d_row1_col6" class="data row1 col6" >1.116</td>
      <td id="T_70a7d_row1_col7" class="data row1 col7" >0.988</td>
      <td id="T_70a7d_row1_col8" class="data row1 col8" >0.925</td>
    </tr>
    <tr>
      <th id="T_70a7d_level0_row2" class="row_heading level0 row2" >056090</th>
      <td id="T_70a7d_row2_col0" class="data row2 col0" >에디슨INNO</td>
      <td id="T_70a7d_row2_col1" class="data row2 col1" >1</td>
      <td id="T_70a7d_row2_col2" class="data row2 col2" >12800</td>
      <td id="T_70a7d_row2_col3" class="data row2 col3" >11350.000</td>
      <td id="T_70a7d_row2_col4" class="data row2 col4" >13350.000</td>
      <td id="T_70a7d_row2_col5" class="data row2 col5" >0.542</td>
      <td id="T_70a7d_row2_col6" class="data row2 col6" >1.273</td>
      <td id="T_70a7d_row2_col7" class="data row2 col7" >1.127</td>
      <td id="T_70a7d_row2_col8" class="data row2 col8" >0.930</td>
    </tr>
    <tr>
      <th id="T_70a7d_level0_row3" class="row_heading level0 row3" >122690</th>
      <td id="T_70a7d_row3_col0" class="data row3 col0" >서진오토모티브</td>
      <td id="T_70a7d_row3_col1" class="data row3 col1" >1</td>
      <td id="T_70a7d_row3_col2" class="data row3 col2" >3350</td>
      <td id="T_70a7d_row3_col3" class="data row3 col3" >3330.000</td>
      <td id="T_70a7d_row3_col4" class="data row3 col4" >3680.000</td>
      <td id="T_70a7d_row3_col5" class="data row3 col5" >0.321</td>
      <td id="T_70a7d_row3_col6" class="data row3 col6" >1.103</td>
      <td id="T_70a7d_row3_col7" class="data row3 col7" >1.070</td>
      <td id="T_70a7d_row3_col8" class="data row3 col8" >1.037</td>
    </tr>
    <tr>
      <th id="T_70a7d_level0_row4" class="row_heading level0 row4" >083660</th>
      <td id="T_70a7d_row4_col0" class="data row4 col0" >CSA 코스믹</td>
      <td id="T_70a7d_row4_col1" class="data row4 col1" >0</td>
      <td id="T_70a7d_row4_col2" class="data row4 col2" >2080</td>
      <td id="T_70a7d_row4_col3" class="data row4 col3" >2100.000</td>
      <td id="T_70a7d_row4_col4" class="data row4 col4" >2270.000</td>
      <td id="T_70a7d_row4_col5" class="data row4 col5" >0.353</td>
      <td id="T_70a7d_row4_col6" class="data row4 col6" >1.087</td>
      <td id="T_70a7d_row4_col7" class="data row4 col7" >1.067</td>
      <td id="T_70a7d_row4_col8" class="data row4 col8" >1.041</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>2022년 4월 1일 추천받은 종목들의 일봉 차트를 보겠습니다. CSA 코스믹은 전일 종가로 당일 매수가 불가능합니다. 2022년 4월 2일 갭상승으로 시작을 했습니다.  에디슨 INNO 는 4월 2일 매수 후 익절할 기회를 제공하고 있습니다.</p>
<p><br> <strong>한일단조</strong></p>
<!-- <img src="./images/Hanil.PNG" width="500" height="400"></img>} -->
<p><img alt="GET_IMAGE" src="_images/Hanil.PNG" /></p>
<p><br><strong>장원테크</strong></p>
<!-- <img src="./images/JangWon.PNG" width="500" height="400"></img> -->
<p><img alt="GET_IMAGE" src="_images/JangWon.PNG" /></p>
<p><br><strong>에디슨INNO</strong></p>
<!-- <img src="./images/Eddison.PNG" width="500" height="400"></img> -->
<p><img alt="GET_IMAGE" src="_images/Eddison.PNG" /></p>
<p><br><strong>서진오토모티브</strong></p>
<!-- <img src="./images/SeoJin.PNG" width="500" height="400"></img>
 -->
<p><img alt="GET_IMAGE" src="_images/SeoJin.PNG" /></p>
<p><br><strong>CSA 코스믹</strong></p>
<!-- <img src="./images/CSA.PNG" width="500" height="400"></img> -->
<p><img alt="GET_IMAGE" src="_images/CSA.PNG" /></p>
</section>
<span id="document-chapter6/6.1.2_Stock_Selection_Function"></span><section id="id1">
<h3>해결책 테스트<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>오늘 날짜만 입력하면 내일 매수할 종목이 추천되도록 각 프로세스를 통합하여 함수를 구현합니다. 임의 날짜를 넣어서 테스트 해 봅니다. 이 책에서는 2022년 4월 1일, 2022년 4월 18일,  2022년 5월 2일, 2022년 5월 9일, 2022년 5월 25일,  2022년 6월 2일, 6월 16일에 대하여 종목 선정 및 결과 수익률을 테스트 해 보았습니다.  모델을 개발하는데 사용한 날짜는 모델 검증 용도로 적절하지 않습니다. 왜냐하면 개발에서 사용한 데이터는 모델이 좋은 성과가 나오도록 최적화되어 있기 때문입니다.  참고로 모델 개발은 2021년 1월 4일부터 2022년 3월 24일까지 데이터가 사용되었습니다.</p>
<p>이제 종목을 추천하는 프로세스를 완성했습니다. 장 마감 후 종목 추천을 받아 익일 증권사 API  를 이용해서 자동매매를 구현하고 한 달 동안의 수익이 어떤지 검증해 보겠습니다. 홈트레이딩 시스템에도 자동매매가 가능합니다. 책에서 구현할 자동매매는 홈트레이딩 감시 매매 설정으로도 충분히 가능합니다.</p>
<p>실전에서는 HTS 에서 제공하는 예약 매수기능과 매도 감시기능을 이용하는 것리 편리합니다. HTS 를 활용하여 자동으로 매수 매도가 가능합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">glob</span>
</pre></div>
</div>
</div>
</div>
<p><br> 추전 종목을 만드는 여러 개의 프로세스를 하나의 함수로 만들었습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">select_stocks</span><span class="p">(</span><span class="n">today_dt</span><span class="p">):</span>
    
    <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">today_dt</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">start_dt</span> <span class="o">=</span> <span class="n">today</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># 100 일전 데이터 부터 시작 - 피쳐 엔지니어링은 최소 60 개의 일봉이 필요함</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">start_dt</span><span class="p">,</span> <span class="n">today_dt</span><span class="p">)</span>

    <span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span>

    <span class="n">price_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]):</span>  <span class="c1"># 코스닥 모든 종목에서 대하여 반복</span>
        <span class="n">daily_price</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="n">start_dt</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">today_dt</span><span class="p">)</span> <span class="c1"># 종목, 일봉, 데이터 갯수</span>

        <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
        <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">price_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">price_data</span><span class="p">,</span> <span class="n">daily_price</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>   

    <span class="n">price_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>
    <span class="n">price_data</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span> <span class="n">price_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="c1"># 컬럼 이름 소문자로 변경</span>

    <span class="c1"># DataReder 코스닥 인덱스 조회 실패시, 야후파이낸스로 추출    </span>
    <span class="c1"># kosdaq_index = fdr.DataReader(&#39;KQ11&#39;, start = start_dt, end = today_dt) # 데이터 호출</span>
    <span class="c1"># kosdaq_index.columns = [&#39;close&#39;,&#39;open&#39;,&#39;high&#39;,&#39;low&#39;,&#39;volume&#39;,&#39;change&#39;] # 컬럼명 변경</span>
    
    <span class="n">kosdaq_index</span> <span class="o">=</span>  <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;^KQ11&#39;</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="n">start_dt</span><span class="p">)</span>
    <span class="n">kosdaq_index</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="s1">&#39;high&#39;</span><span class="p">,</span><span class="s1">&#39;low&#39;</span><span class="p">,</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="s1">&#39;adj_close&#39;</span><span class="p">,</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="c1"># 컬럼명 변경</span>
    <span class="n">kosdaq_index</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;date&#39;</span> <span class="c1"># 인덱스 이름 생성</span>
    <span class="n">kosdaq_index</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># 인덱스(날짜) 로 정렬 </span>
    <span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 수익율 : 전 날 종가대비 당일 종가</span>

    <span class="n">merged</span> <span class="o">=</span> <span class="n">price_data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">],</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

    <span class="n">return_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]:</span>  

        <span class="n">stock_return</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">merged</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 종목별 전일 종가 대비 당일 종가 수익율</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># 수익율 1 보다 작음. 당일 종가가 전일 종가보다 낮음 (코스닥 지표)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># 수익율 1 보다 큼. 당일 종가가 전일 종가보다 큼 (개별 종목)</span>
        <span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;win_market&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">c1</span><span class="o">&amp;</span><span class="n">c2</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># C1 과 C2 조건을 동시에 만족하면 1, 아니면 0</span>
        <span class="n">return_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">return_all</span><span class="p">,</span> <span class="n">stock_return</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> 

    <span class="n">return_all</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    

    <span class="n">model_inputs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sector</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]):</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">return_all</span><span class="p">[</span><span class="n">return_all</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>    

        <span class="c1"># 가격변동성이 크고, 거래량이 몰린 종목이 주가가 상승한다</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_mean&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_std&#39;</span><span class="p">]</span>    
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span>

        <span class="c1"># 위꼬리가 긴 양봉이 자주발생한다.</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;positive_candle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 양봉</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;high/close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;positive_candle&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 양봉이면서 고가가 종가보다 높게 위치</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_high/close&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;high/close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;long_candle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;positive_candle&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span><span class="o">*</span>\
        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 장대 양봉을 데이터로 표현</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_long&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;long_candle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># 지난 20 일 동안 장대양봉의 갯 수</span>


         <span class="c1"># 거래량이 종좀 터지며 매집의 흔적을 보인다   </span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span> <span class="c1"># 거래량은 종목과 주가에 따라 다르기 떄문에 표준화한 값이 필요함</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;z&gt;1.96&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_z&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.65</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 양봉이면서 거래량이 90%신뢰구간을 벗어난 날</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_z&gt;1.96&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;z&gt;1.96&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># 양봉이면서 거래량이 90% 신뢰구간을 벗어난 날을 카운트</span>

        <span class="c1"># 주가지수보다 더 좋은 수익율을 보여준다</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_win_market&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;win_market&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># 주가지수 수익율이 1 보다 작을 때, 종목 수익율이 1 보다 큰 날 수</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pct_win_market&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 주가지수 수익율 대비 종목 수익율</span>


        <span class="c1"># 동종업체 수익률보다 더 좋은 수익율을 보여준다.           </span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 종목별 최근 60 일 수익율의 평균</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sector</span>    
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_std&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)]</span>    

        <span class="n">model_inputs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">model_inputs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">model_inputs</span><span class="p">[</span><span class="s1">&#39;sector_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_inputs</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="n">model_inputs</span><span class="o">.</span><span class="n">index</span><span class="p">])[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="c1"># 섹터의 평균 수익율 계산</span>
    <span class="n">model_inputs</span><span class="p">[</span><span class="s1">&#39;return over sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_inputs</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">model_inputs</span><span class="p">[</span><span class="s1">&#39;sector_return&#39;</span><span class="p">])</span> <span class="c1"># 섹터 평균 수익률 대비 종목 수익률 계산</span>
    <span class="n">model_inputs</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Missing 값 있는 행 모두 제거</span>


    <span class="n">feature_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">,</span><span class="s1">&#39;volume_z&#39;</span><span class="p">,</span><span class="s1">&#39;num_high/close&#39;</span><span class="p">,</span><span class="s1">&#39;num_win_market&#39;</span><span class="p">,</span><span class="s1">&#39;pct_win_market&#39;</span><span class="p">,</span><span class="s1">&#39;return over sector&#39;</span><span class="p">]</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">model_inputs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">today_dt</span><span class="p">][[</span><span class="s1">&#39;code&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;return&#39;</span><span class="p">,</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">,</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">feature_list</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span> 

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;gam.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">gam</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>     

    <span class="n">yhat</span> <span class="o">=</span> <span class="n">gam</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">feature_list</span><span class="p">])</span>
    <span class="n">X</span><span class="p">[</span><span class="s1">&#39;yhat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat</span>

    <span class="n">tops</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;yhat&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.3</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;yhat&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># 스코어 0.3 이상 종목만 </span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tops</span><span class="p">))</span>    
     
    <span class="n">select_tops</span> <span class="o">=</span> <span class="n">tops</span><span class="p">[(</span><span class="n">tops</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.03</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tops</span><span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)][[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;return&#39;</span><span class="p">,</span><span class="s1">&#39;price_z&#39;</span><span class="p">,</span><span class="s1">&#39;yhat&#39;</span><span class="p">,</span> <span class="s1">&#39;kosdaq_return&#39;</span><span class="p">,</span><span class="s1">&#39;close&#39;</span><span class="p">]]</span>  <span class="c1"># 기본 필터링 조건   </span>
      
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">select_tops</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># 최소한 2개 종목 - 추천 리스크 분산        </span>
        <span class="k">return</span> <span class="n">select_tops</span>    
    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<p><br> 수익률 검정하는 프로세스도 하나의 함수로 구현합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">outcome_tops</span><span class="p">(</span><span class="n">select_tops</span><span class="p">,</span> <span class="n">today_dt</span><span class="p">,</span> <span class="n">end_dt</span><span class="p">):</span>   

    <span class="n">outcome_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">select_tops</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>  <span class="c1"># 스코어가 생성된 모든 종목에서 대하여 반복</span>
        <span class="n">daily_price</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">code</span><span class="p">,</span>  <span class="n">start</span> <span class="o">=</span> <span class="n">today_dt</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">end_dt</span><span class="p">)</span> <span class="c1"># 종목, 일봉, 데이터 갯수</span>
        <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>  

        <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>   
        <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;close_r2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>  
        <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;close_r3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>   
        <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;close_r4&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>   
        <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>   

        <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;max_close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_price</span><span class="p">[[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;mean_close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_price</span><span class="p">[[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;min_close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_price</span><span class="p">[[</span><span class="s1">&#39;close_r1&#39;</span><span class="p">,</span><span class="s1">&#39;close_r2&#39;</span><span class="p">,</span><span class="s1">&#39;close_r3&#39;</span><span class="p">,</span><span class="s1">&#39;close_r4&#39;</span><span class="p">,</span><span class="s1">&#39;close_r5&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;buy_low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 익일 저가</span>
        <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;buy_high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 익일 고가</span>

        <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;buy_price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;buy_low&#39;</span><span class="p">],</span> <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;buy_high&#39;</span><span class="p">])),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># 당일 종가로 익일 매수 가능한지 여부</span>

        <span class="n">outcome_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">outcome_data</span><span class="p">,</span> <span class="n">daily_price</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">outcome</span> <span class="o">=</span> <span class="n">outcome_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">today_dt</span><span class="p">][[</span><span class="s1">&#39;code&#39;</span><span class="p">,</span><span class="s1">&#39;buy&#39;</span><span class="p">,</span><span class="s1">&#39;buy_price&#39;</span><span class="p">,</span><span class="s1">&#39;buy_low&#39;</span><span class="p">,</span><span class="s1">&#39;buy_high&#39;</span><span class="p">,</span><span class="s1">&#39;max_close&#39;</span><span class="p">,</span><span class="s1">&#39;mean_close&#39;</span><span class="p">,</span><span class="s1">&#39;min_close&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span>
    <span class="n">select_outcome</span> <span class="o">=</span> <span class="n">select_tops</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">outcome</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">select_outcome</span><span class="p">[[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;buy&#39;</span><span class="p">,</span><span class="s1">&#39;buy_price&#39;</span><span class="p">,</span> <span class="s1">&#39;buy_low&#39;</span><span class="p">,</span><span class="s1">&#39;buy_high&#39;</span><span class="p">,</span><span class="s1">&#39;yhat&#39;</span><span class="p">,</span><span class="s1">&#39;max_close&#39;</span><span class="p">,</span><span class="s1">&#39;mean_close&#39;</span><span class="p">,</span><span class="s1">&#39;min_close&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
<p><br> <strong>2022년 4월 1일 - 종목 선정 및 수익률 테스트</strong><br />
상당이 고무적입니다. 모든 종목이 익절이 가능합니다. 단 CSA 코스믹은 전일 종가로 당일 매수가 불가능합니다. 2022년 4월 2일 갭상승으로 시작을 했습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_tops</span> <span class="o">=</span> <span class="n">select_stocks</span><span class="p">(</span><span class="s1">&#39;2022-04-01&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">select_tops</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">outcome_tops</span><span class="p">(</span><span class="n">select_tops</span><span class="p">,</span> <span class="s1">&#39;2022-04-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2022-04-08&#39;</span><span class="p">)</span> <span class="c1"># 5 영업일</span>
<span class="n">results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;buy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-12-22 00:00:00 2022-04-01
[*********************100%***********************]  1 of 1 completed
203
</pre></div>
</div>
<div class="output text_html"><style type="text/css">
</style>
<table id="T_49219_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >name</th>
      <th class="col_heading level0 col1" >buy</th>
      <th class="col_heading level0 col2" >buy_price</th>
      <th class="col_heading level0 col3" >buy_low</th>
      <th class="col_heading level0 col4" >buy_high</th>
      <th class="col_heading level0 col5" >yhat</th>
      <th class="col_heading level0 col6" >max_close</th>
      <th class="col_heading level0 col7" >mean_close</th>
      <th class="col_heading level0 col8" >min_close</th>
    </tr>
    <tr>
      <th class="index_name level0" >code</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
      <th class="blank col7" >&nbsp;</th>
      <th class="blank col8" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_49219_level0_row0" class="row_heading level0 row0" >083660</th>
      <td id="T_49219_row0_col0" class="data row0 col0" >CSA 코스믹</td>
      <td id="T_49219_row0_col1" class="data row0 col1" >0</td>
      <td id="T_49219_row0_col2" class="data row0 col2" >2080</td>
      <td id="T_49219_row0_col3" class="data row0 col3" >2100.000</td>
      <td id="T_49219_row0_col4" class="data row0 col4" >2270.000</td>
      <td id="T_49219_row0_col5" class="data row0 col5" >0.351</td>
      <td id="T_49219_row0_col6" class="data row0 col6" >1.087</td>
      <td id="T_49219_row0_col7" class="data row0 col7" >1.067</td>
      <td id="T_49219_row0_col8" class="data row0 col8" >1.041</td>
    </tr>
    <tr>
      <th id="T_49219_level0_row1" class="row_heading level0 row1" >056090</th>
      <td id="T_49219_row1_col0" class="data row1 col0" >에디슨INNO</td>
      <td id="T_49219_row1_col1" class="data row1 col1" >1</td>
      <td id="T_49219_row1_col2" class="data row1 col2" >2560</td>
      <td id="T_49219_row1_col3" class="data row1 col3" >2270.000</td>
      <td id="T_49219_row1_col4" class="data row1 col4" >2670.000</td>
      <td id="T_49219_row1_col5" class="data row1 col5" >0.540</td>
      <td id="T_49219_row1_col6" class="data row1 col6" >1.273</td>
      <td id="T_49219_row1_col7" class="data row1 col7" >1.127</td>
      <td id="T_49219_row1_col8" class="data row1 col8" >0.930</td>
    </tr>
    <tr>
      <th id="T_49219_level0_row2" class="row_heading level0 row2" >024740</th>
      <td id="T_49219_row2_col0" class="data row2 col0" >한일단조</td>
      <td id="T_49219_row2_col1" class="data row2 col1" >1</td>
      <td id="T_49219_row2_col2" class="data row2 col2" >3185</td>
      <td id="T_49219_row2_col3" class="data row2 col3" >3185.000</td>
      <td id="T_49219_row2_col4" class="data row2 col4" >3300.000</td>
      <td id="T_49219_row2_col5" class="data row2 col5" >0.355</td>
      <td id="T_49219_row2_col6" class="data row2 col6" >1.057</td>
      <td id="T_49219_row2_col7" class="data row2 col7" >1.025</td>
      <td id="T_49219_row2_col8" class="data row2 col8" >0.983</td>
    </tr>
    <tr>
      <th id="T_49219_level0_row3" class="row_heading level0 row3" >122690</th>
      <td id="T_49219_row3_col0" class="data row3 col0" >서진오토모티브</td>
      <td id="T_49219_row3_col1" class="data row3 col1" >1</td>
      <td id="T_49219_row3_col2" class="data row3 col2" >3350</td>
      <td id="T_49219_row3_col3" class="data row3 col3" >3330.000</td>
      <td id="T_49219_row3_col4" class="data row3 col4" >3680.000</td>
      <td id="T_49219_row3_col5" class="data row3 col5" >0.314</td>
      <td id="T_49219_row3_col6" class="data row3 col6" >1.103</td>
      <td id="T_49219_row3_col7" class="data row3 col7" >1.070</td>
      <td id="T_49219_row3_col8" class="data row3 col8" >1.037</td>
    </tr>
    <tr>
      <th id="T_49219_level0_row4" class="row_heading level0 row4" >174880</th>
      <td id="T_49219_row4_col0" class="data row4 col0" >장원테크</td>
      <td id="T_49219_row4_col1" class="data row4 col1" >1</td>
      <td id="T_49219_row4_col2" class="data row4 col2" >1990</td>
      <td id="T_49219_row4_col3" class="data row4 col3" >1985.000</td>
      <td id="T_49219_row4_col4" class="data row4 col4" >2225.000</td>
      <td id="T_49219_row4_col5" class="data row4 col5" >0.305</td>
      <td id="T_49219_row4_col6" class="data row4 col6" >1.116</td>
      <td id="T_49219_row4_col7" class="data row4 col7" >0.988</td>
      <td id="T_49219_row4_col8" class="data row4 col8" >0.925</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> <strong>2022년 4월 18일 - 종목 선정 및 수익률 테스트</strong><br />
4 월 18일은 인성정보는 수익권, 웨이버스는 손절로 대응이 필요합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_tops</span> <span class="o">=</span> <span class="n">select_stocks</span><span class="p">(</span><span class="s1">&#39;2022-04-18&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">select_tops</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">outcome_tops</span><span class="p">(</span><span class="n">select_tops</span><span class="p">,</span> <span class="s1">&#39;2022-04-18&#39;</span><span class="p">,</span> <span class="s1">&#39;2022-04-25&#39;</span><span class="p">)</span> <span class="c1"># 5 영업일</span>
<span class="n">results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;buy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-01-08 00:00:00 2022-04-18
180
</pre></div>
</div>
<div class="output text_html"><style type="text/css">
</style>
<table id="T_b9fff_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >name</th>
      <th class="col_heading level0 col1" >buy</th>
      <th class="col_heading level0 col2" >buy_price</th>
      <th class="col_heading level0 col3" >buy_low</th>
      <th class="col_heading level0 col4" >buy_high</th>
      <th class="col_heading level0 col5" >yhat</th>
      <th class="col_heading level0 col6" >max_close</th>
      <th class="col_heading level0 col7" >mean_close</th>
      <th class="col_heading level0 col8" >min_close</th>
    </tr>
    <tr>
      <th class="index_name level0" >code</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
      <th class="blank col7" >&nbsp;</th>
      <th class="blank col8" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_b9fff_level0_row0" class="row_heading level0 row0" >109820</th>
      <td id="T_b9fff_row0_col0" class="data row0 col0" >진매트릭스</td>
      <td id="T_b9fff_row0_col1" class="data row0 col1" >0</td>
      <td id="T_b9fff_row0_col2" class="data row0 col2" >6690</td>
      <td id="T_b9fff_row0_col3" class="data row0 col3" >6450.000</td>
      <td id="T_b9fff_row0_col4" class="data row0 col4" >6670.000</td>
      <td id="T_b9fff_row0_col5" class="data row0 col5" >0.311</td>
      <td id="T_b9fff_row0_col6" class="data row0 col6" >0.978</td>
      <td id="T_b9fff_row0_col7" class="data row0 col7" >0.943</td>
      <td id="T_b9fff_row0_col8" class="data row0 col8" >0.903</td>
    </tr>
    <tr>
      <th id="T_b9fff_level0_row1" class="row_heading level0 row1" >089530</th>
      <td id="T_b9fff_row1_col0" class="data row1 col0" >에이티세미콘</td>
      <td id="T_b9fff_row1_col1" class="data row1 col1" >0</td>
      <td id="T_b9fff_row1_col2" class="data row1 col2" >1940</td>
      <td id="T_b9fff_row1_col3" class="data row1 col3" >1810.000</td>
      <td id="T_b9fff_row1_col4" class="data row1 col4" >1915.000</td>
      <td id="T_b9fff_row1_col5" class="data row1 col5" >0.310</td>
      <td id="T_b9fff_row1_col6" class="data row1 col6" >1.134</td>
      <td id="T_b9fff_row1_col7" class="data row1 col7" >1.037</td>
      <td id="T_b9fff_row1_col8" class="data row1 col8" >0.951</td>
    </tr>
    <tr>
      <th id="T_b9fff_level0_row2" class="row_heading level0 row2" >033230</th>
      <td id="T_b9fff_row2_col0" class="data row2 col0" >인성정보</td>
      <td id="T_b9fff_row2_col1" class="data row2 col1" >1</td>
      <td id="T_b9fff_row2_col2" class="data row2 col2" >2960</td>
      <td id="T_b9fff_row2_col3" class="data row2 col3" >2930.000</td>
      <td id="T_b9fff_row2_col4" class="data row2 col4" >3045.000</td>
      <td id="T_b9fff_row2_col5" class="data row2 col5" >0.313</td>
      <td id="T_b9fff_row2_col6" class="data row2 col6" >1.030</td>
      <td id="T_b9fff_row2_col7" class="data row2 col7" >0.994</td>
      <td id="T_b9fff_row2_col8" class="data row2 col8" >0.922</td>
    </tr>
    <tr>
      <th id="T_b9fff_level0_row3" class="row_heading level0 row3" >336060</th>
      <td id="T_b9fff_row3_col0" class="data row3 col0" >웨이버스</td>
      <td id="T_b9fff_row3_col1" class="data row3 col1" >1</td>
      <td id="T_b9fff_row3_col2" class="data row3 col2" >2630</td>
      <td id="T_b9fff_row3_col3" class="data row3 col3" >2535.000</td>
      <td id="T_b9fff_row3_col4" class="data row3 col4" >2665.000</td>
      <td id="T_b9fff_row3_col5" class="data row3 col5" >0.305</td>
      <td id="T_b9fff_row3_col6" class="data row3 col6" >0.970</td>
      <td id="T_b9fff_row3_col7" class="data row3 col7" >0.867</td>
      <td id="T_b9fff_row3_col8" class="data row3 col8" >0.759</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> <strong>2022년 5월 2일 - 종목 선정 및 수익률 테스트</strong><br />
미래생명자원은 매수 후, 주가가 하락하는 것으로 나왔습니다. 다행이 급락 종목은 아니여서 손절로 대응하는 것이 좋을 것으로 판단됩니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_tops</span> <span class="o">=</span> <span class="n">select_stocks</span><span class="p">(</span><span class="s1">&#39;2022-05-02&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">select_tops</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">outcome_tops</span><span class="p">(</span><span class="n">select_tops</span><span class="p">,</span> <span class="s1">&#39;2022-05-02&#39;</span><span class="p">,</span> <span class="s1">&#39;2022-05-10&#39;</span><span class="p">)</span> <span class="c1"># 5 영업일 (5월 5일 어린이날)</span>
    
<span class="n">results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;buy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-01-22 00:00:00 2022-05-02
169
</pre></div>
</div>
<div class="output text_html"><style type="text/css">
</style>
<table id="T_0737e_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >name</th>
      <th class="col_heading level0 col1" >buy</th>
      <th class="col_heading level0 col2" >buy_price</th>
      <th class="col_heading level0 col3" >buy_low</th>
      <th class="col_heading level0 col4" >buy_high</th>
      <th class="col_heading level0 col5" >yhat</th>
      <th class="col_heading level0 col6" >max_close</th>
      <th class="col_heading level0 col7" >mean_close</th>
      <th class="col_heading level0 col8" >min_close</th>
    </tr>
    <tr>
      <th class="index_name level0" >code</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
      <th class="blank col7" >&nbsp;</th>
      <th class="blank col8" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_0737e_level0_row0" class="row_heading level0 row0" >218150</th>
      <td id="T_0737e_row0_col0" class="data row0 col0" >미래생명자원</td>
      <td id="T_0737e_row0_col1" class="data row0 col1" >1</td>
      <td id="T_0737e_row0_col2" class="data row0 col2" >9690</td>
      <td id="T_0737e_row0_col3" class="data row0 col3" >9360.000</td>
      <td id="T_0737e_row0_col4" class="data row0 col4" >9870.000</td>
      <td id="T_0737e_row0_col5" class="data row0 col5" >0.430</td>
      <td id="T_0737e_row0_col6" class="data row0 col6" >0.991</td>
      <td id="T_0737e_row0_col7" class="data row0 col7" >0.918</td>
      <td id="T_0737e_row0_col8" class="data row0 col8" >0.863</td>
    </tr>
    <tr>
      <th id="T_0737e_level0_row1" class="row_heading level0 row1" >014200</th>
      <td id="T_0737e_row1_col0" class="data row1 col0" >광림</td>
      <td id="T_0737e_row1_col1" class="data row1 col1" >1</td>
      <td id="T_0737e_row1_col2" class="data row1 col2" >2515</td>
      <td id="T_0737e_row1_col3" class="data row1 col3" >2445.000</td>
      <td id="T_0737e_row1_col4" class="data row1 col4" >2950.000</td>
      <td id="T_0737e_row1_col5" class="data row1 col5" >0.370</td>
      <td id="T_0737e_row1_col6" class="data row1 col6" >1.151</td>
      <td id="T_0737e_row1_col7" class="data row1 col7" >1.083</td>
      <td id="T_0737e_row1_col8" class="data row1 col8" >1.000</td>
    </tr>
    <tr>
      <th id="T_0737e_level0_row2" class="row_heading level0 row2" >258610</th>
      <td id="T_0737e_row2_col0" class="data row2 col0" >케일럼</td>
      <td id="T_0737e_row2_col1" class="data row2 col1" >1</td>
      <td id="T_0737e_row2_col2" class="data row2 col2" >4575</td>
      <td id="T_0737e_row2_col3" class="data row2 col3" >4445.000</td>
      <td id="T_0737e_row2_col4" class="data row2 col4" >5100.000</td>
      <td id="T_0737e_row2_col5" class="data row2 col5" >0.327</td>
      <td id="T_0737e_row2_col6" class="data row2 col6" >1.045</td>
      <td id="T_0737e_row2_col7" class="data row2 col7" >0.999</td>
      <td id="T_0737e_row2_col8" class="data row2 col8" >0.954</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> <strong>2022년 5월 9일 - 종목 선정 및 수익률 테스트</strong><br />
5월 9일은 추천종목이 없습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_tops</span> <span class="o">=</span> <span class="n">select_stocks</span><span class="p">(</span><span class="s1">&#39;2022-05-09&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">select_tops</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">outcome_tops</span><span class="p">(</span><span class="n">select_tops</span><span class="p">,</span> <span class="s1">&#39;2022-05-09&#39;</span><span class="p">,</span> <span class="s1">&#39;2022-05-16&#39;</span><span class="p">)</span> <span class="c1"># 5 영업일 (5월 5일 어린이날)</span>
    
<span class="n">results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;buy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-01-29 00:00:00 2022-05-09
348
</pre></div>
</div>
<div class="output text_html"><style type="text/css">
</style>
<table id="T_0e7a1_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >name</th>
      <th class="col_heading level0 col1" >buy</th>
      <th class="col_heading level0 col2" >buy_price</th>
      <th class="col_heading level0 col3" >buy_low</th>
      <th class="col_heading level0 col4" >buy_high</th>
      <th class="col_heading level0 col5" >yhat</th>
      <th class="col_heading level0 col6" >max_close</th>
      <th class="col_heading level0 col7" >mean_close</th>
      <th class="col_heading level0 col8" >min_close</th>
    </tr>
    <tr>
      <th class="index_name level0" >code</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
      <th class="blank col7" >&nbsp;</th>
      <th class="blank col8" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_0e7a1_level0_row0" class="row_heading level0 row0" >218150</th>
      <td id="T_0e7a1_row0_col0" class="data row0 col0" >미래생명자원</td>
      <td id="T_0e7a1_row0_col1" class="data row0 col1" >1</td>
      <td id="T_0e7a1_row0_col2" class="data row0 col2" >9690</td>
      <td id="T_0e7a1_row0_col3" class="data row0 col3" >9360.000</td>
      <td id="T_0e7a1_row0_col4" class="data row0 col4" >9870.000</td>
      <td id="T_0e7a1_row0_col5" class="data row0 col5" >0.430</td>
      <td id="T_0e7a1_row0_col6" class="data row0 col6" >0.991</td>
      <td id="T_0e7a1_row0_col7" class="data row0 col7" >0.918</td>
      <td id="T_0e7a1_row0_col8" class="data row0 col8" >0.863</td>
    </tr>
    <tr>
      <th id="T_0e7a1_level0_row1" class="row_heading level0 row1" >014200</th>
      <td id="T_0e7a1_row1_col0" class="data row1 col0" >광림</td>
      <td id="T_0e7a1_row1_col1" class="data row1 col1" >1</td>
      <td id="T_0e7a1_row1_col2" class="data row1 col2" >2515</td>
      <td id="T_0e7a1_row1_col3" class="data row1 col3" >2445.000</td>
      <td id="T_0e7a1_row1_col4" class="data row1 col4" >2950.000</td>
      <td id="T_0e7a1_row1_col5" class="data row1 col5" >0.370</td>
      <td id="T_0e7a1_row1_col6" class="data row1 col6" >1.151</td>
      <td id="T_0e7a1_row1_col7" class="data row1 col7" >1.083</td>
      <td id="T_0e7a1_row1_col8" class="data row1 col8" >1.000</td>
    </tr>
    <tr>
      <th id="T_0e7a1_level0_row2" class="row_heading level0 row2" >258610</th>
      <td id="T_0e7a1_row2_col0" class="data row2 col0" >케일럼</td>
      <td id="T_0e7a1_row2_col1" class="data row2 col1" >1</td>
      <td id="T_0e7a1_row2_col2" class="data row2 col2" >4575</td>
      <td id="T_0e7a1_row2_col3" class="data row2 col3" >4445.000</td>
      <td id="T_0e7a1_row2_col4" class="data row2 col4" >5100.000</td>
      <td id="T_0e7a1_row2_col5" class="data row2 col5" >0.327</td>
      <td id="T_0e7a1_row2_col6" class="data row2 col6" >1.045</td>
      <td id="T_0e7a1_row2_col7" class="data row2 col7" >0.999</td>
      <td id="T_0e7a1_row2_col8" class="data row2 col8" >0.954</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> <strong>2022년 5월 25일 - 종목 선정 및 수익률 테스트</strong><br />
지더블유바이텍과 아이에스이커머스는 5영업일이내 익절이 가능할 것으로 보입니다. 조이시티와 상지카일룸은 대응이 필요합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_tops</span> <span class="o">=</span> <span class="n">select_stocks</span><span class="p">(</span><span class="s1">&#39;2022-05-25&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">select_tops</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">outcome_tops</span><span class="p">(</span><span class="n">select_tops</span><span class="p">,</span> <span class="s1">&#39;2022-05-25&#39;</span><span class="p">,</span> <span class="s1">&#39;2022-06-02&#39;</span><span class="p">)</span> <span class="c1"># 5 영업일 (6월 1일 지방선거)          </span>
    
<span class="n">results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;buy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-02-14 00:00:00 2022-05-25
144
</pre></div>
</div>
<div class="output text_html"><style type="text/css">
</style>
<table id="T_c1f1d_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >name</th>
      <th class="col_heading level0 col1" >buy</th>
      <th class="col_heading level0 col2" >buy_price</th>
      <th class="col_heading level0 col3" >buy_low</th>
      <th class="col_heading level0 col4" >buy_high</th>
      <th class="col_heading level0 col5" >yhat</th>
      <th class="col_heading level0 col6" >max_close</th>
      <th class="col_heading level0 col7" >mean_close</th>
      <th class="col_heading level0 col8" >min_close</th>
    </tr>
    <tr>
      <th class="index_name level0" >code</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
      <th class="blank col7" >&nbsp;</th>
      <th class="blank col8" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_c1f1d_level0_row0" class="row_heading level0 row0" >069920</th>
      <td id="T_c1f1d_row0_col0" class="data row0 col0" >아이에스이커머스</td>
      <td id="T_c1f1d_row0_col1" class="data row0 col1" >1</td>
      <td id="T_c1f1d_row0_col2" class="data row0 col2" >6970</td>
      <td id="T_c1f1d_row0_col3" class="data row0 col3" >6960.000</td>
      <td id="T_c1f1d_row0_col4" class="data row0 col4" >7690.000</td>
      <td id="T_c1f1d_row0_col5" class="data row0 col5" >0.554</td>
      <td id="T_c1f1d_row0_col6" class="data row0 col6" >1.070</td>
      <td id="T_c1f1d_row0_col7" class="data row0 col7" >1.013</td>
      <td id="T_c1f1d_row0_col8" class="data row0 col8" >0.950</td>
    </tr>
    <tr>
      <th id="T_c1f1d_level0_row1" class="row_heading level0 row1" >036180</th>
      <td id="T_c1f1d_row1_col0" class="data row1 col0" >지더블유바이텍</td>
      <td id="T_c1f1d_row1_col1" class="data row1 col1" >1</td>
      <td id="T_c1f1d_row1_col2" class="data row1 col2" >887</td>
      <td id="T_c1f1d_row1_col3" class="data row1 col3" >883.000</td>
      <td id="T_c1f1d_row1_col4" class="data row1 col4" >1045.000</td>
      <td id="T_c1f1d_row1_col5" class="data row1 col5" >0.413</td>
      <td id="T_c1f1d_row1_col6" class="data row1 col6" >1.125</td>
      <td id="T_c1f1d_row1_col7" class="data row1 col7" >1.074</td>
      <td id="T_c1f1d_row1_col8" class="data row1 col8" >1.025</td>
    </tr>
    <tr>
      <th id="T_c1f1d_level0_row2" class="row_heading level0 row2" >005860</th>
      <td id="T_c1f1d_row2_col0" class="data row2 col0" >한일사료</td>
      <td id="T_c1f1d_row2_col1" class="data row2 col1" >1</td>
      <td id="T_c1f1d_row2_col2" class="data row2 col2" >8000</td>
      <td id="T_c1f1d_row2_col3" class="data row2 col3" >7670.000</td>
      <td id="T_c1f1d_row2_col4" class="data row2 col4" >8150.000</td>
      <td id="T_c1f1d_row2_col5" class="data row2 col5" >0.390</td>
      <td id="T_c1f1d_row2_col6" class="data row2 col6" >1.211</td>
      <td id="T_c1f1d_row2_col7" class="data row2 col7" >1.127</td>
      <td id="T_c1f1d_row2_col8" class="data row2 col8" >0.966</td>
    </tr>
    <tr>
      <th id="T_c1f1d_level0_row3" class="row_heading level0 row3" >067000</th>
      <td id="T_c1f1d_row3_col0" class="data row3 col0" >조이시티</td>
      <td id="T_c1f1d_row3_col1" class="data row3 col1" >1</td>
      <td id="T_c1f1d_row3_col2" class="data row3 col2" >5990</td>
      <td id="T_c1f1d_row3_col3" class="data row3 col3" >5800.000</td>
      <td id="T_c1f1d_row3_col4" class="data row3 col4" >6180.000</td>
      <td id="T_c1f1d_row3_col5" class="data row3 col5" >0.335</td>
      <td id="T_c1f1d_row3_col6" class="data row3 col6" >0.990</td>
      <td id="T_c1f1d_row3_col7" class="data row3 col7" >0.977</td>
      <td id="T_c1f1d_row3_col8" class="data row3 col8" >0.967</td>
    </tr>
    <tr>
      <th id="T_c1f1d_level0_row4" class="row_heading level0 row4" >227100</th>
      <td id="T_c1f1d_row4_col0" class="data row4 col0" >에이치앤비디자인</td>
      <td id="T_c1f1d_row4_col1" class="data row4 col1" >1</td>
      <td id="T_c1f1d_row4_col2" class="data row4 col2" >4430</td>
      <td id="T_c1f1d_row4_col3" class="data row4 col3" >4430.000</td>
      <td id="T_c1f1d_row4_col4" class="data row4 col4" >5640.000</td>
      <td id="T_c1f1d_row4_col5" class="data row4 col5" >0.335</td>
      <td id="T_c1f1d_row4_col6" class="data row4 col6" >1.411</td>
      <td id="T_c1f1d_row4_col7" class="data row4 col7" >1.341</td>
      <td id="T_c1f1d_row4_col8" class="data row4 col8" >1.221</td>
    </tr>
    <tr>
      <th id="T_c1f1d_level0_row5" class="row_heading level0 row5" >104540</th>
      <td id="T_c1f1d_row5_col0" class="data row5 col0" >코렌텍</td>
      <td id="T_c1f1d_row5_col1" class="data row5 col1" >1</td>
      <td id="T_c1f1d_row5_col2" class="data row5 col2" >11550</td>
      <td id="T_c1f1d_row5_col3" class="data row5 col3" >11350.000</td>
      <td id="T_c1f1d_row5_col4" class="data row5 col4" >14800.000</td>
      <td id="T_c1f1d_row5_col5" class="data row5 col5" >0.327</td>
      <td id="T_c1f1d_row5_col6" class="data row5 col6" >1.139</td>
      <td id="T_c1f1d_row5_col7" class="data row5 col7" >1.099</td>
      <td id="T_c1f1d_row5_col8" class="data row5 col8" >1.065</td>
    </tr>
    <tr>
      <th id="T_c1f1d_level0_row6" class="row_heading level0 row6" >042940</th>
      <td id="T_c1f1d_row6_col0" class="data row6 col0" >상지카일룸</td>
      <td id="T_c1f1d_row6_col1" class="data row6 col1" >1</td>
      <td id="T_c1f1d_row6_col2" class="data row6 col2" >1235</td>
      <td id="T_c1f1d_row6_col3" class="data row6 col3" >1170.000</td>
      <td id="T_c1f1d_row6_col4" class="data row6 col4" >1235.000</td>
      <td id="T_c1f1d_row6_col5" class="data row6 col5" >0.302</td>
      <td id="T_c1f1d_row6_col6" class="data row6 col6" >0.992</td>
      <td id="T_c1f1d_row6_col7" class="data row6 col7" >0.959</td>
      <td id="T_c1f1d_row6_col8" class="data row6 col8" >0.923</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> <strong>2022년 6월 2일 - 종목 선정 및 수익률 테스트</strong><br />
토탈소프트를 제외한 모든 종목이 익절이 가능할 것으로 보입니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_tops</span> <span class="o">=</span> <span class="n">select_stocks</span><span class="p">(</span><span class="s1">&#39;2022-06-02&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">select_tops</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">outcome_tops</span><span class="p">(</span><span class="n">select_tops</span><span class="p">,</span> <span class="s1">&#39;2022-06-02&#39;</span><span class="p">,</span> <span class="s1">&#39;2022-06-10&#39;</span><span class="p">)</span> <span class="c1"># 5 영업일 (6월 6일 현충일)</span>
    
<span class="n">results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;buy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-02-22 00:00:00 2022-06-02
125
</pre></div>
</div>
<div class="output text_html"><style type="text/css">
</style>
<table id="T_a648e_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >name</th>
      <th class="col_heading level0 col1" >buy</th>
      <th class="col_heading level0 col2" >buy_price</th>
      <th class="col_heading level0 col3" >buy_low</th>
      <th class="col_heading level0 col4" >buy_high</th>
      <th class="col_heading level0 col5" >yhat</th>
      <th class="col_heading level0 col6" >max_close</th>
      <th class="col_heading level0 col7" >mean_close</th>
      <th class="col_heading level0 col8" >min_close</th>
    </tr>
    <tr>
      <th class="index_name level0" >code</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
      <th class="blank col7" >&nbsp;</th>
      <th class="blank col8" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_a648e_level0_row0" class="row_heading level0 row0" >069920</th>
      <td id="T_a648e_row0_col0" class="data row0 col0" >아이에스이커머스</td>
      <td id="T_a648e_row0_col1" class="data row0 col1" >1</td>
      <td id="T_a648e_row0_col2" class="data row0 col2" >7410</td>
      <td id="T_a648e_row0_col3" class="data row0 col3" >7270.000</td>
      <td id="T_a648e_row0_col4" class="data row0 col4" >7720.000</td>
      <td id="T_a648e_row0_col5" class="data row0 col5" >0.419</td>
      <td id="T_a648e_row0_col6" class="data row0 col6" >1.076</td>
      <td id="T_a648e_row0_col7" class="data row0 col7" >1.006</td>
      <td id="T_a648e_row0_col8" class="data row0 col8" >0.961</td>
    </tr>
    <tr>
      <th id="T_a648e_level0_row1" class="row_heading level0 row1" >021880</th>
      <td id="T_a648e_row1_col0" class="data row1 col0" >메이슨캐피탈</td>
      <td id="T_a648e_row1_col1" class="data row1 col1" >1</td>
      <td id="T_a648e_row1_col2" class="data row1 col2" >668</td>
      <td id="T_a648e_row1_col3" class="data row1 col3" >652.000</td>
      <td id="T_a648e_row1_col4" class="data row1 col4" >685.000</td>
      <td id="T_a648e_row1_col5" class="data row1 col5" >0.323</td>
      <td id="T_a648e_row1_col6" class="data row1 col6" >1.157</td>
      <td id="T_a648e_row1_col7" class="data row1 col7" >1.087</td>
      <td id="T_a648e_row1_col8" class="data row1 col8" >1.016</td>
    </tr>
    <tr>
      <th id="T_a648e_level0_row2" class="row_heading level0 row2" >014200</th>
      <td id="T_a648e_row2_col0" class="data row2 col0" >광림</td>
      <td id="T_a648e_row2_col1" class="data row2 col1" >1</td>
      <td id="T_a648e_row2_col2" class="data row2 col2" >2100</td>
      <td id="T_a648e_row2_col3" class="data row2 col3" >2040.000</td>
      <td id="T_a648e_row2_col4" class="data row2 col4" >2185.000</td>
      <td id="T_a648e_row2_col5" class="data row2 col5" >0.308</td>
      <td id="T_a648e_row2_col6" class="data row2 col6" >1.221</td>
      <td id="T_a648e_row2_col7" class="data row2 col7" >1.035</td>
      <td id="T_a648e_row2_col8" class="data row2 col8" >0.938</td>
    </tr>
    <tr>
      <th id="T_a648e_level0_row3" class="row_heading level0 row3" >045340</th>
      <td id="T_a648e_row3_col0" class="data row3 col0" >토탈소프트</td>
      <td id="T_a648e_row3_col1" class="data row3 col1" >1</td>
      <td id="T_a648e_row3_col2" class="data row3 col2" >6540</td>
      <td id="T_a648e_row3_col3" class="data row3 col3" >6450.000</td>
      <td id="T_a648e_row3_col4" class="data row3 col4" >6740.000</td>
      <td id="T_a648e_row3_col5" class="data row3 col5" >0.305</td>
      <td id="T_a648e_row3_col6" class="data row3 col6" >1.031</td>
      <td id="T_a648e_row3_col7" class="data row3 col7" >0.981</td>
      <td id="T_a648e_row3_col8" class="data row3 col8" >0.945</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br> <strong>2022년 6월 16일 - 종목 선정 및 수익률 테스트</strong><br />
2022년 6월 16일 추천종목은 20 종목이 넘습니다. 종목은 모델 스코어가 높은 5 종목만 선택하도록 하겠습니다. 한탑, 에이에프더블류, 베셀이 매수가 가능했습니다. 익절 가능할 것으로 예상됩니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_tops</span> <span class="o">=</span> <span class="n">select_stocks</span><span class="p">(</span><span class="s1">&#39;2022-06-16&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">select_tops</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">outcome_tops</span><span class="p">(</span><span class="n">select_tops</span><span class="p">,</span> <span class="s1">&#39;2022-06-16&#39;</span><span class="p">,</span> <span class="s1">&#39;2022-06-23&#39;</span><span class="p">)</span> <span class="c1"># 5 영업일 (6월 6일 현충일)</span>
    
<span class="n">results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;buy&#39;</span><span class="p">,</span><span class="s1">&#39;yhat&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-03-08 00:00:00 2022-06-16
[*********************100%***********************]  1 of 1 completed
395
</pre></div>
</div>
<div class="output text_html"><style type="text/css">
</style>
<table id="T_36f7b_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >name</th>
      <th class="col_heading level0 col1" >buy</th>
      <th class="col_heading level0 col2" >buy_price</th>
      <th class="col_heading level0 col3" >buy_low</th>
      <th class="col_heading level0 col4" >buy_high</th>
      <th class="col_heading level0 col5" >yhat</th>
      <th class="col_heading level0 col6" >max_close</th>
      <th class="col_heading level0 col7" >mean_close</th>
      <th class="col_heading level0 col8" >min_close</th>
    </tr>
    <tr>
      <th class="index_name level0" >code</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
      <th class="blank col7" >&nbsp;</th>
      <th class="blank col8" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_36f7b_level0_row0" class="row_heading level0 row0" >002680</th>
      <td id="T_36f7b_row0_col0" class="data row0 col0" >한탑</td>
      <td id="T_36f7b_row0_col1" class="data row0 col1" >1</td>
      <td id="T_36f7b_row0_col2" class="data row0 col2" >3155</td>
      <td id="T_36f7b_row0_col3" class="data row0 col3" >3050.000</td>
      <td id="T_36f7b_row0_col4" class="data row0 col4" >3595.000</td>
      <td id="T_36f7b_row0_col5" class="data row0 col5" >0.457</td>
      <td id="T_36f7b_row0_col6" class="data row0 col6" >1.132</td>
      <td id="T_36f7b_row0_col7" class="data row0 col7" >1.029</td>
      <td id="T_36f7b_row0_col8" class="data row0 col8" >0.805</td>
    </tr>
    <tr>
      <th id="T_36f7b_level0_row1" class="row_heading level0 row1" >177350</th>
      <td id="T_36f7b_row1_col0" class="data row1 col0" >베셀</td>
      <td id="T_36f7b_row1_col1" class="data row1 col1" >1</td>
      <td id="T_36f7b_row1_col2" class="data row1 col2" >7630</td>
      <td id="T_36f7b_row1_col3" class="data row1 col3" >7300.000</td>
      <td id="T_36f7b_row1_col4" class="data row1 col4" >8280.000</td>
      <td id="T_36f7b_row1_col5" class="data row1 col5" >0.413</td>
      <td id="T_36f7b_row1_col6" class="data row1 col6" >1.054</td>
      <td id="T_36f7b_row1_col7" class="data row1 col7" >1.006</td>
      <td id="T_36f7b_row1_col8" class="data row1 col8" >0.920</td>
    </tr>
    <tr>
      <th id="T_36f7b_level0_row2" class="row_heading level0 row2" >312610</th>
      <td id="T_36f7b_row2_col0" class="data row2 col0" >에이에프더블류</td>
      <td id="T_36f7b_row2_col1" class="data row2 col1" >1</td>
      <td id="T_36f7b_row2_col2" class="data row2 col2" >3505</td>
      <td id="T_36f7b_row2_col3" class="data row2 col3" >3315.000</td>
      <td id="T_36f7b_row2_col4" class="data row2 col4" >4555.000</td>
      <td id="T_36f7b_row2_col5" class="data row2 col5" >0.397</td>
      <td id="T_36f7b_row2_col6" class="data row2 col6" >1.185</td>
      <td id="T_36f7b_row2_col7" class="data row2 col7" >1.054</td>
      <td id="T_36f7b_row2_col8" class="data row2 col8" >0.874</td>
    </tr>
    <tr>
      <th id="T_36f7b_level0_row3" class="row_heading level0 row3" >317850</th>
      <td id="T_36f7b_row3_col0" class="data row3 col0" >대모</td>
      <td id="T_36f7b_row3_col1" class="data row3 col1" >1</td>
      <td id="T_36f7b_row3_col2" class="data row3 col2" >10950</td>
      <td id="T_36f7b_row3_col3" class="data row3 col3" >10250.000</td>
      <td id="T_36f7b_row3_col4" class="data row3 col4" >11700.000</td>
      <td id="T_36f7b_row3_col5" class="data row3 col5" >0.373</td>
      <td id="T_36f7b_row3_col6" class="data row3 col6" >1.032</td>
      <td id="T_36f7b_row3_col7" class="data row3 col7" >0.986</td>
      <td id="T_36f7b_row3_col8" class="data row3 col8" >0.904</td>
    </tr>
    <tr>
      <th id="T_36f7b_level0_row4" class="row_heading level0 row4" >067010</th>
      <td id="T_36f7b_row4_col0" class="data row4 col0" >이씨에스</td>
      <td id="T_36f7b_row4_col1" class="data row4 col1" >1</td>
      <td id="T_36f7b_row4_col2" class="data row4 col2" >3980</td>
      <td id="T_36f7b_row4_col3" class="data row4 col3" >3800.000</td>
      <td id="T_36f7b_row4_col4" class="data row4 col4" >4395.000</td>
      <td id="T_36f7b_row4_col5" class="data row4 col5" >0.362</td>
      <td id="T_36f7b_row4_col6" class="data row4 col6" >1.062</td>
      <td id="T_36f7b_row4_col7" class="data row4 col7" >0.954</td>
      <td id="T_36f7b_row4_col8" class="data row4 col8" >0.812</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<span id="document-chapter6/6.1.3_Save_Stocks"></span><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">pickle</span>
</pre></div>
</div>
</div>
</div>
<section id="id1">
<h3><strong>추천 종목을 파일로 저장</strong><a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p><br> 알고리즘으로 추천받은 종목을 딕셔너리로 저장한 후, pickle 파일로 변환하겠습니다. 저장된 pickle 파일을 읽어서 자동매매를 진행합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">select_stocks</span><span class="p">(</span><span class="n">today_dt</span><span class="p">):</span>
    
    <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">today_dt</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">start_dt</span> <span class="o">=</span> <span class="n">today</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># 100 일전 데이터 부터 시작 - 피쳐 엔지니어링은 최소 60 개의 일봉이 필요함</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">start_dt</span><span class="p">,</span> <span class="n">today_dt</span><span class="p">)</span>

    <span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span>

    <span class="n">price_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]):</span>  <span class="c1"># 코스닥 모든 종목에서 대하여 반복</span>
        <span class="n">daily_price</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="n">start_dt</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">today_dt</span><span class="p">)</span> <span class="c1"># 종목, 일봉, 데이터 갯수</span>

        <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
        <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">price_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">price_data</span><span class="p">,</span> <span class="n">daily_price</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>   

    <span class="n">price_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>
    <span class="n">price_data</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span> <span class="n">price_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="c1"># 컬럼 이름 소문자로 변경</span>

    <span class="c1"># DataReder 코스닥 인덱스 조회 실패시, 야후파이낸스로 추출    </span>
    <span class="c1"># kosdaq_index = fdr.DataReader(&#39;KQ11&#39;, start = start_dt, end = today_dt) # 데이터 호출</span>
    <span class="c1"># kosdaq_index.columns = [&#39;close&#39;,&#39;open&#39;,&#39;high&#39;,&#39;low&#39;,&#39;volume&#39;,&#39;change&#39;] # 컬럼명 변경</span>
    
    <span class="n">kosdaq_index</span> <span class="o">=</span>  <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;^KQ11&#39;</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="n">start_dt</span><span class="p">)</span>
    <span class="n">kosdaq_index</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="s1">&#39;high&#39;</span><span class="p">,</span><span class="s1">&#39;low&#39;</span><span class="p">,</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="s1">&#39;adj_close&#39;</span><span class="p">,</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="c1"># 컬럼명 변경</span>
    <span class="n">kosdaq_index</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;date&#39;</span> <span class="c1"># 인덱스 이름 생성</span>
    <span class="n">kosdaq_index</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># 인덱스(날짜) 로 정렬 </span>
    <span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 수익율 : 전 날 종가대비 당일 종가</span>

    <span class="n">merged</span> <span class="o">=</span> <span class="n">price_data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">],</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

    <span class="n">return_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]:</span>  

        <span class="n">stock_return</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">merged</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 종목별 전일 종가 대비 당일 종가 수익율</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># 수익율 1 보다 작음. 당일 종가가 전일 종가보다 낮음 (코스닥 지표)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># 수익율 1 보다 큼. 당일 종가가 전일 종가보다 큼 (개별 종목)</span>
        <span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;win_market&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">c1</span><span class="o">&amp;</span><span class="n">c2</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># C1 과 C2 조건을 동시에 만족하면 1, 아니면 0</span>
        <span class="n">return_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">return_all</span><span class="p">,</span> <span class="n">stock_return</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> 

    <span class="n">return_all</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    

    <span class="n">model_inputs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sector</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]):</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">return_all</span><span class="p">[</span><span class="n">return_all</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>    

        <span class="c1"># 가격변동성이 크고, 거래량이 몰린 종목이 주가가 상승한다</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_mean&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_std&#39;</span><span class="p">]</span>    
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span>

        <span class="c1"># 위꼬리가 긴 양봉이 자주발생한다.</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;positive_candle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 양봉</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;high/close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;positive_candle&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 양봉이면서 고가가 종가보다 높게 위치</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_high/close&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;high/close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;long_candle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;positive_candle&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span><span class="o">*</span>\
        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 장대 양봉을 데이터로 표현</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_long&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;long_candle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># 지난 20 일 동안 장대양봉의 갯 수</span>


         <span class="c1"># 거래량이 종좀 터지며 매집의 흔적을 보인다   </span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span> <span class="c1"># 거래량은 종목과 주가에 따라 다르기 떄문에 표준화한 값이 필요함</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;z&gt;1.96&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_z&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.65</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 양봉이면서 거래량이 90%신뢰구간을 벗어난 날</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_z&gt;1.96&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;z&gt;1.96&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># 양봉이면서 거래량이 90% 신뢰구간을 벗어난 날을 카운트</span>

        <span class="c1"># 주가지수보다 더 좋은 수익율을 보여준다</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_win_market&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;win_market&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># 주가지수 수익율이 1 보다 작을 때, 종목 수익율이 1 보다 큰 날 수</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pct_win_market&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 주가지수 수익율 대비 종목 수익율</span>


        <span class="c1"># 동종업체 수익률보다 더 좋은 수익율을 보여준다.           </span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 종목별 최근 60 일 수익율의 평균</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sector</span>    
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_std&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)]</span>    

        <span class="n">model_inputs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">model_inputs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">model_inputs</span><span class="p">[</span><span class="s1">&#39;sector_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_inputs</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="n">model_inputs</span><span class="o">.</span><span class="n">index</span><span class="p">])[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="c1"># 섹터의 평균 수익율 계산</span>
    <span class="n">model_inputs</span><span class="p">[</span><span class="s1">&#39;return over sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_inputs</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">model_inputs</span><span class="p">[</span><span class="s1">&#39;sector_return&#39;</span><span class="p">])</span> <span class="c1"># 섹터 평균 수익률 대비 종목 수익률 계산</span>
    <span class="n">model_inputs</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Missing 값 있는 행 모두 제거</span>


    <span class="n">feature_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">,</span><span class="s1">&#39;volume_z&#39;</span><span class="p">,</span><span class="s1">&#39;num_high/close&#39;</span><span class="p">,</span><span class="s1">&#39;num_win_market&#39;</span><span class="p">,</span><span class="s1">&#39;pct_win_market&#39;</span><span class="p">,</span><span class="s1">&#39;return over sector&#39;</span><span class="p">]</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">model_inputs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">today_dt</span><span class="p">][[</span><span class="s1">&#39;code&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;return&#39;</span><span class="p">,</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">,</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">feature_list</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span> 

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;gam.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">gam</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>     

    <span class="n">yhat</span> <span class="o">=</span> <span class="n">gam</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">feature_list</span><span class="p">])</span>
    <span class="n">X</span><span class="p">[</span><span class="s1">&#39;yhat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat</span>

    <span class="n">tops</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;yhat&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.3</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;yhat&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># 스코어 0.3 이상 종목만 </span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tops</span><span class="p">))</span>    
     
    <span class="n">select_tops</span> <span class="o">=</span> <span class="n">tops</span><span class="p">[(</span><span class="n">tops</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.03</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tops</span><span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)][[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;return&#39;</span><span class="p">,</span><span class="s1">&#39;price_z&#39;</span><span class="p">,</span><span class="s1">&#39;yhat&#39;</span><span class="p">,</span> <span class="s1">&#39;kosdaq_return&#39;</span><span class="p">,</span><span class="s1">&#39;close&#39;</span><span class="p">]]</span>  <span class="c1"># 기본 필터링 조건   </span>
      
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">select_tops</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># 최소한 2개 종목 - 추천 리스크 분산        </span>
        <span class="k">return</span> <span class="n">select_tops</span>    
    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_tops</span> <span class="o">=</span> <span class="n">select_stocks</span><span class="p">(</span><span class="s1">&#39;2022-06-16&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;yhat&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-03-08 00:00:00 2022-06-16
[*********************100%***********************]  1 of 1 completed
395
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_tops</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
</style>
<table id="T_81a93_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >name</th>
      <th class="col_heading level0 col1" >return</th>
      <th class="col_heading level0 col2" >price_z</th>
      <th class="col_heading level0 col3" >yhat</th>
      <th class="col_heading level0 col4" >kosdaq_return</th>
      <th class="col_heading level0 col5" >close</th>
    </tr>
    <tr>
      <th class="index_name level0" >code</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_81a93_level0_row0" class="row_heading level0 row0" >002680</th>
      <td id="T_81a93_row0_col0" class="data row0 col0" >한탑</td>
      <td id="T_81a93_row0_col1" class="data row0 col1" >1.031</td>
      <td id="T_81a93_row0_col2" class="data row0 col2" >-1.282</td>
      <td id="T_81a93_row0_col3" class="data row0 col3" >0.457</td>
      <td id="T_81a93_row0_col4" class="data row0 col4" >1.003</td>
      <td id="T_81a93_row0_col5" class="data row0 col5" >3155</td>
    </tr>
    <tr>
      <th id="T_81a93_level0_row1" class="row_heading level0 row1" >177350</th>
      <td id="T_81a93_row1_col0" class="data row1 col0" >베셀</td>
      <td id="T_81a93_row1_col1" class="data row1 col1" >1.052</td>
      <td id="T_81a93_row1_col2" class="data row1 col2" >-1.346</td>
      <td id="T_81a93_row1_col3" class="data row1 col3" >0.413</td>
      <td id="T_81a93_row1_col4" class="data row1 col4" >1.003</td>
      <td id="T_81a93_row1_col5" class="data row1 col5" >7630</td>
    </tr>
    <tr>
      <th id="T_81a93_level0_row2" class="row_heading level0 row2" >312610</th>
      <td id="T_81a93_row2_col0" class="data row2 col0" >에이에프더블류</td>
      <td id="T_81a93_row2_col1" class="data row2 col1" >1.035</td>
      <td id="T_81a93_row2_col2" class="data row2 col2" >-1.967</td>
      <td id="T_81a93_row2_col3" class="data row2 col3" >0.397</td>
      <td id="T_81a93_row2_col4" class="data row2 col4" >1.003</td>
      <td id="T_81a93_row2_col5" class="data row2 col5" >3505</td>
    </tr>
    <tr>
      <th id="T_81a93_level0_row3" class="row_heading level0 row3" >096870</th>
      <td id="T_81a93_row3_col0" class="data row3 col0" >엘디티</td>
      <td id="T_81a93_row3_col1" class="data row3 col1" >1.082</td>
      <td id="T_81a93_row3_col2" class="data row3 col2" >-1.330</td>
      <td id="T_81a93_row3_col3" class="data row3 col3" >0.381</td>
      <td id="T_81a93_row3_col4" class="data row3 col4" >1.003</td>
      <td id="T_81a93_row3_col5" class="data row3 col5" >4145</td>
    </tr>
    <tr>
      <th id="T_81a93_level0_row4" class="row_heading level0 row4" >311390</th>
      <td id="T_81a93_row4_col0" class="data row4 col0" >네오크레마</td>
      <td id="T_81a93_row4_col1" class="data row4 col1" >1.076</td>
      <td id="T_81a93_row4_col2" class="data row4 col2" >-2.141</td>
      <td id="T_81a93_row4_col3" class="data row4 col3" >0.377</td>
      <td id="T_81a93_row4_col4" class="data row4 col4" >1.003</td>
      <td id="T_81a93_row4_col5" class="data row4 col5" >13450</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">select_tops</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
    <span class="n">select_dict</span><span class="p">[</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]]</span>    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_dict</span> <span class="c1"># 결과 확인</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;002680&#39;: [&#39;한탑&#39;, 3155],
 &#39;177350&#39;: [&#39;베셀&#39;, 7630],
 &#39;312610&#39;: [&#39;에이에프더블류&#39;, 3505],
 &#39;096870&#39;: [&#39;엘디티&#39;, 4145],
 &#39;311390&#39;: [&#39;네오크레마&#39;, 13450]}
</pre></div>
</div>
</div>
</div>
<p><br> pickle 파일로 딕셔너리를 저장합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 피클파일로 저장</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;select_dict.pkl&quot;</span><span class="p">,</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">select_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>저장된 피클 파일을 Load 후 원본 디셔너리 파일과 동일한지 확인해 봅니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;select_dict.pkl&quot;</span><span class="p">,</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span>
<span class="n">select_dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span>

<span class="c1"># 결과 확인</span>
<span class="n">select_dict</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;002680&#39;: [&#39;한탑&#39;, 3155],
 &#39;177350&#39;: [&#39;베셀&#39;, 7630],
 &#39;312610&#39;: [&#39;에이에프더블류&#39;, 3505],
 &#39;096870&#39;: [&#39;엘디티&#39;, 4145],
 &#39;311390&#39;: [&#39;네오크레마&#39;, 13450]}
</pre></div>
</div>
</div>
</div>
</section>
</div>
</section>
</div>
<div class="toctree-wrapper compound">
<span id="document-chapter7/7.0.0_Auto_Overview"></span><section class="tex2jax_ignore mathjax_ignore" id="id1">
<h2>자동매매를 해보자<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<p>앞장의 예측 모델로 추천 받은 종목으로 자동매매를 해보는 시간 입니다. 자동매매 프로그래밍은 증권사 API 를 활용하여 파이썬으로 구현할 수 있습니다. 한국투자증권 API 는 기존 증권사들의 것과 완전히 다른 형태로 서비스를 제공하고 있습니다. 구동방식이 기존의 COM, OCX, DLL 과 달리 Rest API(request) 및 Websocket(실시간) 방식 입니다. 따라서, HTS 접속없이 API 호출이 가능한 서비스 입니다. 이번 장에서는 한국투자증권 API 를 활용한 자동매매 방법을 집중적으로 알아보겠습니다. 한편, 한국투자증권 API 자동매매 코드는 유투버 조코딩님의 영상(https://www.youtube.com/watch?v=2Hxfb5HT4kE) 및 깃헙(https://github.com/youtube-jocoding/koreainvestment-autotrade)을 많이 참고 했습니다. 이베스트증권 API 자동매매 코드는 유투버 프로그램동산님의 영상(https://www.youtube.com/playlist?list=PLDtzZPtOGenYAnPT-vVam534Med-dNMDf) 및 카페(https://cafe.naver.com/programgarden/2857)를 많이 참고 했습니다. 두 분 모두 정말 감사드립니다.</p><p>자동매매 프로그램의 경과를 모니터링 하기 위해서 Discord 라는 서비스를 함께 활용할 계획 입니다. Discord 는 서버를 통해 채널(채팅방)을 만들 수 있고, 해당 채널과 연동된 웹후크를 생성 할 수 있습니다. 생성된 웹후크를 활용해서 웹과 모바일 앱을 통해 간편하게 경과 메시지를 받아 볼 수 있습니다.</p><p><img alt="GET_IMAGE" src="_images/autotrade_overview.png" /></p>
<div class="toctree-wrapper compound">
<span id="document-chapter7/7.2.0_env_setting"></span><section class="tex2jax_ignore mathjax_ignore" id="id1">
<h3>개발환경<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<section id="id2">
<h4>코딩 환경 설치<a class="headerlink" href="#id2" title="Permalink to this headline">#</a></h4>
<section id="id3">
<h5>아나콘다 설치<a class="headerlink" href="#id3" title="Permalink to this headline">#</a></h5>
<p>자동매매 코딩 환경 설치를 진행하겠습니다.
먼저 수백 개의 파이썬 패키지를 한 번에 사용할 수 있는 아나콘다(Anaconda)를 설치하겠습니다. 아나콘다 홈페이지(<a class="reference external" href="https://www.anaconda.com/products/distribution">https://www.anaconda.com/products/distribution</a>) 하단에 있는 [Download]를 클릭합니다.</p>
<figure class="align-default" id="id4">
<a class="reference internal image-reference" href="_images/anaconda_1.png"><img alt="_images/anaconda_1.png" src="_images/anaconda_1.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 1 </span><span class="caption-text">[Download] 클릭</span><a class="headerlink" href="#id4" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>한국투자증권 API는 Bit 버전과 운영체제(윈도우, 맥, 리눅스)에 상관없이 전부 실행이 되는 서비스입니다. 만약 다른 증권사 API를 동일 PC에서 사용하고 싶으신 경우에는 호환성을 갖기 위해 windows 32-Bit 버전을 설치합니다.</p>
<figure class="align-default" id="id5">
<a class="reference internal image-reference" href="_images/anaconda_2.png"><img alt="_images/anaconda_2.png" src="_images/anaconda_2.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 2 </span><span class="caption-text">Windows 32-Bit 버전 다운받기</span><a class="headerlink" href="#id5" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>다운로드한 아나콘다 설치 파일을 마우스 우클릭하여 관리자 권한으로 실행합니다.</p>
<figure class="align-default" id="id6">
<a class="reference internal image-reference" href="_images/anaconda_3.png"><img alt="_images/anaconda_3.png" src="_images/anaconda_3.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 3 </span><span class="caption-text">아나콘다 설치 파일 관리자 권한으로 실행 (마우스 우클릭)</span><a class="headerlink" href="#id6" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>[Next]를 클릭하여 아나콘다 설치를 시작합니다.</p>
<figure class="align-default" id="id7">
<a class="reference internal image-reference" href="_images/anaconda_4.png"><img alt="_images/anaconda_4.png" src="_images/anaconda_4.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 4 </span><span class="caption-text">아나콘다 설치 시작 화면 [Next] 클릭</span><a class="headerlink" href="#id7" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>[I Agree]를 클릭하여 라이선스 동의서에 동의합니다.</p>
<figure class="align-default" id="id8">
<a class="reference internal image-reference" href="_images/anaconda_5.png"><img alt="_images/anaconda_5.png" src="_images/anaconda_5.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 5 </span><span class="caption-text">라이선스 동의서 [I Agree] 클릭</span><a class="headerlink" href="#id8" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>[All Users] 체크 후, [Next]를 클릭하여 설치 타입을 정합니다.</p>
<figure class="align-default" id="id9">
<a class="reference internal image-reference" href="_images/anaconda_6.png"><img alt="_images/anaconda_6.png" src="_images/anaconda_6.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 6 </span><span class="caption-text">[All Users] 타입 체크 및 [Next] 클릭</span><a class="headerlink" href="#id9" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>[Next]를 클릭하여 기본 설치 경로를 따릅니다.</p>
<figure class="align-default" id="id10">
<a class="reference internal image-reference" href="_images/anaconda_7.png"><img alt="_images/anaconda_7.png" src="_images/anaconda_7.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 7 </span><span class="caption-text">기본 설치 경로 변경하지 않고 [Next] 클릭</span><a class="headerlink" href="#id10" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>[Register Anaconda3 as the system Python 3.9] 체크하여 Python IDE에서 인터프리터를 자동 인식할 수 있도록 설정합니다.
체크 후, [Install] 클릭하여 설치를 시작합니다.</p>
<figure class="align-default" id="id11">
<a class="reference internal image-reference" href="_images/anaconda_8.png"><img alt="_images/anaconda_8.png" src="_images/anaconda_8.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 8 </span><span class="caption-text">[Register Anaconda3 as the system Python 3.9] 체크 및 [Install] 클릭</span><a class="headerlink" href="#id11" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="pycharm">
<h5>PyCharm 설치<a class="headerlink" href="#pycharm" title="Permalink to this headline">#</a></h5>
<p>파이참(PyCharm) 은 파이썬 코드를 실행하고 그 결과를 확인하는 IDE 입니다. 파이참 홈페이지에서(<a class="reference external" href="https://www.jetbrains.com/ko-kr/pycharm/download/#section=windows">https://www.jetbrains.com/ko-kr/pycharm/download/#section=windows</a>) Community 버전을 다운로드합니다.</p>
<figure class="align-default" id="id12">
<a class="reference internal image-reference" href="_images/PyCharm_1.png"><img alt="_images/PyCharm_1.png" src="_images/PyCharm_1.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 9 </span><span class="caption-text">Community 버전 [Download] 클릭</span><a class="headerlink" href="#id12" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>다운로드한 설치 파일을 실행시키고,
Welcome Page 가 뜨면 [Next] 버튼을 클릭합니다.</p>
<figure class="align-default" id="id13">
<a class="reference internal image-reference" href="_images/PyCharm_2.png"><img alt="_images/PyCharm_2.png" src="_images/PyCharm_2.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 10 </span><span class="caption-text">Welcome Page 에서 [Next] 클릭</span><a class="headerlink" href="#id13" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>설치 경로를 설정한 후, [Next] 버튼을 클릭합니다.</p>
<figure class="align-default" id="id14">
<a class="reference internal image-reference" href="_images/PyCharm_3.png"><img alt="_images/PyCharm_3.png" src="_images/PyCharm_3.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 11 </span><span class="caption-text">설치 경로 설정 및 [Next] 클릭</span><a class="headerlink" href="#id14" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>설치 옵션 화면에서 모든 옵션을 선택 후, [Next] 버튼을 클릭합니다.</p>
<figure class="align-default" id="id15">
<a class="reference internal image-reference" href="_images/PyCharm_4.png"><img alt="_images/PyCharm_4.png" src="_images/PyCharm_4.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 12 </span><span class="caption-text">모든 옵션 선택 및 [Next] 클릭</span><a class="headerlink" href="#id15" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>시작 메뉴 이름 설정 후, [Install] 버튼을 클릭합니다.</p>
<figure class="align-default" id="id16">
<a class="reference internal image-reference" href="_images/PyCharm_5.png"><img alt="_images/PyCharm_5.png" src="_images/PyCharm_5.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 13 </span><span class="caption-text">시작 메뉴 이름 설정 및 [Install] 클릭</span><a class="headerlink" href="#id16" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>마지막으로 재부팅을 바로 실행하거나 나중에 실행하기 선택 후 [Finish] 버튼을 클릭합니다.</p>
<figure class="align-default" id="id17">
<a class="reference internal image-reference" href="_images/PyCharm_6.png"><img alt="_images/PyCharm_6.png" src="_images/PyCharm_6.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 14 </span><span class="caption-text">재부팅 옵션 선택 및 [Finish] 클릭</span><a class="headerlink" href="#id17" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
</section>
<section id="id18">
<h4>디스코드 설정<a class="headerlink" href="#id18" title="Permalink to this headline">#</a></h4>
<p>자동매매 경과를 모니터링할 수 있는 디스코드 설정을 진행하겠습니다. 먼저 디스코드 홈페이지(<a class="reference external" href="https://discord.com/">https://discord.com/</a>)를 방문하여 회원가입을 진행합니다. 회원가입 완료 후, [웹브라우저에서 Discord 열기]를 클릭합니다. 디스코드 웹 APP 및 모바일 APP 을 다운로드하면 메시지를 더 편리하게 받아 볼 수 있습니다.</p>
<figure class="align-default" id="id19">
<a class="reference internal image-reference" href="_images/discord_1.png"><img alt="_images/discord_1.png" src="_images/discord_1.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 15 </span><span class="caption-text">회원가입 후, [웹브라우저에서 Discord 열기] 클릭</span><a class="headerlink" href="#id19" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>웹브라우저에서 디스코드가 열리면, 화면의 좌측 플러스(“+”) 아이콘을 클릭합니다.</p>
<figure class="align-default" id="id20">
<a class="reference internal image-reference" href="_images/discord_2.png"><img alt="_images/discord_2.png" src="_images/discord_2.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 16 </span><span class="caption-text">화면 좌측 플러스 아이콘 클릭</span><a class="headerlink" href="#id20" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>“서버만들기” 팝업이 뜨면 [직접만들기] 버튼을 클릭합니다.</p>
<figure class="align-default" id="id21">
<a class="reference internal image-reference" href="_images/discord_3.png"><img alt="_images/discord_3.png" src="_images/discord_3.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 17 </span><span class="caption-text">[직접만들기] 클릭</span><a class="headerlink" href="#id21" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>이어서 [나와친구들을 위한 서버] 버튼을 클릭합니다.</p>
<figure class="align-default" id="id22">
<a class="reference internal image-reference" href="_images/discord_4.png"><img alt="_images/discord_4.png" src="_images/discord_4.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 18 </span><span class="caption-text">[나와친구들을 위한 서버] 클릭</span><a class="headerlink" href="#id22" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>서버 이름은 자유롭게 정하고 [만들기] 버튼을 클릭합니다.</p>
<figure class="align-default" id="id23">
<a class="reference internal image-reference" href="_images/discord_5.png"><img alt="_images/discord_5.png" src="_images/discord_5.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 19 </span><span class="caption-text">서버이름 작성 및 [만들기] 클릭</span><a class="headerlink" href="#id23" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>서버가 만들어지면 채팅 채널 밑에 “# 일반” 혹은 “# general” 의 설정 아이콘(채널 편집) 을 클릭합니다.</p>
<figure class="align-default" id="id24">
<a class="reference internal image-reference" href="_images/discord_6.png"><img alt="_images/discord_6.png" src="_images/discord_6.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 20 </span><span class="caption-text">화면 좌측 “# 일반” 설정 아이콘 클릭</span><a class="headerlink" href="#id24" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>이어서 왼쪽에 있는 [연동] 세션을 클릭하고 [웹후크 만들기] 버튼을 클릭합니다.</p>
<figure class="align-default" id="id25">
<a class="reference internal image-reference" href="_images/discord_7.png"><img alt="_images/discord_7.png" src="_images/discord_7.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 21 </span><span class="caption-text">화면 좌측 [연동] 클릭 후, [웹후크 만들기] 클릭</span><a class="headerlink" href="#id25" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>마지막으로 [웹후크 URL 복사] 버튼을 클릭하고, 추후에 사용할 수 있도록 저장해둡니다.</p>
</section>
</section>
<span id="document-chapter7/7.2.1_create_accnt_hanguk"></span><section class="tex2jax_ignore mathjax_ignore" id="id1">
<h3>한국투자증권<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<section id="id2">
<h4>계좌개설<a class="headerlink" href="#id2" title="Permalink to this headline">#</a></h4>
<p>안드로이드 혹은 앱 스토어에서 Fig 1에서 보이는 한국투자증권 애플리케이션을 설치합니다. 앱 설치 완료 후, 비대면 계좌 개설을 진행합니다. 신분증 촬영과 간단한 인증절차를 밟으면 어렵지 않게 계좌 개설을 완료할 수 있습니다.</p>
<figure class="align-default" id="https-apps-apple-com-kr-app-ed-95-9c-ea-b5-ad-ed-88-ac-ec-9e-90-id1621986905">
<a class="reference internal image-reference" href="_images/hanguk_app.png"><img alt="_images/hanguk_app.png" src="_images/hanguk_app.png" style="width: 500px; height: 250px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 22 </span><span class="caption-text">한국투자증권 애플리케이션 설치</span><a class="headerlink" href="#https-apps-apple-com-kr-app-ed-95-9c-ea-b5-ad-ed-88-ac-ec-9e-90-id1621986905" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="open-api">
<h4>Open API 인증키 발급<a class="headerlink" href="#open-api" title="Permalink to this headline">#</a></h4>
<p>이어서 한국투자증권의 Open API 키를 받아야 합니다. 국내 유일 REST API 및 Websocket 방식이어서 기존 증권사 API 처럼 프로그램 설치가 필요 없습니다. Web 을 통해서 데이터를 송/수신하기 때문에 OS(윈도우, 맥, 리눅스)에 상관없이 모두 사용 가능합니다. KIS Developers 홈페이지(<a class="reference external" href="http://apiportal.koreainvestment.com">http://apiportal.koreainvestment.com</a>)로 이동한 후, API 신청을 진행합니다.</p>
<figure class="align-default" id="api">
<a class="reference internal image-reference" href="_images/api_1.png"><img alt="_images/api_1.png" src="_images/api_1.png" style="width: 600px; height: 200px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 23 </span><span class="caption-text">우측 상단 [API신청] 클릭</span><a class="headerlink" href="#api" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>[API신청] 클릭 후, Fig 3에서 보이는 스마트폰 인증을 통해 간단히 로그인을 할 수 있습니다.</p>
<figure class="align-default" id="id3">
<a class="reference internal image-reference" href="_images/api_2.png"><img alt="_images/api_2.png" src="_images/api_2.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 24 </span><span class="caption-text">한국투자앱&gt; 전체메뉴&gt; 인증센터&gt; PC인증</span><a class="headerlink" href="#id3" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>로그인을 성공하면 모바일 [인증번호 요청] 을 클릭하고 인증번호 입력 후, [신청] 버튼을 클릭합니다.</p>
<figure class="align-default" id="id4">
<a class="reference internal image-reference" href="_images/api_3.png"><img alt="_images/api_3.png" src="_images/api_3.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 25 </span><span class="caption-text">번호 인증 후, [신청] 클릭</span><a class="headerlink" href="#id4" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>[신청] 클릭 후, 개인정보 및 고객 이용 약관에 모두 동의한 후, [다음] 버튼을 클릭합니다.</p>
<figure class="align-default" id="id5">
<a class="reference internal image-reference" href="_images/api_4.png"><img alt="_images/api_4.png" src="_images/api_4.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 26 </span><span class="caption-text">개인정보 및 고객이용약관 동의 후, [다음] 클릭</span><a class="headerlink" href="#id5" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>[다음] 클릭 후, 고객명, 이메일, 핸드폰 번호, 전화번호 정보가 제대로 기입되었는지 확인하고, 계좌 정보란에서 이용할 종합계좌를 선택하고 비밀번호를 입력합니다. 모의계좌도 체크하여 임의의 계좌번호를 입력합니다. API그룹란에서 모든 그룹을 선택하고 [다음] 버튼을 클릭합니다.</p>
<figure class="align-default" id="id6">
<a class="reference internal image-reference" href="_images/api_5.png"><img alt="_images/api_5.png" src="_images/api_5.png" style="width: 600px; height: 400px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 27 </span><span class="caption-text">계좌정보 기입 및 API그룹 모두 선택 후, [다음] 클릭</span><a class="headerlink" href="#id6" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>[다음] 클릭 후, 스마트폰 인증을 완료하면 카톡을 통해 API 신청 완료 메시지를 받을 수 있습니다. 이로써 한국투자증권의 Open API 신청을 완료했습니다.</p>
</section>
</section>
<span id="document-chapter7/7.2.2_connect_hanguk"></span><section id="id1">
<h3>서비스 연결<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>API 요청을 위해 “requests” 와 “json” 패키지가 필요합니다. “requests” 패키지는 HTTP 요청을 보낼 때, “json” 은 수신 받은 객체를 JSON 데이터로 만들어서 쓰기 위해 활용되는 패키지입니다. JSON 데이터는 pandas 데이터프레임으로 변환하기 쉬운 이점도 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span> 
<span class="kn">import</span> <span class="nn">json</span>
</pre></div>
</div>
</div>
</div>
<p>requests는 크게 GET과 POST 방식이 있습니다. GET 방식은 현재가 혹은 주식 잔고 조회 같은 요청에서 쓰이고, POST 방식은 주로 주문/정정/취소 요청에서 쓰입니다. 아래 코드 셀은 GET 방식의 예제입니다. GET 방식의 주요 구성 요소는 URL, headers, 그리고 params입니다. 먼저 URL은 실전 또는 모의 투자에서 조회하고 싶은 요청의 경로 정보를 담고 있습니다. 다음으로 headers는 수신 데이터의 형태 및 요청자를 식별할 수 있는 인증 정보를 담고 있습니다. 마지막으로 params는 조회하고자 하는 시장(주식, ETF, ETN) 과 종목 코드 정보를 담고 있습니다. 각 구성 요소에서 어떤 구분자를 입력해야 하는지는 KIS Developers의 API 문서에 자세히 나와 있습니다. API 문서의 활용 방법은 주요 사용 함수를 정리하는 절에서 함께 들여다볼 계획입니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;주식 종목 현재가 조회&quot;&quot;&quot;</span>

<span class="c1"># URL 설정</span>
<span class="n">URL_BASE</span> <span class="o">=</span> <span class="s2">&quot;https://openapivts.koreainvestment.com:29443&quot;</span> <span class="c1"># 모의 투자</span>
<span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;uapi/domestic-stock/v1/quotations/inquire-price&quot;</span> <span class="c1"># 현재가 조회를 위한 URL 경로</span>
<span class="n">URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">URL_BASE</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;005930&quot;</span> <span class="c1"># 삼성전자 종목 코드</span>

<span class="c1"># headers 설정</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
    <span class="s2">&quot;authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">ACCESS_TOKEN</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="c1"># 보안인증키</span>
    <span class="s2">&quot;appKey&quot;</span><span class="p">:</span><span class="n">APP_KEY</span><span class="p">,</span> <span class="c1"># API 신청으로 발금 받은 Key</span>
    <span class="s2">&quot;appSecret&quot;</span><span class="p">:</span><span class="n">APP_SECRET</span><span class="p">,</span> <span class="c1"># API 신청으로 발금 받은 Secret</span>
    <span class="s2">&quot;tr_id&quot;</span><span class="p">:</span><span class="s2">&quot;FHKST01010100&quot;</span> <span class="c1"># 현재가 조회를 위한 거래ID </span>
<span class="p">}</span>

<span class="c1"># params 설정</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;fid_cond_mrkt_div_code&quot;</span><span class="p">:</span><span class="s2">&quot;J&quot;</span><span class="p">,</span> <span class="c1"># J: 주식</span>
    <span class="s2">&quot;fid_input_iscd&quot;</span><span class="p">:</span><span class="n">code</span><span class="p">,</span> <span class="c1"># 조회 하고 싶은 주식 종목의 코드 ex) 삼성전자: 005930</span>
<span class="p">}</span>

<span class="c1"># GET request 함수 호출</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;stck_prpr&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<p>GET 방식과 마찬가지로 POST 방식에서도 URL에 주문하고자 하는 경로 값을 설정해 줍니다. 주문 관련 요청이 있기 때문에 headers에는 hashkey(암호화) 값을 추가하여 보안 수준을 높여 줍니다. 또한, 매수/매도를 구분하는 거래ID 값을 headers에 추가해 줍니다. 마지막으로 data에 주문 요청을 처리할 수 있는 계좌번호, 매수/매도 수량 그리고 주문가격 정보들을 담아 줍니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;주식 시장가 매수&quot;&quot;&quot;</span>

<span class="c1"># URL 설정</span>
<span class="n">URL_BASE</span> <span class="o">=</span> <span class="s2">&quot;https://openapivts.koreainvestment.com:29443&quot;</span> <span class="c1"># 모의 투자</span>
<span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;uapi/domestic-stock/v1/trading/order-cash&quot;</span> <span class="c1"># cash 주문</span>
<span class="n">URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">URL_BASE</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="n">code</span> <span class="o">=</span> <span class="s2">&quot;005930&quot;</span> <span class="c1"># 삼성전자 종목 코드</span>

<span class="c1"># data 설정</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;CANO&quot;</span><span class="p">:</span> <span class="n">CANO</span><span class="p">,</span> <span class="c1"># 계좌번호 앞자리</span>
    <span class="s2">&quot;ACNT_PRDT_CD&quot;</span><span class="p">:</span> <span class="n">ACNT_PRDT_CD</span><span class="p">,</span>  <span class="c1"># 계좌번호 뒷자리</span>
    <span class="s2">&quot;PDNO&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
    <span class="s2">&quot;ORD_DVSN&quot;</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span> <span class="c1"># 시장가</span>
    <span class="s2">&quot;ORD_QTY&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">qty</span><span class="p">)),</span> <span class="c1"># 매수 주문 수량</span>
    <span class="s2">&quot;ORD_UNPR&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="c1"># 시장가로 매수 시, ORD_UNPR 는 0 (지정가로 매수 시, ORD_UNPR 는 원하는 지정가로 명시) </span>
<span class="p">}</span>

<span class="c1"># headers 설정</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
    <span class="s2">&quot;authorization&quot;</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">ACCESS_TOKEN</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="c1"># 보안인증키</span>
    <span class="s2">&quot;appKey&quot;</span><span class="p">:</span><span class="n">APP_KEY</span><span class="p">,</span>  <span class="c1"># API 신청으로 발금 받은 Key</span>
    <span class="s2">&quot;appSecret&quot;</span><span class="p">:</span><span class="n">APP_SECRET</span><span class="p">,</span> <span class="c1"># API 신청으로 발금 받은 Secret</span>
    <span class="s2">&quot;tr_id&quot;</span><span class="p">:</span><span class="s2">&quot;VTTC0802U&quot;</span><span class="p">,</span> <span class="c1"># 매수 주문을 위한 거래ID</span>
    <span class="s2">&quot;custtype&quot;</span><span class="p">:</span><span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="c1"># P: 개인 </span>
    <span class="s2">&quot;hashkey&quot;</span> <span class="p">:</span> <span class="n">hashkey</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
<span class="p">}</span>

<span class="c1"># POST request 함수 호출</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>한편, 해쉬키 함수는 다음과 같이 정의 되어 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">hashkey</span><span class="p">(</span><span class="n">datas</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;암호화&quot;&quot;&quot;</span>
    <span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;uapi/hashkey&quot;</span>
    <span class="n">URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">URL_BASE</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;content-Type&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
    <span class="s1">&#39;appKey&#39;</span> <span class="p">:</span> <span class="n">APP_KEY</span><span class="p">,</span>
    <span class="s1">&#39;appSecret&#39;</span> <span class="p">:</span> <span class="n">APP_SECRET</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">datas</span><span class="p">))</span>
    <span class="n">hashkey</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;HASH&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">hashkey</span>
</pre></div>
</div>
</div>
</div>
<p>위 예제 코드의 GET 과 POST 방식 모두 headers에서 ACCESS_TOKEN 을 필요로 하는데, get_access_token() 함수에서 APP_KEY 와 APP_SECRET를 이용해서 발급받을 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_access_token</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;토큰 발급&quot;&quot;&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;content-type&quot;</span><span class="p">:</span><span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;grant_type&quot;</span><span class="p">:</span><span class="s2">&quot;client_credentials&quot;</span><span class="p">,</span>
    <span class="s2">&quot;appkey&quot;</span><span class="p">:</span><span class="n">APP_KEY</span><span class="p">,</span>
    <span class="s2">&quot;appsecret&quot;</span><span class="p">:</span><span class="n">APP_SECRET</span><span class="p">}</span>
    <span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;oauth2/tokenP&quot;</span>
    <span class="n">URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">URL_BASE</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>
    <span class="n">ACCESS_TOKEN</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ACCESS_TOKEN</span>
</pre></div>
</div>
</div>
</div>
<p>끝으로 headers와 data 설정에서 반복적으로 사용되는 개인 정보들은 config.yaml 파일에 일괄적으로 저장해 두면 더 간편하게 개인정보를 관리할 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;config.yaml 파일 생성&quot;&quot;&quot;</span>

<span class="c1">#홈페이지에서 API서비스 신청시 받은 Appkey, Appsecret 값 설정</span>
<span class="n">APP_KEY</span><span class="p">:</span> <span class="s2">&quot;xxxxxxxxxxxxxxxxxxxxxxx&quot;</span>
<span class="n">APP_SECRET</span><span class="p">:</span> <span class="s2">&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span>

<span class="c1">#계좌번호 앞 8자리</span>
<span class="n">CANO</span><span class="p">:</span> <span class="s2">&quot;xxxxxxxx&quot;</span>
<span class="c1">#계좌번호 뒤 2자리</span>
<span class="n">ACNT_PRDT_CD</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span>

<span class="c1">#실전투자</span>
<span class="c1"># URL_BASE: &quot;https://openapi.koreainvestment.com:9443&quot;</span>
<span class="c1">#모의투자</span>
<span class="n">URL_BASE</span><span class="p">:</span> <span class="s2">&quot;https://openapivts.koreainvestment.com:29443&quot;</span>

<span class="c1">#디스코드 웹훅 URL</span>
<span class="n">DISCORD_WEBHOOK_URL</span><span class="p">:</span> <span class="s2">&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span>
</pre></div>
</div>
</div>
</div>
</section>
<span id="document-chapter7/7.2.3_functions_hanguk"></span><section class="tex2jax_ignore mathjax_ignore" id="id1">
<h3>주요 함수 정의<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<section id="id2">
<h4>현재가 조회<a class="headerlink" href="#id2" title="Permalink to this headline">#</a></h4>
<p>원하는 시장가에 매수 주문을 넣기 위해서 해당 종목의 현재가를 조회해야 합니다. 현재가 조회 방법을 알아보기 위해서 KIS Developers 홈페이지 &gt; API 문서 &gt; 국내주식시세 &gt; 주식현재가 시세(<a class="reference external" href="https://apiportal.koreainvestment.com/apiservice/apiservice-domestic-stock-quotations#L_07802512-4f49-4486-91b4-1050b6f5dc9d">https://apiportal.koreainvestment.com/apiservice/apiservice-domestic-stock-quotations#L_07802512-4f49-4486-91b4-1050b6f5dc9d</a>) 페이지에 접속하겠습니다.</p>
<p><img alt="GET_IMAGE" src="_images/get_current_price_1.png" /></p>
<p>기본정보에서 주식현재가 시세 조회가 GET 방식임을 확인할 수 있고, LAYOUT 을 통해 Request 함수의 headers 및 params의 인자 값들을 확인할 수 있습니다.</p>
<p><img alt="GET_IMAGE" src="_images/get_current_price_2.png" /></p>
<p>또한, 수신 받을 Response 객체의 형태도 미리 확인하고 원하는 데이터를 어떻게 추출할지도 알 수 있습니다.</p>
<p><img alt="GET_IMAGE" src="_images/get_current_price_3.png" /></p>
<p>Request 와 Response 문서를 참고하여 특정 종목의 현재가를 조회하는 함수는 아래와 같습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_current_price</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;005930&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;현재가 조회&quot;&quot;&quot;</span>
    <span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;uapi/domestic-stock/v1/quotations/inquire-price&quot;</span>
    <span class="n">URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">URL_BASE</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">PAH</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span> 
            <span class="s2">&quot;authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">ACCESS_TOKEN</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
            <span class="s2">&quot;appKey&quot;</span><span class="p">:</span><span class="n">APP_KEY</span><span class="p">,</span>
            <span class="s2">&quot;appSecret&quot;</span><span class="p">:</span><span class="n">APP_SECRET</span><span class="p">,</span>
            <span class="s2">&quot;tr_id&quot;</span><span class="p">:</span><span class="s2">&quot;FHKST01010100&quot;</span> 
    <span class="p">}</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;fid_cond_mrkt_div_code&quot;</span><span class="p">:</span><span class="s2">&quot;J&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;fid_input_iscd&quot;</span><span class="p">:</span><span class="n">code</span><span class="p">,</span> 
    <span class="p">}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;stck_prpr&#39;</span><span class="p">])</span> 
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h4>잔고 조회<a class="headerlink" href="#id3" title="Permalink to this headline">#</a></h4>
<p>잔고 조회도 마찬가지로 KIS Developers의 API 문서를 참고하겠습니다. KIS Developers 홈페이지 &gt; API 문서 &gt; 국내주식주문 &gt; 주식잔고조회(<a class="reference external" href="https://apiportal.koreainvestment.com/apiservice/apiservice-domestic-stock#L_66c61080-674f-4c91-a0cc-db5e64e9a5e6">https://apiportal.koreainvestment.com/apiservice/apiservice-domestic-stock#L_66c61080-674f-4c91-a0cc-db5e64e9a5e6</a>) 페이지에 접속하겠습니다.</p>
<p><img alt="GET_IMAGE" src="_images/get_stock_balance_1.png" /></p>
<p>앞에서의 현재가 조회와 마찬가지로 LAYOUT의 Request 문서를 참고하여 headers 및 params의 인자 값들을 확인할 수 있습니다. Response 문서에서 수신 데이터 형태를 미리 확인하고 원하는 데이터를 추출하는 코드를 작성합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_stock_balance</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;주식 잔고조회&quot;&quot;&quot;</span>
    <span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;uapi/domestic-stock/v1/trading/inquire-balance&quot;</span>
    <span class="n">URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">URL_BASE</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;authorization&quot;</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">ACCESS_TOKEN</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;appKey&quot;</span><span class="p">:</span><span class="n">APP_KEY</span><span class="p">,</span>
        <span class="s2">&quot;appSecret&quot;</span><span class="p">:</span><span class="n">APP_SECRET</span><span class="p">,</span>
        <span class="s2">&quot;tr_id&quot;</span><span class="p">:</span><span class="s2">&quot;VTTC8434R&quot;</span><span class="p">,</span>  <span class="c1"># 실전 투자 &quot;TTTC8434R&quot;</span>
        <span class="s2">&quot;custtype&quot;</span><span class="p">:</span><span class="s2">&quot;P&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;CANO&quot;</span><span class="p">:</span> <span class="n">CANO</span><span class="p">,</span>
        <span class="s2">&quot;ACNT_PRDT_CD&quot;</span><span class="p">:</span> <span class="n">ACNT_PRDT_CD</span><span class="p">,</span>
        <span class="s2">&quot;AFHR_FLPR_YN&quot;</span><span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span>
        <span class="s2">&quot;OFL_YN&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INQR_DVSN&quot;</span><span class="p">:</span> <span class="s2">&quot;02&quot;</span><span class="p">,</span>
        <span class="s2">&quot;UNPR_DVSN&quot;</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FUND_STTL_ICLD_YN&quot;</span><span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FNCG_AMT_AUTO_RDPT_YN&quot;</span><span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PRCS_DVSN&quot;</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CTX_AREA_FK100&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CTX_AREA_NK100&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
    <span class="p">}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
    <span class="n">stock_list</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;output1&#39;</span><span class="p">]</span>
    <span class="n">evaluation</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;output2&#39;</span><span class="p">]</span>
    <span class="n">stock_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;====주식 보유잔고====&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">stock</span> <span class="ow">in</span> <span class="n">stock_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;hldg_qty&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">stock_dict</span><span class="p">[</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;pdno&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;hldg_qty&#39;</span><span class="p">],</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;evlu_pfls_rt&#39;</span><span class="p">]]</span> <span class="c1"># 0: 보유 수량, 1: 평가손익율</span>
            <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;prdt_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;pdno&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;hldg_qty&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">주 </span><span class="si">{</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;evlu_pfls_rt&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;주식 평가 금액: </span><span class="si">{</span><span class="n">evaluation</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;scts_evlu_amt&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">원&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;평가 손익 합계: </span><span class="si">{</span><span class="n">evaluation</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;evlu_pfls_smtl_amt&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">원&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;총 평가 금액: </span><span class="si">{</span><span class="n">evaluation</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;tot_evlu_amt&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">원&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=================&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stock_dict</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h4>잔여 현금 조회<a class="headerlink" href="#id4" title="Permalink to this headline">#</a></h4>
<p>잔여 현금 조회도 마찬가지로 KIS Developers의 API 문서를 참고하겠습니다. KIS Developers 홈페이지 &gt; API 문서 &gt; 국내주식주문 &gt; 매수가능조회(<a class="reference external" href="https://apiportal.koreainvestment.com/apiservice/apiservice-domestic-stock#L_aade4c72-5fb7-418a-9ff2-254b4d5f0ceb">https://apiportal.koreainvestment.com/apiservice/apiservice-domestic-stock#L_aade4c72-5fb7-418a-9ff2-254b4d5f0ceb</a>) 페이지에 접속하겠습니다.</p>
<p><img alt="GET_IMAGE" src="_images/get_balance_1.png" /></p>
<p>LAYOUT의 Request 문서를 참고하여 headers 및 params의 인자 값들을 확인할 수 있습니다. Response 문서에서 수신 데이터 형태를 미리 확인하고 원하는 데이터를 추출하는 코드를 작성합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_balance</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;현금 잔고조회&quot;&quot;&quot;</span>
    <span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;uapi/domestic-stock/v1/trading/inquire-psbl-order&quot;</span> <span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
    <span class="n">URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">URL_BASE</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span> <span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
        <span class="s2">&quot;authorization&quot;</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">ACCESS_TOKEN</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;appKey&quot;</span><span class="p">:</span><span class="n">APP_KEY</span><span class="p">,</span>
        <span class="s2">&quot;appSecret&quot;</span><span class="p">:</span><span class="n">APP_SECRET</span><span class="p">,</span>
        <span class="s2">&quot;tr_id&quot;</span><span class="p">:</span><span class="s2">&quot;TTTC8908R&quot;</span><span class="p">,</span> <span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
        <span class="s2">&quot;custtype&quot;</span><span class="p">:</span><span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
    <span class="p">}</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;CANO&quot;</span><span class="p">:</span> <span class="n">CANO</span><span class="p">,</span>
        <span class="s2">&quot;ACNT_PRDT_CD&quot;</span><span class="p">:</span> <span class="n">ACNT_PRDT_CD</span><span class="p">,</span>
        <span class="s2">&quot;PDNO&quot;</span><span class="p">:</span> <span class="s2">&quot;005930&quot;</span><span class="p">,</span> <span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
        <span class="s2">&quot;ORD_UNPR&quot;</span><span class="p">:</span> <span class="s2">&quot;65500&quot;</span><span class="p">,</span> <span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
        <span class="s2">&quot;ORD_DVSN&quot;</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span> <span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
        <span class="s2">&quot;CMA_EVLU_AMT_ICLD_YN&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
        <span class="s2">&quot;OVRS_ICLD_YN&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span> <span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
    <span class="p">}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
    <span class="n">cash</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;ord_psbl_cash&#39;</span><span class="p">]</span> <span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
    <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;주문 가능 현금 잔고: </span><span class="si">{</span><span class="n">cash</span><span class="si">}</span><span class="s2">원&quot;</span><span class="p">)</span> 
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">cash</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id5">
<h4>5일 이상 보유 종목 조회<a class="headerlink" href="#id5" title="Permalink to this headline">#</a></h4>
<p>5일 이상 보유 중인 종목을 조회하기 위해서는 주식일별주문체결 정보를 조회 해야 합니다. KIS Developers 홈페이지 &gt; API 문서 &gt; 국내주식주문 &gt; 주식일별주문체결조회(<a class="reference external" href="https://apiportal.koreainvestment.com/apiservice/apiservice-domestic-stock#L_bc51f9f7-146f-4971-a5ae-ebd574acec12">https://apiportal.koreainvestment.com/apiservice/apiservice-domestic-stock#L_bc51f9f7-146f-4971-a5ae-ebd574acec12</a>) 페이지에 접속하겠습니다.</p>
<p><img alt="GET_IMAGE" src="_images/stock_over_5d.png" /></p>
<p>LAYOUT의 Request 문서를 참고하여 headers 및 params의 인자 값들을 확인할 수 있습니다. Response 문서에서 수신 데이터 형태를 미리 확인하고 원하는 데이터를 추출하는 코드를 작성합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_stock_5d_before</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">get_stock_before</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
        <span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;uapi/domestic-stock/v1/trading/inquire-daily-ccld&quot;</span>
        <span class="n">URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">URL_BASE</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;authorization&quot;</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">ACCESS_TOKEN</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;appKey&quot;</span><span class="p">:</span><span class="n">APP_KEY</span><span class="p">,</span>
            <span class="s2">&quot;appSecret&quot;</span><span class="p">:</span><span class="n">APP_SECRET</span><span class="p">,</span>
            <span class="s2">&quot;tr_id&quot;</span><span class="p">:</span><span class="s2">&quot;VTTC8001R&quot;</span><span class="p">,</span>  <span class="c1"># 실전 투자 &quot;TTTC8001R&quot;</span>
            <span class="s2">&quot;custtype&quot;</span><span class="p">:</span><span class="s2">&quot;P&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;CANO&quot;</span><span class="p">:</span> <span class="n">CANO</span><span class="p">,</span>
            <span class="s2">&quot;ACNT_PRDT_CD&quot;</span><span class="p">:</span> <span class="n">ACNT_PRDT_CD</span><span class="p">,</span>
            <span class="s2">&quot;INQR_STRT_DT&quot;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
            <span class="s2">&quot;INQR_END_DT&quot;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
            <span class="s2">&quot;SLL_BUY_DVSN_CD&quot;</span><span class="p">:</span> <span class="s2">&quot;02&quot;</span><span class="p">,</span> <span class="c1"># 00:전체, 01:매도, 02:매수</span>
            <span class="s2">&quot;INQR_DVSN&quot;</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span> <span class="c1"># 00: 역순</span>
            <span class="s2">&quot;PDNO&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> 
            <span class="s2">&quot;CCLD_DVSN&quot;</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ORD_GNO_BRNO&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ODNO&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;INQR_DVSN_3&quot;</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span>
            <span class="s2">&quot;INQR_DVSN_1&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CTX_AREA_FK100&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CTX_AREA_NK100&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
        <span class="p">}</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="n">stock_dict</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;output1&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">stock_dict</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="k">while</span> <span class="n">prev</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span>
        <span class="n">t_previous_5d</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">prev</span><span class="p">)</span>
        <span class="n">t_previous_5d</span> <span class="o">=</span> <span class="n">t_previous_5d</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">bought_previous_5d_dict</span> <span class="o">=</span> <span class="n">get_stock_before</span><span class="p">(</span><span class="n">t_previous_5d</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bought_previous_5d_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prev</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">sell_list_5d_over</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">stock</span> <span class="ow">in</span> <span class="n">bought_previous_5d_dict</span><span class="p">:</span>
        <span class="n">sell_list_5d_over</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;pdno&#39;</span><span class="p">])</span>
    <span class="n">sell_list_5d_over</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sell_list_5d_over</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">sell_list_5d_over</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id6">
<h4>매수<a class="headerlink" href="#id6" title="Permalink to this headline">#</a></h4>
<p>매수 주문도 마찬가지로 KIS Developers의 API 문서를 참고하겠습니다. KIS Developers 홈페이지 &gt; API 문서 &gt;  국내주식주문 &gt; 주식주문(현금) (<a class="reference external" href="https://apiportal.koreainvestment.com/apiservice/apiservice-domestic-stock#L_aade4c72-5fb7-418a-9ff2-254b4d5f0ceb">https://apiportal.koreainvestment.com/apiservice/apiservice-domestic-stock#L_aade4c72-5fb7-418a-9ff2-254b4d5f0ceb</a>) 페이지에 접속하겠습니다.</p>
<p><img alt="GET_IMAGE" src="_images/buy_1.png" /></p>
<p>앞의 조회 요청들과 달리 주문 요청은 기본정보에서 POST 방식임을 확인할 수 있고 보안을 위해서 headers에 hashkey 값을 입력해 줍니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">buy</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;005930&quot;</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;주식 시장가 매수&quot;&quot;&quot;</span>
    <span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;uapi/domestic-stock/v1/trading/order-cash&quot;</span> <span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
    <span class="n">URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">URL_BASE</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;CANO&quot;</span><span class="p">:</span> <span class="n">CANO</span><span class="p">,</span>
        <span class="s2">&quot;ACNT_PRDT_CD&quot;</span><span class="p">:</span> <span class="n">ACNT_PRDT_CD</span><span class="p">,</span>
        <span class="s2">&quot;PDNO&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
        <span class="s2">&quot;ORD_DVSN&quot;</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ORD_QTY&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">qty</span><span class="p">)),</span> <span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
        <span class="s2">&quot;ORD_UNPR&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
    <span class="p">}</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span> <span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
        <span class="s2">&quot;authorization&quot;</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">ACCESS_TOKEN</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;appKey&quot;</span><span class="p">:</span><span class="n">APP_KEY</span><span class="p">,</span>
        <span class="s2">&quot;appSecret&quot;</span><span class="p">:</span><span class="n">APP_SECRET</span><span class="p">,</span>
        <span class="s2">&quot;tr_id&quot;</span><span class="p">:</span><span class="s2">&quot;TTTC0802U&quot;</span><span class="p">,</span> <span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
        <span class="s2">&quot;custtype&quot;</span><span class="p">:</span><span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
        <span class="s2">&quot;hashkey&quot;</span> <span class="p">:</span> <span class="n">hashkey</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
    <span class="p">}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rt_cd&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span> <span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; rt_cd 값이 0 이면 성공 </span>
        <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[매수 성공]</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[매수 실패]</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id7">
<h4>매도<a class="headerlink" href="#id7" title="Permalink to this headline">#</a></h4>
<p>매도 주문은 매수 주문 코드와 거의 똑같습니다. 다만, 거래ID 가 다릅니다.</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>거래 ID</p></th>
<th class="text-align:left head"><p>정의</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>TTTC0802U</p></td>
<td class="text-align:left"><p>매수 주문</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>TTTC0801U</p></td>
<td class="text-align:left"><p>매도 주문</p></td>
</tr>
</tbody>
</table>
<p>간단하게 headers 에서 거래 ID 만 바꿔 주겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sell</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;005930&quot;</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;주식 시장가 매도&quot;&quot;&quot;</span>
    <span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;uapi/domestic-stock/v1/trading/order-cash&quot;</span>
    <span class="n">URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">URL_BASE</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;CANO&quot;</span><span class="p">:</span> <span class="n">CANO</span><span class="p">,</span>
        <span class="s2">&quot;ACNT_PRDT_CD&quot;</span><span class="p">:</span> <span class="n">ACNT_PRDT_CD</span><span class="p">,</span>
        <span class="s2">&quot;PDNO&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
        <span class="s2">&quot;ORD_DVSN&quot;</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ORD_QTY&quot;</span><span class="p">:</span> <span class="n">qty</span><span class="p">,</span>
        <span class="s2">&quot;ORD_UNPR&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;authorization&quot;</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">ACCESS_TOKEN</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;appKey&quot;</span><span class="p">:</span><span class="n">APP_KEY</span><span class="p">,</span>
        <span class="s2">&quot;appSecret&quot;</span><span class="p">:</span><span class="n">APP_SECRET</span><span class="p">,</span>
        <span class="s2">&quot;tr_id&quot;</span><span class="p">:</span><span class="s2">&quot;TTTC0801U&quot;</span><span class="p">,</span> <span class="c1"># &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span>
        <span class="s2">&quot;custtype&quot;</span><span class="p">:</span><span class="s2">&quot;P&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hashkey&quot;</span> <span class="p">:</span> <span class="n">hashkey</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rt_cd&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
        <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[매도 성공]</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[매도 실패]</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<p>KIS Developers의 공식 API 문서를 참고해서 손쉽게 주요 함수들의 정의를 마쳤습니다. 이외에 더 궁금하거나 까닭 없이 에러가 발생하는 부분에 관해서는 KIS Develpers 포럼을 적극적으로 활용해 보시기 바랍니다. FAQ와 Q&amp;A 세션에 이미 많은 질문과 응답들이 달려있습니다. 다음 절부터는 자동매매의 주요 로직과 코드를 중심적으로 설명드리겠습니다.</p>
</section>
</section>
<span id="document-chapter7/7.2.4_main_hanguk"></span><section class="tex2jax_ignore mathjax_ignore" id="id1">
<h3>자동매매 로직 이해하기<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>자동매매 코드는 다음과 같이 크게 네 파트로 구분되어 있습니다.</p>
<ol class="simple">
<li><p>장 전</p>
<ul class="simple">
<li><p>필요 변수 준비</p></li>
</ul>
</li>
<li><p>장 중</p>
<ul class="simple">
<li><p>매수</p></li>
<li><p>매도</p></li>
</ul>
</li>
<li><p>장 종료 전</p>
<ul class="simple">
<li><p>보유 종목 중, 5th 영업일 지난 종목 일괄 매도</p></li>
</ul>
</li>
<li><p>장 후</p>
<ul class="simple">
<li><p>매수 종목 코드 및 날짜 저장 (pickle 파일)</p></li>
</ul>
</li>
</ol>
<p>아래와 같이 keyring 라이브러리를 이용하여 API 앱키 값과 앱시크릿키 값을 저장합니다. 키 값을 프로그램을 시작할 때 불러올 수 있도록 합니다. 그리고 get_access_token() 함수를 통해 보안인증 토큰을 생성합니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">keyring</span>
<span class="n">keyring</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="s1">&#39;real_app_key&#39;</span><span class="p">,</span><span class="s1">&#39;occam12345&#39;</span><span class="p">,</span><span class="s1">&#39;XXXXXX&#39;</span><span class="p">)</span> <span class="c1"># API 신청 시 제공받은 개인 앱 키 값 저장</span>
<span class="n">keyring</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="s1">&#39;real_app_secret&#39;</span><span class="p">,</span><span class="s1">&#39;occam12345&#39;</span><span class="p">,</span><span class="s1">&#39;XXXXXXXXX&#39;</span><span class="p">)</span>  <span class="c1"># API 신청 시 제공받은 개인 앱 시크릿 키 값 저장</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot; 장 시작 전 정보 준비&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">keyring</span>

<span class="n">APP_KEY</span> <span class="o">=</span> <span class="n">keyring</span><span class="o">.</span><span class="n">get_password</span><span class="p">(</span><span class="s1">&#39;real_app_key&#39;</span><span class="p">,</span><span class="s1">&#39;occam12345&#39;</span><span class="p">)</span>
<span class="n">APP_SECRET</span> <span class="o">=</span>  <span class="n">keyring</span><span class="o">.</span><span class="n">get_password</span><span class="p">(</span><span class="s1">&#39;real_app_secret&#39;</span><span class="p">,</span><span class="s1">&#39;occam12345&#39;</span><span class="p">)</span>
<span class="c1"># URL_BASE = &quot;https://openapi.koreainvestment.com:9443&quot; # 실전 투자</span>
<span class="n">URL_BASE</span> <span class="o">=</span> <span class="s2">&quot;https://openapivts.koreainvestment.com:29443&quot;</span> <span class="c1">#모의투자서비스</span>
<span class="n">CANO</span> <span class="o">=</span> <span class="s1">&#39;XXXXXXX&#39;</span> <span class="c1"># 계좌번호</span>
<span class="n">ACNT_PRDT_CD</span> <span class="o">=</span> <span class="s1">&#39;01&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>이어서 추천 종목이 들어 있는 “select_dict.pkl” 피클 파일을 불러오고, 매수 주문이 완료된 종목을 담아놓을 bought_list 변수를 선언합니다. 그다음, 잔고 조회 함수를 호출해서 보유 주식 정보를 balance_dict 변수에 저장합니다. 만약 추천종목 중에 보유 중인 종목이 있다면 매수하지 않기 위해서 bought_list 변수에 추가시키고, 추천 종목 딕셔너리 변수 selec_dict에서 해당 종목을 제외합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot; 장 전, 매수/매도 관련 변수 선언 &quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">pickle</span>

<span class="c1"># 추천 종목 딕셔너리 불러오기</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;select_dict.pkl&quot;</span><span class="p">,</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span>
<span class="n">select_dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># 매수 완료된 종목 리스트</span>
<span class="n">bought_list</span> <span class="o">=</span> <span class="p">[]</span> 

<span class="c1"># 보유 주식 조회</span>
<span class="n">balance_dict</span> <span class="o">=</span> <span class="n">get_stock_balance</span><span class="p">()</span>

<span class="c1"># 보유 중인 추천 종목을 매수 완료된 종목 리스트로 추가</span>
<span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">select_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">balance_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">bought_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
        
<span class="c1"># 보유 중인 추천 종목을 매수하지 않기 위해서 매수 딕셔너리에서 제외</span>
<span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">bought_list</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">select_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">del</span> <span class="n">select_dict</span><span class="p">[</span><span class="n">sym</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>마지막으로 매수 가능한 보유 현금을 total_cash 변수에 저장하고, 매수해야 하는 종목 수를 total_buy_count에 저장합니다. 종목 당 매수 금액 비율을 산출하여 buy_percent에 저장하고, 선언된 total_cash와 buy_percent를 통해 종목별 주문 가능 금액을 buy_amount에 저장합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;장 전, 매수 금액 준비&quot;&quot;&quot;</span>

<span class="c1"># 보유 현금 조회 </span>
<span class="n">total_cash</span> <span class="o">=</span> <span class="n">get_balance</span><span class="p">()</span>
<span class="c1"># 매수할 종목 수</span>
<span class="n">target_buy_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">select_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> 
<span class="c1"># 종목당 매수 금액 비율</span>
<span class="n">buy_percent</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">target_buy_count</span>
<span class="c1"># 종목별 주문 가능 금액 계산</span>
<span class="n">buy_amount</span> <span class="o">=</span> <span class="n">total_cash</span> <span class="o">*</span> <span class="n">buy_percent</span>  
</pre></div>
</div>
</div>
</div>
<p>다음으로 장이 시작하는 시간과 끝나는 시간을 t_start와 t_exit에 저장합니다. 5일 이상 보유했던 종목을 장이 끝나기 5 분 전에 전량 매도하기 위해서 t_sell에 해당 시간을 저장 했습니다. 그리고 주말이면 자동매매 코드를 돌리지 않기 위해서 현재 요일 정보를 today 변수에 저장합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;장 중, 시간 변수 준비&quot;&quot;&quot;</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">t_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="c1"># 현재 시간</span>
        <span class="n">t_start</span> <span class="o">=</span> <span class="n">t_now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">t_sell</span> <span class="o">=</span> <span class="n">t_now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">t_exit</span> <span class="o">=</span> <span class="n">t_now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">today</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">or</span> <span class="n">today</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>  <span class="c1"># 토요일이나 일요일이면 자동 종료</span>
            <span class="n">send_message</span><span class="p">(</span><span class="s2">&quot;주말이므로 프로그램을 종료합니다.&quot;</span><span class="p">)</span>
            <span class="k">break</span>
</pre></div>
</div>
</div>
</div>
<p>장이 시작되고, 추천 종목 매수를 먼저 시도 합니다. 추천 종목의 현재가격이 목표가격 범위에 들어오면 매수 가능 수량을 계산하고 매수를 시도합니다. Discord 를 통해 매수 시도 알림을 보내고, 매수 성공 시, bought_list 에 해당 종목을 추가 합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;장 중, 매수&quot;&quot;&quot;</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    
    <span class="c1"># 시간 변수 준비 코드 생략&quot; </span>
    
    <span class="k">if</span> <span class="n">t_start</span> <span class="o">&lt;</span> <span class="n">t_now</span> <span class="o">&lt;</span> <span class="n">t_sell</span> <span class="p">:</span>  <span class="c1"># AM 09:00 ~ PM 03:15</span>
        <span class="c1"># 매수 코드</span>
        <span class="k">for</span> <span class="n">sym</span><span class="p">,</span> <span class="n">name_n_target_price_list</span> <span class="ow">in</span> <span class="n">select_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bought_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">target_buy_count</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">bought_list</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">target_price</span> <span class="o">=</span> <span class="n">name_n_target_price_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># 전날 종가</span>
                <span class="n">current_price</span> <span class="o">=</span> <span class="n">get_current_price</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">target_price</span> <span class="o">&lt;=</span> <span class="n">current_price</span> <span class="o">&lt;</span> <span class="n">target_price</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">:</span> <span class="c1"># Max: 5% 상승 가격, Min: 전날 종가</span>
                    <span class="n">buy_qty</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 매수할 수량 초기화</span>
                    <span class="n">buy_qty</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">buy_amount</span> <span class="o">//</span> <span class="n">current_price</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">buy_qty</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name_n_target_price_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> 목표가 달성(</span><span class="si">{</span><span class="n">current_price</span><span class="si">}</span><span class="s2">) 매수를 시도합니다.&quot;</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">buy</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">buy_qty</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                            <span class="n">soldout</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">bought_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
                            <span class="n">get_stock_balance</span><span class="p">()</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>매도 코드는 매수 코드 보다 더 간단 합니다. 계좌 잔고 조회를 통해서 보유 중인 종목의 평가수익률이 목표하는 익절 혹은 손절라인을 넘어갈 때 매도를 시도 합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;장 중, 매도&quot;&quot;&quot;</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    
    <span class="c1"># 시간 변수 준비 코드 생략</span>
    
    <span class="k">if</span> <span class="n">t_start</span> <span class="o">&lt;</span> <span class="n">t_now</span> <span class="o">&lt;</span> <span class="n">t_sell</span> <span class="p">:</span>  <span class="c1"># AM 09:00 ~ PM 03:15</span>
        
        <span class="c1"># 매수 코드 생략</span>
    
        <span class="c1"># 매도 코드</span>
        <span class="n">balance_dict</span> <span class="o">=</span> <span class="n">get_stock_balance</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sym</span><span class="p">,</span> <span class="n">qty_rt</span> <span class="ow">in</span> <span class="n">balance_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="c1"># qty_rt / [0]: qty(보유수량), [1]: rt(평가손익율)</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">qty_rt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">5.0</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">(</span><span class="n">qty_rt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">3.0</span><span class="p">:</span> <span class="c1"># 익절 라인은 dynamic 하게 바꿀 수 있다</span>
                <span class="n">sell</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">qty_rt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>이전 장들에서 구현한 모델의 평가 기준이 5 영업일 뒤의 수익율이었기 때문에 장 종료 5분 전, 5 영업일 지난 보유 종목을 일괄 매도 합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;장 종료 5분 전, 5 영업일 지난 보유 종목 일괄 매도&quot;&quot;&quot;</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    
    <span class="c1"># 시간 변수 준비 코드 생략</span>
    
    <span class="k">if</span> <span class="n">t_start</span> <span class="o">&lt;</span> <span class="n">t_now</span> <span class="o">&lt;</span> <span class="n">t_sell</span> <span class="p">:</span>  <span class="c1"># AM 09:00 ~ PM 03:15</span>
        
        <span class="c1"># 매수 코드 생략</span>
    
        <span class="c1"># 매도 코드 생략</span>
        
    <span class="k">if</span> <span class="n">t_sell</span> <span class="o">&lt;</span> <span class="n">t_now</span> <span class="o">&lt;</span> <span class="n">t_exit</span><span class="p">:</span>  <span class="c1"># PM 03:15 ~ PM 03:20 : 5 영업일 지난 종목들 일괄 매도</span>
        <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;5일된 종목을 전량 매도 합니다.&quot;</span><span class="p">)</span>
        <span class="n">sell_list_5d_over</span> <span class="o">=</span> <span class="n">get_stock_5d_before</span><span class="p">()</span>
            
        <span class="n">balance_dict</span> <span class="o">=</span> <span class="n">get_stock_balance</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sym</span><span class="p">,</span> <span class="n">qty_rt</span> <span class="ow">in</span> <span class="n">balance_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">sell_list_5d_over</span><span class="p">:</span>
                <span class="n">sell</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">qty_rt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>장 후, 프로그램을 종료합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;장 후, 프로그램 종료&quot;&quot;&quot;</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    
    <span class="c1"># 시간 변수 준비 코드 생략</span>
    
    <span class="k">if</span> <span class="n">t_start</span> <span class="o">&lt;</span> <span class="n">t_now</span> <span class="o">&lt;</span> <span class="n">t_sell</span> <span class="p">:</span>  <span class="c1"># AM 09:00 ~ PM 03:15</span>
        
        <span class="c1"># 매수 코드 생략</span>
    
        <span class="c1"># 매도 코드 생략</span>
    <span class="k">if</span> <span class="n">t_sell</span> <span class="o">&lt;</span> <span class="n">t_now</span> <span class="o">&lt;</span> <span class="n">t_exit</span><span class="p">:</span> <span class="c1"># PM 03:15 ~ PM 03:20 </span>
        
        <span class="c1"># 5 영업일 지난 종목들 일괄 매도</span>

    <span class="k">if</span> <span class="n">t_exit</span> <span class="o">&lt;</span> <span class="n">t_now</span><span class="p">:</span>  <span class="c1"># PM 03:20 ~ :프로그램 종료</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;프로그램을 종료합니다.&quot;</span><span class="p">)</span>
        <span class="k">break</span>
</pre></div>
</div>
</div>
</div>
<p>전체 코드의 로직을 볼 수 있는 플로우 차트는 아래와 같습니다.</p>
<p><img alt="GET_IMAGE" src="_images/hanguk_logic.png" /></p>
<p>Jupyter 환경에서 ipynb 파일로 전체 코드를 아래와 같이 순서대로 실행해 볼 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;select_dict.pkl&quot;</span><span class="p">,</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span>
<span class="n">select_dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_dict</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;002680&#39;: [&#39;한탑&#39;, 3155],
 &#39;177350&#39;: [&#39;베셀&#39;, 7630],
 &#39;312610&#39;: [&#39;에이에프더블류&#39;, 3505],
 &#39;096870&#39;: [&#39;엘디티&#39;, 4145],
 &#39;311390&#39;: [&#39;네오크레마&#39;, 13450]}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">import</span> <span class="nn">keyring</span>

<span class="n">APP_KEY</span> <span class="o">=</span> <span class="n">keyring</span><span class="o">.</span><span class="n">get_password</span><span class="p">(</span><span class="s1">&#39;real_app_key&#39;</span><span class="p">,</span><span class="s1">&#39;occam12345&#39;</span><span class="p">)</span>
<span class="n">APP_SECRET</span> <span class="o">=</span>  <span class="n">keyring</span><span class="o">.</span><span class="n">get_password</span><span class="p">(</span><span class="s1">&#39;real_app_secret&#39;</span><span class="p">,</span><span class="s1">&#39;occam12345&#39;</span><span class="p">)</span>
<span class="c1"># URL_BASE = &quot;https://openapi.koreainvestment.com:9443&quot; # 실전 투자</span>
<span class="n">URL_BASE</span> <span class="o">=</span> <span class="s2">&quot;https://openapivts.koreainvestment.com:29443&quot;</span> <span class="c1">#모의투자서비스</span>
<span class="n">CANO</span> <span class="o">=</span> <span class="s1">&#39;XXXXXXX&#39;</span> <span class="c1"># 계좌번호</span>
<span class="n">ACNT_PRDT_CD</span> <span class="o">=</span> <span class="s1">&#39;01&#39;</span>

<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;select_dict.pkl&quot;</span><span class="p">,</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span>
<span class="n">select_dict</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Input Dict 로 엑셀 파일 만들기</span>

<span class="k">def</span> <span class="nf">send_message</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;디스코드 메세지 전송&quot;&quot;&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">DISCORD_WEBHOOK_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_access_token</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;토큰 발급&quot;&quot;&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;content-type&quot;</span><span class="p">:</span><span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;grant_type&quot;</span><span class="p">:</span><span class="s2">&quot;client_credentials&quot;</span><span class="p">,</span>
    <span class="s2">&quot;appkey&quot;</span><span class="p">:</span><span class="n">APP_KEY</span><span class="p">,</span>
    <span class="s2">&quot;appsecret&quot;</span><span class="p">:</span><span class="n">APP_SECRET</span><span class="p">}</span>
    <span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;oauth2/tokenP&quot;</span>
    <span class="n">URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">URL_BASE</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>
    <span class="n">ACCESS_TOKEN</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ACCESS_TOKEN</span>

<span class="k">def</span> <span class="nf">hashkey</span><span class="p">(</span><span class="n">datas</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;암호화&quot;&quot;&quot;</span>
    <span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;uapi/hashkey&quot;</span>
    <span class="n">URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">URL_BASE</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;content-Type&#39;</span> <span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
    <span class="s1">&#39;appKey&#39;</span> <span class="p">:</span> <span class="n">APP_KEY</span><span class="p">,</span>
    <span class="s1">&#39;appSecret&#39;</span> <span class="p">:</span> <span class="n">APP_SECRET</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">datas</span><span class="p">))</span>
    <span class="n">hashkey</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;HASH&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">hashkey</span>

<span class="k">def</span> <span class="nf">get_current_price</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;005930&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;현재가 조회&quot;&quot;&quot;</span>
    <span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;uapi/domestic-stock/v1/quotations/inquire-price&quot;</span>
    <span class="n">URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">URL_BASE</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">ACCESS_TOKEN</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;appKey&quot;</span><span class="p">:</span><span class="n">APP_KEY</span><span class="p">,</span>
            <span class="s2">&quot;appSecret&quot;</span><span class="p">:</span><span class="n">APP_SECRET</span><span class="p">,</span>
            <span class="s2">&quot;tr_id&quot;</span><span class="p">:</span><span class="s2">&quot;FHKST01010100&quot;</span><span class="p">}</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;fid_cond_mrkt_div_code&quot;</span><span class="p">:</span><span class="s2">&quot;J&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fid_input_iscd&quot;</span><span class="p">:</span><span class="n">code</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;stck_prpr&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">get_stock_5d_before</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">get_stock_before</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
        <span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;uapi/domestic-stock/v1/trading/inquire-daily-ccld&quot;</span>
        <span class="n">URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">URL_BASE</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;authorization&quot;</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">ACCESS_TOKEN</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;appKey&quot;</span><span class="p">:</span><span class="n">APP_KEY</span><span class="p">,</span>
            <span class="s2">&quot;appSecret&quot;</span><span class="p">:</span><span class="n">APP_SECRET</span><span class="p">,</span>
            <span class="s2">&quot;tr_id&quot;</span><span class="p">:</span><span class="s2">&quot;VTTC8001R&quot;</span><span class="p">,</span>  <span class="c1"># 실전 투자 &quot;TTTC8001R&quot;</span>
            <span class="s2">&quot;custtype&quot;</span><span class="p">:</span><span class="s2">&quot;P&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;CANO&quot;</span><span class="p">:</span> <span class="n">CANO</span><span class="p">,</span>
            <span class="s2">&quot;ACNT_PRDT_CD&quot;</span><span class="p">:</span> <span class="n">ACNT_PRDT_CD</span><span class="p">,</span>
            <span class="s2">&quot;INQR_STRT_DT&quot;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
            <span class="s2">&quot;INQR_END_DT&quot;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
            <span class="s2">&quot;SLL_BUY_DVSN_CD&quot;</span><span class="p">:</span> <span class="s2">&quot;02&quot;</span><span class="p">,</span> <span class="c1"># 00:전체, 01:매도, 02:매수</span>
            <span class="s2">&quot;INQR_DVSN&quot;</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span> <span class="c1"># 00: 역순</span>
            <span class="s2">&quot;PDNO&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> 
            <span class="s2">&quot;CCLD_DVSN&quot;</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ORD_GNO_BRNO&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ODNO&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;INQR_DVSN_3&quot;</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span>
            <span class="s2">&quot;INQR_DVSN_1&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CTX_AREA_FK100&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CTX_AREA_NK100&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
        <span class="p">}</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="n">stock_dict</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;output1&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">stock_dict</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="k">while</span> <span class="n">prev</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span>
        <span class="n">t_previous_5d</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">prev</span><span class="p">)</span>
        <span class="n">t_previous_5d</span> <span class="o">=</span> <span class="n">t_previous_5d</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">bought_previous_5d_dict</span> <span class="o">=</span> <span class="n">get_stock_before</span><span class="p">(</span><span class="n">t_previous_5d</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bought_previous_5d_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prev</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">sell_list_5d_over</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">stock</span> <span class="ow">in</span> <span class="n">bought_previous_5d_dict</span><span class="p">:</span>
        <span class="n">sell_list_5d_over</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;pdno&#39;</span><span class="p">])</span>
    <span class="n">sell_list_5d_over</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sell_list_5d_over</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">sell_list_5d_over</span>

<span class="k">def</span> <span class="nf">get_stock_balance</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;주식 잔고조회&quot;&quot;&quot;</span>
    <span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;uapi/domestic-stock/v1/trading/inquire-balance&quot;</span>
    <span class="n">URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">URL_BASE</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;authorization&quot;</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">ACCESS_TOKEN</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;appKey&quot;</span><span class="p">:</span><span class="n">APP_KEY</span><span class="p">,</span>
        <span class="s2">&quot;appSecret&quot;</span><span class="p">:</span><span class="n">APP_SECRET</span><span class="p">,</span>
        <span class="s2">&quot;tr_id&quot;</span><span class="p">:</span><span class="s2">&quot;VTTC8434R&quot;</span><span class="p">,</span>  <span class="c1"># 실전 투자 &quot;TTTC8434R&quot;</span>
        <span class="s2">&quot;custtype&quot;</span><span class="p">:</span><span class="s2">&quot;P&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;CANO&quot;</span><span class="p">:</span> <span class="n">CANO</span><span class="p">,</span>
        <span class="s2">&quot;ACNT_PRDT_CD&quot;</span><span class="p">:</span> <span class="n">ACNT_PRDT_CD</span><span class="p">,</span>
        <span class="s2">&quot;AFHR_FLPR_YN&quot;</span><span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span>
        <span class="s2">&quot;OFL_YN&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;INQR_DVSN&quot;</span><span class="p">:</span> <span class="s2">&quot;02&quot;</span><span class="p">,</span>
        <span class="s2">&quot;UNPR_DVSN&quot;</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FUND_STTL_ICLD_YN&quot;</span><span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FNCG_AMT_AUTO_RDPT_YN&quot;</span><span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PRCS_DVSN&quot;</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CTX_AREA_FK100&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CTX_AREA_NK100&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
    <span class="p">}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
    <span class="n">stock_list</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;output1&#39;</span><span class="p">]</span>
    <span class="n">evaluation</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;output2&#39;</span><span class="p">]</span>
    <span class="n">stock_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;====주식 보유잔고====&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">stock</span> <span class="ow">in</span> <span class="n">stock_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;hldg_qty&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">stock_dict</span><span class="p">[</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;pdno&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;hldg_qty&#39;</span><span class="p">],</span> <span class="n">stock</span><span class="p">[</span><span class="s1">&#39;evlu_pfls_rt&#39;</span><span class="p">]]</span> <span class="c1"># 0: 보유 수량, 1: 평가손익율</span>
            <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;prdt_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;pdno&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;hldg_qty&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">주 </span><span class="si">{</span><span class="n">stock</span><span class="p">[</span><span class="s1">&#39;evlu_pfls_rt&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;주식 평가 금액: </span><span class="si">{</span><span class="n">evaluation</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;scts_evlu_amt&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">원&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;평가 손익 합계: </span><span class="si">{</span><span class="n">evaluation</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;evlu_pfls_smtl_amt&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">원&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;총 평가 금액: </span><span class="si">{</span><span class="n">evaluation</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;tot_evlu_amt&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">원&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=================&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stock_dict</span>

<span class="k">def</span> <span class="nf">get_balance</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;현금 잔고조회&quot;&quot;&quot;</span>
    <span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;uapi/domestic-stock/v1/trading/inquire-psbl-order&quot;</span>
    <span class="n">URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">URL_BASE</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;authorization&quot;</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">ACCESS_TOKEN</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;appKey&quot;</span><span class="p">:</span><span class="n">APP_KEY</span><span class="p">,</span>
        <span class="s2">&quot;appSecret&quot;</span><span class="p">:</span><span class="n">APP_SECRET</span><span class="p">,</span>
        <span class="s2">&quot;tr_id&quot;</span><span class="p">:</span><span class="s2">&quot;VTTC8908R&quot;</span><span class="p">,</span> <span class="c1"># 실전 투자 : &quot;TTTC8908R&quot;</span>
        <span class="s2">&quot;custtype&quot;</span><span class="p">:</span><span class="s2">&quot;P&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;CANO&quot;</span><span class="p">:</span> <span class="n">CANO</span><span class="p">,</span>
        <span class="s2">&quot;ACNT_PRDT_CD&quot;</span><span class="p">:</span> <span class="n">ACNT_PRDT_CD</span><span class="p">,</span>
        <span class="s2">&quot;PDNO&quot;</span><span class="p">:</span> <span class="s2">&quot;005930&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ORD_UNPR&quot;</span><span class="p">:</span> <span class="s2">&quot;65500&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ORD_DVSN&quot;</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CMA_EVLU_AMT_ICLD_YN&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span>
        <span class="s2">&quot;OVRS_ICLD_YN&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span>
    <span class="p">}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
    <span class="n">cash</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;ord_psbl_cash&#39;</span><span class="p">]</span>
    <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;주문 가능 현금 잔고: </span><span class="si">{</span><span class="n">cash</span><span class="si">}</span><span class="s2">원&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">cash</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">buy</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;005930&quot;</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;주식 시장가 매수&quot;&quot;&quot;</span>
    <span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;uapi/domestic-stock/v1/trading/order-cash&quot;</span>
    <span class="n">URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">URL_BASE</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;CANO&quot;</span><span class="p">:</span> <span class="n">CANO</span><span class="p">,</span>
        <span class="s2">&quot;ACNT_PRDT_CD&quot;</span><span class="p">:</span> <span class="n">ACNT_PRDT_CD</span><span class="p">,</span>
        <span class="s2">&quot;PDNO&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
        <span class="s2">&quot;ORD_DVSN&quot;</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ORD_QTY&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">qty</span><span class="p">)),</span>
        <span class="s2">&quot;ORD_UNPR&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;authorization&quot;</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">ACCESS_TOKEN</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;appKey&quot;</span><span class="p">:</span><span class="n">APP_KEY</span><span class="p">,</span>
        <span class="s2">&quot;appSecret&quot;</span><span class="p">:</span><span class="n">APP_SECRET</span><span class="p">,</span>
        <span class="s2">&quot;tr_id&quot;</span><span class="p">:</span><span class="s2">&quot;VTTC0802U&quot;</span><span class="p">,</span>  <span class="c1"># 실전 투자 : &quot;TTTC0802U&quot;</span>
        <span class="s2">&quot;custtype&quot;</span><span class="p">:</span><span class="s2">&quot;P&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hashkey&quot;</span> <span class="p">:</span> <span class="n">hashkey</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rt_cd&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
        <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[매수 성공]</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[매수 실패]</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">sell</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s2">&quot;005930&quot;</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;주식 시장가 매도&quot;&quot;&quot;</span>
    <span class="n">PATH</span> <span class="o">=</span> <span class="s2">&quot;uapi/domestic-stock/v1/trading/order-cash&quot;</span>
    <span class="n">URL</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">URL_BASE</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">PATH</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;CANO&quot;</span><span class="p">:</span> <span class="n">CANO</span><span class="p">,</span>
        <span class="s2">&quot;ACNT_PRDT_CD&quot;</span><span class="p">:</span> <span class="n">ACNT_PRDT_CD</span><span class="p">,</span>
        <span class="s2">&quot;PDNO&quot;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
        <span class="s2">&quot;ORD_DVSN&quot;</span><span class="p">:</span> <span class="s2">&quot;01&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ORD_QTY&quot;</span><span class="p">:</span> <span class="n">qty</span><span class="p">,</span>
        <span class="s2">&quot;ORD_UNPR&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;authorization&quot;</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">ACCESS_TOKEN</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;appKey&quot;</span><span class="p">:</span><span class="n">APP_KEY</span><span class="p">,</span>
        <span class="s2">&quot;appSecret&quot;</span><span class="p">:</span><span class="n">APP_SECRET</span><span class="p">,</span>
        <span class="s2">&quot;tr_id&quot;</span><span class="p">:</span><span class="s2">&quot;VTTC0801U&quot;</span><span class="p">,</span> <span class="c1"># 실전 투자 : TTTC0801U</span>
        <span class="s2">&quot;custtype&quot;</span><span class="p">:</span><span class="s2">&quot;P&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hashkey&quot;</span> <span class="p">:</span> <span class="n">hashkey</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rt_cd&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
        <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[매도 성공]</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[매도 실패]</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

<span class="c1"># 자동매매 시작</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ACCESS_TOKEN</span> <span class="o">=</span> <span class="n">get_access_token</span><span class="p">()</span>
    <span class="n">bought_list</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># 매수 완료된 종목 리스트</span>
    <span class="n">balance_dict</span> <span class="o">=</span> <span class="n">get_stock_balance</span><span class="p">()</span> <span class="c1"># 보유 주식 조회</span>
    <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">select_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">balance_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">bought_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">bought_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">select_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">del</span> <span class="n">select_dict</span><span class="p">[</span><span class="n">sym</span><span class="p">]</span>
            
    <span class="n">total_cash</span> <span class="o">=</span> <span class="n">get_balance</span><span class="p">()</span> <span class="c1"># 보유 현금 조회        </span>
    <span class="n">target_buy_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">select_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="c1"># 매수할 종목 수</span>
    <span class="n">buy_percent</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">target_buy_count</span> <span class="c1"># 종목당 매수 금액 비율</span>
    <span class="n">buy_amount</span> <span class="o">=</span> <span class="n">total_cash</span> <span class="o">*</span> <span class="n">buy_percent</span>  <span class="c1"># 종목별 주문 금액 계산</span>

    <span class="n">send_message</span><span class="p">(</span><span class="s2">&quot;===국내 주식 자동매매 프로그램을 시작합니다===&quot;</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">t_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">t_start</span> <span class="o">=</span> <span class="n">t_now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">59</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">59</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">t_sell</span> <span class="o">=</span> <span class="n">t_now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">t_exit</span> <span class="o">=</span> <span class="n">t_now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">today</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">or</span> <span class="n">today</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>  <span class="c1"># 토요일이나 일요일이면 자동 종료</span>
            <span class="n">send_message</span><span class="p">(</span><span class="s2">&quot;주말이므로 프로그램을 종료합니다.&quot;</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="n">t_start</span> <span class="o">&lt;</span> <span class="n">t_now</span> <span class="o">&lt;</span> <span class="n">t_exit</span> <span class="p">:</span>  <span class="c1"># AM 09:00 ~ PM 03:15</span>
            <span class="c1"># 매수 코드</span>
            <span class="k">for</span> <span class="n">sym</span><span class="p">,</span> <span class="n">name_n_target_price_list</span> <span class="ow">in</span> <span class="n">select_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bought_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">target_buy_count</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">bought_list</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">target_price</span> <span class="o">=</span> <span class="n">name_n_target_price_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># 전날 종가</span>
                    <span class="n">current_price</span> <span class="o">=</span> <span class="n">get_current_price</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">target_price</span> <span class="o">&lt;=</span> <span class="n">current_price</span> <span class="o">&lt;</span> <span class="n">target_price</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">:</span> <span class="c1"># Max: 5% 상승 가격, Min: 전날 종가</span>
                        <span class="n">buy_qty</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 매수할 수량 초기화</span>
                        <span class="n">buy_qty</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">buy_amount</span> <span class="o">//</span> <span class="n">current_price</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">buy_qty</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name_n_target_price_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> 목표가 달성(</span><span class="si">{</span><span class="n">current_price</span><span class="si">}</span><span class="s2">) 매수를 시도합니다.&quot;</span><span class="p">)</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="n">buy</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">buy_qty</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                                <span class="n">soldout</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">bought_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sym</span><span class="p">)</span>
                                <span class="n">get_stock_balance</span><span class="p">()</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="c1"># 매도 코드</span>
            <span class="n">balance_dict</span> <span class="o">=</span> <span class="n">get_stock_balance</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">sym</span><span class="p">,</span> <span class="n">qty_rt</span> <span class="ow">in</span> <span class="n">balance_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="c1"># qty_rt / [0]: qty(보유수량), [1]: rt(평가손익율)</span>
                <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">qty_rt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">5.0</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">(</span><span class="n">qty_rt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">3.0</span><span class="p">:</span> <span class="c1"># 익절 라인은 dynamic 하게 바꿀 수 있다</span>
                    <span class="n">sell</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">qty_rt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">t_sell</span> <span class="o">&lt;</span> <span class="n">t_now</span> <span class="o">&lt;</span> <span class="n">t_exit</span><span class="p">:</span>  <span class="c1"># PM 03:15 ~ PM 03:20 : 5th Day 를 맞이한 종목들 일괄 매도</span>
            <span class="n">sell_list_5d_over</span> <span class="o">=</span> <span class="n">get_stock_5d_before</span><span class="p">()</span>
            
            <span class="n">balance_dict</span> <span class="o">=</span> <span class="n">get_stock_balance</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">sym</span><span class="p">,</span> <span class="n">qty_rt</span> <span class="ow">in</span> <span class="n">balance_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">sell_list_5d_over</span><span class="p">:</span>
                    <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;5일된 종목 </span><span class="si">{</span><span class="n">sym</span><span class="si">}</span><span class="s2">을 전량 매도 합니다.&quot;</span><span class="p">)</span>
                    <span class="n">sell</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span> <span class="n">qty_rt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">t_exit</span> <span class="o">&lt;</span> <span class="n">t_now</span><span class="p">:</span>  <span class="c1"># PM 03:20 ~ :프로그램 종료</span>
            <span class="n">send_message</span><span class="p">(</span><span class="s2">&quot;프로그램을 종료합니다.&quot;</span><span class="p">)</span>
            <span class="k">break</span>
        
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[오류 발생]</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</div>
</section>
</div>
<div class="toctree-wrapper compound">
<span id="document-chapter8/8.0.0_Web_Intro"></span><section id="webapp">
<h2><strong>WebApp을 만들어보자</strong><a class="headerlink" href="#webapp" title="Permalink to this headline">#</a></h2>
<p>Streamlit 는 머신러닝 결과를 손쉽게 배포할 수 있는 패키지입니다. 일반적으로 웹앱은 HTML, CSS, JavaScript 등의 기술이 있어야 원하는 웹앱을 만들 수 있습니다. 파이썬만으로 웹앱을 만들 수 있게 해 주는 패키지가 Streamlit 입니다. Steamlit 을 써보고 “바로 이거야” 하고 감탄했던 기억이 납니다. 이런 상황을 생각해 보세요. 오늘 갑자기 지방출장이 생겼습니다. 회사 노트북으로는 파이썬을 돌리지 못하니 어떤 종목을 추천받아 매수를 해야 할지 궁금합니다. 만약 웹앱을 만들어 인터넷으로 추천 종목 결과물을 받아보면 얼마나 좋을까요? streamlit 을 이용하면 아주 쉽게 할 수 있습니다. 더 나아가 매수/매도 결과 등도 웹앱을 이용해 조회 할 수 있습니다.</p>
<div class="toctree-wrapper compound">
<span id="document-chapter8/8.1.0_Web_Application"></span><section id="webapp">
<h3>WebApp 로컬에서 구현하기<a class="headerlink" href="#webapp" title="Permalink to this headline">#</a></h3>
<p>이 책에서 구현하고자 하는 웹앱은 장 마감 후, 당일 날짜를 ‘YYYY-MM-DD’ 형식으로 입력하면 내일 매수 추천 종목이 뜨는 WebApp입니다. 먼저 만들어 놓은 종목 추천 함수를 테스트 해 봅니다. 추천함수에 필요한 데이터는 종목별로 Loop 를 돌리기 위한 ‘kosdaq_list.pkl’ 파일과 모델 데이터 “gam.pkl” 입니다. 이 두 파일이 같은 폴더에 있어야 됩니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">select_stocks</span><span class="p">(</span><span class="n">today_dt</span><span class="p">):</span>
    
    <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">today_dt</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">start_dt</span> <span class="o">=</span> <span class="n">today</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># 100 일전 데이터 부터 시작 - 피쳐 엔지니어링은 최소 60 개의 일봉이 필요함</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">start_dt</span><span class="p">,</span> <span class="n">today_dt</span><span class="p">)</span>

    <span class="n">kosdaq_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;kosdaq_list.pkl&#39;</span><span class="p">)</span>

    <span class="n">price_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]):</span>  <span class="c1"># 코스닥 모든 종목에서 대하여 반복</span>
        <span class="n">daily_price</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="n">start_dt</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">today_dt</span><span class="p">)</span> <span class="c1"># 종목, 일봉, 데이터 갯수</span>

        <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
        <span class="n">daily_price</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">price_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">price_data</span><span class="p">,</span> <span class="n">daily_price</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>   

    <span class="n">price_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>
    <span class="n">price_data</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span> <span class="n">price_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="c1"># 컬럼 이름 소문자로 변경  </span>
    
    <span class="c1"># DataReder 코스닥 인덱스 조회 실패시, 야후파이낸스로 추출    </span>
    <span class="c1"># kosdaq_index = fdr.DataReader(&#39;KQ11&#39;, start = start_dt, end = today_dt) # 데이터 호출</span>
    <span class="c1"># kosdaq_index.columns = [&#39;close&#39;,&#39;open&#39;,&#39;high&#39;,&#39;low&#39;,&#39;volume&#39;,&#39;change&#39;] # 컬럼명 변경</span>
    
    <span class="n">kosdaq_index</span> <span class="o">=</span>  <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;^KQ11&#39;</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="n">start_dt</span><span class="p">)</span>
    <span class="n">kosdaq_index</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">,</span><span class="s1">&#39;high&#39;</span><span class="p">,</span><span class="s1">&#39;low&#39;</span><span class="p">,</span><span class="s1">&#39;close&#39;</span><span class="p">,</span><span class="s1">&#39;adj_close&#39;</span><span class="p">,</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="c1"># 컬럼명 변경</span>
    <span class="n">kosdaq_index</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;date&#39;</span> <span class="c1"># 인덱스 이름 생성</span>
    <span class="n">kosdaq_index</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># 인덱스(날짜) 로 정렬 </span>
    <span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 수익율 : 전 날 종가대비 당일 종가</span>
    

    <span class="n">merged</span> <span class="o">=</span> <span class="n">price_data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">kosdaq_index</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">],</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>

    <span class="n">return_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]:</span>  

        <span class="n">stock_return</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">merged</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 종목별 전일 종가 대비 당일 종가 수익율</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># 수익율 1 보다 작음. 당일 종가가 전일 종가보다 낮음 (코스닥 지표)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># 수익율 1 보다 큼. 당일 종가가 전일 종가보다 큼 (개별 종목)</span>
        <span class="n">stock_return</span><span class="p">[</span><span class="s1">&#39;win_market&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">c1</span><span class="o">&amp;</span><span class="n">c2</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># C1 과 C2 조건을 동시에 만족하면 1, 아니면 0</span>
        <span class="n">return_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">return_all</span><span class="p">,</span> <span class="n">stock_return</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> 

    <span class="n">return_all</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>    

    <span class="n">model_inputs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sector</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">],</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">kosdaq_list</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]):</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">return_all</span><span class="p">[</span><span class="n">return_all</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">code</span><span class="p">]</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>    

        <span class="c1"># 가격변동성이 크고, 거래량이 몰린 종목이 주가가 상승한다</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_mean&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_std&#39;</span><span class="p">]</span>    
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span>

        <span class="c1"># 위꼬리가 긴 양봉이 자주발생한다.</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;positive_candle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 양봉</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;high/close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;positive_candle&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 양봉이면서 고가가 종가보다 높게 위치</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_high/close&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;high/close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;long_candle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;positive_candle&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">])</span><span class="o">*</span>\
        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 장대 양봉을 데이터로 표현</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_long&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;long_candle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># 지난 20 일 동안 장대양봉의 갯 수</span>


         <span class="c1"># 거래량이 종좀 터지며 매집의 흔적을 보인다   </span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_mean&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span> <span class="c1"># 거래량은 종목과 주가에 따라 다르기 떄문에 표준화한 값이 필요함</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;z&gt;1.96&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_z&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.65</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># 양봉이면서 거래량이 90%신뢰구간을 벗어난 날</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_z&gt;1.96&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">data</span><span class="p">[</span><span class="s1">&#39;z&gt;1.96&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># 양봉이면서 거래량이 90% 신뢰구간을 벗어난 날을 카운트</span>

        <span class="c1"># 주가지수보다 더 좋은 수익율을 보여준다</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;num_win_market&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;win_market&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># 주가지수 수익율이 1 보다 작을 때, 종목 수익율이 1 보다 큰 날 수</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pct_win_market&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 주가지수 수익율 대비 종목 수익율</span>


        <span class="c1"># 동종업체 수익률보다 더 좋은 수익율을 보여준다.           </span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># 종목별 최근 60 일 수익율의 평균</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sector</span>    
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;price_std&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;volume_std&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)]</span>    

        <span class="n">model_inputs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">model_inputs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">model_inputs</span><span class="p">[</span><span class="s1">&#39;sector_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_inputs</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="n">model_inputs</span><span class="o">.</span><span class="n">index</span><span class="p">])[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="c1"># 섹터의 평균 수익율 계산</span>
    <span class="n">model_inputs</span><span class="p">[</span><span class="s1">&#39;return over sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_inputs</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">model_inputs</span><span class="p">[</span><span class="s1">&#39;sector_return&#39;</span><span class="p">])</span> <span class="c1"># 섹터 평균 수익률 대비 종목 수익률 계산</span>
    <span class="n">model_inputs</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Missing 값 있는 행 모두 제거</span>


    <span class="n">feature_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">,</span><span class="s1">&#39;volume_z&#39;</span><span class="p">,</span><span class="s1">&#39;num_high/close&#39;</span><span class="p">,</span><span class="s1">&#39;num_win_market&#39;</span><span class="p">,</span><span class="s1">&#39;pct_win_market&#39;</span><span class="p">,</span><span class="s1">&#39;return over sector&#39;</span><span class="p">]</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">model_inputs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">today_dt</span><span class="p">][[</span><span class="s1">&#39;code&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;return&#39;</span><span class="p">,</span><span class="s1">&#39;kosdaq_return&#39;</span><span class="p">,</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">feature_list</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span> 

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;gam.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">gam</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>     

    <span class="n">yhat</span> <span class="o">=</span> <span class="n">gam</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">feature_list</span><span class="p">])</span>
    <span class="n">X</span><span class="p">[</span><span class="s1">&#39;yhat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yhat</span>

    <span class="n">tops</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;yhat&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.3</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;yhat&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># 스코어 0.3 이상 종목만 </span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tops</span><span class="p">))</span>    
     
    <span class="n">select_tops</span> <span class="o">=</span> <span class="n">tops</span><span class="p">[(</span><span class="n">tops</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.03</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tops</span><span class="p">[</span><span class="s1">&#39;price_z&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)][[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;return&#39;</span><span class="p">,</span><span class="s1">&#39;price_z&#39;</span><span class="p">,</span><span class="s1">&#39;yhat&#39;</span><span class="p">,</span><span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="s1">&#39;kosdaq_return&#39;</span><span class="p">,</span><span class="s1">&#39;close&#39;</span><span class="p">]]</span>  <span class="c1"># 기본 필터링 조건   </span>
      
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">select_tops</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># 최소한 2개 종목 - 추천 리스크 분산        </span>
        <span class="k">return</span> <span class="n">select_tops</span>    
    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<p>2022년 4월 1일을 테스트 한 결과 함수가 잘 작동하는 것을 확인할 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_tops</span> <span class="o">=</span> <span class="n">select_stocks</span><span class="p">(</span><span class="s1">&#39;2022-04-01&#39;</span><span class="p">)</span>
<span class="n">select_tops</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-12-22 00:00:00 2022-04-01
[*********************100%***********************]  1 of 1 completed
203
</pre></div>
</div>
<div class="output text_html"><style type="text/css">
</style>
<table id="T_949e8_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >name</th>
      <th class="col_heading level0 col1" >return</th>
      <th class="col_heading level0 col2" >price_z</th>
      <th class="col_heading level0 col3" >yhat</th>
      <th class="col_heading level0 col4" >return</th>
      <th class="col_heading level0 col5" >kosdaq_return</th>
      <th class="col_heading level0 col6" >close</th>
    </tr>
    <tr>
      <th class="index_name level0" >code</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_949e8_level0_row0" class="row_heading level0 row0" >056090</th>
      <td id="T_949e8_row0_col0" class="data row0 col0" >에디슨INNO</td>
      <td id="T_949e8_row0_col1" class="data row0 col1" >1.080</td>
      <td id="T_949e8_row0_col2" class="data row0 col2" >-1.621</td>
      <td id="T_949e8_row0_col3" class="data row0 col3" >0.540</td>
      <td id="T_949e8_row0_col4" class="data row0 col4" >1.080</td>
      <td id="T_949e8_row0_col5" class="data row0 col5" >0.996</td>
      <td id="T_949e8_row0_col6" class="data row0 col6" >2560</td>
    </tr>
    <tr>
      <th id="T_949e8_level0_row1" class="row_heading level0 row1" >024740</th>
      <td id="T_949e8_row1_col0" class="data row1 col0" >한일단조</td>
      <td id="T_949e8_row1_col1" class="data row1 col1" >1.062</td>
      <td id="T_949e8_row1_col2" class="data row1 col2" >-0.823</td>
      <td id="T_949e8_row1_col3" class="data row1 col3" >0.355</td>
      <td id="T_949e8_row1_col4" class="data row1 col4" >1.062</td>
      <td id="T_949e8_row1_col5" class="data row1 col5" >0.996</td>
      <td id="T_949e8_row1_col6" class="data row1 col6" >3185</td>
    </tr>
    <tr>
      <th id="T_949e8_level0_row2" class="row_heading level0 row2" >083660</th>
      <td id="T_949e8_row2_col0" class="data row2 col0" >CSA 코스믹</td>
      <td id="T_949e8_row2_col1" class="data row2 col1" >1.035</td>
      <td id="T_949e8_row2_col2" class="data row2 col2" >-0.094</td>
      <td id="T_949e8_row2_col3" class="data row2 col3" >0.351</td>
      <td id="T_949e8_row2_col4" class="data row2 col4" >1.035</td>
      <td id="T_949e8_row2_col5" class="data row2 col5" >0.996</td>
      <td id="T_949e8_row2_col6" class="data row2 col6" >2080</td>
    </tr>
    <tr>
      <th id="T_949e8_level0_row3" class="row_heading level0 row3" >122690</th>
      <td id="T_949e8_row3_col0" class="data row3 col0" >서진오토모티브</td>
      <td id="T_949e8_row3_col1" class="data row3 col1" >1.058</td>
      <td id="T_949e8_row3_col2" class="data row3 col2" >-0.114</td>
      <td id="T_949e8_row3_col3" class="data row3 col3" >0.314</td>
      <td id="T_949e8_row3_col4" class="data row3 col4" >1.058</td>
      <td id="T_949e8_row3_col5" class="data row3 col5" >0.996</td>
      <td id="T_949e8_row3_col6" class="data row3 col6" >3350</td>
    </tr>
    <tr>
      <th id="T_949e8_level0_row4" class="row_heading level0 row4" >174880</th>
      <td id="T_949e8_row4_col0" class="data row4 col0" >장원테크</td>
      <td id="T_949e8_row4_col1" class="data row4 col1" >1.090</td>
      <td id="T_949e8_row4_col2" class="data row4 col2" >-0.366</td>
      <td id="T_949e8_row4_col3" class="data row4 col3" >0.305</td>
      <td id="T_949e8_row4_col4" class="data row4 col4" >1.090</td>
      <td id="T_949e8_row4_col5" class="data row4 col5" >0.996</td>
      <td id="T_949e8_row4_col6" class="data row4 col6" >1990</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br></br>
파이썬 파일 ‘stock_selection.py’ 만들고 select_stocks() 함수를 복사해 넣습니다. 쥬피터랩을 쓰고 계신다면 File &gt; New &gt; Python File 에서 파일을 하나 만드시고 그 파일에 함수 select_stocks() 를 복사해서 넣으면 됩니다. stock_selection.py 파일을 동일한 폴더에 저장하신 후에, 아래와 같이 import 를 해 봅니다. 그리고 다시 함수를 호출해서 2022년 4월 1일 추천종목을 확인해 봅니다. 이상없이 함수가 호출되는 것을 확인했습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">stock_selection</span>
<span class="n">stock_selection</span><span class="o">.</span><span class="n">select_stocks</span><span class="p">(</span><span class="s1">&#39;2022-04-01&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;style=&quot;font-size: 12px&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-12-22 00:00:00 2022-04-01
[*********************100%***********************]  1 of 1 completed
203
</pre></div>
</div>
<div class="output text_html"><style type="text/css">
</style>
<table id="T_13b7a_" style="font-size: 12px">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th class="col_heading level0 col0" >name</th>
      <th class="col_heading level0 col1" >yhat</th>
      <th class="col_heading level0 col2" >close</th>
    </tr>
    <tr>
      <th class="index_name level0" >code</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_13b7a_level0_row0" class="row_heading level0 row0" >056090</th>
      <td id="T_13b7a_row0_col0" class="data row0 col0" >에디슨INNO</td>
      <td id="T_13b7a_row0_col1" class="data row0 col1" >0.540</td>
      <td id="T_13b7a_row0_col2" class="data row0 col2" >2560</td>
    </tr>
    <tr>
      <th id="T_13b7a_level0_row1" class="row_heading level0 row1" >024740</th>
      <td id="T_13b7a_row1_col0" class="data row1 col0" >한일단조</td>
      <td id="T_13b7a_row1_col1" class="data row1 col1" >0.355</td>
      <td id="T_13b7a_row1_col2" class="data row1 col2" >3185</td>
    </tr>
    <tr>
      <th id="T_13b7a_level0_row2" class="row_heading level0 row2" >083660</th>
      <td id="T_13b7a_row2_col0" class="data row2 col0" >CSA 코스믹</td>
      <td id="T_13b7a_row2_col1" class="data row2 col1" >0.351</td>
      <td id="T_13b7a_row2_col2" class="data row2 col2" >2080</td>
    </tr>
    <tr>
      <th id="T_13b7a_level0_row3" class="row_heading level0 row3" >122690</th>
      <td id="T_13b7a_row3_col0" class="data row3 col0" >서진오토모티브</td>
      <td id="T_13b7a_row3_col1" class="data row3 col1" >0.314</td>
      <td id="T_13b7a_row3_col2" class="data row3 col2" >3350</td>
    </tr>
    <tr>
      <th id="T_13b7a_level0_row4" class="row_heading level0 row4" >174880</th>
      <td id="T_13b7a_row4_col0" class="data row4 col0" >장원테크</td>
      <td id="T_13b7a_row4_col1" class="data row4 col1" >0.305</td>
      <td id="T_13b7a_row4_col2" class="data row4 col2" >1990</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><br></br>이제 <a class="reference external" href="http://main.py">main.py</a> 파이썬 파일을 만들겠습니다. <a class="reference external" href="http://main.py">main.py</a> 에서는 종목을 추천하는 함수(select_stock)가 있는 stock_selection.py 를 import 하고, 웹앱을 만들어주는 streamlit 도 import 할 것입니다. stock_selection 모듈은 이미 만들었으므로 streamlit 를 설치 후 import 하면 됩니다. 아래와 같이 streamlit 을 설치합니다. (참고 링크 <a class="reference external" href="https://anaconda.org/conda-forge/streamlit">https://anaconda.org/conda-forge/streamlit</a>). 설치를 위해서 먼저 아나콘다 Prompt 을 실행합니다. streamlit 은 pip install streamlit 로도 설치가 가능합니다만, 아나콘다에서 배포하는 패키지를 우선적으로 설치하는 것이 좋습니다. 아래 그림과 타이핑한 후 ‘Enter’ 를 누르시면 자동으로 설치가 됩니다. 참고로 이 책에서는 가상환경에 대하여는 다루지 않도록 하겠습니다. 가상환경이란 프로젝트별로 필요한 파이썬 패키지를 간섭없이 쓸 수 있게 해 줍니다. 이 웹앱 프로젝트는 streamlit 가 필요하지만, 다른 프로젝트는 streamlit 이 필요하지 않을 수 있습니다. 따라서 가상환경을 만들고 가상환경에서 패키지를 설치함으로써 프로젝트 사이에 서로 간섭이 없도록 하는 것이 가장 큰 목적입니다.</p>
<!-- <img src="./images/Install_Streamlit.PNG" width="800" height="150"></img>  -->
<p><img alt="GET_IMAGE" src="_images/Install_Streamlit.PNG" /></p>
<p><br></br>
이제는 웹앱을 만들 준비가 끝났습니다. 주피터노트북은 셀 단위 명령을 실행함으로써 결과를 빠르게 확인하고 다음 단계로 넘어가는 장점이 있었습니다. 따라서 데이터를 여러 관점으로 분석해야 하는 데이터분석가에게 안성맞춤입니다. 하지만, 큰 프로그램을 웹 브러우저 상에서 실행하는 것은 안정성 면에서 문제가 있습니다. 예를 들어 프로그램이 실행되고 있는 웹브라우저가 죽으면 프로그램도 따라서 정지하게 됩니다. 주피터노트북 상에서는 데이터분석과 모델링을 하고, 만들어진 프로그램의 실행은 PyCharm 이나 Vscode 등의 에디터를 이용을 추천드립니다. <a class="reference external" href="http://main.py">main.py</a> 가 있는 폴더에 ‘gam.pkl’, ‘kosdaq_list.pkl’, ‘stock_selection.py’ 파일을 저장합니다. ‘gam..pkl’ 은 예측모델이 저장된 파일이고, ‘kosdaq_list.pkl’ 은 코스닥 종목 리스트가 있는 파일이며 ‘stock_selection.py’ 은 종목 추천 알고리즘이 저장되 파일입니다. <a class="reference external" href="http://main.py">main.py</a> 를 PyCharm 에서 아래와 실행합니다. 참고로 requirements.txt 는 현재 로컬에서 작업하고 있는 환경을 다른 곳에 복사하기 위한 라이브러리 정보가 담긴 파일입니다. 로컬에서 웹앱을 테스트하는 데 필요하지는 않습니다. requirements.txt 파일의 용도에 대하여는 나중에 설명드리도록 하겠습니다.</p>
<p><img alt="GET_IMAGE" src="_images/Streamlit_Run.PNG" /></p>
<p><br></br>
위 코드를 실행하면 새로운 브라우저가 뜨면서 아래와 같은 창이 생깁니다. 아래 박스에 ‘YYYY-MM-DD’ 형식으로 날짜를 입력하고 엔터를 치면 프로그램을 실행합니다. 2022-04-01 를 넣어보겠습니다.</p>
<!-- <img src="./images/Streamlit_Results.PNG" width="800" height="500"></img> -->
<p><img alt="GET_IMAGE" src="_images/Streamlit_Results.PNG" /></p>
<p><br></br>
약 15분 후에 아래와 같은 결과값을 볼 수 있습니다. 로컬 호스트에서 잘 작동하는 지 확인합니다. 아래 5 종목만 추천된 이유는 <a class="reference external" href="http://main.py">main.py</a> 의 마지막 라인에서</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>  <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;yhat&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
<p>head(5) 로 스코어(yhat) 가 높은 5 개 종목만 제시하도록 했기 때문입니다.</p>
<!-- <img src="./images/Streamlit_Results_Stocks.PNG" width="800" height="500"></img> -->
<p><img alt="GET_IMAGE" src="_images/Streamlit_Results_Stocks.PNG" /></p>
</section>
<span id="document-chapter8/8.1.1_Webapp_Deployment"></span><section id="webapp">
<h3>WebApp을 배포하자<a class="headerlink" href="#webapp" title="Permalink to this headline">#</a></h3>
<p>로컬 환경에서 잘동하는 것을 확인했습니다. 이제 streamlit 에서 제공하는 호스팅을 이용하여 웹앱을 배포해 보겠습니다. 아래와 같은 순서대로 진행하면 됩니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">1.</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span> <span class="n">파일을</span> <span class="n">추가합니다</span> 
<span class="mf">2.</span> <span class="n">만들어진</span> <span class="n">WebApp</span> <span class="n">를</span> <span class="n">Github</span> <span class="n">에</span> <span class="n">Push</span> <span class="n">합니다</span><span class="o">.</span>
<span class="mf">3.</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">share</span><span class="o">.</span><span class="n">streamlit</span><span class="o">.</span><span class="n">io</span>  <span class="n">와</span> <span class="n">본인의</span> <span class="n">github</span> <span class="n">repository</span> <span class="n">를</span> <span class="n">연결하고</span> <span class="n">배포합니다</span><span class="o">.</span>
</pre></div>
</div>
<p><br></br>
1.’requirements.txt’ 파일 만들기</p>
<p>아나콘다 프롬프트에서 아래와 같이 명령어를 주면 ‘requirements.txt’ 파일이 생성됩니다. ‘requirements.txt’ 는 Webapp 이 동작하기 위한 모든 라이브러리와 버전 정보가 있습니다.</p>
<p><img alt="GET_IMAGE" src="_images/requirements_Streamlit.PNG" /></p>
<br>
'requirements.txt' 을 열어서 보면 아래와 같습니다.  이 파일을 main.py 가 있는 폴더에 넣어줍니다. Streamlit 에 Webapp 를 배포하는 과정에 아래 버전이 존재하지 않아 에러가 나는 경우가 있습니다. 이때는 '== 버전' 제거한 후 라이브러리 이름만을 적고 다시 진행을 합니다.<p><img alt="GET_IMAGE" src="_images/requirements_file.PNG" /></p>
<p><br></br>
2. Github 에 Push 하기</p>
<p>아래와 같이 ‘requirements.txt’ 파일을 작업폴더에 복사하고 github 에 push 합니다.</p>
<p><img alt="GET_IMAGE" src="_images/git_push.PNG" /></p>
<p><br></br>
3. <a class="reference external" href="https://share.streamlit.io">https://share.streamlit.io</a> 에서 배포하기</p>
<p><a class="reference external" href="http://share.streamlit.io">share.streamlit.io</a> 에서 github Repository 와 연결한 후, 아래와 같이 Branch 이름과 파이썬 파일을 지정해줍니다. 그리고 Deploy 버튼을 누르면 Webapp 이 만들어 집니다.</p>
<p><img alt="GET_IMAGE" src="_images/deploy_app.PNG" /></p>
<p><img alt="GET_IMAGE" src="_images/webapp_launch.PNG" /></p>
</section>
</div>
</section>
</div>
<div class="toctree-wrapper compound">
<span id="document-chapter9/9.0.0_POC"></span><section id="id1">
<h2><strong>종목 추천과 자동매매를 하나로</strong><a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h2>
<p>6 장에서 완성된 종목 추천 알고리즘과 7 장에서 완성된 자동매매 코드를 하나의 파이썬 패키지로 만들고, 아침 9시 00분아 되면 자동으로 실행이 되도록 합니다.  종목을 추천받고, 자동매매가 시작될 수 있도록 프로그램을 만들어 보겠습니다. 윈도우즈 스케줄러을 이용하여 파이썬 파일이 정해진 시간에 자동으로 실행이 될 수 있도록 합니다. 우선 아래와 같이 주피터 노트북 상에서 파이썬 파일로 종목 추천 프로세스와 자동매매 프로세스를 저장합니다. 각 파일의 이름은 ‘<a class="reference external" href="http://selection.py">selection.py</a>’ 와 ‘<a class="reference external" href="http://trading.py">trading.py</a>’ 이며 깃허브 chapter 9 에서 찾으실 수 있습니다. 깃허브 주소 - <a class="reference external" href="https://github.com/occam-KHS/JupyterBook/tree/master/chapter9">https://github.com/occam-KHS/JupyterBook/tree/master/chapter9</a></p>
<p><img alt="GET_IMAGE" src="_images/Python_File.PNG" /></p>
<div class="toctree-wrapper compound">
<span id="document-chapter9/9.1.0_Packaging"></span><section id="id1">
<h3>파이썬 프로그램 패키징<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>PyCharm 에디터를 이용해 파이썬 프로그램 패키징을 진행하겠습니다. ‘<a class="reference external" href="http://selection.py">selection.py</a>’ 와 ‘<a class="reference external" href="http://trading.py">trading.py</a>’ 파이썬 파일로 된 모듈을 import 합니다. 아래와 같이 ‘<a class="reference external" href="http://main.py">main.py</a>’ 에 임의의 영업일 입력한 후, 프로그램을 실행시킵니다. 8장에서도 설명드린 바와 같이 ‘gam.pkl’ 는 예측모델이 저장된 파일이고 ‘kosdaq_list.pkl’ 은 코스닥 종목 리스트가 있는 파일입니다. 프로그램이 추천종목을 받아, 자동매매가 되는지 테스트 해 봅니다.</p>
<p><img alt="GET_IMAGE" src="_images/main_py.PNG" /></p>
<p>별도의 가상환경 설정없이 주피터노트북으로 알고리즘을 만들었으므로, 아나콘다 Base 에 라이브러리가 모두 설치되어 있습니다. 아나콘다 base 를 아래와 같이 인터프리터로 설정해서 필요한 라이브러리를 모두 활용할 수 있도록 합니다.</p>
<p><img alt="GET_IMAGE" src="_images/interpreter.PNG" /></p>
<br>
본서에서 구현된 알고리즘은 자동매매를 실행하는 날과 추천 종목을 조회하는 날이 서로 다릅니다. 예를 들어 2022년 9월 26일(월요일) 자동매매를 실행하려면, 매매할 추천종목은 전 주 금요일(2022년 9월 23일) 로 조회를 해야 합니다. 또한 긴 연휴가 있을 수 있으므로 전 영업일을 알아내는 로직이 필요할 것으로 생각이 됩니다. 삼성전자의 일봉을 매매날짜까지 추출하면, 마지막에서 2번 째 레코드가 전 영업일이 될 것입니다. 코드로 간단하게 구현해보겠습니다. 아래와 같이 오늘이 2022년 9월 26일이면 직전 영업일은 2022년 9월 23일이 됩니다. <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">FinanceDataReader</span> <span class="k">as</span> <span class="nn">fdr</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="n">today_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># 오늘날짜를 &#39;YYYY-MM-DD&#39; 형태로 변경하여 저장</span>
<span class="n">prev_dt</span> <span class="o">=</span> <span class="n">fdr</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s1">&#39;005930&#39;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">today_dt</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># today_dt 의 전 영업일을 찾아 &#39;YYYY-MM-DD&#39; 로 저장</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; 자동매매 일: </span><span class="si">{</span><span class="n">today_dt</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; 전 영업일: </span><span class="si">{</span><span class="n">prev_dt</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 자동매매 일: 2022-09-26
 전 영업일: 2022-09-23
</pre></div>
</div>
</div>
</div>
</section>
<span id="document-chapter9/9.1.1_Scheduling"></span><section id="id1">
<h3>윈도우즈 스케줄러<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>오전 9시에 파이썬 프로그램이 자동으로 실행이 되게 윈도우즈 스케줄링 해 보겠습니다. 우선 실행창에 아래와 같이 타이핑하여 스케줄러를 오픈합니다.</p>
<p><img alt="GET_IMAGE" src="_images/cmd_window.PNG" /></p>
<p><img alt="GET_IMAGE" src="_images/scheduler.PNG" /></p>
<p>오른쪽 ‘작업만들기’ 버튼을 클릭하여 새로운 작업을 생성합니다. 간단하 이름과 설명을 넣어주고 마지막에 ‘가장 높은 수준의 권한으로 실행’ 을 체크합니다. 이제 ‘트리거’와 ‘동작’을 설정하면 됩니다.</p>
<p><img alt="GET_IMAGE" src="_images/new_task.PNG" /></p>
<p>‘트리거’ 탭에서 [새로만들기]로 들어가 작업 설정을 해 줍니다. 매주에서 월요일부터 금요일까지 선택을 하고, 시작시간을 9시00분으로 설정해줍니다.</p>
<p><img alt="GET_IMAGE" src="_images/Trigger.PNG" /></p>
<p>그 다음 동작탭으로 가서 파이썬 실행파일 위치를 지정해줍니다. ‘프로그램/스크립트’ 칸에는 우리가 사용할 python.exe 의 위치, ‘인수 추가’ 칸에는 작성한 실행코드 파일, 마지막으로 시작 위치는 ‘작성한 파이썬 코드’의 위치를 넣어줍니다. 이제 스케줄링이 끝났습니다. 매주 월요일부터 금요일까지 9시에 파이썬 코드가 자동으로 실행됩니다.</p>
<p><img alt="GET_IMAGE" src="_images/Action.PNG" /></p>
</section>
</div>
</section>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By KHS<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>